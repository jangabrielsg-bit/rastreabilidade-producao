<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Rastreabilidade e Controle de Estoque</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Bibliotecas para exportação e gráficos -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .sidebar-icon {
            transition: all 0.2s ease-in-out;
        }
        .sidebar-icon:hover {
            transform: scale(1.1);
        }
        .active-nav {
            background-color: #4f46e5;
            color: white;
        }
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 50;
            inset: 0;
            align-items: center;
            justify-content: center;
            background-color: rgba(0, 0, 0, 0.5);
        }
        .form-input {
            transition: border-color 0.2s;
        }
        .form-input:focus {
            border-color: #4f46e5;
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.25);
        }
        .table-header-sortable {
            cursor: pointer;
        }
        .table-header-sortable:hover {
            background-color: #f0f4f8;
        }
        .insufficient-stock-row {
            background-color: #fee2e2; /* Red-100 */
        }
        .insufficient-stock-row:hover {
            background-color: #fecaca; /* Red-200 */
        }
        @keyframes fade-in-out {
            0% { opacity: 0; transform: translateY(-20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }
        .animate-fade-in-out {
            animation: fade-in-out 4s ease-in-out forwards;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="loading-overlay" class="fixed inset-0 z-[101] flex items-center justify-center bg-white">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-indigo-600"></div>
    </div>

    <div class="flex h-screen">
        <!-- Sidebar -->
        <aside class="w-20 bg-gray-800 text-white flex flex-col items-center py-4 space-y-6">
            <a href="#" id="nav-dashboard" class="sidebar-icon p-3 rounded-lg active-nav" title="Dashboard">
                <i class="fa-solid fa-chart-pie fa-lg"></i>
            </a>
            <nav class="flex flex-col items-center space-y-4">
                <a href="#" id="nav-entry" class="sidebar-icon p-3 rounded-lg" title="Entrada de Mercadorias">
                    <i class="fa-solid fa-dolly fa-lg"></i>
                </a>
                <a href="#" id="nav-inventory" class="sidebar-icon p-3 rounded-lg" title="Gerenciamento de Estoque">
                    <i class="fa-solid fa-warehouse fa-lg"></i>
                </a>
                <a href="#" id="nav-recipes" class="sidebar-icon p-3 rounded-lg" title="Receitas">
                    <i class="fa-solid fa-book-open fa-lg"></i>
                </a>
                <a href="#" id="nav-production" class="sidebar-icon p-3 rounded-lg" title="Ordens de Produção">
                    <i class="fa-solid fa-clipboard-list fa-lg"></i>
                </a>
            </nav>
            <div class="mt-auto">
                 <a href="#" id="nav-settings" class="sidebar-icon p-3 rounded-lg" title="Configurações">
                    <i class="fa-solid fa-cog fa-lg"></i>
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-6 md:p-8 overflow-y-auto">
            
            <!-- Tela da Dashboard -->
            <div id="screen-dashboard">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Dashboard</h1>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Coluna Esquerda -->
                    <div class="lg:col-span-2 space-y-6">
                        <!-- Gráfico -->
                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <h2 class="text-xl font-semibold text-gray-700 mb-4">Top 5 Itens em Estoque</h2>
                            <div class="h-80 flex items-center justify-center">
                                <canvas id="stock-chart"></canvas>
                            </div>
                        </div>
                        <!-- Últimas Entradas -->
                        <div class="bg-white p-6 rounded-xl shadow-lg">
                             <h2 class="text-xl font-semibold text-gray-700 mb-4">Últimas Entradas</h2>
                             <ul id="last-entries-list" class="divide-y divide-gray-200">
                                <!-- Preenchido por JS -->
                             </ul>
                        </div>
                    </div>
                    <!-- Coluna Direita (Alertas) -->
                    <div class="space-y-6">
                        <div class="bg-white p-6 rounded-xl shadow-lg">
                             <h2 class="text-xl font-semibold text-gray-700 mb-4 flex items-center"><i class="fa-solid fa-triangle-exclamation text-yellow-500 mr-3"></i>Alertas</h2>
                             <div id="alerts-container" class="space-y-4">
                                <!-- Estoque Baixo -->
                                <div id="low-stock-alert"></div>
                                <!-- Próximo da Validade -->
                                <div id="expiry-alert"></div>
                                <!-- Risco de Perda -->
                                <div id="loss-risk-alert"></div>
                                <!-- Itens Sem Uso -->
                                <div id="stagnant-stock-alert"></div>
                             </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tela de Registro de Entrada -->
            <div id="screen-entry" class="hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Registro de Entrada de Mercadorias</h1>
                <div class="bg-white p-8 rounded-xl shadow-lg max-w-2xl mx-auto">
                    <form id="entry-form">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="col-span-1 md:col-span-2">
                                <label for="product-name" class="block text-sm font-medium text-gray-700">Nome do Produto</label>
                                <input type="text" id="product-name" name="product-name" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none form-input">
                            </div>
                            <div>
                                <label for="product-code" class="block text-sm font-medium text-gray-700">Código</label>
                                <input type="text" id="product-code" name="product-code" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none form-input">
                            </div>
                            <div>
                                <label for="supplier" class="block text-sm font-medium text-gray-700">Fornecedor</label>
                                <input type="text" id="supplier" name="supplier" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none form-input">
                            </div>
                            <div>
                                <label for="quantity" class="block text-sm font-medium text-gray-700">Quantidade Recebida</label>
                                <input type="number" id="quantity" name="quantity" required min="0.01" step="0.01" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none form-input">
                            </div>
                             <div>
                                <label for="batch-code" class="block text-sm font-medium text-gray-700">Lote</label>
                                <input type="text" id="batch-code" name="batch-code" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none form-input">
                            </div>
                            <div>
                                <label for="mfg-date" class="block text-sm font-medium text-gray-700">Data de Fabricação</label>
                                <input type="date" id="mfg-date" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none form-input">
                            </div>
                            <div>
                                <label for="receipt-date" class="block text-sm font-medium text-gray-700">Data de Recebimento</label>
                                <input type="date" id="receipt-date" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none form-input">
                            </div>
                            <div>
                                <label for="expiry-date" class="block text-sm font-medium text-gray-700">Data de Validade</label>
                                <input type="date" id="expiry-date" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none form-input">
                            </div>
                        </div>
                        <div class="mt-8 flex justify-end">
                            <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105">
                                Registrar Entrada
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Tela de Gerenciamento de Estoque -->
            <div id="screen-inventory" class="hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Gerenciamento de Estoque</h1>
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <div class="flex justify-between items-center mb-4">
                        <input type="text" id="search-inventory" placeholder="🔍 Buscar item por nome, código ou fornecedor..." class="w-full md:w-1/3 border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none form-input">
                        <button id="btn-export-excel" class="bg-white hover:bg-gray-100 text-gray-800 font-semibold py-2 px-4 border border-gray-300 rounded-lg shadow-sm">
                            <i class="fa-solid fa-file-excel text-green-600 mr-2"></i>Exportar para Excel
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 table-header-sortable" data-sort="name">Nome do Produto</th>
                                    <th scope="col" class="px-6 py-3 table-header-sortable" data-sort="code">Código</th>
                                    <th scope="col" class="px-6 py-3 table-header-sortable" data-sort="supplier">Fornecedor</th>
                                    <th scope="col" class="px-6 py-3 text-right">Qtd. Total</th>
                                    <th scope="col" class="px-6 py-3 table-header-sortable" data-sort="expiry">Próx. Validade</th>
                                </tr>
                            </thead>
                            <tbody id="inventory-table-body">
                                <!-- Linhas de inventário serão inseridas aqui -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Tela de Receitas -->
            <div id="screen-recipes" class="hidden">
                 <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">Receitas</h1>
                    <button id="btn-new-recipe" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                        <i class="fa-solid fa-plus mr-2"></i>Nova Receita
                    </button>
                </div>
                <div id="recipes-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Cards de categoria de receita serão inseridos aqui -->
                </div>
            </div>
            
            <!-- Tela de Ordens de Produção -->
            <div id="screen-production" class="hidden">
                 <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">Ordens de Produção</h1>
                    <div>
                        <button id="btn-confirm-production" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 mr-2">
                            <i class="fa-solid fa-check-double mr-2"></i>Confirmar Produção do Dia
                        </button>
                        <button id="btn-new-production-order" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                            <i class="fa-solid fa-plus mr-2"></i>Nova Ordem
                        </button>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm mb-6 flex items-center justify-between">
                    <div class="flex items-center">
                        <label for="search-po-by-date" class="text-sm font-medium text-gray-700 mr-2">Filtrar por data:</label>
                        <input type="date" id="search-po-by-date" class="form-input">
                    </div>
                    <button id="btn-export-pdf" class="bg-white hover:bg-gray-100 text-gray-800 font-semibold py-2 px-4 border border-gray-300 rounded-lg shadow-sm">
                        <i class="fa-solid fa-file-pdf text-red-600 mr-2"></i>Exportar Relatório (PDF)
                    </button>
                </div>
                <div id="production-orders-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Ordens de produção serão listadas aqui -->
                </div>
            </div>
            
            <!-- Tela de Configurações -->
            <div id="screen-settings" class="hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Configurações e Backup</h1>
                <div class="bg-white p-8 rounded-xl shadow-lg max-w-2xl mx-auto space-y-6">
                    <div>
                        <h2 class="text-xl font-semibold text-gray-700">Backup dos Dados</h2>
                        <p class="text-sm text-gray-500 mt-1">
                            Salve todos os seus dados em um arquivo para segurança ou para transferir para outro dispositivo.
                        </p>
                        <button id="btn-download-backup" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105">
                            <i class="fa-solid fa-download mr-2"></i>Baixar Backup (.json)
                        </button>
                    </div>
                    <div class="border-t pt-6">
                        <h2 class="text-xl font-semibold text-gray-700">Restaurar Backup</h2>
                        <p class="text-sm text-gray-500 mt-1">
                            Importe um arquivo de backup. <strong class="text-red-600">Atenção:</strong> Isso substituirá todos os dados existentes no aplicativo.
                        </p>
                        <button id="btn-upload-backup" class="mt-4 w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105">
                            <i class="fa-solid fa-upload mr-2"></i>Carregar Backup (.json)
                        </button>
                        <input type="file" id="backup-file-input" class="hidden" accept=".json">
                    </div>
                </div>
            </div>

        </main>
    </div>
    
    <!-- Modal de Alerta de Shelf Life -->
    <div id="shelf-life-modal" class="modal">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100">
                    <i class="fa-solid fa-triangle-exclamation text-yellow-600 text-2xl"></i>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mt-4">Alerta de Shelf Life</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500">
                        O shelf life do produto é de <strong id="shelf-life-value"></strong>%, abaixo do mínimo de 75%.
                    </p>
                    <p class="text-sm text-gray-600 mt-2">
                        Para prosseguir, insira o nome do responsável que autorizou o recebimento.
                    </p>
                </div>
                <div class="mt-4">
                    <label for="authorizer-name" class="sr-only">Nome do Autorizador</label>
                    <input type="text" id="authorizer-name" placeholder="Nome do Responsável" class="w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none form-input" required>
                </div>
            </div>
            <div class="mt-6 flex justify-center space-x-4">
                <button id="cancel-receipt-btn" type="button" class="py-2 px-4 bg-gray-200 text-gray-800 font-semibold rounded-lg shadow-md hover:bg-gray-300">
                    Cancelar
                </button>
                <button id="confirm-receipt-btn" type="button" class="py-2 px-4 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700">
                    Confirmar Recebimento
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Detalhes e Edição do Item -->
    <div id="item-details-modal" class="modal p-4">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold" id="details-product-name">Nome do Produto</h2>
                <button id="close-details-modal" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            
            <!-- View Mode -->
            <div id="item-details-view">
                <div class="flex justify-end mb-4">
                    <button id="btn-edit-item" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md">
                        <i class="fa-solid fa-pencil mr-2"></i>Editar Item
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-sm">
                    <div><strong>Código:</strong> <span id="details-product-code"></span></div>
                    <div><strong>Fornecedor:</strong> <span id="details-supplier"></span></div>
                    <div><strong>Estoque Total:</strong> <span id="details-total-quantity"></span></div>
                    <div><strong>Consumo Médio Diário:</strong> <span id="details-avg-consumption"></span></div>
                    <div><strong>Estoque Mínimo (sugestão):</strong> <span id="details-min-stock"></span></div>
                    <div><strong>Estoque Máximo (sugestão):</strong> <span id="details-max-stock"></span></div>
                </div>
            </div>

            <!-- Edit Mode -->
            <div id="item-details-edit" class="hidden">
                 <form id="edit-item-form">
                    <input type="hidden" id="edit-item-id">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="col-span-1 md:col-span-2">
                            <label for="edit-product-name" class="block text-sm font-medium text-gray-700">Nome do Produto</label>
                            <input type="text" id="edit-product-name" required class="mt-1 block w-full form-input">
                        </div>
                        <div>
                            <label for="edit-product-code" class="block text-sm font-medium text-gray-700">Código</label>
                            <input type="text" id="edit-product-code" required class="mt-1 block w-full form-input">
                        </div>
                        <div>
                            <label for="edit-supplier" class="block text-sm font-medium text-gray-700">Fornecedor</label>
                            <input type="text" id="edit-supplier" required class="mt-1 block w-full form-input">
                        </div>
                    </div>
                    <div class="mt-8 flex justify-end space-x-3">
                        <button type="button" id="btn-cancel-edit" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancelar</button>
                        <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Salvar Alterações</button>
                    </div>
                </form>
            </div>


            <h3 class="text-xl font-semibold mt-6 mb-2">Lotes Disponíveis</h3>
            <div class="overflow-x-auto border rounded-lg">
                <table class="w-full text-sm text-left">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2">Lote</th>
                            <th class="px-4 py-2">Quantidade</th>
                            <th class="px-4 py-2">Data de Validade</th>
                            <th class="px-4 py-2">Shelf Life na Entrada</th>
                        </tr>
                    </thead>
                    <tbody id="details-batches-table"></tbody>
                </table>
            </div>
            
            <h3 class="text-xl font-semibold mt-6 mb-2">Histórico de Movimentação</h3>
            <div class="overflow-x-auto border rounded-lg max-h-60" id="details-history-container">
                <!-- Histórico agrupado por data -->
            </div>
        </div>
    </div>

    <!-- Modal de Receitas -->
    <div id="recipe-modal" class="modal p-4">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
             <div class="flex justify-between items-center mb-6">
                <h2 id="recipe-modal-title" class="text-2xl font-bold">Criar Nova Receita</h2>
                <button id="close-recipe-modal" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <form id="recipe-form">
                <input type="hidden" id="edit-recipe-id">
                <div class="space-y-4">
                     <div>
                        <label for="recipe-name" class="block text-sm font-medium text-gray-700">Nome da Receita</label>
                        <input type="text" id="recipe-name" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none form-input">
                    </div>
                     <div>
                        <label for="recipe-category" class="block text-sm font-medium text-gray-700">Linha de Produção</label>
                        <select id="recipe-category" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none form-input">
                            <option>Salgado</option>
                            <option>Pães congelados</option>
                            <option>Pães especiais</option>
                            <option>Pão de queijo</option>
                            <option>Confeitaria</option>
                        </select>
                    </div>
                    
                    <h3 class="text-lg font-medium pt-4">Ingredientes</h3>
                    <div id="ingredients-container" class="space-y-3">
                        <!-- Ingredientes serão adicionados dinamicamente aqui -->
                    </div>

                    <button type="button" id="add-ingredient-btn" class="text-indigo-600 hover:text-indigo-800 font-medium text-sm">
                        <i class="fa-solid fa-plus mr-1"></i>Adicionar Ingrediente
                    </button>
                </div>
                <div class="mt-8 flex justify-end">
                    <button id="save-recipe-btn" type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg shadow-md">
                        Salvar Receita
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal de Ordem de Produção -->
    <div id="production-order-modal" class="modal p-4">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-5xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 id="production-order-modal-title" class="text-2xl font-bold">Nova Ordem de Produção</h2>
                <button id="close-production-order-modal" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <form id="production-order-form">
                <input type="hidden" id="edit-po-id">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                     <div class="md:col-span-2">
                        <label for="po-recipe-select" class="block text-sm font-medium text-gray-700">Selecione a Receita</label>
                        <select id="po-recipe-select" required class="mt-1 block w-full form-input"></select>
                    </div>
                    <div>
                        <label for="po-quantity" class="block text-sm font-medium text-gray-700">Qtd. de Receitas</label>
                        <input type="number" id="po-quantity" value="1" min="1" required class="mt-1 block w-full form-input">
                    </div>
                </div>
                 <div class="mt-4">
                    <label for="po-date" class="block text-sm font-medium text-gray-700">Data da Produção</label>
                    <input type="date" id="po-date" required class="mt-1 block w-full form-input">
                </div>
                <h3 class="text-lg font-medium pt-6 mb-2">Insumos Necessários</h3>
                <div class="overflow-x-auto border rounded-lg">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-2 py-2 text-left">Insumo</th>
                                <th class="px-2 py-2 text-left">Estoque Disp.</th>
                                <th class="px-2 py-2 text-left">Qtd. Necessária</th>
                                <th class="px-2 py-2 text-left">Qtd. a Usar</th>
                                <th class="px-2 py-2 text-left">Lote de Consumo</th>
                                <th class="px-2 py-2 text-left">Manipulador</th>
                            </tr>
                        </thead>
                        <tbody id="po-ingredients-body"></tbody>
                    </table>
                </div>
                <div class="mt-8 flex justify-end">
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg shadow-md">
                        Criar Ordem de Produção
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Confirmação de Produção -->
    <div id="confirm-production-modal" class="modal p-4">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
             <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Confirmar Produção e Baixa de Estoque</h2>
                <button id="close-confirm-production-modal" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div class="flex items-center space-x-4 mb-4">
                <label for="production-date-filter" class="text-sm font-medium">Data da Produção:</label>
                <input type="date" id="production-date-filter" class="form-input">
            </div>
            <p class="text-sm text-gray-600 mb-4">Resumo de todos os insumos para as ordens de produção pendentes na data selecionada.</p>
             <div class="overflow-x-auto border rounded-lg">
                <table class="w-full text-sm">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left">Insumo</th>
                            <th class="px-4 py-2 text-left">Lote Específico</th>
                            <th class="px-4 py-2 text-left">Qtd. Requisitada</th>
                            <th class="px-4 py-2 text-left">Qtd. Entregue (editável)</th>
                        </tr>
                    </thead>
                    <tbody id="confirm-production-tbody"></tbody>
                </table>
             </div>
             <div class="mt-8 flex justify-end">
                <button id="btn-execute-stock-consumption" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md">
                    Confirmar e Dar Baixa no Estoque
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Confirmação de Upload -->
    <div id="confirm-upload-modal" class="modal">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                    <i class="fa-solid fa-triangle-exclamation text-red-600 text-2xl"></i>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mt-4">Confirmar Restauração</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500">
                        Você tem certeza que deseja restaurar o backup? <strong>Todos os dados atuais serão apagados e substituídos</strong> por completo. Essa ação não pode ser desfeita.
                    </p>
                </div>
            </div>
            <div class="mt-6 flex justify-center space-x-4">
                <button id="cancel-upload-btn" type="button" class="py-2 px-4 bg-gray-200 text-gray-800 font-semibold rounded-lg shadow-md hover:bg-gray-300">
                    Cancelar
                </button>
                <button id="confirm-upload-btn" type="button" class="py-2 px-4 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700">
                    Sim, Substituir Tudo
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação Genérica -->
    <div id="confirm-action-modal" class="modal">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                    <i class="fa-solid fa-triangle-exclamation text-red-600 text-2xl"></i>
                </div>
                <h3 id="confirm-title" class="text-lg leading-6 font-medium text-gray-900 mt-4">Confirmar Ação</h3>
                <div class="mt-2 px-7 py-3">
                    <p id="confirm-message" class="text-sm text-gray-500">
                        Você tem certeza? Essa ação não pode ser desfeita.
                    </p>
                </div>
            </div>
            <div class="mt-6 flex justify-center space-x-4">
                <button id="cancel-action-btn" type="button" class="py-2 px-4 bg-gray-200 text-gray-800 font-semibold rounded-lg shadow-md hover:bg-gray-300">
                    Cancelar
                </button>
                <button id="confirm-action-btn" type="button" class="py-2 px-4 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700">
                    Confirmar
                </button>
            </div>
        </div>
    </div>


    <!-- Modal de Notificação -->
    <div id="notification-modal" class="fixed top-5 right-5 z-[100] hidden text-white py-2 px-5 rounded-lg shadow-lg">
        <p id="notification-message"></p>
    </div>

<script type="module">
    // --- MÓDULO DO BANCO DE DADOS OFFLINE (IndexedDB) ---
    const DB = (() => {
        let dbInstance;

        function init() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('estoqueDB', 2);

                request.onerror = (event) => reject("Erro ao abrir o banco de dados.");

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('inventory')) {
                        const inventoryStore = db.createObjectStore('inventory', { keyPath: 'id', autoIncrement: true });
                        inventoryStore.createIndex('code', 'code', { unique: false });
                    }
                    if (!db.objectStoreNames.contains('batches')) {
                        const batchesStore = db.createObjectStore('batches', { keyPath: 'id', autoIncrement: true });
                        batchesStore.createIndex('productId', 'productId', { unique: false });
                    }
                    if (!db.objectStoreNames.contains('history')) {
                        db.createObjectStore('history', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains('recipes')) {
                        db.createObjectStore('recipes', { keyPath: 'id', autoIncrement: true });
                    }
                     if (!db.objectStoreNames.contains('productionOrders')) {
                        db.createObjectStore('productionOrders', { keyPath: 'id', autoIncrement: true });
                    }
                };

                request.onsuccess = (event) => {
                    dbInstance = event.target.result;
                    resolve(dbInstance);
                };
            });
        }

        async function getDB() {
            if (!dbInstance) await init();
            return dbInstance;
        }

        async function add(storeName, data) {
            const db = await getDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.add(data);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function get(storeName, key) {
             const db = await getDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.get(key);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }
        
        async function getByIndex(storeName, indexName, value) {
            const db = await getDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readonly');
                const store = transaction.objectStore(storeName);
                const index = store.index(indexName);
                const request = index.get(value);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function getAll(storeName) {
            const db = await getDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function update(storeName, data) {
            const db = await getDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.put(data);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }
        
        async function remove(storeName, key) {
             const db = await getDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.delete(key);
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }
        
        async function clear(storeName) {
            const db = await getDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.clear();
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        return { add, get, getAll, update, getByIndex, getDB, clear, remove };
    })();

    // --- STATE MANAGEMENT ---
    let localInventory = [], localBatches = [], localHistory = [], localRecipes = [], localProductionOrders = [];
    let currentSort = { key: 'name', order: 'asc' };
    let tempEntryData = null;
    let backupFileContent = null; 
    let stockChart = null;

    // --- DOM ELEMENTS ---
    const loadingOverlay = document.getElementById('loading-overlay');
    const screens = { dashboard: document.getElementById('screen-dashboard'), entry: document.getElementById('screen-entry'), inventory: document.getElementById('screen-inventory'), recipes: document.getElementById('screen-recipes'), production: document.getElementById('screen-production'), settings: document.getElementById('screen-settings') };
    const navLinks = { dashboard: document.getElementById('nav-dashboard'), entry: document.getElementById('nav-entry'), inventory: document.getElementById('nav-inventory'), recipes: document.getElementById('nav-recipes'), production: document.getElementById('nav-production'), settings: document.getElementById('nav-settings') };
    const entryForm = document.getElementById('entry-form');
    const shelfLifeModal = document.getElementById('shelf-life-modal');
    const shelfLifeValue = document.getElementById('shelf-life-value');
    const authorizerNameInput = document.getElementById('authorizer-name');
    const cancelReceiptBtn = document.getElementById('cancel-receipt-btn');
    const confirmReceiptBtn = document.getElementById('confirm-receipt-btn');
    const inventoryTableBody = document.getElementById('inventory-table-body');
    const searchInput = document.getElementById('search-inventory');
    const btnExportExcel = document.getElementById('btn-export-excel');
    const detailsModal = document.getElementById('item-details-modal');
    const closeDetailsModalBtn = document.getElementById('close-details-modal');
    const btnNewRecipe = document.getElementById('btn-new-recipe');
    const recipeModal = document.getElementById('recipe-modal');
    const recipeModalTitle = document.getElementById('recipe-modal-title');
    const saveRecipeBtn = document.getElementById('save-recipe-btn');
    const closeRecipeModalBtn = document.getElementById('close-recipe-modal');
    const recipeForm = document.getElementById('recipe-form');
    const addIngredientBtn = document.getElementById('add-ingredient-btn');
    const ingredientsContainer = document.getElementById('ingredients-container');
    const notificationModal = document.getElementById('notification-modal');
    const notificationMessage = document.getElementById('notification-message');
    const itemDetailsView = document.getElementById('item-details-view');
    const itemDetailsEdit = document.getElementById('item-details-edit');
    const btnEditItem = document.getElementById('btn-edit-item');
    const btnCancelEdit = document.getElementById('btn-cancel-edit');
    const editItemForm = document.getElementById('edit-item-form');
    const detailsHistoryContainer = document.getElementById('details-history-container');
    const recipesList = document.getElementById('recipes-list');
    const productionOrdersList = document.getElementById('production-orders-list');
    const btnNewProductionOrder = document.getElementById('btn-new-production-order');
    const productionOrderModal = document.getElementById('production-order-modal');
    const productionOrderModalTitle = document.getElementById('production-order-modal-title');
    const closeProductionOrderModalBtn = document.getElementById('close-production-order-modal');
    const productionOrderForm = document.getElementById('production-order-form');
    const poRecipeSelect = document.getElementById('po-recipe-select');
    const poIngredientsBody = document.getElementById('po-ingredients-body');
    const poQuantity = document.getElementById('po-quantity');
    const poDate = document.getElementById('po-date');
    const searchPoByDate = document.getElementById('search-po-by-date');
    const btnExportPdf = document.getElementById('btn-export-pdf');
    const btnConfirmProduction = document.getElementById('btn-confirm-production');
    const confirmProductionModal = document.getElementById('confirm-production-modal');
    const closeConfirmProductionModalBtn = document.getElementById('close-confirm-production-modal');
    const productionDateFilter = document.getElementById('production-date-filter');
    const confirmProductionTbody = document.getElementById('confirm-production-tbody');
    const btnExecuteStockConsumption = document.getElementById('btn-execute-stock-consumption');
    const btnDownloadBackup = document.getElementById('btn-download-backup');
    const btnUploadBackup = document.getElementById('btn-upload-backup');
    const backupFileInput = document.getElementById('backup-file-input');
    const confirmUploadModal = document.getElementById('confirm-upload-modal');
    const cancelUploadBtn = document.getElementById('cancel-upload-btn');
    const confirmUploadBtn = document.getElementById('confirm-upload-btn');
    const confirmActionModal = document.getElementById('confirm-action-modal');
    
    // --- FUNÇÕES AUXILIARES ---
    function showNotification(message, isError = false) {
        notificationMessage.textContent = message;
        notificationModal.classList.toggle('bg-green-500', !isError);
        notificationModal.classList.toggle('bg-red-500', isError);
        notificationModal.style.display = 'block';
        setTimeout(() => {
             notificationModal.style.display = 'none';
        }, 4000);
    }

    function showModal(modalElement) {
        modalElement.style.display = 'flex';
    }

    function hideModal(modalElement) {
        modalElement.style.display = 'none';
    }
    
    function showConfirmationModal(title, message, onConfirm) {
        document.getElementById('confirm-title').textContent = title;
        document.getElementById('confirm-message').innerHTML = message;
        showModal(confirmActionModal);

        const cancelBtn = document.getElementById('cancel-action-btn');
        const confirmBtn = document.getElementById('confirm-action-btn');

        const cleanup = () => {
            hideModal(confirmActionModal);
            confirmBtn.replaceWith(confirmBtn.cloneNode(true));
            cancelBtn.replaceWith(cancelBtn.cloneNode(true));
        };

        cancelBtn.addEventListener('click', cleanup, { once: true });
        confirmBtn.addEventListener('click', () => {
            onConfirm();
            cleanup();
        }, { once: true });
    }

    // --- NAVIGATION ---
    function navigateTo(screenName) {
        Object.values(screens).forEach(screen => screen.classList.add('hidden'));
        screens[screenName].classList.remove('hidden');
        Object.values(navLinks).forEach(link => link.classList.remove('active-nav'));
        navLinks[screenName].classList.add('active-nav');
    }
    Object.keys(navLinks).forEach(key => { navLinks[key].addEventListener('click', (e) => { e.preventDefault(); navigateTo(key); }); });

    // --- ENTRY SCREEN LOGIC ---
    function calculateShelfLife(mfg, receipt, expiry) {
        const mfgDate = new Date(mfg + 'T00:00:00');
        const receiptDate = new Date(receipt + 'T00:00:00');
        const expiryDate = new Date(expiry + 'T00:00:00');
        const totalLife = expiryDate.getTime() - mfgDate.getTime();
        const remainingLife = expiryDate.getTime() - receiptDate.getTime();
        if (totalLife <= 0) return 0;
        return ((remainingLife / totalLife) * 100).toFixed(1);
    }
    entryForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const formData = new FormData(entryForm);
        const data = {
            name: formData.get('product-name'), code: formData.get('product-code') || 'N/A', supplier: formData.get('supplier'),
            quantity: parseFloat(formData.get('quantity')), batchCode: formData.get('batch-code') || 'N/A',
            mfgDate: document.getElementById('mfg-date').value, receiptDate: document.getElementById('receipt-date').value,
            expiryDate: document.getElementById('expiry-date').value
        };
        let shelfLife = 100;
        if (data.mfgDate && data.receiptDate && data.expiryDate) { shelfLife = calculateShelfLife(data.mfgDate, data.receiptDate, data.expiryDate); }
        data.shelfLife = shelfLife;
        tempEntryData = data;
        if (shelfLife < 75) {
            shelfLifeValue.textContent = shelfLife;
            showModal(shelfLifeModal);
        } else { saveEntry(); }
    });

    async function saveEntry(authorizedBy = null) {
        const data = tempEntryData;
        if (!data) return;
        try {
            let product = await DB.getByIndex('inventory', 'code', data.code);
            let productId;
            if (!product) {
                productId = await DB.add('inventory', { code: data.code, name: data.name, supplier: data.supplier, totalQuantity: data.quantity });
            } else {
                productId = product.id;
                product.totalQuantity += data.quantity;
                await DB.update('inventory', product);
            }
            await DB.add('batches', { productId, code: data.batchCode, quantity: data.quantity, mfgDate: data.mfgDate, receiptDate: data.receiptDate, expiryDate: data.expiryDate, shelfLife: data.shelfLife, authorizedBy });
            await DB.add('history', { productId, batchCode: data.batchCode, type: 'entrada', quantity: data.quantity, date: data.receiptDate });
            showNotification('Entrada registrada com sucesso!');
            entryForm.reset();
            closeShelfLifeModal();
            await refreshLocalData();
        } catch (error) {
            console.error("Erro ao salvar entrada: ", error);
            showNotification("Erro ao salvar entrada.", true);
        }
    }
    function closeShelfLifeModal() {
        hideModal(shelfLifeModal);
        authorizerNameInput.value = '';
        tempEntryData = null;
    }
    cancelReceiptBtn.addEventListener('click', closeShelfLifeModal);
    confirmReceiptBtn.addEventListener('click', () => {
        const authorizer = authorizerNameInput.value;
        if (!authorizer.trim()) {
            showNotification('Por favor, insira o nome do responsável.', true);
            return;
        }
        saveEntry(authorizer);
    });

    // --- INVENTORY SCREEN LOGIC ---
    function renderInventoryTable() {
        let filteredInventory = [...localInventory];
        const searchTerm = searchInput.value.toLowerCase();
        if (searchTerm) {
            filteredInventory = filteredInventory.filter(item => 
                item.name.toLowerCase().includes(searchTerm) ||
                item.code.toLowerCase().includes(searchTerm) ||
                item.supplier.toLowerCase().includes(searchTerm)
            );
        }
        filteredInventory.sort((a, b) => {
            let valA, valB;
            if (currentSort.key === 'expiry') {
                valA = getNextExpiry(a.id) || '9999-12-31';
                valB = getNextExpiry(b.id) || '9999-12-31';
            } else {
                valA = a[currentSort.key] || '';
                valB = b[currentSort.key] || '';
            }
            if (valA < valB) return currentSort.order === 'asc' ? -1 : 1;
            if (valA > valB) return currentSort.order === 'asc' ? 1 : -1;
            return 0;
        });
        inventoryTableBody.innerHTML = '';
        if (filteredInventory.length === 0) {
            inventoryTableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4">Nenhum item em estoque.</td></tr>`;
            return;
        }
        filteredInventory.forEach(item => {
            const nextExpiry = getNextExpiry(item.id);
            const row = document.createElement('tr');
            row.className = 'bg-white border-b hover:bg-gray-50 cursor-pointer';
            row.addEventListener('click', () => showItemDetails(item.id));
            row.innerHTML = `
                <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${item.name}</td>
                <td class="px-6 py-4">${item.code}</td>
                <td class="px-6 py-4">${item.supplier}</td>
                <td class="px-6 py-4 text-right">${item.totalQuantity.toFixed(2)}</td>
                <td class="px-6 py-4">${nextExpiry ? new Date(nextExpiry + 'T00:00:00').toLocaleDateString('pt-BR') : 'N/A'}</td>
            `;
            inventoryTableBody.appendChild(row);
        });
    }
    function getNextExpiry(productId) {
         const productBatches = localBatches.filter(b => b.productId === productId && b.quantity > 0);
        if (productBatches.length === 0) return null;
        return productBatches.sort((a, b) => new Date(a.expiryDate) - new Date(b.expiryDate))[0].expiryDate;
    }
    document.querySelectorAll('.table-header-sortable').forEach(header => { header.addEventListener('click', () => { /* ... */ }); });
    searchInput.addEventListener('input', renderInventoryTable);
    
    // --- ITEM DETAILS & EDIT MODAL ---
    function calculateConsumptionMetrics(productId) {
        const productHistory = localHistory
            .filter(h => h.productId === productId && h.type === 'saída')
            .sort((a, b) => new Date(a.date) - new Date(b.date));

        if (productHistory.length < 2) {
            return { avgConsumption: 0, minStock: 0, maxStock: 0 };
        }

        const firstConsumptionDate = new Date(productHistory[0].date);
        const lastConsumptionDate = new Date(productHistory[productHistory.length - 1].date);
        
        let daysDifference = (lastConsumptionDate.getTime() - firstConsumptionDate.getTime()) / (1000 * 3600 * 24);
        if (daysDifference < 1) {
            daysDifference = 1; // Avoid division by zero and consider consumption within a single day
        }

        const totalConsumed = productHistory.reduce((sum, h) => sum + h.quantity, 0);
        const avgConsumption = totalConsumed / daysDifference;

        const leadTime = 7; // Tempo de reposição em dias (exemplo)
        const replenishmentPeriod = 30; // Período de compra em dias (exemplo)

        const minStock = avgConsumption * leadTime;
        const maxStock = minStock + (avgConsumption * replenishmentPeriod);
        
        return { avgConsumption, minStock, maxStock };
    }

    function showItemDetails(productId) {
        const product = localInventory.find(p => p.id === productId);
        if (!product) return;
        
        document.getElementById('details-product-name').textContent = product.name;
        document.getElementById('details-product-code').textContent = product.code;
        document.getElementById('details-supplier').textContent = product.supplier;
        document.getElementById('details-total-quantity').textContent = product.totalQuantity.toFixed(2);
        
        const metrics = calculateConsumptionMetrics(productId);
        document.getElementById('details-avg-consumption').textContent = metrics.avgConsumption.toFixed(2);
        document.getElementById('details-min-stock').textContent = metrics.minStock.toFixed(2);
        document.getElementById('details-max-stock').textContent = metrics.maxStock.toFixed(2);
        
        document.getElementById('edit-item-id').value = product.id;
        document.getElementById('edit-product-name').value = product.name;
        document.getElementById('edit-product-code').value = product.code;
        document.getElementById('edit-supplier').value = product.supplier;

        const batches = localBatches.filter(b => b.productId === productId && b.quantity > 0);
        const history = localHistory.filter(h => h.productId === productId).sort((a, b) => new Date(b.date) - new Date(a.date));

        document.getElementById('details-batches-table').innerHTML = batches.map(batch => `
            <tr class="border-b"><td class="px-4 py-2">${batch.code}</td><td class="px-4 py-2">${batch.quantity.toFixed(2)}</td><td class="px-4 py-2">${new Date(batch.expiryDate + 'T00:00:00').toLocaleDateString('pt-BR')}</td><td class="px-4 py-2">${batch.shelfLife}% ${batch.authorizedBy ? `(Aut: ${batch.authorizedBy})` : ''}</td></tr>`).join('');
        
        const groupedHistory = history.reduce((acc, entry) => {
            (acc[entry.date] = acc[entry.date] || []).push(entry);
            return acc;
        }, {});

        detailsHistoryContainer.innerHTML = Object.keys(groupedHistory).sort((a,b) => new Date(b) - new Date(a)).map(date => `
            <div class="pt-2">
                <h4 class="bg-gray-100 p-2 font-semibold text-sm sticky top-0">${new Date(date + 'T00:00:00').toLocaleDateString('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</h4>
                <table class="w-full text-sm text-left">
                    <tbody>
                        ${groupedHistory[date].map(entry => `
                        <tr class="border-b">
                            <td class="px-4 py-2 w-1/4 ${entry.type === 'entrada' ? 'text-green-600' : 'text-red-600'}">${entry.type}</td>
                            <td class="px-4 py-2 w-1/4">${entry.quantity.toFixed(2)}</td>
                            <td class="px-4 py-2 w-1/2">${entry.batchCode}</td>
                        </tr>`).join('')}
                    </tbody>
                </table>
            </div>
        `).join('');

        itemDetailsView.classList.remove('hidden');
        itemDetailsEdit.classList.add('hidden');
        showModal(detailsModal);
    }
    closeDetailsModalBtn.addEventListener('click', () => { hideModal(detailsModal) });
    btnEditItem.addEventListener('click', () => { itemDetailsView.classList.add('hidden'); itemDetailsEdit.classList.remove('hidden'); });
    btnCancelEdit.addEventListener('click', () => { itemDetailsView.classList.remove('hidden'); itemDetailsEdit.classList.add('hidden'); });

    editItemForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const updatedData = {
            id: parseInt(document.getElementById('edit-item-id').value),
            name: document.getElementById('edit-product-name').value,
            code: document.getElementById('edit-product-code').value,
            supplier: document.getElementById('edit-supplier').value,
        };
        try {
            const item = await DB.get('inventory', updatedData.id);
            const fullItem = { ...item, ...updatedData };
            await DB.update('inventory', fullItem);
            showNotification("Item atualizado com sucesso!");
            itemDetailsView.classList.remove('hidden');
            itemDetailsEdit.classList.add('hidden');
            document.getElementById('details-product-name').textContent = updatedData.name;
            await refreshLocalData();
        } catch (error) {
            console.error("Erro ao atualizar o item:", error);
            showNotification("Erro ao atualizar o item.", true);
        }
    });

    // --- RECIPES SCREEN LOGIC ---
    function renderRecipes() {
        recipesList.innerHTML = '';
        if (localRecipes.length === 0) {
            recipesList.innerHTML = `<p class="text-gray-500 col-span-full">Nenhuma receita criada ainda.</p>`
            return;
        }
        const categories = [...new Set(localRecipes.map(r => r.category))].sort();
        categories.forEach(category => {
            const categoryDiv = document.createElement('div');
            categoryDiv.innerHTML = `<h2 class="text-xl font-semibold mb-3 text-gray-700">${category}</h2>`;
            const recipeCards = document.createElement('div');
            recipeCards.className = 'space-y-4';
            localRecipes.filter(r => r.category === category).forEach(recipe => {
                const card = document.createElement('div');
                card.className = 'relative bg-white p-4 rounded-lg shadow transition hover:shadow-md';
                let ingredientsHtml = recipe.ingredients.map(ing => {
                    const product = localInventory.find(p => p.id === ing.productId);
                    return `<li class="text-sm text-gray-600">${product ? product.name : 'Ingrediente desconhecido'}: ${ing.quantity}</li>`;
                }).join('');
                card.innerHTML = `
                    <div class="absolute top-2 right-2 flex space-x-2">
                        <button class="edit-recipe-btn text-blue-500 hover:text-blue-700" data-recipe-id="${recipe.id}" title="Editar"><i class="fa-solid fa-pencil"></i></button>
                        <button class="delete-recipe-btn text-red-500 hover:text-red-700" data-recipe-id="${recipe.id}" title="Excluir"><i class="fa-solid fa-trash"></i></button>
                    </div>
                    <h3 class="font-bold">${recipe.name}</h3>
                    <ul class="list-disc list-inside mt-2">${ingredientsHtml}</ul>
                `;
                recipeCards.appendChild(card);
            });
            categoryDiv.appendChild(recipeCards);
            recipesList.appendChild(categoryDiv);
        });
    }

    recipesList.addEventListener('click', (e) => {
        const editBtn = e.target.closest('.edit-recipe-btn');
        if (editBtn) {
            handleEditRecipe(parseInt(editBtn.dataset.recipeId));
        }
        const deleteBtn = e.target.closest('.delete-recipe-btn');
        if (deleteBtn) {
            handleDeleteRecipe(parseInt(deleteBtn.dataset.recipeId));
        }
    });
    
    function handleEditRecipe(recipeId) {
        const recipe = localRecipes.find(r => r.id === recipeId);
        if (!recipe) return;
        
        document.getElementById('edit-recipe-id').value = recipe.id;
        document.getElementById('recipe-name').value = recipe.name;
        document.getElementById('recipe-category').value = recipe.category;

        ingredientsContainer.innerHTML = '';
        recipe.ingredients.forEach(ing => {
            addIngredientRow(ing.productId, ing.quantity);
        });

        recipeModalTitle.textContent = "Editar Receita";
        saveRecipeBtn.textContent = "Salvar Alterações";
        showModal(recipeModal);
    }
    
    function handleDeleteRecipe(recipeId) {
         const recipe = localRecipes.find(r => r.id === recipeId);
         if(!recipe) return;

         showConfirmationModal(
            "Excluir Receita",
            `Tem certeza que deseja excluir a receita "<strong>${recipe.name}</strong>"?`,
            async () => {
                try {
                    await DB.remove('recipes', recipeId);
                    showNotification("Receita excluída com sucesso.");
                    await refreshLocalData();
                } catch(err) {
                    showNotification("Erro ao excluir a receita.", true);
                }
            }
        );
    }

    btnNewRecipe.addEventListener('click', () => {
        if(localInventory.length === 0) { showNotification("Adicione itens ao estoque antes de criar uma receita.", true); return; }
        recipeForm.reset();
        document.getElementById('edit-recipe-id').value = '';
        ingredientsContainer.innerHTML = '';
        addIngredientRow();
        recipeModalTitle.textContent = "Criar Nova Receita";
        saveRecipeBtn.textContent = "Salvar Receita";
        showModal(recipeModal);
    });

    closeRecipeModalBtn.addEventListener('click', () => hideModal(recipeModal));
    
    function addIngredientRow(selectedProductId = null, quantity = null) {
        const row = document.createElement('div');
        row.className = 'flex items-center space-x-2';
        let options = localInventory.map(p => `<option value="${p.id}" ${selectedProductId === p.id ? 'selected' : ''}>${p.name} (${p.code})</option>`).join('');
        row.innerHTML = `<select class="block w-2/3 form-input" required>${options}</select><input type="number" placeholder="Qtd" value="${quantity || ''}" min="0.01" step="0.01" class="block w-1/3 form-input" required><button type="button" class="text-red-500 hover:text-red-700 remove-ingredient-btn font-bold text-xl">&times;</button>`;
        ingredientsContainer.appendChild(row);
    }
    addIngredientBtn.addEventListener('click', () => addIngredientRow());
    ingredientsContainer.addEventListener('click', (e) => { if (e.target.classList.contains('remove-ingredient-btn')) e.target.parentElement.remove(); });
    
    recipeForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const recipeId = document.getElementById('edit-recipe-id').value;
        const recipeData = {
            name: document.getElementById('recipe-name').value, 
            category: document.getElementById('recipe-category').value,
            ingredients: Array.from(ingredientsContainer.querySelectorAll('.flex')).map(row => ({
                productId: parseInt(row.querySelector('select').value),
                quantity: parseFloat(row.querySelector('input').value)
            }))
        };
        try {
            if (recipeId) {
                recipeData.id = parseInt(recipeId);
                await DB.update('recipes', recipeData);
                showNotification("Receita atualizada com sucesso!");
            } else {
                await DB.add('recipes', recipeData);
                showNotification("Receita salva com sucesso!");
            }
            hideModal(recipeModal);
            await refreshLocalData();
        } catch(error) { console.error("Erro ao salvar receita: ", error); showNotification("Erro ao salvar receita.", true); }
    });

    // --- PRODUCTION ORDERS LOGIC ---
    function renderProductionOrders() {
        productionOrdersList.innerHTML = '';
        const filterDate = searchPoByDate.value;
        
        let filteredOrders = localProductionOrders;
        if (filterDate) {
            filteredOrders = localProductionOrders.filter(po => po.date === filterDate);
        }

        if (filteredOrders.length === 0) {
            productionOrdersList.innerHTML = `<div class="bg-white p-6 rounded-lg shadow text-center text-gray-500 col-span-full">Nenhuma ordem de produção encontrada para a data selecionada.</div>`;
            return;
        }

        [...filteredOrders].sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(po => {
             try {
                const card = document.createElement('div');
                card.className = 'relative bg-white rounded-xl shadow-md overflow-hidden transform hover:scale-[1.02] transition-transform duration-300';
                
                const statusClass = po.status === 'pendente' ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800';
                const statusBorderClass = po.status === 'pendente' ? 'border-yellow-400' : 'border-green-400';

                const ingredientsHtml = po.ingredients.map(ing => {
                    const product = localInventory.find(p => p.id === ing.productId);
                    return `
                    <li class="flex justify-between items-center text-sm py-1">
                        <span class="text-gray-600"><i class="fa-solid fa-box-open mr-2 text-gray-400"></i>${product ? product.name : '...'}</span>
                        <span class="font-medium text-gray-800">${ing.adjustedQuantity.toFixed(2)}</span>
                    </li>`;
                }).join('');

                card.innerHTML = `
                    <div class="p-4 border-l-4 ${statusBorderClass}">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="text-lg font-bold text-gray-800 pr-16">${po.recipeName} (${po.quantityProduced}x)</h3>
                                <p class="text-sm text-gray-500 mt-1">
                                    <i class="fa-solid fa-calendar-alt mr-1"></i>
                                    ${new Date(po.date + 'T00:00:00').toLocaleDateString('pt-BR')}
                                </p>
                            </div>
                            <div class="absolute top-3 right-3 text-right">
                                 <span class="block text-xs font-semibold px-3 py-1 rounded-full ${statusClass}">${po.status}</span>
                                 <div class="mt-2 flex space-x-2 justify-end">
                                    <button class="edit-po-btn text-blue-500 hover:text-blue-700 p-1" data-po-id="${po.id}" title="Editar Ordem"><i class="fa-solid fa-pencil"></i></button>
                                    <button class="delete-po-btn text-red-500 hover:text-red-700 p-1" data-po-id="${po.id}" title="Excluir Ordem"><i class="fa-solid fa-trash"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="p-4 bg-gray-50 border-t border-gray-200">
                        <p class="text-xs font-semibold text-gray-500 mb-2 uppercase tracking-wider">Insumos</p>
                        <ul class="space-y-1">${ingredientsHtml}</ul>
                    </div>
                `;
                productionOrdersList.appendChild(card);
            } catch (e) {
                console.error('Erro ao renderizar ordem de produção:', po, e);
            }
        });
    }

    productionOrdersList.addEventListener('click', (e) => {
        const editBtn = e.target.closest('.edit-po-btn');
        if (editBtn) {
            handleEditProductionOrder(parseInt(editBtn.dataset.poId));
        }
        const deleteBtn = e.target.closest('.delete-po-btn');
        if (deleteBtn) {
            handleDeleteProductionOrder(parseInt(deleteBtn.dataset.poId));
        }
    });

    function handleEditProductionOrder(poId) {
        const po = localProductionOrders.find(p => p.id === poId);
        if (!po) return;

        document.getElementById('edit-po-id').value = po.id;
        poRecipeSelect.value = po.recipeId;
        poQuantity.value = po.quantityProduced;
        poDate.value = po.date;
        
        updatePOIngredients();

        setTimeout(() => {
            const rows = poIngredientsBody.querySelectorAll('tr');
            if (rows.length === po.ingredients.length) {
                rows.forEach((row, index) => {
                    const ingredientData = po.ingredients[index];
                    if (ingredientData) {
                        row.querySelector('input[type="number"]').value = ingredientData.adjustedQuantity;
                        row.querySelector('select').value = ingredientData.batchId;
                        row.querySelector('input[type="text"]').value = ingredientData.handler;
                    }
                });
            }
        }, 100);

        productionOrderModalTitle.textContent = "Editar Ordem de Produção";
        productionOrderForm.querySelector('button[type="submit"]').textContent = "Salvar Alterações";
        
        showModal(productionOrderModal);
    }

    function handleDeleteProductionOrder(poId) {
        const po = localProductionOrders.find(p => p.id === poId);
        if (!po) return;

        showConfirmationModal(
            "Excluir Ordem de Produção",
            `Tem certeza que deseja excluir a ordem para "<strong>${po.recipeName}</strong>" do dia ${new Date(po.date + 'T00:00:00').toLocaleDateString('pt-BR')}?`,
            async () => {
                try {
                    await DB.remove('productionOrders', poId);
                    showNotification("Ordem de produção excluída com sucesso.");
                    await refreshLocalData();
                } catch (err) {
                    showNotification("Erro ao excluir a ordem de produção.", true);
                }
            }
        );
    }

    btnNewProductionOrder.addEventListener('click', () => {
        if (localRecipes.length === 0) {
            showNotification("Crie uma receita antes de gerar uma ordem.", true);
            return;
        }
        if(localInventory.length === 0) {
            showNotification("Adicione itens ao estoque antes de gerar uma ordem.", true);
            return;
        }
        productionOrderForm.reset();
        document.getElementById('edit-po-id').value = '';
        poRecipeSelect.innerHTML = localRecipes.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
        poQuantity.value = 1;
        poDate.value = new Date().toISOString().split('T')[0];
        updatePOIngredients();
        productionOrderModalTitle.textContent = "Nova Ordem de Produção";
        productionOrderForm.querySelector('button[type="submit"]').textContent = "Criar Ordem de Produção";
        showModal(productionOrderModal);
    });

    function updatePOIngredients() {
         const recipe = localRecipes.find(r => r.id === parseInt(poRecipeSelect.value));
        const recipeQuantity = parseInt(poQuantity.value, 10) || 1;
        if (!recipe) { poIngredientsBody.innerHTML = ''; return; }

        poIngredientsBody.innerHTML = recipe.ingredients.map(ing => {
            const product = localInventory.find(p => p.id === ing.productId);
            if(!product) return '';

            const neededQty = ing.quantity * recipeQuantity;
            const availableQty = product.totalQuantity;
            const isInsufficient = neededQty > availableQty;

            const availableBatches = localBatches
                .filter(b => b.productId === ing.productId && b.quantity > 0)
                .sort((a,b) => new Date(a.expiryDate) - new Date(b.expiryDate));
            
            const batchOptions = availableBatches.map(b => 
                `<option value="${b.id}" data-code="${b.code}">
                    ${b.code} (Qtd: ${b.quantity.toFixed(2)}, Val: ${new Date(b.expiryDate+'T00:00:00').toLocaleDateString('pt-BR')})
                </option>`
            ).join('');
            
            return `
            <tr data-product-id="${product.id}" data-original-qty="${ing.quantity}" class="${isInsufficient ? 'insufficient-stock-row' : ''}">
                <td class="px-2 py-2">${product.name}</td>
                <td class="px-2 py-2">${availableQty.toFixed(2)}</td>
                <td class="px-2 py-2 font-medium">${neededQty.toFixed(2)} ${isInsufficient ? `<span class="text-red-600 text-xs">(-${(neededQty - availableQty).toFixed(2)})</span>` : ''}</td>
                <td class="px-2 py-2"><input type="number" value="${neededQty.toFixed(2)}" min="0" step="0.01" class="w-24 form-input"></td>
                <td class="px-2 py-2"><select class="w-48 form-input text-xs">${batchOptions}</select></td>
                <td class="px-2 py-2"><input type="text" placeholder="Nome" class="w-32 form-input"></td>
            </tr>`;
        }).join('');
    }
    poRecipeSelect.addEventListener('change', updatePOIngredients);
    poQuantity.addEventListener('input', updatePOIngredients);
    
    closeProductionOrderModalBtn.addEventListener('click', () => { hideModal(productionOrderModal) });

    productionOrderForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const poId = document.getElementById('edit-po-id').value;
        if (poIngredientsBody.querySelectorAll('.insufficient-stock-row').length > 0) { showNotification("Estoque insuficiente.", true); return; }
        const recipe = localRecipes.find(r => r.id === parseInt(poRecipeSelect.value));
        const ingredients = Array.from(poIngredientsBody.querySelectorAll('tr')).map(row => {
            const batchSelect = row.querySelector('select');
            const selectedOption = batchSelect.options[batchSelect.selectedIndex];
            return {
                productId: parseInt(row.dataset.productId), adjustedQuantity: parseFloat(row.querySelector('input[type="number"]').value),
                handler: row.querySelector('input[type="text"]').value || 'N/A',
                batchId: selectedOption ? parseInt(selectedOption.value) : null,
                batchCode: selectedOption ? selectedOption.dataset.code : 'N/A',
            }
        });
        if (ingredients.some(ing => !ing.batchId)) { showNotification("Lotes não disponíveis.", true); return; }
        const poData = {
            recipeId: recipe.id, recipeName: recipe.name, date: poDate.value,
            quantityProduced: parseInt(poQuantity.value, 10), status: 'pendente', ingredients
        };
        try {
            if (poId) {
                poData.id = parseInt(poId);
                const originalPo = localProductionOrders.find(p => p.id === poData.id);
                poData.status = originalPo.status; // Keep original status when editing
                await DB.update('productionOrders', poData);
                showNotification("Ordem de Produção atualizada!");
            } else {
                await DB.add('productionOrders', poData);
                showNotification("Ordem de Produção criada com sucesso!");
            }
            hideModal(productionOrderModal);
            await refreshLocalData();
        } catch(error) { console.error("Erro ao salvar Ordem de Produção:", error); showNotification("Erro ao salvar Ordem.", true); }
    });
    searchPoByDate.addEventListener('input', renderProductionOrders);
    btnConfirmProduction.addEventListener('click', () => {
         productionDateFilter.value = new Date().toISOString().split('T')[0];
        productionDateFilter.dispatchEvent(new Event('change'));
        showModal(confirmProductionModal);
    });

    closeConfirmProductionModalBtn.addEventListener('click', () => { hideModal(confirmProductionModal) });

    productionDateFilter.addEventListener('change', () => {
        const selectedDate = productionDateFilter.value;
        const pendingOrders = localProductionOrders.filter(po => po.date === selectedDate && po.status === 'pendente');
        
        const aggregatedItems = {};
        pendingOrders.forEach(po => {
            po.ingredients.forEach(ing => {
                const key = `${ing.productId}-${ing.batchId}`;
                if (aggregatedItems[key]) {
                    aggregatedItems[key].quantity += ing.adjustedQuantity;
                } else {
                    const product = localInventory.find(p => p.id === ing.productId);
                    aggregatedItems[key] = { 
                        productId: ing.productId, batchId: ing.batchId,
                        name: product.name, batchCode: ing.batchCode,
                        quantity: ing.adjustedQuantity 
                    };
                }
            });
        });
        
        confirmProductionTbody.innerHTML = Object.values(aggregatedItems).map(item => {
            return `<tr data-product-id="${item.productId}" data-batch-id="${item.batchId}">
                <td class="px-4 py-2">${item.name}</td>
                <td class="px-4 py-2">${item.batchCode}</td>
                <td class="px-4 py-2">${item.quantity.toFixed(2)}</td>
                <td class="px-4 py-2"><input type="number" value="${item.quantity.toFixed(2)}" class="w-32 form-input"></td>
            </tr>`;
        }).join('');
        confirmProductionTbody.dataset.orders = JSON.stringify(pendingOrders.map(po => po.id));
    });

    // --- CONFIRM PRODUCTION & STOCK CONSUMPTION ---
    btnExecuteStockConsumption.addEventListener('click', async () => {
        const orderIdsToUpdate = JSON.parse(confirmProductionTbody.dataset.orders || '[]');
        if (orderIdsToUpdate.length === 0) { showNotification("Nenhuma ordem para confirmar.", true); return; }
        try {
            loadingOverlay.classList.remove('hidden');
            const consumptionItems = Array.from(confirmProductionTbody.querySelectorAll('tr')).map(row => ({
                productId: parseInt(row.dataset.productId), batchId: parseInt(row.dataset.batchId),
                deliveredQty: parseFloat(row.querySelector('input').value)
            }));
            const totalConsumptionByProduct = {};

            for (const item of consumptionItems) {
                let remainingToConsume = item.deliveredQty;
                if (remainingToConsume <= 0) continue;
                totalConsumptionByProduct[item.productId] = (totalConsumptionByProduct[item.productId] || 0) + remainingToConsume;

                const specifiedBatch = await DB.get('batches', item.batchId);
                if (!specifiedBatch || specifiedBatch.quantity <= 0) throw new Error(`Lote ${specifiedBatch?.code || 'N/A'} não encontrado.`);
                const consumeFromSpecified = Math.min(remainingToConsume, specifiedBatch.quantity);
                specifiedBatch.quantity -= consumeFromSpecified;
                await DB.update('batches', specifiedBatch);
                await DB.add('history', { productId: item.productId, batchCode: specifiedBatch.code, type: 'saída', quantity: consumeFromSpecified, date: new Date().toISOString().split('T')[0] });
                remainingToConsume -= consumeFromSpecified;

                if (remainingToConsume > 0) {
                    const otherBatches = localBatches.filter(b => b.productId === item.productId && b.id !== item.batchId && b.quantity > 0)
                        .sort((a,b) => new Date(a.expiryDate) - new Date(b.expiryDate));
                    for (const otherBatchDoc of otherBatches) {
                        const consumeFromThis = Math.min(remainingToConsume, otherBatchDoc.quantity);
                        otherBatchDoc.quantity -= consumeFromThis;
                        await DB.update('batches', otherBatchDoc);
                        await DB.add('history', { productId: item.productId, batchCode: otherBatchDoc.code, type: 'saída', quantity: consumeFromThis, date: new Date().toISOString().split('T')[0] });
                        remainingToConsume -= consumeFromThis;
                        if (remainingToConsume <= 0) break;
                    }
                }
                if (remainingToConsume > 0) throw new Error(`Estoque insuficiente. Faltam ${remainingToConsume.toFixed(2)}.`);
            }

            for (const productId in totalConsumptionByProduct) {
                const product = await DB.get('inventory', parseInt(productId));
                product.totalQuantity -= totalConsumptionByProduct[productId];
                await DB.update('inventory', product);
            }

            for (const orderId of orderIdsToUpdate) {
                const po = await DB.get('productionOrders', orderId);
                po.status = 'concluído';
                await DB.update('productionOrders', po);
            }
            showNotification("Baixa de estoque realizada com sucesso!");
            hideModal(confirmProductionModal);
            await refreshLocalData();
        } catch (error) {
            console.error("Erro ao dar baixa no estoque: ", error);
            showNotification(error.message || "Erro ao dar baixa no estoque.", true);
        } finally {
            loadingOverlay.classList.add('hidden');
        }
    });

    // --- BACKUP / RESTORE FUNCTIONS ---
    async function downloadBackup() {
        try {
            loadingOverlay.classList.remove('hidden');
            const backupData = {
                inventory: await DB.getAll('inventory'),
                batches: await DB.getAll('batches'),
                history: await DB.getAll('history'),
                recipes: await DB.getAll('recipes'),
                productionOrders: await DB.getAll('productionOrders'),
            };

            const jsonString = JSON.stringify(backupData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            const date = new Date().toISOString().split('T')[0];
            a.download = `backup_estoque_${date}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification("Backup baixado com sucesso!");

        } catch (error) {
            console.error("Erro ao criar backup:", error);
            showNotification("Falha ao criar o backup.", true);
        } finally {
            loadingOverlay.classList.add('hidden');
        }
    }
    btnDownloadBackup.addEventListener('click', downloadBackup);

    btnUploadBackup.addEventListener('click', () => {
        backupFileInput.click();
    });

    backupFileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                backupFileContent = JSON.parse(e.target.result);
                if (!backupFileContent.inventory || !backupFileContent.batches) {
                    throw new Error("Arquivo de backup inválido ou corrompido.");
                }
                showModal(confirmUploadModal);
            } catch (error) {
                console.error("Erro ao ler o arquivo de backup:", error);
                showNotification(error.message || "Falha ao ler o arquivo de backup.", true);
                backupFileContent = null;
            }
        };
        reader.onerror = () => {
             showNotification("Erro ao ler o arquivo.", true);
             backupFileContent = null;
        };
        reader.readAsText(file);
        
        backupFileInput.value = '';
    });

    cancelUploadBtn.addEventListener('click', () => {
        backupFileContent = null;
        hideModal(confirmUploadModal);
    });

    confirmUploadBtn.addEventListener('click', () => {
        hideModal(confirmUploadModal);
        if (backupFileContent) {
            importData(backupFileContent);
        }
    });
    
    async function importData(data) {
        try {
            loadingOverlay.classList.remove('hidden');
            const stores = ['inventory', 'batches', 'history', 'recipes', 'productionOrders'];
            
            for (const storeName of stores) {
                await DB.clear(storeName);
            }

            const idMaps = { inventory: {}, recipes: {} };

            if (data.inventory) {
                for (const item of data.inventory) {
                    const oldId = item.id;
                    delete item.id;
                    const newId = await DB.add('inventory', item);
                    idMaps.inventory[oldId] = newId;
                }
            }
            
             if (data.recipes) {
                for (const recipe of data.recipes) {
                    const oldId = recipe.id;
                    delete recipe.id;
                    if (recipe.ingredients) {
                        recipe.ingredients.forEach(ing => {
                            ing.productId = idMaps.inventory[ing.productId];
                        });
                    }
                    const newId = await DB.add('recipes', recipe);
                    idMaps.recipes[oldId] = newId;
                }
            }

            if (data.batches) {
                for (const batch of data.batches) {
                    delete batch.id;
                    batch.productId = idMaps.inventory[batch.productId];
                    if (batch.productId) {
                        await DB.add('batches', batch);
                    }
                }
            }

            if (data.history) {
                 for (const record of data.history) {
                    delete record.id;
                    record.productId = idMaps.inventory[record.productId];
                    if (record.productId) {
                        await DB.add('history', record);
                    }
                }
            }

            if (data.productionOrders) {
                for (const po of data.productionOrders) {
                    delete po.id;
                    po.recipeId = idMaps.recipes[po.recipeId];
                    if (po.ingredients) {
                        po.ingredients.forEach(ing => {
                           ing.productId = idMaps.inventory[ing.productId];
                        });
                    }
                    if (po.recipeId) {
                        await DB.add('productionOrders', po);
                    }
                }
            }

            await refreshLocalData();
            showNotification("Backup restaurado com sucesso!");

        } catch (error) {
            console.error("Erro ao importar dados:", error);
            showNotification("Falha ao restaurar o backup. Verifique o arquivo.", true);
            const stores = ['inventory', 'batches', 'history', 'recipes', 'productionOrders'];
            for (const storeName of stores) { await DB.clear(storeName); }
            await refreshLocalData();

        } finally {
            loadingOverlay.classList.add('hidden');
            backupFileContent = null;
        }
    }


    // --- EXPORT FUNCTIONS ---
    function exportInventoryToExcel() {
        const dataToExport = localInventory.map(item => ({
            'Código': item.code,
            'Item': item.name,
            'Fornecedor': item.supplier,
            'Quantidade': item.totalQuantity.toFixed(2)
        }));
        const worksheet = XLSX.utils.json_to_sheet(dataToExport);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Estoque");
        XLSX.writeFile(workbook, "relatorio_estoque.xlsx");
        showNotification("Relatório de estoque exportado!");
    }
    btnExportExcel.addEventListener('click', exportInventoryToExcel);
    function exportOrdersToPDF() {
        const { jsPDF } = window.jspdf;
        const filterDate = searchPoByDate.value;
        if (!filterDate) {
            showNotification("Por favor, selecione uma data para gerar o relatório.", true);
            return;
        }

        const filteredOrders = localProductionOrders.filter(po => po.date === filterDate);
        if (filteredOrders.length === 0) {
            showNotification("Nenhuma ordem de produção para a data selecionada.", true);
            return;
        }

        const doc = new jsPDF();
        const formattedDate = new Date(filterDate + 'T00:00:00').toLocaleDateString('pt-BR');

        doc.setFontSize(18);
        doc.text(`Relatório de Ordens de Produção`, 14, 22);
        doc.setFontSize(11);
        doc.setTextColor(100);
        doc.text(`Data: ${formattedDate}`, 14, 30);

        let startY = 40;

        filteredOrders.forEach(order => {
            if (startY > 250) { // Page break
                doc.addPage();
                startY = 22;
            }
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text(`${order.recipeName} (${order.quantityProduced}x)`, 14, startY);
            startY += 7;

            const tableBody = order.ingredients.map(ing => {
                const product = localInventory.find(p => p.id === ing.productId);
                return [
                    product ? product.name : 'N/A',
                    ing.adjustedQuantity.toFixed(2),
                    ing.batchCode,
                    ing.handler
                ];
            });

            doc.autoTable({
                startY: startY,
                head: [['Insumo', 'Qtd. Usada', 'Lote', 'Manipulador']],
                body: tableBody,
                theme: 'striped',
                headStyles: { fillColor: [79, 70, 229] }
            });

            startY = doc.autoTable.previous.finalY + 15;
        });

        doc.save(`relatorio_producao_${filterDate}.pdf`);
        showNotification("Relatório PDF exportado!");
    }
    btnExportPdf.addEventListener('click', exportOrdersToPDF);


    // --- INICIALIZAÇÃO E SINCRONIZAÇÃO COM DADOS LOCAIS ---
    async function refreshLocalData() {
        try {
            localInventory = await DB.getAll('inventory');
            localBatches = await DB.getAll('batches');
            localHistory = await DB.getAll('history');
            localRecipes = await DB.getAll('recipes');
            localProductionOrders = await DB.getAll('productionOrders');
            
            renderInventoryTable();
            renderRecipes();
            renderProductionOrders();
            renderDashboard();
        } catch (error) {
            console.error("Erro ao carregar dados locais:", error);
            showNotification("Falha ao carregar dados do banco de dados local.", true);
        }
    }
    
    // --- DASHBOARD ---
    function renderDashboard() {
        // --- GRÁFICO ---
        const top5Stock = [...localInventory].sort((a,b) => b.totalQuantity - a.totalQuantity).slice(0, 5);
        const ctx = document.getElementById('stock-chart').getContext('2d');
        if (stockChart) {
            stockChart.destroy();
        }
        stockChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: top5Stock.map(item => item.name),
                datasets: [{
                    label: 'Quantidade em Estoque',
                    data: top5Stock.map(item => item.totalQuantity),
                    backgroundColor: ['#4f46e5', '#6366f1', '#818cf8', '#a5b4fc', '#c7d2fe'],
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    }
                }
            }
        });

        // --- ÚLTIMAS ENTRADAS ---
        const lastEntries = [...localHistory].filter(h => h.type === 'entrada').sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0,5);
        const lastEntriesList = document.getElementById('last-entries-list');
        lastEntriesList.innerHTML = '';
        if (lastEntries.length > 0) {
            lastEntries.forEach(entry => {
                const product = localInventory.find(p => p.id === entry.productId);
                const li = document.createElement('li');
                li.className = 'py-3 flex justify-between items-center text-sm';
                li.innerHTML = `
                    <div>
                        <p class="font-medium text-gray-800">${product ? product.name : 'Produto desconhecido'}</p>
                        <p class="text-gray-500">Lote: ${entry.batchCode}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-semibold text-green-600">+${entry.quantity.toFixed(2)}</p>
                        <p class="text-gray-400">${new Date(entry.date + 'T00:00:00').toLocaleDateString('pt-BR')}</p>
                    </div>
                `;
                lastEntriesList.appendChild(li);
            });
        } else {
             lastEntriesList.innerHTML = `<p class="text-center text-gray-500 py-4">Nenhuma entrada registrada.</p>`;
        }
        
        // --- ALERTAS ---
        const today = new Date();
        const thirtyDaysFromNow = new Date();
        thirtyDaysFromNow.setDate(today.getDate() + 30);
        
        const lowStockItems = localInventory.filter(i => {
            const metrics = calculateConsumptionMetrics(i.id);
            return i.totalQuantity < metrics.minStock && metrics.minStock > 0;
        });
        const expiringBatches = localBatches.filter(b => b.quantity > 0 && new Date(b.expiryDate) <= thirtyDaysFromNow);
        
        const lossRiskBatches = localBatches.filter(b => {
             const expiryDate = new Date(b.expiryDate);
             if (expiryDate <= today || b.quantity <= 0) return false;
             
             const metrics = calculateConsumptionMetrics(b.productId);
             const consumptionRate = metrics.avgConsumption;
             if (consumptionRate <= 0) return false; // Sem consumo, não há risco calculado

             const daysToExpire = (expiryDate.getTime() - today.getTime()) / (1000 * 3600 * 24);
             const estimatedConsumption = daysToExpire * consumptionRate;
             
             return b.quantity > estimatedConsumption;
        });

        const sixtyDaysAgo = new Date();
        sixtyDaysAgo.setDate(today.getDate() - 60);
        const recentOuts = [...localHistory].filter(h => h.type === 'saída' && new Date(h.date) > sixtyDaysAgo);
        const recentOutProductIds = new Set(recentOuts.map(h => h.productId));
        const stagnantItems = localInventory.filter(i => i.totalQuantity > 0 && !recentOutProductIds.has(i.id));

        const renderAlert = (elementId, title, items, formatter) => {
            const container = document.getElementById(elementId);
            if(items.length > 0) {
                container.innerHTML = `
                    <h3 class="font-semibold text-sm text-gray-600">${title} (${items.length})</h3>
                    <ul class="text-xs text-gray-500 mt-1 space-y-1">${items.map(formatter).join('')}</ul>`;
            } else {
                container.innerHTML = ``;
            }
        }
        
        renderAlert('low-stock-alert', 'Estoque Baixo', lowStockItems, item => `<li>- ${item.name} (${item.totalQuantity.toFixed(2)})</li>`);
        renderAlert('expiry-alert', 'Próximo da Validade', expiringBatches, batch => {
            const product = localInventory.find(p => p.id === batch.productId);
            return `<li>- ${product.name} (L: ${batch.code}) vence em ${new Date(batch.expiryDate + 'T00:00:00').toLocaleDateString('pt-BR')}</li>`;
        });
        renderAlert('loss-risk-alert', 'Risco de Perda', lossRiskBatches, batch => {
            const product = localInventory.find(p => p.id === batch.productId);
            return `<li>- ${product.name} (L: ${batch.code})</li>`;
        });
         renderAlert('stagnant-stock-alert', 'Itens sem Saída (>60d)', stagnantItems, item => `<li>- ${item.name}</li>`);
    }


    async function initialize() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('receipt-date').value = today;
        searchPoByDate.value = today;
        navigateTo('dashboard');

        try {
            await DB.getDB(); // Inicializa e abre o banco
            await refreshLocalData();
        } catch (error) {
            console.error("Erro na inicialização do IndexedDB:", error);
            loadingOverlay.innerHTML = "Erro ao iniciar o banco de dados offline.";
        }
        loadingOverlay.classList.add('hidden');
    }

    initialize();
</script>

</body>
</html>

