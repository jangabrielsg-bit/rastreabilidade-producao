<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rastreabilidade de Produção</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Bibliotecas para gerar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal { display: none; }
        .modal.active { display: flex; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .sidebar-icon { transition: all 0.2s ease-in-out; }
        .sidebar-icon:hover { background-color: #3b82f6; color: white; }
        .sortable:hover { background-color: #f3f4f6; }
        .sort-asc::after { content: ' ▲'; font-size: 0.8em; }
        .sort-desc::after { content: ' ▼'; font-size: 0.8em; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-95 flex items-center justify-center z-50">
        <div class="text-center">
            <svg class="animate-spin h-10 w-10 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-lg font-semibold text-gray-700">Carregando dados...</p>
        </div>
    </div>

    <div id="app-container" class="flex h-screen bg-gray-200">
        <!-- Sidebar -->
        <aside class="w-20 lg:w-64 bg-gray-800 text-white flex flex-col transition-all duration-300">
            <div class="h-16 flex items-center justify-center border-b border-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                </svg>
                <span class="hidden lg:inline ml-3 text-lg font-semibold">Rastreio PRO</span>
            </div>
            <nav class="flex-1 px-2 lg:px-4 py-4 space-y-2">
                <a href="#" id="nav-dashboard" class="nav-link flex items-center py-2.5 px-4 rounded-lg bg-blue-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>
                    <span class="hidden lg:inline ml-3">Dashboard</span>
                </a>
                <a href="#" id="nav-insumos" class="nav-link flex items-center py-2.5 px-4 rounded-lg hover:bg-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-14L4 7m0 10l8 4m0-14L4 7" /></svg>
                    <span class="hidden lg:inline ml-3">Estoque de Insumos</span>
                </a>
                <a href="#" id="nav-produtos" class="nav-link flex items-center py-2.5 px-4 rounded-lg hover:bg-gray-700">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>
                    <span class="hidden lg:inline ml-3">Produtos e Receitas</span>
                </a>
                <a href="#" id="nav-ordens" class="nav-link flex items-center py-2.5 px-4 rounded-lg hover:bg-gray-700">
                   <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
                    <span class="hidden lg:inline ml-3">Ordens de Produção</span>
                </a>
                <a href="#" id="nav-requisicoes" class="nav-link flex items-center py-2.5 px-4 rounded-lg hover:bg-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <span class="hidden lg:inline ml-3">Requisições</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col overflow-hidden">
            <header class="h-16 bg-white shadow-md flex items-center justify-between px-6">
                 <h1 id="page-title" class="text-2xl font-semibold text-gray-800">Dashboard</h1>
                 <div id="user-info" class="text-sm text-gray-500" style="display: none;"></div>
            </header>
            <div class="flex-1 p-6 overflow-auto">

                <!-- Dashboard View -->
                <div id="view-dashboard" class="page-view">
                    <h2 class="text-xl font-semibold mb-4">Alertas Críticos</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-6">
                        <div class="bg-white p-4 rounded-lg shadow">
                            <h3 class="font-semibold text-red-600 mb-2">Insumos com Estoque Baixo</h3>
                            <ul id="low-stock-list" class="space-y-2">
                                <li class="text-gray-500">Nenhum alerta de estoque baixo.</li>
                            </ul>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow">
                            <h3 class="font-semibold text-yellow-600 mb-2">Insumos Próximos da Validade (30 dias)</h3>
                            <ul id="expiring-list" class="space-y-2">
                                <li class="text-gray-500">Nenhum insumo próximo do vencimento.</li>
                            </ul>
                        </div>
                         <div class="bg-white p-4 rounded-lg shadow">
                            <h3 class="font-semibold text-orange-600 mb-2">Risco de Vencimento por Baixo Consumo</h3>
                            <ul id="risco-vencimento-list" class="space-y-2">
                                <li class="text-gray-500">Nenhum item com risco de vencimento.</li>
                            </ul>
                        </div>
                         <div class="bg-white p-4 rounded-lg shadow">
                            <h3 class="font-semibold text-purple-600 mb-2">Insumos Sem Uso Recente (30 dias)</h3>
                            <ul id="sem-uso-list" class="space-y-2">
                                <li class="text-gray-500">Todos os insumos foram utilizados recentemente.</li>
                            </ul>
                        </div>
                    </div>
                     <h2 class="text-xl font-semibold mt-8 mb-4">Linhas de Produção</h2>
                     <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                         <div class="bg-white p-6 rounded-lg shadow hover:shadow-lg transition-shadow cursor-pointer new-order-shortcut" data-line="Pães Congelados">
                             <h3 class="font-semibold text-lg text-blue-700">Pães Congelados</h3>
                             <p class="text-gray-600 mt-2">Iniciar nova ordem de produção.</p>
                         </div>
                         <div class="bg-white p-6 rounded-lg shadow hover:shadow-lg transition-shadow cursor-pointer new-order-shortcut" data-line="Pães Especiais">
                             <h3 class="font-semibold text-lg text-green-700">Pães Especiais</h3>
                             <p class="text-gray-600 mt-2">Iniciar nova ordem de produção.</p>
                         </div>
                         <div class="bg-white p-6 rounded-lg shadow hover:shadow-lg transition-shadow cursor-pointer new-order-shortcut" data-line="Pão de Queijo">
                             <h3 class="font-semibold text-lg text-yellow-700">Pão de Queijo</h3>
                             <p class="text-gray-600 mt-2">Iniciar nova ordem de produção.</p>
                         </div>
                         <div class="bg-white p-6 rounded-lg shadow hover:shadow-lg transition-shadow cursor-pointer new-order-shortcut" data-line="Confeitaria">
                             <h3 class="font-semibold text-lg text-purple-700">Confeitaria</h3>
                             <p class="text-gray-600 mt-2">Iniciar nova ordem de produção.</p>
                         </div>
                     </div>
                </div>

                <!-- Insumos View -->
                <div id="view-insumos" class="page-view hidden">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                        <input type="search" id="search-insumo" placeholder="Pesquisar por nome, código, lote..." class="p-2 border rounded-lg w-full sm:w-auto flex-grow">
                        <div class="flex space-x-2">
                            <button id="export-stock-pdf-btn" class="bg-teal-600 text-white px-4 py-2 rounded-lg hover:bg-teal-700">Exportar PDF</button>
                            <button id="add-insumo-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Adicionar Lote</button>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="p-3 sortable cursor-pointer" data-sort="nome">Insumo</th>
                                        <th class="p-3 sortable cursor-pointer" data-sort="lote">Lote</th>
                                        <th class="p-3 sortable cursor-pointer" data-sort="dataRecebimento">Data Receb.</th>
                                        <th class="p-3 sortable cursor-pointer" data-sort="validade">Validade</th>
                                        <th class="p-3 sortable cursor-pointer" data-sort="estoque">Estoque (kg)</th>
                                        <th class="p-3">Autorizado por</th>
                                        <th class="p-3">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="insumos-table-body">
                                    <!-- JS will populate this -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Produtos e Receitas View -->
                <div id="view-produtos" class="page-view hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">Produtos e Receitas</h2>
                        <button id="add-produto-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">Adicionar Produto</button>
                    </div>
                     <div class="bg-white p-4 rounded-lg shadow">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="p-3">Produto</th>
                                        <th class="p-3">Linha de Produção</th>
                                        <th class="p-3">Receita</th>
                                        <th class="p-3">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="produtos-table-body">
                                    <!-- JS will populate this -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Ordens de Produção View -->
                <div id="view-ordens" class="page-view hidden">
                     <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">Ordens de Produção</h2>
                        <div class="flex space-x-2">
                            <button id="export-pdf-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">Exportar do Dia (PDF)</button>
                            <button id="add-ordem-btn" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">Nova Ordem</button>
                        </div>
                    </div>
                     <div class="bg-white p-4 rounded-lg shadow">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="p-3">Lote do Produto</th>
                                        <th class="p-3">Produto</th>
                                        <th class="p-3">Data de Produção</th>
                                        <th class="p-3">Quantidade</th>
                                        <th class="p-3">Manipuladores</th>
                                        <th class="p-3">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="ordens-table-body">
                                    <!-- JS will populate this -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Requisições View -->
                <div id="view-requisicoes" class="page-view hidden">
                     <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">Requisições de Insumos</h2>
                        <button id="add-requisicao-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">Nova Requisição</button>
                    </div>
                     <div class="bg-white p-4 rounded-lg shadow">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="p-3">Data</th>
                                        <th class="p-3">Responsável</th>
                                        <th class="p-3">Motivo</th>
                                        <th class="p-3">Itens</th>
                                        <th class="p-3">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="requisicoes-table-body">
                                    <!-- JS will populate this -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Modals -->
    <!-- Insumo Modal -->
    <div id="insumo-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl">
            <h3 id="insumo-modal-title" class="text-xl font-semibold mb-4">Adicionar Lote de Insumo</h3>
            <form id="insumo-form">
                <input type="hidden" id="insumo-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" id="insumo-codigo" placeholder="Código do Insumo (Ex: 101)" class="p-2 border rounded-lg" required>
                    <input type="text" id="insumo-nome" placeholder="Nome do Insumo (Ex: Farinha de Trigo)" class="p-2 border rounded-lg" required>
                    <input type="text" id="insumo-lote" placeholder="Lote do Fornecedor" class="p-2 border rounded-lg" required>
                    <input type="text" id="insumo-fornecedor" placeholder="Fornecedor" class="p-2 border rounded-lg">
                    <input type="number" step="0.001" id="insumo-estoque" placeholder="Estoque do Lote (kg)" class="p-2 border rounded-lg" required>
                </div>
                 <div id="stock-levels-info" class="mt-4 p-3 bg-gray-50 rounded-lg text-sm hidden">
                    <h4 class="font-semibold mb-2">Níveis de Estoque Sugeridos (Baseado no consumo dos últimos 30 dias)</h4>
                    <p><strong>Estoque Mínimo:</strong> <span id="sugerido-min">N/A</span> kg</p>
                    <p><strong>Estoque Máximo:</strong> <span id="sugerido-max">N/A</span> kg</p>
                </div>
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4 border-t pt-4">
                     <div>
                        <label for="insumo-data-fabricacao" class="text-sm text-gray-600">Data de Fabricação (Opcional)</label>
                        <input type="date" id="insumo-data-fabricacao" class="w-full p-2 border rounded-lg">
                    </div>
                    <div>
                        <label for="insumo-data-recebimento" class="text-sm text-gray-600">Data de Recebimento</label>
                        <input type="date" id="insumo-data-recebimento" class="w-full p-2 border rounded-lg" required>
                    </div>
                     <div>
                        <label for="insumo-validade" class="text-sm text-gray-600">Validade do Lote</label>
                        <input type="date" id="insumo-validade" class="w-full p-2 border rounded-lg" required>
                    </div>
                </div>
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" id="cancel-insumo-btn" class="bg-gray-300 px-4 py-2 rounded-lg">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg">Salvar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Shelf Life Alert Modal -->
    <div id="shelf-life-alert-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-40">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <h3 class="text-xl font-semibold text-yellow-600 mb-4">Alerta de Shelf Life</h3>
            <p id="shelf-life-alert-message" class="mb-4 text-gray-700">O shelf life restante deste lote é de <strong class="text-yellow-800"></strong>, o que é inferior a 75%. Para confirmar o recebimento, por favor, insira o nome do responsável pela autorização.</p>
            <div class="space-y-4">
                <div>
                    <label for="shelf-life-authorizer" class="text-sm font-medium">Autorizado por:</label>
                    <input type="text" id="shelf-life-authorizer" class="w-full mt-1 p-2 border rounded-lg" required placeholder="Nome completo">
                </div>
            </div>
            <div class="flex justify-end space-x-4 mt-6">
                <button type="button" id="cancel-shelf-life-btn" class="bg-gray-300 px-4 py-2 rounded-lg">Cancelar Recebimento</button>
                <button type="button" id="confirm-shelf-life-btn" class="bg-yellow-500 text-white px-4 py-2 rounded-lg">Confirmar Recebimento</button>
            </div>
        </div>
    </div>

    <!-- Produto Modal -->
    <div id="produto-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl">
            <h3 id="produto-modal-title" class="text-xl font-semibold mb-4">Adicionar Novo Produto</h3>
            <form id="produto-form">
                <input type="hidden" id="produto-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <input type="text" id="produto-nome" placeholder="Nome do Produto" class="p-2 border rounded-lg" required>
                    <select id="produto-linha" class="p-2 border rounded-lg" required>
                        <option value="">Selecione a Linha de Produção</option>
                        <option value="Pães Congelados">Pães Congelados</option>
                        <option value="Pães Especiais">Pães Especiais</option>
                        <option value="Pão de Queijo">Pão de Queijo</option>
                        <option value="Confeitaria">Confeitaria</option>
                    </select>
                </div>
                <h4 class="font-semibold mt-4 mb-2">Receita</h4>
                <div id="receita-container" class="space-y-2 max-h-60 overflow-y-auto pr-2">
                    <!-- JS will populate this -->
                </div>
                <button type="button" id="add-receita-item-btn" class="mt-2 text-sm text-blue-600 hover:underline">+ Adicionar insumo à receita</button>
                
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" id="cancel-produto-btn" class="bg-gray-300 px-4 py-2 rounded-lg">Cancelar</button>
                    <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-lg">Salvar</button>
                </div>
            </form>
        </div>
    </div>
    
     <!-- Ordem de Produção Modal -->
    <div id="ordem-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-5xl max-h-[90vh] flex flex-col">
            <h3 id="ordem-modal-title" class="text-xl font-semibold mb-4">Nova Ordem de Produção</h3>
            <form id="ordem-form" class="flex-1 overflow-y-auto pr-2">
                 <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 p-4 border rounded-lg bg-gray-50">
                    <div>
                         <label for="ordem-produto" class="text-sm font-medium">Produto</label>
                         <select id="ordem-produto" class="w-full mt-1 p-2 border rounded-lg" required></select>
                    </div>
                     <div>
                         <label for="ordem-linha" class="text-sm font-medium">Linha de Produção</label>
                         <input type="text" id="ordem-linha" class="w-full mt-1 p-2 border rounded-lg bg-gray-200" readonly>
                    </div>
                    <div>
                         <label for="ordem-receitas" class="text-sm font-medium">Quantidade (Receitas)</label>
                         <input type="number" id="ordem-receitas" class="w-full mt-1 p-2 border rounded-lg" required min="1" value="1">
                    </div>
                     <div>
                         <label for="ordem-lote" class="text-sm font-medium">Lote do Produto (Opcional)</label>
                         <input type="text" id="ordem-lote" class="w-full mt-1 p-2 border rounded-lg">
                    </div>
                     <div>
                         <label for="ordem-data-producao" class="text-sm font-medium">Data de Produção</label>
                         <input type="date" id="ordem-data-producao" class="w-full mt-1 p-2 border rounded-lg" required>
                    </div>
                     <div>
                         <label for="ordem-validade-produto" class="text-sm font-medium">Validade do Produto</label>
                         <input type="date" id="ordem-validade-produto" class="w-full mt-1 p-2 border rounded-lg" required>
                    </div>
                 </div>
                 <h4 class="font-semibold mt-6 mb-2">Insumos para a Produção</h4>
                 <div id="ordem-stock-warning" class="hidden my-2 p-3 bg-red-100 text-red-700 rounded-lg"></div>
                 <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-100">
                             <tr>
                                 <th class="p-3">Insumo</th>
                                 <th class="p-3">Qtd. a Usar (kg)</th>
                                 <th class="p-3">Lote a Utilizar (Automático/Manual)</th>
                                 <th class="p-3">Fornecedor</th>
                                 <th class="p-3">Manipulador</th>
                             </tr>
                        </thead>
                        <tbody id="ordem-insumos-table">
                            <!-- JS populates this based on selected product -->
                        </tbody>
                    </table>
                 </div>
                 
                <div class="flex justify-end space-x-4 mt-6 sticky bottom-0 bg-white py-4">
                    <button type="button" id="cancel-ordem-btn" class="bg-gray-300 px-4 py-2 rounded-lg">Cancelar</button>
                    <button type="submit" class="bg-purple-600 text-white px-4 py-2 rounded-lg">Salvar Ordem</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- View Ordem Modal -->
    <div id="view-ordem-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-start">
                <h3 class="text-xl font-semibold mb-4">Detalhes da Ordem de Produção</h3>
                <button id="close-view-ordem-modal" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <div id="view-ordem-content" class="flex-1 overflow-y-auto">
                <!-- Content injected by JS -->
            </div>
        </div>
    </div>

    <!-- Insumo History Modal -->
    <div id="insumo-history-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-6xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-start mb-4">
                <h3 id="insumo-history-title" class="text-xl font-semibold">Histórico do Insumo</h3>
                <button id="close-insumo-history-modal" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <div class="flex-1 overflow-y-auto space-y-6">
                 <div id="insumo-stats" class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <h4 class="font-semibold text-md mb-2 text-blue-800">Análise de Consumo (Últimos 30 dias)</h4>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-sm">
                        <div>
                            <span class="block text-gray-500">Consumo Médio Diário</span>
                            <strong id="stats-avg-daily" class="text-lg">0 kg</strong>
                        </div>
                        <div>
                            <span class="block text-gray-500">Estoque Mínimo Sugerido</span>
                            <strong id="stats-min" class="text-lg">0 kg</strong>
                        </div>
                        <div>
                            <span class="block text-gray-500">Estoque Máximo Sugerido</span>
                            <strong id="stats-max" class="text-lg">0 kg</strong>
                        </div>
                    </div>
                </div>
                <div>
                    <h4 class="font-semibold text-md mb-2">Lotes Registrados (Entradas)</h4>
                    <div class="overflow-x-auto border rounded-lg">
                        <table class="w-full text-sm text-left">
                           <thead class="bg-gray-100">
                               <tr>
                                   <th class="p-2">Lote</th>
                                   <th class="p-2">Estoque (kg)</th>
                                   <th class="p-2">Shelf Life Receb.</th>
                                   <th class="p-2">Validade</th>
                                   <th class="p-2">Dias Restantes</th>
                                   <th class="p-2">Estimativa de Consumo</th>
                               </tr>
                           </thead>
                           <tbody id="insumo-history-entradas-body"></tbody>
                        </table>
                    </div>
                </div>
                <div>
                    <h4 class="font-semibold text-md mb-2">Histórico de Uso (Saídas)</h4>
                    <div class="overflow-x-auto border rounded-lg">
                        <table class="w-full text-sm text-left">
                           <thead class="bg-gray-100">
                               <tr>
                                   <th class="p-2">Data</th>
                                   <th class="p-2">Tipo</th>
                                   <th class="p-2">Destino / Motivo</th>
                                   <th class="p-2">Qtd. Usada (kg)</th>
                                   <th class="p-2">Lote do Insumo</th>
                               </tr>
                           </thead>
                           <tbody id="insumo-history-saidas-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Requisição Modal -->
    <div id="requisicao-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-4xl max-h-[90vh] flex flex-col">
            <h3 class="text-xl font-semibold mb-4">Nova Requisição de Insumos</h3>
            <form id="requisicao-form" class="flex-1 overflow-y-auto pr-2">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-4 border rounded-lg bg-gray-50">
                    <div>
                        <label for="requisicao-data" class="text-sm font-medium">Data da Requisição</label>
                        <input type="date" id="requisicao-data" class="w-full mt-1 p-2 border rounded-lg" required>
                    </div>
                    <div>
                        <label for="requisicao-responsavel" class="text-sm font-medium">Responsável</label>
                        <input type="text" id="requisicao-responsavel" class="w-full mt-1 p-2 border rounded-lg" required placeholder="Nome do solicitante">
                    </div>
                    <div>
                        <label for="requisicao-motivo" class="text-sm font-medium">Motivo</label>
                        <select id="requisicao-motivo" class="w-full mt-1 p-2 border rounded-lg" required>
                            <option value="Amostra">Amostra</option>
                            <option value="Teste de Qualidade">Teste de Qualidade</option>
                            <option value="Perda">Perda</option>
                            <option value="Ajuste de Estoque">Ajuste de Estoque</option>
                            <option value="Outro">Outro</option>
                        </select>
                    </div>
                </div>
                <h4 class="font-semibold mt-6 mb-2">Itens Requisitados</h4>
                <div id="requisicao-items-container" class="space-y-3">
                    <!-- JS will populate this -->
                </div>
                <button type="button" id="add-requisicao-item-btn" class="mt-3 text-sm text-blue-600 hover:underline">+ Adicionar Item</button>
                <div class="flex justify-end space-x-4 mt-6 sticky bottom-0 bg-white py-4">
                    <button type="button" id="cancel-requisicao-btn" class="bg-gray-300 px-4 py-2 rounded-lg">Cancelar</button>
                    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg">Salvar Requisição</button>
                </div>
            </form>
        </div>
    </div>

    <!-- View Requisição Modal -->
    <div id="view-requisicao-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-3xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-start">
                <h3 class="text-xl font-semibold mb-4">Detalhes da Requisição</h3>
                <button id="close-view-requisicao-modal" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <div id="view-requisicao-content" class="flex-1 overflow-y-auto">
                <!-- Content injected by JS -->
            </div>
        </div>
    </div>


    <script type="module">
        // --- INITIALIZATION & STORAGE ---
        let insumosCache = [];
        let produtosCache = [];
        let ordensCache = [];
        let requisicoesCache = [];
        let tempInsumoData = null;
        let insumosSortConfig = { key: 'dataRecebimento', direction: 'desc' };
        let insumosSearchTerm = '';
        let displayedInsumos = [];

        const STORAGE_KEYS = {
            insumos: 'rastreio_insumos',
            produtos: 'rastreio_produtos',
            ordens: 'rastreio_ordens',
            requisicoes: 'rastreio_requisicoes'
        };

        function loadFromStorage(key) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : [];
            } catch (e) {
                console.error(`Error loading ${key} from storage`, e);
                return [];
            }
        }

        function saveToStorage(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
            } catch (e) {
                console.error(`Error saving ${key} to storage`, e);
            }
        }

        function initializeApp() {
            insumosCache = loadFromStorage(STORAGE_KEYS.insumos);
            produtosCache = loadFromStorage(STORAGE_KEYS.produtos);
            ordensCache = loadFromStorage(STORAGE_KEYS.ordens);
            requisicoesCache = loadFromStorage(STORAGE_KEYS.requisicoes);
            
            updateInsumosView();
            renderProdutosTable(produtosCache);
            renderOrdensTable(ordensCache);
            renderRequisicoesTable(requisicoesCache);
            updateDashboard(insumosCache, ordensCache);

            document.getElementById('loading-overlay').style.display = 'none';
        }

        window.onload = initializeApp;


        // --- UI NAVIGATION ---
        const navLinks = document.querySelectorAll('.nav-link');
        const pageViews = document.querySelectorAll('.page-view');
        const pageTitles = {
            'nav-dashboard': 'Dashboard',
            'nav-insumos': 'Estoque de Insumos',
            'nav-produtos': 'Produtos e Receitas',
            'nav-ordens': 'Ordens de Produção',
            'nav-requisicoes': 'Requisições'
        };

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetViewId = 'view-' + e.currentTarget.id.split('-')[1];
                
                pageViews.forEach(view => view.classList.add('hidden'));
                document.getElementById(targetViewId).classList.remove('hidden');

                navLinks.forEach(nav => nav.classList.remove('bg-blue-600'));
                e.currentTarget.classList.add('bg-blue-600');
                
                document.getElementById('page-title').textContent = pageTitles[e.currentTarget.id];
            });
        });
        
        // --- UTILITY FUNCTIONS ---
        const formatDate = (dateString) => {
            if (!dateString) return 'N/A';
            const date = new Date(dateString); 
            return date.toLocaleDateString('pt-BR', { timeZone: 'UTC' });
        };
        const getToday = () => new Date().toISOString().split('T')[0];
        const daysBetween = (date1, date2) => {
            const oneDay = 1000 * 60 * 60 * 24;
            const time1 = new Date(date1).getTime();
            const time2 = new Date(date2).getTime();
            return Math.round((time1 - time2) / oneDay);
        };

        // --- MODAL HANDLING ---
        function setupModal(modalId, openBtnId, cancelBtnId) {
            const modal = document.getElementById(modalId);
            const openBtn = document.getElementById(openBtnId);
            const cancelBtn = document.getElementById(cancelBtnId);
            if (openBtn) openBtn.addEventListener('click', () => modal.classList.add('active'));
            if (cancelBtn) cancelBtn.addEventListener('click', () => modal.classList.remove('active'));
        }
        setupModal('insumo-modal', 'add-insumo-btn', 'cancel-insumo-btn');
        setupModal('produto-modal', 'add-produto-btn', 'cancel-produto-btn');
        setupModal('ordem-modal', 'add-ordem-btn', 'cancel-ordem-btn');
        setupModal('requisicao-modal', 'add-requisicao-btn', 'cancel-requisicao-btn');
        
        document.getElementById('close-view-ordem-modal').addEventListener('click', () => {
            document.getElementById('view-ordem-modal').classList.remove('active');
        });
         document.getElementById('close-insumo-history-modal').addEventListener('click', () => {
            document.getElementById('insumo-history-modal').classList.remove('active');
        });
        document.getElementById('close-view-requisicao-modal').addEventListener('click', () => {
            document.getElementById('view-requisicao-modal').classList.remove('active');
        });


        // --- DASHBOARD ---
        document.getElementById('view-dashboard').addEventListener('click', (e) => {
            const target = e.target.closest('.alert-item-btn');
            if (target) {
                const insumoCodigo = target.dataset.codigo;
                const insumoNome = target.dataset.nome;
                showInsumoHistory(insumoCodigo, insumoNome);
            }
        });

        function updateDashboard(insumos, ordens) {
            const lowStockList = document.getElementById('low-stock-list');
            const expiringList = document.getElementById('expiring-list');
            const riscoVencimentoList = document.getElementById('risco-vencimento-list');
            const semUsoList = document.getElementById('sem-uso-list');
            
            lowStockList.innerHTML = '';
            expiringList.innerHTML = '';
            riscoVencimentoList.innerHTML = '';
            semUsoList.innerHTML = '';

            // 1. Logic for Low Stock
            const insumoTotals = {};
            insumos.forEach(insumo => {
                if (!insumoTotals[insumo.codigo]) {
                    insumoTotals[insumo.codigo] = {
                        nome: insumo.nome,
                        estoqueMinimo: 0,
                        totalEstoque: 0,
                        latestBatchDate: '1970-01-01'
                    };
                }
                insumoTotals[insumo.codigo].totalEstoque += parseFloat(insumo.estoque);
                
                const batchDate = insumo.dataRecebimento || '1970-01-01';
                if (batchDate > insumoTotals[insumo.codigo].latestBatchDate) {
                    insumoTotals[insumo.codigo].latestBatchDate = batchDate;
                    insumoTotals[insumo.codigo].estoqueMinimo = parseFloat(insumo.estoqueMinimo);
                }
            });
            
            let lowStockCount = 0;
            for (const codigo in insumoTotals) {
                const insumo = insumoTotals[codigo];
                if (insumo.totalEstoque <= insumo.estoqueMinimo && insumo.estoqueMinimo > 0) {
                    const li = document.createElement('li');
                    li.innerHTML = `<button class="alert-item-btn text-left w-full text-sm text-red-700 hover:underline" data-codigo="${codigo}" data-nome="${insumo.nome}">${insumo.nome} (${insumo.totalEstoque.toFixed(3)} kg / min: ${insumo.estoqueMinimo.toFixed(3)} kg)</button>`;
                    lowStockList.appendChild(li);
                    lowStockCount++;
                }
            }
            if (lowStockCount === 0) lowStockList.innerHTML = '<li class="text-gray-500">Nenhum alerta de estoque baixo.</li>';
            
            // 2. Logic for Expiring Soon
            const today = new Date();
            const thirtyDaysFromNow = new Date();
            thirtyDaysFromNow.setDate(today.getDate() + 30);
            let expiringCount = 0;
            insumos.forEach(insumo => {
                const expiryDate = new Date(insumo.validade + 'T00:00:00');
                if (expiryDate <= thirtyDaysFromNow && expiryDate >= today) {
                    const li = document.createElement('li');
                    li.innerHTML = `<button class="alert-item-btn text-left w-full text-sm text-yellow-700 hover:underline" data-codigo="${insumo.codigo}" data-nome="${insumo.nome}">${insumo.nome} (Lote: ${insumo.lote}) - Vence em: ${formatDate(insumo.validade)}</button>`;
                    expiringList.appendChild(li);
                    expiringCount++;
                }
            });
            if (expiringCount === 0) expiringList.innerHTML = '<li class="text-gray-500">Nenhum insumo próximo do vencimento.</li>';

            // 3. Logic for Risk of Expiry due to low consumption
            let riscoVencimentoCount = 0;
            insumos.forEach(lote => {
                const levels = calculateStockLevels(lote.codigo, ordens);
                const avgDailyConsumption = parseFloat(levels.avg);

                if (avgDailyConsumption > 0 && parseFloat(lote.estoque) > 0) {
                    const diasParaConsumir = parseFloat(lote.estoque) / avgDailyConsumption;
                    const dataEstimada = new Date();
                    dataEstimada.setDate(today.getDate() + diasParaConsumir);

                    if (dataEstimada > new Date(lote.validade)) {
                        const li = document.createElement('li');
                        li.innerHTML = `<button class="alert-item-btn text-left w-full text-sm text-orange-700 hover:underline" data-codigo="${lote.codigo}" data-nome="${lote.nome}">${lote.nome} (Lote: ${lote.lote}) - Val: ${formatDate(lote.validade)}, Est. Fim: ${formatDate(dataEstimada.toISOString().split('T')[0])}</button>`;
                        riscoVencimentoList.appendChild(li);
                        riscoVencimentoCount++;
                    }
                }
            });
            if (riscoVencimentoCount === 0) riscoVencimentoList.innerHTML = '<li class="text-gray-500">Nenhum item com risco de vencimento.</li>';

            // 4. Logic for Unused Items
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            const usedInsumoCodes = new Set();
            ordens
                .filter(ordem => new Date(ordem.dataProducao) >= thirtyDaysAgo)
                .forEach(ordem => {
                    ordem.insumosUtilizados.forEach(insumo => usedInsumoCodes.add(insumo.codigo));
                });
            requisicoesCache
                .filter(req => new Date(req.data) >= thirtyDaysAgo)
                .forEach(req => {
                    req.items.forEach(item => usedInsumoCodes.add(item.codigo));
                })

            const uniqueInsumos = [...new Map(insumos.map(item => [item['codigo'], item])).values()];
            let semUsoCount = 0;
            uniqueInsumos.forEach(insumo => {
                if (!usedInsumoCodes.has(insumo.codigo)) {
                    const li = document.createElement('li');
                    li.innerHTML = `<button class="alert-item-btn text-left w-full text-sm text-purple-700 hover:underline" data-codigo="${insumo.codigo}" data-nome="${insumo.nome}">${insumo.nome} (Cód: ${insumo.codigo})</button>`;
                    semUsoList.appendChild(li);
                    semUsoCount++;
                }
            });
            if (semUsoCount === 0) semUsoList.innerHTML = '<li class="text-gray-500">Todos os insumos foram utilizados recentemente.</li>';
        }

        // --- STOCK LEVEL CALCULATION ---
        function calculateStockLevels(insumoCodigo, ordens) {
            if (!insumoCodigo) {
                return { min: 0, max: 0, avg: 0 };
            }

            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

            let totalConsumed = 0;
            const relevantOrders = ordens.filter(ordem => new Date(ordem.dataProducao) >= thirtyDaysAgo);

            relevantOrders.forEach(ordem => {
                ordem.insumosUtilizados.forEach(insumo => {
                    if (insumo.codigo === insumoCodigo) {
                        totalConsumed += parseFloat(insumo.dosagemTotal);
                    }
                });
            });

            const avgDailyConsumption = (totalConsumed / 30) || 0;
            const suggestedMin = avgDailyConsumption * 7;
            const suggestedMax = avgDailyConsumption * 30;

            return {
                min: suggestedMin.toFixed(3),
                max: suggestedMax.toFixed(3),
                avg: avgDailyConsumption.toFixed(3)
            };
        }

        // --- INSUMOS (BATCHES) CRUD & RENDERING ---
        
        function updateInsumosView() {
            let filteredInsumos = [...insumosCache];

            // Apply search filter
            if (insumosSearchTerm) {
                const lowerCaseTerm = insumosSearchTerm.toLowerCase();
                filteredInsumos = filteredInsumos.filter(insumo =>
                    insumo.nome.toLowerCase().includes(lowerCaseTerm) ||
                    insumo.lote.toLowerCase().includes(lowerCaseTerm) ||
                    (insumo.fornecedor && insumo.fornecedor.toLowerCase().includes(lowerCaseTerm))
                );
            }
            
            // Apply sorting
            filteredInsumos.sort((a, b) => {
                const key = insumosSortConfig.key;
                const direction = insumosSortConfig.direction === 'asc' ? 1 : -1;

                const valA = a[key];
                const valB = b[key];

                if (key === 'estoque') {
                    return (parseFloat(valA) - parseFloat(valB)) * direction;
                }
                if (key === 'validade' || key === 'dataRecebimento') {
                    return (new Date(valA) - new Date(valB)) * direction;
                }
                return String(valA).localeCompare(String(valB)) * direction;
            });

            displayedInsumos = filteredInsumos;
            renderInsumosTable(displayedInsumos);
        }


        function renderInsumosTable(insumos) {
            const tbody = document.getElementById('insumos-table-body');
            tbody.innerHTML = '';

            // Update sort indicators in headers
            document.querySelectorAll('#view-insumos .sortable').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
                if (th.dataset.sort === insumosSortConfig.key) {
                    th.classList.add(insumosSortConfig.direction === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            });

            if (insumos.length === 0) {
                 tbody.innerHTML = `<tr><td colspan="7" class="text-center p-4 text-gray-500">${insumosSearchTerm ? 'Nenhum resultado encontrado.' : 'Nenhum lote de insumo cadastrado.'}</td></tr>`;
                 return;
            }
            
            insumos.forEach(insumo => {
                const tr = document.createElement('tr');
                tr.className = 'border-b';
                
                const isExpired = new Date(insumo.validade + 'T00:00:00') < new Date();
                
                tr.innerHTML = `
                    <td class="p-3 font-medium">
                        <button class="view-history-btn text-blue-600 hover:underline" data-codigo="${insumo.codigo}" data-nome="${insumo.nome}">${insumo.nome}</button>
                    </td>
                    <td class="p-3">${insumo.lote}</td>
                    <td class="p-3">${formatDate(insumo.dataRecebimento)}</td>
                    <td class="p-3 ${isExpired ? 'text-red-600 font-bold' : ''}">${formatDate(insumo.validade)}</td>
                    <td class="p-3">${parseFloat(insumo.estoque).toFixed(3)}</td>
                    <td class="p-3 text-xs ${insumo.quemAutorizou ? 'text-yellow-700' : ''}">${insumo.quemAutorizou || 'N/A'}</td>
                    <td class="p-3">
                        <button class="edit-insumo-btn text-blue-600 hover:underline mr-2" data-id="${insumo.id}">Editar</button>
                        <button class="delete-insumo-btn text-red-600 hover:underline" data-id="${insumo.id}">Excluir</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function saveInsumoData(id, data) {
            try {
                if (id) {
                    const index = insumosCache.findIndex(i => i.id === id);
                    if (index > -1) {
                         insumosCache[index] = { ...insumosCache[index], ...data };
                    }
                } else {
                    data.id = `insumo_${Date.now()}_${Math.random()}`; // Simple unique ID
                    insumosCache.push(data);
                }
                saveToStorage(STORAGE_KEYS.insumos, insumosCache);
                
                updateInsumosView();
                updateDashboard(insumosCache, ordensCache);

                document.getElementById('insumo-form').reset();
                document.getElementById('insumo-modal').classList.remove('active');
                document.getElementById('shelf-life-alert-modal').classList.remove('active');
            } catch(error) {
                 console.error("Error saving insumo batch: ", error);
                 alert("Erro ao salvar o insumo.");
            } finally {
                tempInsumoData = null;
            }
        }
        
        document.getElementById('insumo-form').addEventListener('submit', (e) => {
             e.preventDefault();
             const id = document.getElementById('insumo-id').value;
             const codigo = document.getElementById('insumo-codigo').value.trim();
             const calculatedLevels = calculateStockLevels(codigo, ordensCache);
             let shelfLifePercentual = null;
             
             const dataFabricacao = document.getElementById('insumo-data-fabricacao').value;
             const validade = document.getElementById('insumo-validade').value;
             const dataRecebimento = document.getElementById('insumo-data-recebimento').value;

             if (dataFabricacao && validade && dataRecebimento) {
                 const fabDate = new Date(dataFabricacao + 'T00:00:00');
                 const valDate = new Date(validade + 'T00:00:00');
                 const recDate = new Date(dataRecebimento + 'T00:00:00');

                 const totalShelfLife = daysBetween(valDate, fabDate);
                 const remainingShelfLife = daysBetween(valDate, recDate);
                 
                 if (totalShelfLife > 0) {
                    shelfLifePercentual = (remainingShelfLife / totalShelfLife) * 100;
                 }
             }
             
             const insumoData = {
                 codigo: codigo,
                 nome: document.getElementById('insumo-nome').value.trim(),
                 fornecedor: document.getElementById('insumo-fornecedor').value.trim(),
                 lote: document.getElementById('insumo-lote').value.trim(),
                 estoque: parseFloat(document.getElementById('insumo-estoque').value),
                 estoqueMinimo: parseFloat(calculatedLevels.min),
                 dataFabricacao: dataFabricacao || null,
                 dataRecebimento: dataRecebimento,
                 validade: validade,
                 shelfLifePercentualRecebimento: shelfLifePercentual,
                 quemAutorizou: null
             };

             if (shelfLifePercentual !== null && shelfLifePercentual < 75) {
                 if (new Date(dataFabricacao) > new Date(dataRecebimento) || new Date(dataRecebimento) > new Date(validade)) {
                     alert('Datas inconsistentes! A Data de Recebimento deve ser entre a Fabricação e a Validade.');
                     return;
                 }
                 tempInsumoData = { id, data: insumoData };
                 const alertMessage = document.getElementById('shelf-life-alert-message');
                 alertMessage.querySelector('strong').textContent = `${shelfLifePercentual.toFixed(1)}%`;
                 document.getElementById('shelf-life-authorizer').value = '';
                 document.getElementById('shelf-life-alert-modal').classList.add('active');
                 return; 
             }
             saveInsumoData(id, insumoData);
        });

        document.getElementById('confirm-shelf-life-btn').addEventListener('click', () => {
            const authorizer = document.getElementById('shelf-life-authorizer').value.trim();
            if (!authorizer) {
                alert('O nome do responsável pela autorização é obrigatório.');
                return;
            }
            if (tempInsumoData) {
                tempInsumoData.data.quemAutorizou = authorizer;
                saveInsumoData(tempInsumoData.id, tempInsumoData.data);
            }
        });

        document.getElementById('cancel-shelf-life-btn').addEventListener('click', () => {
            tempInsumoData = null;
            document.getElementById('shelf-life-alert-modal').classList.remove('active');
        });

        document.getElementById('insumo-codigo').addEventListener('blur', () => {
            const codigo = document.getElementById('insumo-codigo').value.trim();
            if (codigo) {
                const levels = calculateStockLevels(codigo, ordensCache);
                document.getElementById('sugerido-min').textContent = levels.min;
                document.getElementById('sugerido-max').textContent = levels.max;
                document.getElementById('stock-levels-info').classList.remove('hidden');
            } else {
                document.getElementById('stock-levels-info').classList.add('hidden');
            }
        });
        
        document.getElementById('search-insumo').addEventListener('input', (e) => {
            insumosSearchTerm = e.target.value;
            updateInsumosView();
        });

        document.querySelector('#view-insumos thead').addEventListener('click', (e) => {
            const header = e.target.closest('[data-sort]');
            if (!header) return;

            const sortKey = header.dataset.sort;
            if (insumosSortConfig.key === sortKey) {
                insumosSortConfig.direction = insumosSortConfig.direction === 'asc' ? 'desc' : 'asc';
            } else {
                insumosSortConfig.key = sortKey;
                insumosSortConfig.direction = 'asc';
            }
            updateInsumosView();
        });


        document.getElementById('insumos-table-body').addEventListener('click', e => {
            const target = e.target;
            const insumoId = target.dataset.id;
            
            if (target.classList.contains('edit-insumo-btn')) {
                const insumo = insumosCache.find(i => i.id === insumoId);
                document.getElementById('insumo-modal-title').textContent = "Editar Lote de Insumo";
                document.getElementById('insumo-id').value = insumo.id;
                document.getElementById('insumo-codigo').value = insumo.codigo;
                document.getElementById('insumo-nome').value = insumo.nome;
                document.getElementById('insumo-fornecedor').value = insumo.fornecedor;
                document.getElementById('insumo-lote').value = insumo.lote;
                document.getElementById('insumo-estoque').value = insumo.estoque;
                document.getElementById('insumo-data-fabricacao').value = insumo.dataFabricacao;
                document.getElementById('insumo-data-recebimento').value = insumo.dataRecebimento;
                document.getElementById('insumo-validade').value = insumo.validade;
                document.getElementById('stock-levels-info').classList.add('hidden');
                document.getElementById('insumo-modal').classList.add('active');
            } else if (target.classList.contains('delete-insumo-btn')) {
                if(confirm('Tem certeza que deseja excluir este lote de insumo?')) {
                    insumosCache = insumosCache.filter(i => i.id !== insumoId);
                    saveToStorage(STORAGE_KEYS.insumos, insumosCache);
                    updateInsumosView();
                    updateDashboard(insumosCache, ordensCache);
                }
            } else if (target.classList.contains('view-history-btn')) {
                const insumoCodigo = target.dataset.codigo;
                const insumoNome = target.dataset.nome;
                showInsumoHistory(insumoCodigo, insumoNome);
            }
        });
        
        document.getElementById('add-insumo-btn').addEventListener('click', () => {
            document.getElementById('insumo-modal-title').textContent = "Adicionar Novo Lote de Insumo";
            document.getElementById('insumo-form').reset();
            document.getElementById('insumo-id').value = '';
            document.getElementById('insumo-data-recebimento').value = getToday();
            document.getElementById('stock-levels-info').classList.add('hidden');
        });

        // --- INSUMO HISTORY ---
        function showInsumoHistory(insumoCodigo, insumoNome) {
            const modal = document.getElementById('insumo-history-modal');
            const title = document.getElementById('insumo-history-title');
            const entradasBody = document.getElementById('insumo-history-entradas-body');
            const saidasBody = document.getElementById('insumo-history-saidas-body');

            title.textContent = `Histórico do Insumo: ${insumoNome} (Cód: ${insumoCodigo})`;
            entradasBody.innerHTML = '';
            saidasBody.innerHTML = '';
            
            const levels = calculateStockLevels(insumoCodigo, ordensCache);
            const avgDailyConsumption = parseFloat(levels.avg);
            document.getElementById('stats-avg-daily').textContent = `${levels.avg} kg`;
            document.getElementById('stats-min').textContent = `${levels.min} kg`;
            document.getElementById('stats-max').textContent = `${levels.max} kg`;

            const lotesDoInsumo = insumosCache.filter(i => i.codigo === insumoCodigo);
            if(lotesDoInsumo.length === 0) {
                 entradasBody.innerHTML = '<tr><td colspan="6" class="text-center p-4 text-gray-500">Nenhum lote registrado para este insumo.</td></tr>';
            } else {
                 const today = new Date();
                 lotesDoInsumo.forEach(lote => {
                    const tr = document.createElement('tr');
                    tr.className = 'border-b';
                    
                    const diasRestantes = daysBetween(lote.validade, today);
                    const shelfLifeRecebimento = lote.shelfLifePercentualRecebimento ? `${lote.shelfLifePercentualRecebimento.toFixed(1)}%` : 'N/A';
                    
                    let estimativaConsumo = 'N/A';
                    let alerta = '';
                    if (avgDailyConsumption > 0 && parseFloat(lote.estoque) > 0) {
                        const diasParaConsumir = parseFloat(lote.estoque) / avgDailyConsumption;
                        const dataEstimada = new Date();
                        dataEstimada.setDate(today.getDate() + diasParaConsumir);
                        estimativaConsumo = formatDate(dataEstimada.toISOString().split('T')[0]);

                        if (dataEstimada > new Date(lote.validade)) {
                            alerta = '<span title="Risco de vencer antes do consumo total" class="ml-2">⚠️</span>';
                        }
                    }

                    tr.innerHTML = `
                        <td class="p-2">${lote.lote}</td>
                        <td class="p-2">${parseFloat(lote.estoque).toFixed(3)}</td>
                        <td class="p-2">${shelfLifeRecebimento}</td>
                        <td class="p-2">${formatDate(lote.validade)}</td>
                        <td class="p-2 ${diasRestantes < 30 ? 'text-yellow-600' : ''} ${diasRestantes <= 0 ? 'text-red-600 font-bold' : ''}">${diasRestantes > 0 ? diasRestantes : 'Vencido'}</td>
                        <td class="p-2">${estimativaConsumo} ${alerta}</td>
                    `;
                    entradasBody.appendChild(tr);
                });
            }
           
            // Combine saidas from Ordens and Requisições
            const saidas = [];
            ordensCache.forEach(ordem => {
                ordem.insumosUtilizados.forEach(insumoUsado => {
                    if (insumoUsado.codigo === insumoCodigo) {
                        saidas.push({
                            data: ordem.dataProducao,
                            tipo: 'Produção',
                            destino: ordem.produtoNome,
                            quantidade: insumoUsado.dosagemTotal,
                            lote: insumoUsado.lote
                        });
                    }
                });
            });
            requisicoesCache.forEach(req => {
                req.items.forEach(item => {
                     if (item.codigo === insumoCodigo) {
                        saidas.push({
                            data: req.data,
                            tipo: 'Requisição',
                            destino: req.motivo,
                            quantidade: item.quantidade,
                            lote: item.lote
                        });
                    }
                });
            });


            if (saidas.length === 0) {
                saidasBody.innerHTML = '<tr><td colspan="5" class="text-center p-4 text-gray-500">Nenhuma saída registrada para este insumo.</td></tr>';
            } else {
                saidas.sort((a,b) => new Date(b.data) - new Date(a.data));
                saidas.forEach(saida => {
                    const tr = document.createElement('tr');
                    tr.className = 'border-b';
                    tr.innerHTML = `
                        <td class="p-2">${formatDate(saida.data)}</td>
                        <td class="p-2">${saida.tipo}</td>
                        <td class="p-2">${saida.destino}</td>
                        <td class="p-2">${saida.quantidade}</td>
                        <td class="p-2">${saida.lote}</td>
                    `;
                    saidasBody.appendChild(tr);
                });
            }

            modal.classList.add('active');
        }

        // --- PRODUTOS E RECEITAS ---
        function loadProdutos() {
            produtosCache = loadFromStorage(STORAGE_KEYS.produtos);
            renderProdutosTable(produtosCache);
        }
        
        function renderProdutosTable(produtos) {
            const tbody = document.getElementById('produtos-table-body');
            tbody.innerHTML = '';
            if (produtos.length === 0) {
                 tbody.innerHTML = '<tr><td colspan="4" class="text-center p-4 text-gray-500">Nenhum produto cadastrado.</td></tr>';
                 return;
            }
             const uniqueInsumos = [...new Map(insumosCache.map(item => [item['codigo'], item])).values()];
            produtos.forEach(produto => {
                const tr = document.createElement('tr');
                tr.className = 'border-b';
                
                const receitaHtml = (produto.receita || []).map(item => {
                    const insumoInfo = uniqueInsumos.find(i => i.codigo === item.insumoCodigo);
                    return `<span class="bg-gray-200 text-gray-700 px-2 py-1 rounded-full text-xs mr-1 mb-1 inline-block">${insumoInfo ? insumoInfo.nome : `Código ${item.insumoCodigo}`}: ${item.dosagem} kg</span>`;
                }).join('');

                tr.innerHTML = `
                    <td class="p-3 font-medium">${produto.nome}</td>
                    <td class="p-3">${produto.linha}</td>
                    <td class="p-3">${receitaHtml || 'Sem receita definida'}</td>
                    <td class="p-3">
                        <button class="edit-produto-btn text-blue-600 hover:underline mr-2" data-id="${produto.id}">Editar</button>
                        <button class="delete-produto-btn text-red-600 hover:underline" data-id="${produto.id}">Excluir</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        document.getElementById('add-receita-item-btn').addEventListener('click', () => {
             addReceitaItem();
        });

        function addReceitaItem(item = { insumoCodigo: '', dosagem: '' }) {
            const container = document.getElementById('receita-container');
            const div = document.createElement('div');
            div.className = 'flex items-center space-x-2';

            const uniqueInsumos = [...new Map(insumosCache.map(item => [item['codigo'], item])).values()];

            const select = document.createElement('select');
            select.className = 'receita-insumo-select p-2 border rounded-lg flex-1';
            select.innerHTML = '<option value="">Selecione um insumo</option>' + uniqueInsumos.map(i => `<option value="${i.codigo}">${i.nome} (Cód: ${i.codigo})</option>`).join('');
            select.value = item.insumoCodigo;

            const input = document.createElement('input');
            input.type = 'number';
            input.step = '0.001';
            input.className = 'receita-dosagem-input p-2 border rounded-lg w-32';
            input.placeholder = 'Dosagem (kg)';
            input.value = item.dosagem;

            const button = document.createElement('button');
            button.type = 'button';
            button.textContent = 'Remover';
            button.className = 'text-red-500 text-sm hover:underline';
            button.onclick = () => div.remove();
            
            div.appendChild(select);
            div.appendChild(input);
            div.appendChild(button);
            container.appendChild(div);
        }
        
        document.getElementById('produto-form').addEventListener('submit', e => {
             e.preventDefault();
             const id = document.getElementById('produto-id').value;
             const receitaItems = document.querySelectorAll('#receita-container > div');
             const receita = Array.from(receitaItems).map(item => ({
                 insumoCodigo: item.querySelector('.receita-insumo-select').value,
                 dosagem: item.querySelector('.receita-dosagem-input').value,
             })).filter(i => i.insumoCodigo && i.dosagem);

             const produtoData = {
                 nome: document.getElementById('produto-nome').value,
                 linha: document.getElementById('produto-linha').value,
                 receita: receita
             };
             
            if (id) {
                const index = produtosCache.findIndex(p => p.id === id);
                if (index > -1) {
                    produtosCache[index] = { ...produtosCache[index], ...produtoData };
                }
            } else {
                produtoData.id = `produto_${Date.now()}`;
                produtosCache.push(produtoData);
            }

            saveToStorage(STORAGE_KEYS.produtos, produtosCache);
            renderProdutosTable(produtosCache);
            document.getElementById('produto-modal').classList.remove('active');
        });
        
        document.getElementById('produtos-table-body').addEventListener('click', e => {
            const produtoId = e.target.dataset.id;
            if (e.target.classList.contains('edit-produto-btn')) {
                 const produto = produtosCache.find(p => p.id === produtoId);
                 document.getElementById('produto-modal-title').textContent = "Editar Produto";
                 document.getElementById('produto-id').value = produto.id;
                 document.getElementById('produto-nome').value = produto.nome;
                 document.getElementById('produto-linha').value = produto.linha;
                 document.getElementById('receita-container').innerHTML = '';
                 (produto.receita || []).forEach(item => addReceitaItem(item));
                 document.getElementById('produto-modal').classList.add('active');
            } else if (e.target.classList.contains('delete-produto-btn')) {
                 if(confirm('Tem certeza que deseja excluir este produto?')) {
                    produtosCache = produtosCache.filter(p => p.id !== produtoId);
                    saveToStorage(STORAGE_KEYS.produtos, produtosCache);
                    renderProdutosTable(produtosCache);
                 }
            }
        });

        document.getElementById('add-produto-btn').addEventListener('click', () => {
            document.getElementById('produto-modal-title').textContent = "Adicionar Novo Produto";
            document.getElementById('produto-form').reset();
            document.getElementById('produto-id').value = '';
            document.getElementById('receita-container').innerHTML = '';
            addReceitaItem();
        });
        
        // --- ORDENS DE PRODUÇÃO ---
        function loadOrdens() {
            ordensCache = loadFromStorage(STORAGE_KEYS.ordens);
            renderOrdensTable(ordensCache);
        }

        function resetOrdemForm() {
            document.getElementById('ordem-form').reset();
            document.getElementById('ordem-modal-title').textContent = "Nova Ordem de Produção";
            document.getElementById('ordem-data-producao').value = getToday();
            document.getElementById('ordem-insumos-table').innerHTML = '';
            document.getElementById('ordem-stock-warning').classList.add('hidden');
        }

        function populateProdutoSelectForOrdem(filterLine = null) {
            const select = document.getElementById('ordem-produto');
            select.innerHTML = '<option value="">Selecione um produto...</option>';
            const filteredProdutos = filterLine ? produtosCache.filter(p => p.linha === filterLine) : produtosCache;

            filteredProdutos.forEach(produto => {
                const option = document.createElement('option');
                option.value = produto.id;
                option.textContent = produto.nome;
                select.appendChild(option);
            });
        }

        document.getElementById('add-ordem-btn').addEventListener('click', () => {
            resetOrdemForm();
            populateProdutoSelectForOrdem(); // show all
            document.getElementById('ordem-modal').classList.add('active');
        });
        
        async function updateOrdemInsumosTable() {
             const produtoId = document.getElementById('ordem-produto').value;
             const quantidade = parseInt(document.getElementById('ordem-receitas').value) || 1;
             const tbody = document.getElementById('ordem-insumos-table');
             const warningDiv = document.getElementById('ordem-stock-warning');
             tbody.innerHTML = '';
             warningDiv.classList.add('hidden');
             warningDiv.textContent = '';
             
             if (!produtoId) return;

             const produto = produtosCache.find(p => p.id === produtoId);
             document.getElementById('ordem-linha').value = produto.linha;
             
             if (!produto || !produto.receita) return;

             let allStockSufficient = true;
             
             for (const item of produto.receita) {
                let requiredQuantity = parseFloat(item.dosagem) * quantidade;
                
                const availableBatches = insumosCache
                    .filter(i => i.codigo === item.insumoCodigo && parseFloat(i.estoque) > 0)
                    .sort((a,b) => new Date(a.validade) - new Date(b.validade));

                const insumoInfo = availableBatches[0] || insumosCache.find(i => i.codigo === item.insumoCodigo) || {nome: "Desconhecido"};
                
                if (availableBatches.length === 0) {
                    warningDiv.textContent += `Estoque esgotado para ${insumoInfo.nome} (Cód: ${item.insumoCodigo}). `;
                    allStockSufficient = false;
                    continue;
                }

                let remainingRequired = requiredQuantity;
                for (const batch of availableBatches) {
                    if (remainingRequired <= 0) break;
                    
                    const quantityToUse = Math.min(remainingRequired, parseFloat(batch.estoque));
                    addOrdemInsumoRow(insumoInfo, quantityToUse, batch, availableBatches);
                    remainingRequired -= quantityToUse;
                }

                if (remainingRequired > 0.001) { 
                    warningDiv.textContent += `Estoque insuficiente para ${insumoInfo.nome}. Necessário: ${requiredQuantity.toFixed(3)}kg. Disponível: ${(requiredQuantity - remainingRequired).toFixed(3)}kg. `;
                    allStockSufficient = false;
                }
             }
             if (!allStockSufficient) {
                warningDiv.classList.remove('hidden');
             }
        }
        
        function addOrdemInsumoRow(insumoInfo, quantityToUse, selectedBatch, allAvailableBatches) {
             const tbody = document.getElementById('ordem-insumos-table');
             const tr = document.createElement('tr');
             tr.className = 'border-b';
             tr.dataset.insumoCodigo = insumoInfo.codigo;

             const batchOptions = allAvailableBatches.map(b => 
                `<option value="${b.id}" ${b.id === selectedBatch.id ? 'selected' : ''}>
                    Lote: ${b.lote} (Estoque: ${b.estoque}kg, Val: ${formatDate(b.validade)})
                 </option>`
             ).join('');

             tr.innerHTML = `
                 <td class="p-2">${insumoInfo.nome}</td>
                 <td class="p-2">
                    <input type="number" step="0.001" class="w-24 p-1 border rounded-md text-sm ordem-insumo-qty" value="${quantityToUse.toFixed(3)}" required>
                 </td>
                 <td class="p-2">
                    <select class="w-full p-1 border rounded-md text-sm ordem-insumo-lote">${batchOptions}</select>
                 </td>
                 <td class="p-2">${selectedBatch.fornecedor}</td>
                 <td class="p-2">
                    <input type="text" class="w-full p-1 border rounded-md text-sm ordem-insumo-manipulador" placeholder="Nome (Opcional)">
                 </td>
             `;
             tbody.appendChild(tr);
        }

        document.getElementById('ordem-produto').addEventListener('change', updateOrdemInsumosTable);
        document.getElementById('ordem-receitas').addEventListener('input', updateOrdemInsumosTable);
        
        document.getElementById('ordem-form').addEventListener('submit', e => {
            e.preventDefault();

            const updates = [];
            const insumosUtilizados = [];
            const insumoRows = document.querySelectorAll('#ordem-insumos-table tr');
            
            for (const row of insumoRows) {
                const batchId = row.querySelector('.ordem-insumo-lote').value;
                const quantityToUse = parseFloat(row.querySelector('.ordem-insumo-qty').value);
                const manipulador = row.querySelector('.ordem-insumo-manipulador').value.trim();
                
                const batch = insumosCache.find(i => i.id === batchId);

                if (quantityToUse > parseFloat(batch.estoque)) {
                     alert(`Estoque insuficiente para o lote ${batch.lote} de ${batch.nome}. Tentando usar: ${quantityToUse}kg, Disponível: ${batch.estoque}kg.`);
                     return;
                }

                const novoEstoque = parseFloat(batch.estoque) - quantityToUse;
                updates.push({ batchId: batch.id, newStock: novoEstoque.toFixed(3) });
                
                insumosUtilizados.push({
                    insumoId: batch.id,
                    codigo: batch.codigo,
                    nome: batch.nome,
                    lote: batch.lote,
                    fornecedor: batch.fornecedor,
                    validade: batch.validade,
                    dosagemTotal: quantityToUse.toFixed(3),
                    manipulador: manipulador
                });
            }

            const ordemData = {
                id: `ordem_${Date.now()}`,
                produtoNome: document.getElementById('ordem-produto').options[document.getElementById('ordem-produto').selectedIndex].text,
                linhaProducao: document.getElementById('ordem-linha').value,
                quantidadeReceitas: document.getElementById('ordem-receitas').value,
                loteProduto: document.getElementById('ordem-lote').value,
                dataProducao: document.getElementById('ordem-data-producao').value,
                validadeProduto: document.getElementById('ordem-validade-produto').value,
                insumosUtilizados: insumosUtilizados,
                createdAt: new Date().toISOString()
            };

            updates.forEach(update => {
                const index = insumosCache.findIndex(i => i.id === update.batchId);
                if (index > -1) {
                    insumosCache[index].estoque = update.newStock;
                }
            });
            saveToStorage(STORAGE_KEYS.insumos, insumosCache);

            ordensCache.push(ordemData);
            saveToStorage(STORAGE_KEYS.ordens, ordensCache);

            renderOrdensTable(ordensCache);
            updateInsumosView();
            updateDashboard(insumosCache, ordensCache);
            document.getElementById('ordem-modal').classList.remove('active');
        });

        
        function renderOrdensTable(ordens) {
            const tbody = document.getElementById('ordens-table-body');
            tbody.innerHTML = '';
            if (ordens.length === 0) {
                 tbody.innerHTML = '<tr><td colspan="6" class="text-center p-4 text-gray-500">Nenhuma ordem de produção cadastrada.</td></tr>';
                 return;
            }

            ordens.sort((a,b) => new Date(b.dataProducao) - new Date(a.dataProducao));

            ordens.forEach(ordem => {
                const tr = document.createElement('tr');
                tr.className = 'border-b';
                const manipulators = [...new Set(ordem.insumosUtilizados.map(i => i.manipulador))].filter(Boolean).join(', ');
                tr.innerHTML = `
                    <td class="p-3 font-medium">${ordem.loteProduto || 'N/A'}</td>
                    <td class="p-3">${ordem.produtoNome}</td>
                    <td class="p-3">${formatDate(ordem.dataProducao)}</td>
                    <td class="p-3">${ordem.quantidadeReceitas}</td>
                    <td class="p-3">${manipulators || 'N/A'}</td>
                    <td class="p-3">
                        <button class="view-ordem-btn text-blue-600 hover:underline" data-id='${ordem.id}'>Ver Detalhes</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            document.querySelectorAll('.view-ordem-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const ordem = ordensCache.find(o => o.id === btn.dataset.id);
                    showOrdemDetails(ordem);
                });
            });
        }

        function showOrdemDetails(ordem) {
            const contentDiv = document.getElementById('view-ordem-content');
            
            const insumosHtml = ordem.insumosUtilizados.map(insumo => {
                 return `
                    <tr class="border-b">
                        <td class="p-2">${insumo.codigo || 'N/A'}</td>
                        <td class="p-2">${insumo.nome}</td>
                        <td class="p-2">${insumo.dosagemTotal} kg</td>
                        <td class="p-2">${insumo.lote}</td>
                        <td class="p-2">${formatDate(insumo.validade)}</td>
                        <td class="p-2">${insumo.fornecedor || 'N/A'}</td>
                        <td class="p-2">${insumo.manipulador || 'N/A'}</td>
                    </tr>
                 `;
            }).join('');

            contentDiv.innerHTML = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 p-4 border rounded-lg bg-gray-50 text-sm">
                        <div><strong class="block text-gray-500">Produto:</strong> ${ordem.produtoNome}</div>
                        <div><strong class="block text-gray-500">Lote do Produto:</strong> ${ordem.loteProduto || 'Não informado'}</div>
                        <div><strong class="block text-gray-500">Qtd. Receitas:</strong> ${ordem.quantidadeReceitas}</div>
                        <div><strong class="block text-gray-500">Linha:</strong> ${ordem.linhaProducao}</div>
                        <div><strong class="block text-gray-500">Data Produção:</strong> ${formatDate(ordem.dataProducao)}</div>
                        <div><strong class="block text-gray-500">Validade Produto:</strong> ${formatDate(ordem.validadeProduto)}</div>
                    </div>
                    <div>
                        <h4 class="font-semibold text-md mt-4 mb-2">Insumos Utilizados</h4>
                        <table class="w-full text-sm text-left">
                           <thead class="bg-gray-100">
                               <tr>
                                   <th class="p-2">Código</th>
                                   <th class="p-2">Insumo</th>
                                   <th class="p-2">Dosagem Total</th>
                                   <th class="p-2">Lote Insumo</th>
                                   <th class="p-2">Validade Insumo</th>
                                   <th class="p-2">Fornecedor</th>
                                   <th class="p-2">Manipulador</th>
                               </tr>
                           </thead>
                           <tbody>${insumosHtml}</tbody>
                        </table>
                    </div>
                </div>
            `;

            document.getElementById('view-ordem-modal').classList.add('active');
        }

        // --- REQUISIÇÕES ---
        function loadRequisicoes() {
            requisicoesCache = loadFromStorage(STORAGE_KEYS.requisicoes);
            renderRequisicoesTable(requisicoesCache);
        }
        
        function renderRequisicoesTable(requisicoes) {
            const tbody = document.getElementById('requisicoes-table-body');
            tbody.innerHTML = '';
             if (requisicoes.length === 0) {
                 tbody.innerHTML = '<tr><td colspan="5" class="text-center p-4 text-gray-500">Nenhuma requisição encontrada.</td></tr>';
                 return;
            }
            requisicoes.sort((a,b) => new Date(b.data) - new Date(a.data));
            requisicoes.forEach(req => {
                const tr = document.createElement('tr');
                tr.className = 'border-b';
                const itemsSummary = req.items.map(i => `${i.nome} (${i.quantidade} kg)`).join(', ');
                tr.innerHTML = `
                    <td class="p-3">${formatDate(req.data)}</td>
                    <td class="p-3">${req.responsavel}</td>
                    <td class="p-3">${req.motivo}</td>
                    <td class="p-3 text-xs">${itemsSummary}</td>
                    <td class="p-3">
                         <button class="view-requisicao-btn text-blue-600 hover:underline" data-id='${req.id}'>Ver Detalhes</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            document.querySelectorAll('.view-requisicao-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const req = requisicoesCache.find(r => r.id === btn.dataset.id);
                    showRequisicaoDetails(req);
                });
            });
        }
        
        document.getElementById('add-requisicao-btn').addEventListener('click', () => {
            document.getElementById('requisicao-form').reset();
            document.getElementById('requisicao-data').value = getToday();
            document.getElementById('requisicao-items-container').innerHTML = '';
            addRequisicaoItem();
            document.getElementById('requisicao-modal').classList.add('active');
        });
        
        function addRequisicaoItem() {
            const container = document.getElementById('requisicao-items-container');
            const itemDiv = document.createElement('div');
            itemDiv.className = 'grid grid-cols-3 gap-3 p-3 border rounded-lg';

            const uniqueInsumos = [...new Map(insumosCache.map(item => [item['codigo'], item])).values()];

            itemDiv.innerHTML = `
                <div>
                    <label class="text-xs">Insumo</label>
                    <select class="req-item-insumo w-full p-1 border rounded-md text-sm">
                        <option value="">Selecione...</option>
                        ${uniqueInsumos.map(i => `<option value="${i.codigo}">${i.nome} (Cód: ${i.codigo})</option>`).join('')}
                    </select>
                </div>
                <div>
                    <label class="text-xs">Lote</label>
                    <select class="req-item-lote w-full p-1 border rounded-md text-sm" disabled>
                        <option value="">Escolha um insumo...</option>
                    </select>
                </div>
                 <div>
                    <label class="text-xs">Quantidade (kg)</label>
                    <div class="flex">
                        <input type="number" step="0.001" class="req-item-qty w-full p-1 border rounded-md text-sm" disabled>
                        <button type="button" class="remove-req-item-btn text-red-500 ml-2 px-2 hover:bg-red-100 rounded">X</button>
                    </div>
                </div>
            `;
            container.appendChild(itemDiv);
        }
        
        document.getElementById('add-requisicao-item-btn').addEventListener('click', addRequisicaoItem);

        document.getElementById('requisicao-items-container').addEventListener('click', e => {
            if (e.target.classList.contains('remove-req-item-btn')) {
                e.target.closest('.grid').remove();
            }
        });

        document.getElementById('requisicao-items-container').addEventListener('change', e => {
            if (e.target.classList.contains('req-item-insumo')) {
                const insumoCodigo = e.target.value;
                const row = e.target.closest('.grid');
                const loteSelect = row.querySelector('.req-item-lote');
                const qtyInput = row.querySelector('.req-item-qty');
                loteSelect.innerHTML = '<option value="">Carregando...</option>';
                loteSelect.disabled = true;
                qtyInput.disabled = true;

                if (!insumoCodigo) {
                    loteSelect.innerHTML = '<option value="">Escolha um insumo...</option>';
                    return;
                }
                const availableBatches = insumosCache.filter(i => i.codigo === insumoCodigo && parseFloat(i.estoque) > 0);
                if (availableBatches.length > 0) {
                     loteSelect.innerHTML = '<option value="">Selecione o lote...</option>' + availableBatches.map(b => 
                        `<option value="${b.id}">Lote: ${b.lote} (Estoque: ${b.estoque} kg)</option>`
                     ).join('');
                     loteSelect.disabled = false;
                     qtyInput.disabled = false;
                } else {
                     loteSelect.innerHTML = '<option value="">Sem estoque</option>';
                }
            }
        });

        document.getElementById('requisicao-form').addEventListener('submit', e => {
            e.preventDefault();
            const updates = [];
            const items = [];
            
            for(const itemRow of document.querySelectorAll('#requisicao-items-container .grid')) {
                const loteId = itemRow.querySelector('.req-item-lote').value;
                const quantidade = parseFloat(itemRow.querySelector('.req-item-qty').value);
                
                if (!loteId || !quantidade || quantidade <= 0) {
                    alert('Por favor, preencha todos os campos dos itens da requisição.');
                    return;
                }
                
                const lote = insumosCache.find(i => i.id === loteId);
                if (quantidade > parseFloat(lote.estoque)) {
                     alert(`Estoque insuficiente para o lote ${lote.lote} de ${lote.nome}.`);
                     return;
                }
                
                const novoEstoque = parseFloat(lote.estoque) - quantidade;
                updates.push({ batchId: lote.id, newStock: novoEstoque.toFixed(3) });
                items.push({
                    codigo: lote.codigo,
                    nome: lote.nome,
                    lote: lote.lote,
                    quantidade: quantidade.toFixed(3)
                });
            }

            const requisicaoData = {
                id: `req_${Date.now()}`,
                data: document.getElementById('requisicao-data').value,
                responsavel: document.getElementById('requisicao-responsavel').value,
                motivo: document.getElementById('requisicao-motivo').value,
                items: items,
                createdAt: new Date().toISOString()
            };

            updates.forEach(update => {
                const index = insumosCache.findIndex(i => i.id === update.batchId);
                if (index > -1) {
                    insumosCache[index].estoque = update.newStock;
                }
            });
            saveToStorage(STORAGE_KEYS.insumos, insumosCache);

            requisicoesCache.push(requisicaoData);
            saveToStorage(STORAGE_KEYS.requisicoes, requisicoesCache);
            
            renderRequisicoesTable(requisicoesCache);
            updateInsumosView();
            updateDashboard(insumosCache, ordensCache);
            document.getElementById('requisicao-modal').classList.remove('active');
        });
        
        function showRequisicaoDetails(req) {
            const contentDiv = document.getElementById('view-requisicao-content');
            
            const itemsHtml = req.items.map(item => `
                <tr class="border-b">
                    <td class="p-2">${item.codigo}</td>
                    <td class="p-2">${item.nome}</td>
                    <td class="p-2">${item.lote}</td>
                    <td class="p-2">${item.quantidade} kg</td>
                </tr>
            `).join('');

            contentDiv.innerHTML = `
                 <div class="space-y-4">
                    <div class="grid grid-cols-3 gap-4 p-4 border rounded-lg bg-gray-50 text-sm">
                        <div><strong class="block text-gray-500">Data:</strong> ${formatDate(req.data)}</div>
                        <div><strong class="block text-gray-500">Responsável:</strong> ${req.responsavel}</div>
                        <div><strong class="block text-gray-500">Motivo:</strong> ${req.motivo}</div>
                    </div>
                    <div>
                        <h4 class="font-semibold text-md mt-4 mb-2">Itens Requisitados</h4>
                        <table class="w-full text-sm text-left">
                           <thead class="bg-gray-100">
                               <tr>
                                   <th class="p-2">Código</th>
                                   <th class="p-2">Insumo</th>
                                   <th class="p-2">Lote</th>
                                   <th class="p-2">Quantidade</th>
                               </tr>
                           </thead>
                           <tbody>${itemsHtml}</tbody>
                        </table>
                    </div>
                </div>
            `;
            document.getElementById('view-requisicao-modal').classList.add('active');
        }



        // --- PDF EXPORT ---
        document.getElementById('export-pdf-btn').addEventListener('click', () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
            const today = getToday();
            const todayFormatted = new Date().toLocaleDateString('pt-BR', { timeZone: 'UTC' });

            const dailyOrders = ordensCache.filter(ordem => ordem.dataProducao === today);

            if (dailyOrders.length === 0) {
                alert('Nenhuma ordem de produção encontrada para a data de hoje.');
                return;
            }

            const productionLineColors = {
                'Pães Congelados': { bg: [235, 247, 255], text: [52, 152, 219] }, 
                'Pães Especiais': { bg: [230, 250, 230], text: [46, 204, 113] },  
                'Pão de Queijo': { bg: [255, 253, 230], text: [241, 196, 15] },   
                'Confeitaria': { bg: [244, 235, 247], text: [155, 89, 182] }    
            };
            
            let finalY = 25; 
            const pageMargin = 15;
            const pageWidth = doc.internal.pageSize.getWidth();

            doc.setFontSize(18);
            doc.setTextColor(40);
            doc.text(`Relatório de Produção`, pageWidth / 2, 15, { align: 'center' });
            doc.setFontSize(11);
            doc.setTextColor(150);
            doc.text(todayFormatted, pageWidth / 2, 21, { align: 'center' });


            dailyOrders.forEach((ordem, index) => {
                const colors = productionLineColors[ordem.linhaProducao] || { bg: [240, 240, 240], text: [80, 80, 80] };

                if (finalY > 220) { 
                    doc.addPage();
                    finalY = 20;
                }
                 if (index > 0) {
                    finalY += 10;
                }

                doc.setFillColor(colors.bg[0], colors.bg[1], colors.bg[2]);
                doc.roundedRect(pageMargin, finalY, pageWidth - (pageMargin * 2), 10, 2, 2, 'F');
                doc.setFontSize(14);
                doc.setTextColor(colors.text[0], colors.text[1], colors.text[2]);
                doc.setFont('helvetica', 'bold');
                doc.text(ordem.produtoNome, pageMargin + 4, finalY + 7);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(100);
                doc.setFontSize(10);
                doc.text(`Lote: ${ordem.loteProduto || 'N/A'}`, pageWidth - pageMargin - 4, finalY + 7, { align: 'right'});

                finalY += 15;

                doc.setFontSize(9);
                doc.setTextColor(80);
                doc.text(`Linha: ${ordem.linhaProducao}`, pageMargin, finalY);
                doc.text(`Quantidade: ${ordem.quantidadeReceitas} receitas`, pageWidth / 2, finalY);
                finalY += 5;
                doc.text(`Produzido em: ${formatDate(ordem.dataProducao)}`, pageMargin, finalY);
                doc.text(`Validade: ${formatDate(ordem.validadeProduto)}`, pageWidth / 2, finalY);
                
                finalY += 8;

                const tableColumn = ["Insumo", "Dosagem (kg)", "Lote", "Manipulador"];
                const tableRows = [];

                ordem.insumosUtilizados.forEach(insumo => {
                    const rowData = [
                        insumo.nome,
                        insumo.dosagemTotal,
                        insumo.lote,
                        insumo.manipulador
                    ];
                    tableRows.push(rowData);
                });

                doc.autoTable({
                    head: [tableColumn],
                    body: tableRows,
                    startY: finalY,
                    theme: 'grid',
                    headStyles: { 
                        fillColor: colors.text,
                        textColor: 255,
                        fontSize: 9
                    },
                    styles: {
                        fontSize: 8,
                        cellPadding: 2
                    },
                    margin: { left: pageMargin, right: pageMargin }
                });

                finalY = doc.autoTable.previous.finalY;
            });

            doc.save(`producao_${today.replace(/-/g, '_')}.pdf`);
        });
        
        document.getElementById('export-stock-pdf-btn').addEventListener('click', () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });

            const tableColumn = ["Insumo", "Lote", "Data Receb.", "Validade", "Estoque (kg)", "Autorizado Por"];
            const tableRows = [];
            
            displayedInsumos.forEach(insumo => {
                const rowData = [
                    insumo.nome,
                    insumo.lote,
                    formatDate(insumo.dataRecebimento),
                    formatDate(insumo.validade),
                    parseFloat(insumo.estoque).toFixed(3),
                    insumo.quemAutorizou || 'N/A'
                ];
                tableRows.push(rowData);
            });

            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: 20,
                theme: 'grid',
                headStyles: { 
                    fillColor: [41, 128, 185],
                    textColor: 255,
                    fontSize: 9
                },
                styles: {
                    fontSize: 8,
                    cellPadding: 2
                }
            });

            const pageCount = doc.internal.getNumberOfPages();
            const todayStr = new Date().toLocaleDateString('pt-BR');
            for(let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(14);
                doc.text('Relatório de Estoque de Insumos', doc.internal.pageSize.getWidth() / 2, 10, { align: 'center' });
                doc.setFontSize(10);
                doc.text(`Gerado em: ${todayStr}`, doc.internal.pageSize.getWidth() / 2, 15, { align: 'center' });
                doc.text(`Página ${i} de ${pageCount}`, doc.internal.pageSize.getWidth() - 20, doc.internal.pageSize.getHeight() - 10);
            }

            doc.save(`relatorio_estoque_${getToday().replace(/-/g, '_')}.pdf`);
        });

    </script>
</body>
</html>

