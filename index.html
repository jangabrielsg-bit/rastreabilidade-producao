<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Rastreabilidade e Controle de Estoque</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Bibliotecas para exporta√ß√£o -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .sidebar-icon {
            transition: all 0.2s ease-in-out;
        }
        .sidebar-icon:hover {
            transform: scale(1.1);
        }
        .active-nav {
            background-color: #4f46e5;
            color: white;
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .form-input {
            transition: border-color 0.2s;
        }
        .form-input:focus {
            border-color: #4f46e5;
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.25);
        }
        .table-header-sortable {
            cursor: pointer;
        }
        .table-header-sortable:hover {
            background-color: #f0f4f8;
        }
        .insufficient-stock-row {
            background-color: #fee2e2; /* Red-100 */
        }
        .insufficient-stock-row:hover {
            background-color: #fecaca; /* Red-200 */
        }
        @keyframes fade-in-out {
            0% { opacity: 0; transform: translateY(-20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }
        .animate-fade-in-out {
            animation: fade-in-out 4s ease-in-out forwards;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="loading-overlay" class="fixed inset-0 z-[101] flex items-center justify-center bg-white">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-indigo-600"></div>
    </div>

    <div class="flex h-screen">
        <!-- Sidebar -->
        <aside class="w-20 bg-gray-800 text-white flex flex-col items-center py-4 space-y-6">
            <div class="text-2xl font-bold">
                <i class="fa-solid fa-boxes-stacked"></i>
            </div>
            <nav class="flex flex-col items-center space-y-4">
                <a href="#" id="nav-entry" class="sidebar-icon p-3 rounded-lg active-nav" title="Entrada de Mercadorias">
                    <i class="fa-solid fa-dolly fa-lg"></i>
                </a>
                <a href="#" id="nav-inventory" class="sidebar-icon p-3 rounded-lg" title="Gerenciamento de Estoque">
                    <i class="fa-solid fa-warehouse fa-lg"></i>
                </a>
                <a href="#" id="nav-recipes" class="sidebar-icon p-3 rounded-lg" title="Receitas">
                    <i class="fa-solid fa-book-open fa-lg"></i>
                </a>
                <a href="#" id="nav-production" class="sidebar-icon p-3 rounded-lg" title="Ordens de Produ√ß√£o">
                    <i class="fa-solid fa-clipboard-list fa-lg"></i>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-6 md:p-8 overflow-y-auto">
            
            <!-- Tela de Registro de Entrada -->
            <div id="screen-entry">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Registro de Entrada de Mercadorias</h1>
                <div class="bg-white p-8 rounded-xl shadow-lg max-w-2xl mx-auto">
                    <form id="entry-form">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="col-span-1 md:col-span-2">
                                <label for="product-name" class="block text-sm font-medium text-gray-700">Nome do Produto</label>
                                <input type="text" id="product-name" name="product-name" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none form-input">
                            </div>
                            <div>
                                <label for="product-code" class="block text-sm font-medium text-gray-700">C√≥digo</label>
                                <input type="text" id="product-code" name="product-code" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none form-input">
                            </div>
                            <div>
                                <label for="supplier" class="block text-sm font-medium text-gray-700">Fornecedor</label>
                                <input type="text" id="supplier" name="supplier" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none form-input">
                            </div>
                            <div>
                                <label for="quantity" class="block text-sm font-medium text-gray-700">Quantidade Recebida</label>
                                <input type="number" id="quantity" name="quantity" required min="0.01" step="0.01" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none form-input">
                            </div>
                             <div>
                                <label for="batch-code" class="block text-sm font-medium text-gray-700">Lote</label>
                                <input type="text" id="batch-code" name="batch-code" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none form-input">
                            </div>
                            <div>
                                <label for="mfg-date" class="block text-sm font-medium text-gray-700">Data de Fabrica√ß√£o</label>
                                <input type="date" id="mfg-date" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none form-input">
                            </div>
                            <div>
                                <label for="receipt-date" class="block text-sm font-medium text-gray-700">Data de Recebimento</label>
                                <input type="date" id="receipt-date" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none form-input">
                            </div>
                            <div>
                                <label for="expiry-date" class="block text-sm font-medium text-gray-700">Data de Validade</label>
                                <input type="date" id="expiry-date" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none form-input">
                            </div>
                        </div>
                        <div class="mt-8 flex justify-end">
                            <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105">
                                Registrar Entrada
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Tela de Gerenciamento de Estoque -->
            <div id="screen-inventory" class="hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Gerenciamento de Estoque</h1>
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <div class="flex justify-between items-center mb-4">
                        <input type="text" id="search-inventory" placeholder="üîç Buscar item por nome, c√≥digo ou fornecedor..." class="w-full md:w-1/3 border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none form-input">
                        <button id="btn-export-excel" class="bg-white hover:bg-gray-100 text-gray-800 font-semibold py-2 px-4 border border-gray-300 rounded-lg shadow-sm">
                            <i class="fa-solid fa-file-excel text-green-600 mr-2"></i>Exportar para Excel
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 table-header-sortable" data-sort="name">Nome do Produto</th>
                                    <th scope="col" class="px-6 py-3 table-header-sortable" data-sort="code">C√≥digo</th>
                                    <th scope="col" class="px-6 py-3 table-header-sortable" data-sort="supplier">Fornecedor</th>
                                    <th scope="col" class="px-6 py-3 text-right">Qtd. Total</th>
                                    <th scope="col" class="px-6 py-3 table-header-sortable" data-sort="expiry">Pr√≥x. Validade</th>
                                </tr>
                            </thead>
                            <tbody id="inventory-table-body">
                                <!-- Linhas de invent√°rio ser√£o inseridas aqui -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Tela de Receitas -->
            <div id="screen-recipes" class="hidden">
                 <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">Receitas</h1>
                    <button id="btn-new-recipe" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                        <i class="fa-solid fa-plus mr-2"></i>Nova Receita
                    </button>
                </div>
                <div id="recipes-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Cards de categoria de receita ser√£o inseridos aqui -->
                </div>
            </div>
            
            <!-- Tela de Ordens de Produ√ß√£o -->
            <div id="screen-production" class="hidden">
                 <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">Ordens de Produ√ß√£o</h1>
                    <div>
                        <button id="btn-confirm-production" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 mr-2">
                            <i class="fa-solid fa-check-double mr-2"></i>Confirmar Produ√ß√£o do Dia
                        </button>
                        <button id="btn-new-production-order" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                            <i class="fa-solid fa-plus mr-2"></i>Nova Ordem
                        </button>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm mb-6 flex items-center justify-between">
                    <div class="flex items-center">
                        <label for="search-po-by-date" class="text-sm font-medium text-gray-700 mr-2">Filtrar por data:</label>
                        <input type="date" id="search-po-by-date" class="form-input">
                    </div>
                    <button id="btn-export-pdf" class="bg-white hover:bg-gray-100 text-gray-800 font-semibold py-2 px-4 border border-gray-300 rounded-lg shadow-sm">
                        <i class="fa-solid fa-file-pdf text-red-600 mr-2"></i>Exportar Relat√≥rio (PDF)
                    </button>
                </div>
                <div id="production-orders-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Ordens de produ√ß√£o ser√£o listadas aqui -->
                </div>
            </div>

        </main>
    </div>
    
    <!-- Modal de Alerta de Shelf Life -->
    <div id="shelf-life-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100">
                    <i class="fa-solid fa-triangle-exclamation text-yellow-600 text-2xl"></i>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mt-4">Alerta de Shelf Life</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500">
                        O shelf life do produto √© de <strong id="shelf-life-value"></strong>%, abaixo do m√≠nimo de 75%.
                    </p>
                    <p class="text-sm text-gray-600 mt-2">
                        Para prosseguir, insira o nome do respons√°vel que autorizou o recebimento.
                    </p>
                </div>
                <div class="mt-4">
                    <label for="authorizer-name" class="sr-only">Nome do Autorizador</label>
                    <input type="text" id="authorizer-name" placeholder="Nome do Respons√°vel" class="w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none form-input" required>
                </div>
            </div>
            <div class="mt-6 flex justify-center space-x-4">
                <button id="cancel-receipt-btn" type="button" class="py-2 px-4 bg-gray-200 text-gray-800 font-semibold rounded-lg shadow-md hover:bg-gray-300">
                    Cancelar
                </button>
                <button id="confirm-receipt-btn" type="button" class="py-2 px-4 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700">
                    Confirmar Recebimento
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Detalhes e Edi√ß√£o do Item -->
    <div id="item-details-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop p-4">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold" id="details-product-name">Nome do Produto</h2>
                <button id="close-details-modal" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            
            <!-- View Mode -->
            <div id="item-details-view">
                <div class="flex justify-end mb-4">
                    <button id="btn-edit-item" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md">
                        <i class="fa-solid fa-pencil mr-2"></i>Editar Item
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-sm">
                    <div><strong>C√≥digo:</strong> <span id="details-product-code"></span></div>
                    <div><strong>Fornecedor:</strong> <span id="details-supplier"></span></div>
                    <div><strong>Estoque Total:</strong> <span id="details-total-quantity"></span></div>
                    <div><strong>Estoque M√≠nimo:</strong> <span>10</span></div>
                    <div><strong>Estoque M√°ximo:</strong> <span>100</span></div>
                    <div><strong>Consumo Di√°rio (Est.):</strong> <span>2.5</span></div>
                </div>
            </div>

            <!-- Edit Mode -->
            <div id="item-details-edit" class="hidden">
                 <form id="edit-item-form">
                    <input type="hidden" id="edit-item-id">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="col-span-1 md:col-span-2">
                            <label for="edit-product-name" class="block text-sm font-medium text-gray-700">Nome do Produto</label>
                            <input type="text" id="edit-product-name" required class="mt-1 block w-full form-input">
                        </div>
                        <div>
                            <label for="edit-product-code" class="block text-sm font-medium text-gray-700">C√≥digo</label>
                            <input type="text" id="edit-product-code" required class="mt-1 block w-full form-input">
                        </div>
                        <div>
                            <label for="edit-supplier" class="block text-sm font-medium text-gray-700">Fornecedor</label>
                            <input type="text" id="edit-supplier" required class="mt-1 block w-full form-input">
                        </div>
                    </div>
                    <div class="mt-8 flex justify-end space-x-3">
                        <button type="button" id="btn-cancel-edit" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancelar</button>
                        <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Salvar Altera√ß√µes</button>
                    </div>
                </form>
            </div>


            <h3 class="text-xl font-semibold mt-6 mb-2">Lotes Dispon√≠veis</h3>
            <div class="overflow-x-auto border rounded-lg">
                <table class="w-full text-sm text-left">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2">Lote</th>
                            <th class="px-4 py-2">Quantidade</th>
                            <th class="px-4 py-2">Data de Validade</th>
                            <th class="px-4 py-2">Shelf Life na Entrada</th>
                        </tr>
                    </thead>
                    <tbody id="details-batches-table"></tbody>
                </table>
            </div>
            
            <h3 class="text-xl font-semibold mt-6 mb-2">Hist√≥rico de Movimenta√ß√£o</h3>
            <div class="overflow-x-auto border rounded-lg max-h-60" id="details-history-container">
                <!-- Hist√≥rico agrupado por data -->
            </div>
        </div>
    </div>

    <!-- Modal de Receitas -->
    <div id="recipe-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop p-4">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
             <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Criar Nova Receita</h2>
                <button id="close-recipe-modal" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <form id="recipe-form">
                <div class="space-y-4">
                     <div>
                        <label for="recipe-name" class="block text-sm font-medium text-gray-700">Nome da Receita</label>
                        <input type="text" id="recipe-name" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none form-input">
                    </div>
                     <div>
                        <label for="recipe-category" class="block text-sm font-medium text-gray-700">Linha de Produ√ß√£o</label>
                        <select id="recipe-category" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none form-input">
                            <option>Salgado</option>
                            <option>P√£es congelados</option>
                            <option>P√£es especiais</option>
                            <option>P√£o de queijo</option>
                            <option>Confeitaria</option>
                        </select>
                    </div>
                    
                    <h3 class="text-lg font-medium pt-4">Ingredientes</h3>
                    <div id="ingredients-container" class="space-y-3">
                        <!-- Ingredientes ser√£o adicionados dinamicamente aqui -->
                    </div>

                    <button type="button" id="add-ingredient-btn" class="text-indigo-600 hover:text-indigo-800 font-medium text-sm">
                        <i class="fa-solid fa-plus mr-1"></i>Adicionar Ingrediente
                    </button>
                </div>
                <div class="mt-8 flex justify-end">
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg shadow-md">
                        Salvar Receita
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal de Ordem de Produ√ß√£o -->
    <div id="production-order-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop p-4">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-5xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Nova Ordem de Produ√ß√£o</h2>
                <button id="close-production-order-modal" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <form id="production-order-form">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                     <div class="md:col-span-2">
                        <label for="po-recipe-select" class="block text-sm font-medium text-gray-700">Selecione a Receita</label>
                        <select id="po-recipe-select" required class="mt-1 block w-full form-input"></select>
                    </div>
                    <div>
                        <label for="po-quantity" class="block text-sm font-medium text-gray-700">Qtd. de Receitas</label>
                        <input type="number" id="po-quantity" value="1" min="1" required class="mt-1 block w-full form-input">
                    </div>
                </div>
                 <div class="mt-4">
                    <label for="po-date" class="block text-sm font-medium text-gray-700">Data da Produ√ß√£o</label>
                    <input type="date" id="po-date" required class="mt-1 block w-full form-input">
                </div>
                <h3 class="text-lg font-medium pt-6 mb-2">Insumos Necess√°rios</h3>
                <div class="overflow-x-auto border rounded-lg">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-2 py-2 text-left">Insumo</th>
                                <th class="px-2 py-2 text-left">Estoque Disp.</th>
                                <th class="px-2 py-2 text-left">Qtd. Necess√°ria</th>
                                <th class="px-2 py-2 text-left">Qtd. a Usar</th>
                                <th class="px-2 py-2 text-left">Lote de Consumo</th>
                                <th class="px-2 py-2 text-left">Manipulador</th>
                            </tr>
                        </thead>
                        <tbody id="po-ingredients-body"></tbody>
                    </table>
                </div>
                <div class="mt-8 flex justify-end">
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg shadow-md">
                        Criar Ordem de Produ√ß√£o
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Confirma√ß√£o de Produ√ß√£o -->
    <div id="confirm-production-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop p-4">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
             <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Confirmar Produ√ß√£o e Baixa de Estoque</h2>
                <button id="close-confirm-production-modal" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div class="flex items-center space-x-4 mb-4">
                <label for="production-date-filter" class="text-sm font-medium">Data da Produ√ß√£o:</label>
                <input type="date" id="production-date-filter" class="form-input">
            </div>
            <p class="text-sm text-gray-600 mb-4">Resumo de todos os insumos para as ordens de produ√ß√£o pendentes na data selecionada.</p>
             <div class="overflow-x-auto border rounded-lg">
                <table class="w-full text-sm">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left">Insumo</th>
                            <th class="px-4 py-2 text-left">Lote Espec√≠fico</th>
                            <th class="px-4 py-2 text-left">Qtd. Requisitada</th>
                            <th class="px-4 py-2 text-left">Qtd. Entregue (edit√°vel)</th>
                        </tr>
                    </thead>
                    <tbody id="confirm-production-tbody"></tbody>
                </table>
             </div>
             <div class="mt-8 flex justify-end">
                <button id="btn-execute-stock-consumption" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md">
                    Confirmar e Dar Baixa no Estoque
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Notifica√ß√£o -->
    <div id="notification-modal" class="fixed top-5 right-5 z-[100] hidden text-white py-2 px-5 rounded-lg shadow-lg">
        <p id="notification-message"></p>
    </div>

<script type="module">
    // --- M√ìDULO DO BANCO DE DADOS OFFLINE (IndexedDB) ---
    const DB = (() => {
        let dbInstance;

        function init() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('estoqueDB', 2);

                request.onerror = (event) => reject("Erro ao abrir o banco de dados.");

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('inventory')) {
                        const inventoryStore = db.createObjectStore('inventory', { keyPath: 'id', autoIncrement: true });
                        inventoryStore.createIndex('code', 'code', { unique: false });
                    }
                    if (!db.objectStoreNames.contains('batches')) {
                        const batchesStore = db.createObjectStore('batches', { keyPath: 'id', autoIncrement: true });
                        batchesStore.createIndex('productId', 'productId', { unique: false });
                    }
                    if (!db.objectStoreNames.contains('history')) {
                        db.createObjectStore('history', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains('recipes')) {
                        db.createObjectStore('recipes', { keyPath: 'id', autoIncrement: true });
                    }
                     if (!db.objectStoreNames.contains('productionOrders')) {
                        db.createObjectStore('productionOrders', { keyPath: 'id', autoIncrement: true });
                    }
                };

                request.onsuccess = (event) => {
                    dbInstance = event.target.result;
                    resolve(dbInstance);
                };
            });
        }

        async function getDB() {
            if (!dbInstance) await init();
            return dbInstance;
        }

        async function add(storeName, data) {
            const db = await getDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.add(data);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function get(storeName, key) {
             const db = await getDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.get(key);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }
        
        async function getByIndex(storeName, indexName, value) {
            const db = await getDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readonly');
                const store = transaction.objectStore(storeName);
                const index = store.index(indexName);
                const request = index.get(value);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function getAll(storeName) {
            const db = await getDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function update(storeName, data) {
            const db = await getDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.put(data);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        return { add, get, getAll, update, getByIndex, getDB };
    })();

    // --- STATE MANAGEMENT ---
    let localInventory = [], localBatches = [], localHistory = [], localRecipes = [], localProductionOrders = [];
    let currentSort = { key: 'name', order: 'asc' };
    let tempEntryData = null;

    // --- DOM ELEMENTS (permanecem os mesmos) ---
    const loadingOverlay = document.getElementById('loading-overlay');
    const screens = { entry: document.getElementById('screen-entry'), inventory: document.getElementById('screen-inventory'), recipes: document.getElementById('screen-recipes'), production: document.getElementById('screen-production'), };
    const navLinks = { entry: document.getElementById('nav-entry'), inventory: document.getElementById('nav-inventory'), recipes: document.getElementById('nav-recipes'), production: document.getElementById('nav-production'), };
    const entryForm = document.getElementById('entry-form');
    const shelfLifeModal = document.getElementById('shelf-life-modal');
    const shelfLifeValue = document.getElementById('shelf-life-value');
    const authorizerNameInput = document.getElementById('authorizer-name');
    const cancelReceiptBtn = document.getElementById('cancel-receipt-btn');
    const confirmReceiptBtn = document.getElementById('confirm-receipt-btn');
    const inventoryTableBody = document.getElementById('inventory-table-body');
    const searchInput = document.getElementById('search-inventory');
    const btnExportExcel = document.getElementById('btn-export-excel');
    const detailsModal = document.getElementById('item-details-modal');
    const closeDetailsModalBtn = document.getElementById('close-details-modal');
    const btnNewRecipe = document.getElementById('btn-new-recipe');
    const recipeModal = document.getElementById('recipe-modal');
    const closeRecipeModalBtn = document.getElementById('close-recipe-modal');
    const recipeForm = document.getElementById('recipe-form');
    const addIngredientBtn = document.getElementById('add-ingredient-btn');
    const ingredientsContainer = document.getElementById('ingredients-container');
    const notificationModal = document.getElementById('notification-modal');
    const notificationMessage = document.getElementById('notification-message');
    const itemDetailsView = document.getElementById('item-details-view');
    const itemDetailsEdit = document.getElementById('item-details-edit');
    const btnEditItem = document.getElementById('btn-edit-item');
    const btnCancelEdit = document.getElementById('btn-cancel-edit');
    const editItemForm = document.getElementById('edit-item-form');
    const detailsHistoryContainer = document.getElementById('details-history-container');
    const productionOrdersList = document.getElementById('production-orders-list');
    const btnNewProductionOrder = document.getElementById('btn-new-production-order');
    const productionOrderModal = document.getElementById('production-order-modal');
    const closeProductionOrderModalBtn = document.getElementById('close-production-order-modal');
    const productionOrderForm = document.getElementById('production-order-form');
    const poRecipeSelect = document.getElementById('po-recipe-select');
    const poIngredientsBody = document.getElementById('po-ingredients-body');
    const poQuantity = document.getElementById('po-quantity');
    const poDate = document.getElementById('po-date');
    const searchPoByDate = document.getElementById('search-po-by-date');
    const btnExportPdf = document.getElementById('btn-export-pdf');
    const btnConfirmProduction = document.getElementById('btn-confirm-production');
    const confirmProductionModal = document.getElementById('confirm-production-modal');
    const closeConfirmProductionModalBtn = document.getElementById('close-confirm-production-modal');
    const productionDateFilter = document.getElementById('production-date-filter');
    const confirmProductionTbody = document.getElementById('confirm-production-tbody');
    const btnExecuteStockConsumption = document.getElementById('btn-execute-stock-consumption');
    
    // --- FUN√á√ïES AUXILIARES ---
    function showNotification(message, isError = false) { /* ... (sem altera√ß√µes) ... */ 
        notificationMessage.textContent = message;
        notificationModal.classList.toggle('bg-green-500', !isError);
        notificationModal.classList.toggle('bg-red-500', isError);
        notificationModal.classList.remove('hidden');
        notificationModal.classList.remove('animate-fade-in-out');
        void notificationModal.offsetWidth;
        notificationModal.classList.add('animate-fade-in-out');
    }

    // --- NAVIGATION ---
    function navigateTo(screenName) { /* ... (sem altera√ß√µes) ... */ 
        Object.values(screens).forEach(screen => screen.classList.add('hidden'));
        screens[screenName].classList.remove('hidden');
        Object.values(navLinks).forEach(link => link.classList.remove('active-nav'));
        navLinks[screenName].classList.add('active-nav');
    }
    Object.keys(navLinks).forEach(key => { navLinks[key].addEventListener('click', (e) => { e.preventDefault(); navigateTo(key); }); });

    // --- ENTRY SCREEN LOGIC ---
    function calculateShelfLife(mfg, receipt, expiry) { /* ... (sem altera√ß√µes) ... */ 
        const mfgDate = new Date(mfg + 'T00:00:00');
        const receiptDate = new Date(receipt + 'T00:00:00');
        const expiryDate = new Date(expiry + 'T00:00:00');
        const totalLife = expiryDate.getTime() - mfgDate.getTime();
        const remainingLife = expiryDate.getTime() - receiptDate.getTime();
        if (totalLife <= 0) return 0;
        return ((remainingLife / totalLife) * 100).toFixed(1);
    }
    entryForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const formData = new FormData(entryForm);
        const data = {
            name: formData.get('product-name'), code: formData.get('product-code') || 'N/A', supplier: formData.get('supplier'),
            quantity: parseFloat(formData.get('quantity')), batchCode: formData.get('batch-code') || 'N/A',
            mfgDate: document.getElementById('mfg-date').value, receiptDate: document.getElementById('receipt-date').value,
            expiryDate: document.getElementById('expiry-date').value
        };
        let shelfLife = 100;
        if (data.mfgDate && data.receiptDate && data.expiryDate) { shelfLife = calculateShelfLife(data.mfgDate, data.receiptDate, data.expiryDate); }
        data.shelfLife = shelfLife;
        tempEntryData = data;
        if (shelfLife < 75) {
            shelfLifeValue.textContent = shelfLife;
            shelfLifeModal.classList.remove('hidden');
            shelfLifeModal.classList.add('flex');
        } else { saveEntry(); }
    });

    async function saveEntry(authorizedBy = null) {
        const data = tempEntryData;
        if (!data) return;
        try {
            let product = await DB.getByIndex('inventory', 'code', data.code);
            let productId;
            if (!product) {
                productId = await DB.add('inventory', { code: data.code, name: data.name, supplier: data.supplier, totalQuantity: data.quantity });
            } else {
                productId = product.id;
                product.totalQuantity += data.quantity;
                await DB.update('inventory', product);
            }
            await DB.add('batches', { productId, code: data.batchCode, quantity: data.quantity, mfgDate: data.mfgDate, receiptDate: data.receiptDate, expiryDate: data.expiryDate, shelfLife: data.shelfLife, authorizedBy });
            await DB.add('history', { productId, batchCode: data.batchCode, type: 'entrada', quantity: data.quantity, date: data.receiptDate });
            showNotification('Entrada registrada com sucesso!');
            entryForm.reset();
            closeShelfLifeModal();
            await refreshLocalData();
        } catch (error) {
            console.error("Erro ao salvar entrada: ", error);
            showNotification("Erro ao salvar entrada.", true);
        }
    }
    function closeShelfLifeModal() { /* ... (sem altera√ß√µes) ... */ 
        shelfLifeModal.classList.add('hidden');
        shelfLifeModal.classList.remove('flex');
        authorizerNameInput.value = '';
        tempEntryData = null;
    }
    cancelReceiptBtn.addEventListener('click', closeShelfLifeModal);
    confirmReceiptBtn.addEventListener('click', () => { /* ... (sem altera√ß√µes) ... */ 
        const authorizer = authorizerNameInput.value;
        if (!authorizer.trim()) {
            showNotification('Por favor, insira o nome do respons√°vel.', true);
            return;
        }
        saveEntry(authorizer);
    });

    // --- INVENTORY SCREEN LOGIC ---
    function renderInventoryTable() { /* ... (sem altera√ß√µes, pois usa localInventory) ... */ 
        let filteredInventory = [...localInventory];
        const searchTerm = searchInput.value.toLowerCase();
        if (searchTerm) {
            filteredInventory = filteredInventory.filter(item => 
                item.name.toLowerCase().includes(searchTerm) ||
                item.code.toLowerCase().includes(searchTerm) ||
                item.supplier.toLowerCase().includes(searchTerm)
            );
        }
        filteredInventory.sort((a, b) => {
            let valA, valB;
            if (currentSort.key === 'expiry') {
                valA = getNextExpiry(a.id) || '9999-12-31';
                valB = getNextExpiry(b.id) || '9999-12-31';
            } else {
                valA = a[currentSort.key] || '';
                valB = b[currentSort.key] || '';
            }
            if (valA < valB) return currentSort.order === 'asc' ? -1 : 1;
            if (valA > valB) return currentSort.order === 'asc' ? 1 : -1;
            return 0;
        });
        inventoryTableBody.innerHTML = '';
        if (filteredInventory.length === 0) {
            inventoryTableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4">Nenhum item em estoque.</td></tr>`;
            return;
        }
        filteredInventory.forEach(item => {
            const nextExpiry = getNextExpiry(item.id);
            const row = document.createElement('tr');
            row.className = 'bg-white border-b hover:bg-gray-50 cursor-pointer';
            row.addEventListener('click', () => showItemDetails(item.id));
            row.innerHTML = `
                <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${item.name}</td>
                <td class="px-6 py-4">${item.code}</td>
                <td class="px-6 py-4">${item.supplier}</td>
                <td class="px-6 py-4 text-right">${item.totalQuantity.toFixed(2)}</td>
                <td class="px-6 py-4">${nextExpiry ? new Date(nextExpiry + 'T00:00:00').toLocaleDateString('pt-BR') : 'N/A'}</td>
            `;
            inventoryTableBody.appendChild(row);
        });
    }
    function getNextExpiry(productId) { /* ... (sem altera√ß√µes) ... */ 
         const productBatches = localBatches.filter(b => b.productId === productId && b.quantity > 0);
        if (productBatches.length === 0) return null;
        return productBatches.sort((a, b) => new Date(a.expiryDate) - new Date(b.expiryDate))[0].expiryDate;
    }
    document.querySelectorAll('.table-header-sortable').forEach(header => { header.addEventListener('click', () => { /* ... */ }); });
    searchInput.addEventListener('input', renderInventoryTable);
    
    // --- ITEM DETAILS & EDIT MODAL ---
    function showItemDetails(productId) {
        const product = localInventory.find(p => p.id === productId);
        if (!product) return;
        
        document.getElementById('details-product-name').textContent = product.name;
        document.getElementById('details-product-code').textContent = product.code;
        document.getElementById('details-supplier').textContent = product.supplier;
        document.getElementById('details-total-quantity').textContent = product.totalQuantity.toFixed(2);
        
        document.getElementById('edit-item-id').value = product.id;
        document.getElementById('edit-product-name').value = product.name;
        document.getElementById('edit-product-code').value = product.code;
        document.getElementById('edit-supplier').value = product.supplier;

        const batches = localBatches.filter(b => b.productId === productId && b.quantity > 0);
        const history = localHistory.filter(h => h.productId === productId).sort((a, b) => new Date(b.date) - new Date(a.date));

        document.getElementById('details-batches-table').innerHTML = batches.map(batch => `
            <tr class="border-b"><td class="px-4 py-2">${batch.code}</td><td class="px-4 py-2">${batch.quantity.toFixed(2)}</td><td class="px-4 py-2">${new Date(batch.expiryDate + 'T00:00:00').toLocaleDateString('pt-BR')}</td><td class="px-4 py-2">${batch.shelfLife}% ${batch.authorizedBy ? `(Aut: ${batch.authorizedBy})` : ''}</td></tr>`).join('');
        
        const groupedHistory = history.reduce((acc, entry) => {
            (acc[entry.date] = acc[entry.date] || []).push(entry);
            return acc;
        }, {});

        detailsHistoryContainer.innerHTML = Object.keys(groupedHistory).sort((a,b) => new Date(b) - new Date(a)).map(date => `
            <div class="pt-2">
                <h4 class="bg-gray-100 p-2 font-semibold text-sm sticky top-0">${new Date(date + 'T00:00:00').toLocaleDateString('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</h4>
                <table class="w-full text-sm text-left">
                    <tbody>
                        ${groupedHistory[date].map(entry => `
                        <tr class="border-b">
                            <td class="px-4 py-2 w-1/4 ${entry.type === 'entrada' ? 'text-green-600' : 'text-red-600'}">${entry.type}</td>
                            <td class="px-4 py-2 w-1/4">${entry.quantity.toFixed(2)}</td>
                            <td class="px-4 py-2 w-1/2">${entry.batchCode}</td>
                        </tr>`).join('')}
                    </tbody>
                </table>
            </div>
        `).join('');

        itemDetailsView.classList.remove('hidden');
        itemDetailsEdit.classList.add('hidden');
        detailsModal.classList.remove('hidden');
        detailsModal.classList.add('flex');
    }
    closeDetailsModalBtn.addEventListener('click', () => { /* ... */ });
    btnEditItem.addEventListener('click', () => { /* ... */ });
    btnCancelEdit.addEventListener('click', () => { /* ... */ });

    editItemForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const updatedData = {
            id: parseInt(document.getElementById('edit-item-id').value),
            name: document.getElementById('edit-product-name').value,
            code: document.getElementById('edit-product-code').value,
            supplier: document.getElementById('edit-supplier').value,
        };
        try {
            const item = await DB.get('inventory', updatedData.id);
            const fullItem = { ...item, ...updatedData };
            await DB.update('inventory', fullItem);
            showNotification("Item atualizado com sucesso!");
            itemDetailsView.classList.remove('hidden');
            itemDetailsEdit.classList.add('hidden');
            document.getElementById('details-product-name').textContent = updatedData.name;
            await refreshLocalData();
        } catch (error) {
            console.error("Erro ao atualizar o item:", error);
            showNotification("Erro ao atualizar o item.", true);
        }
    });

    // --- RECIPES SCREEN LOGIC ---
    function renderRecipes() { /* ... (sem altera√ß√µes) ... */ }
    btnNewRecipe.addEventListener('click', () => { /* ... */ });
    closeRecipeModalBtn.addEventListener('click', () => recipeModal.classList.add('hidden'));
    function addIngredientRow() { /* ... */ }
    addIngredientBtn.addEventListener('click', addIngredientRow);
    ingredientsContainer.addEventListener('click', (e) => { if (e.target.classList.contains('remove-ingredient-btn')) e.target.parentElement.remove(); });
    recipeForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const newRecipe = {
            name: document.getElementById('recipe-name').value, category: document.getElementById('recipe-category').value,
            ingredients: Array.from(ingredientsContainer.querySelectorAll('.flex')).map(row => ({
                productId: parseInt(row.querySelector('select').value),
                quantity: parseFloat(row.querySelector('input').value)
            }))
        };
        try {
            await DB.add('recipes', newRecipe);
            showNotification("Receita salva com sucesso!");
            recipeModal.classList.add('hidden');
            await refreshLocalData();
        } catch(error) { console.error("Erro ao salvar receita: ", error); showNotification("Erro ao salvar receita.", true); }
    });

    // --- PRODUCTION ORDERS LOGIC ---
    function renderProductionOrders() { /* ... (sem altera√ß√µes) ... */ }
    btnNewProductionOrder.addEventListener('click', () => { /* ... */ });
    function updatePOIngredients() {
         const recipe = localRecipes.find(r => r.id === parseInt(poRecipeSelect.value));
        const recipeQuantity = parseInt(poQuantity.value, 10) || 1;
        if (!recipe) { poIngredientsBody.innerHTML = ''; return; }

        poIngredientsBody.innerHTML = recipe.ingredients.map(ing => {
            const product = localInventory.find(p => p.id === ing.productId);
            if(!product) return '';

            const neededQty = ing.quantity * recipeQuantity;
            const availableQty = product.totalQuantity;
            const isInsufficient = neededQty > availableQty;

            const availableBatches = localBatches
                .filter(b => b.productId === ing.productId && b.quantity > 0)
                .sort((a,b) => new Date(a.expiryDate) - new Date(b.expiryDate));
            
            const batchOptions = availableBatches.map(b => 
                `<option value="${b.id}" data-code="${b.code}">
                    ${b.code} (Qtd: ${b.quantity.toFixed(2)}, Val: ${new Date(b.expiryDate+'T00:00:00').toLocaleDateString('pt-BR')})
                </option>`
            ).join('');
            
            return `
            <tr data-product-id="${product.id}" data-original-qty="${ing.quantity}" class="${isInsufficient ? 'insufficient-stock-row' : ''}">
                <td class="px-2 py-2">${product.name}</td>
                <td class="px-2 py-2">${availableQty.toFixed(2)}</td>
                <td class="px-2 py-2 font-medium">${neededQty.toFixed(2)} ${isInsufficient ? `<span class="text-red-600 text-xs">(-${(neededQty - availableQty).toFixed(2)})</span>` : ''}</td>
                <td class="px-2 py-2"><input type="number" value="${neededQty.toFixed(2)}" min="0" step="0.01" class="w-24 form-input"></td>
                <td class="px-2 py-2"><select class="w-48 form-input text-xs">${batchOptions}</select></td>
                <td class="px-2 py-2"><input type="text" placeholder="Nome" class="w-32 form-input"></td>
            </tr>`;
        }).join('');
    }
    poRecipeSelect.addEventListener('change', updatePOIngredients);
    poQuantity.addEventListener('input', updatePOIngredients);
    closeProductionOrderModalBtn.addEventListener('click', () => productionOrderModal.classList.add('hidden'));
    productionOrderForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (poIngredientsBody.querySelectorAll('.insufficient-stock-row').length > 0) { showNotification("Estoque insuficiente.", true); return; }
        const recipe = localRecipes.find(r => r.id === parseInt(poRecipeSelect.value));
        const ingredients = Array.from(poIngredientsBody.querySelectorAll('tr')).map(row => {
            const batchSelect = row.querySelector('select');
            const selectedOption = batchSelect.options[batchSelect.selectedIndex];
            return {
                productId: parseInt(row.dataset.productId), adjustedQuantity: parseFloat(row.querySelector('input[type="number"]').value),
                handler: row.querySelector('input[type="text"]').value || 'N/A',
                batchId: selectedOption ? parseInt(selectedOption.value) : null,
                batchCode: selectedOption ? selectedOption.dataset.code : 'N/A',
            }
        });
        if (ingredients.some(ing => !ing.batchId)) { showNotification("Lotes n√£o dispon√≠veis.", true); return; }
        const newPO = {
            recipeId: recipe.id, recipeName: recipe.name, date: poDate.value,
            quantityProduced: parseInt(poQuantity.value, 10), status: 'pendente', ingredients
        };
        try {
            await DB.add('productionOrders', newPO);
            showNotification("Ordem de Produ√ß√£o criada com sucesso!");
            productionOrderModal.classList.add('hidden');
            await refreshLocalData();
        } catch(error) { console.error("Erro ao criar Ordem de Produ√ß√£o:", error); showNotification("Erro ao criar Ordem.", true); }
    });
    searchPoByDate.addEventListener('input', renderProductionOrders);
    btnConfirmProduction.addEventListener('click', () => { /* ... */ });
    closeConfirmProductionModalBtn.addEventListener('click', () => confirmProductionModal.classList.add('hidden'));
    productionDateFilter.addEventListener('change', () => {
        const selectedDate = productionDateFilter.value;
        const pendingOrders = localProductionOrders.filter(po => po.date === selectedDate && po.status === 'pendente');
        
        const aggregatedItems = {};
        pendingOrders.forEach(po => {
            po.ingredients.forEach(ing => {
                const key = `${ing.productId}-${ing.batchId}`;
                if (aggregatedItems[key]) {
                    aggregatedItems[key].quantity += ing.adjustedQuantity;
                } else {
                    const product = localInventory.find(p => p.id === ing.productId);
                    aggregatedItems[key] = { 
                        productId: ing.productId, batchId: ing.batchId,
                        name: product.name, batchCode: ing.batchCode,
                        quantity: ing.adjustedQuantity 
                    };
                }
            });
        });
        
        confirmProductionTbody.innerHTML = Object.values(aggregatedItems).map(item => {
            return `<tr data-product-id="${item.productId}" data-batch-id="${item.batchId}">
                <td class="px-4 py-2">${item.name}</td>
                <td class="px-4 py-2">${item.batchCode}</td>
                <td class="px-4 py-2">${item.quantity.toFixed(2)}</td>
                <td class="px-4 py-2"><input type="number" value="${item.quantity.toFixed(2)}" class="w-32 form-input"></td>
            </tr>`;
        }).join('');
        confirmProductionTbody.dataset.orders = JSON.stringify(pendingOrders.map(po => po.id));
    });

    // --- CONFIRM PRODUCTION & STOCK CONSUMPTION ---
    btnExecuteStockConsumption.addEventListener('click', async () => {
        const orderIdsToUpdate = JSON.parse(confirmProductionTbody.dataset.orders || '[]');
        if (orderIdsToUpdate.length === 0) { showNotification("Nenhuma ordem para confirmar.", true); return; }
        try {
            loadingOverlay.classList.remove('hidden');
            const consumptionItems = Array.from(confirmProductionTbody.querySelectorAll('tr')).map(row => ({
                productId: parseInt(row.dataset.productId), batchId: parseInt(row.dataset.batchId),
                deliveredQty: parseFloat(row.querySelector('input').value)
            }));
            const totalConsumptionByProduct = {};

            for (const item of consumptionItems) {
                let remainingToConsume = item.deliveredQty;
                if (remainingToConsume <= 0) continue;
                totalConsumptionByProduct[item.productId] = (totalConsumptionByProduct[item.productId] || 0) + remainingToConsume;

                const specifiedBatch = await DB.get('batches', item.batchId);
                if (!specifiedBatch || specifiedBatch.quantity <= 0) throw new Error(`Lote ${specifiedBatch?.code || 'N/A'} n√£o encontrado.`);
                const consumeFromSpecified = Math.min(remainingToConsume, specifiedBatch.quantity);
                specifiedBatch.quantity -= consumeFromSpecified;
                await DB.update('batches', specifiedBatch);
                await DB.add('history', { productId: item.productId, batchCode: specifiedBatch.code, type: 'sa√≠da', quantity: consumeFromSpecified, date: new Date().toISOString().split('T')[0] });
                remainingToConsume -= consumeFromSpecified;

                if (remainingToConsume > 0) {
                    const otherBatches = localBatches.filter(b => b.productId === item.productId && b.id !== item.batchId && b.quantity > 0)
                        .sort((a,b) => new Date(a.expiryDate) - new Date(b.expiryDate));
                    for (const otherBatchDoc of otherBatches) {
                        const consumeFromThis = Math.min(remainingToConsume, otherBatchDoc.quantity);
                        otherBatchDoc.quantity -= consumeFromThis;
                        await DB.update('batches', otherBatchDoc);
                        await DB.add('history', { productId: item.productId, batchCode: otherBatchDoc.code, type: 'sa√≠da', quantity: consumeFromThis, date: new Date().toISOString().split('T')[0] });
                        remainingToConsume -= consumeFromThis;
                        if (remainingToConsume <= 0) break;
                    }
                }
                if (remainingToConsume > 0) throw new Error(`Estoque insuficiente. Faltam ${remainingToConsume.toFixed(2)}.`);
            }

            for (const productId in totalConsumptionByProduct) {
                const product = await DB.get('inventory', parseInt(productId));
                product.totalQuantity -= totalConsumptionByProduct[productId];
                await DB.update('inventory', product);
            }

            for (const orderId of orderIdsToUpdate) {
                const po = await DB.get('productionOrders', orderId);
                po.status = 'conclu√≠do';
                await DB.update('productionOrders', po);
            }
            showNotification("Baixa de estoque realizada com sucesso!");
            confirmProductionModal.classList.add('hidden');
            await refreshLocalData();
        } catch (error) {
            console.error("Erro ao dar baixa no estoque: ", error);
            showNotification(error.message || "Erro ao dar baixa no estoque.", true);
        } finally {
            loadingOverlay.classList.add('hidden');
        }
    });

    // --- EXPORT FUNCTIONS ---
    function exportInventoryToExcel() { /* ... (sem altera√ß√µes) ... */ 
        const dataToExport = localInventory.map(item => ({
            'C√≥digo': item.code,
            'Item': item.name,
            'Fornecedor': item.supplier,
            'Quantidade': item.totalQuantity.toFixed(2)
        }));
        const worksheet = XLSX.utils.json_to_sheet(dataToExport);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Estoque");
        XLSX.writeFile(workbook, "relatorio_estoque.xlsx");
        showNotification("Relat√≥rio de estoque exportado!");
    }
    btnExportExcel.addEventListener('click', exportInventoryToExcel);
    function exportOrdersToPDF() { /* ... (sem altera√ß√µes) ... */ 
        const { jsPDF } = window.jspdf;
        const filterDate = searchPoByDate.value;
        if (!filterDate) {
            showNotification("Por favor, selecione uma data para gerar o relat√≥rio.", true);
            return;
        }

        const filteredOrders = localProductionOrders.filter(po => po.date === filterDate);
        if (filteredOrders.length === 0) {
            showNotification("Nenhuma ordem de produ√ß√£o para a data selecionada.", true);
            return;
        }

        const doc = new jsPDF();
        const formattedDate = new Date(filterDate + 'T00:00:00').toLocaleDateString('pt-BR');

        doc.setFontSize(18);
        doc.text(`Relat√≥rio de Ordens de Produ√ß√£o`, 14, 22);
        doc.setFontSize(11);
        doc.setTextColor(100);
        doc.text(`Data: ${formattedDate}`, 14, 30);

        let startY = 40;

        filteredOrders.forEach(order => {
            if (startY > 250) { // Page break
                doc.addPage();
                startY = 22;
            }
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text(`${order.recipeName} (${order.quantityProduced}x)`, 14, startY);
            startY += 7;

            const tableBody = order.ingredients.map(ing => {
                const product = localInventory.find(p => p.id === ing.productId);
                return [
                    product ? product.name : 'N/A',
                    ing.adjustedQuantity.toFixed(2),
                    ing.batchCode,
                    ing.handler
                ];
            });

            doc.autoTable({
                startY: startY,
                head: [['Insumo', 'Qtd. Usada', 'Lote', 'Manipulador']],
                body: tableBody,
                theme: 'striped',
                headStyles: { fillColor: [79, 70, 229] }
            });

            startY = doc.autoTable.previous.finalY + 15;
        });

        doc.save(`relatorio_producao_${filterDate}.pdf`);
        showNotification("Relat√≥rio PDF exportado!");
    }
    btnExportPdf.addEventListener('click', exportOrdersToPDF);


    // --- INICIALIZA√á√ÉO E SINCRONIZA√á√ÉO COM DADOS LOCAIS ---
    async function refreshLocalData() {
        try {
            localInventory = await DB.getAll('inventory');
            localBatches = await DB.getAll('batches');
            localHistory = await DB.getAll('history');
            localRecipes = await DB.getAll('recipes');
            localProductionOrders = await DB.getAll('productionOrders');
            
            renderInventoryTable();
            renderRecipes();
            renderProductionOrders();
        } catch (error) {
            console.error("Erro ao carregar dados locais:", error);
            showNotification("Falha ao carregar dados do banco de dados local.", true);
        }
    }

    async function initialize() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('receipt-date').value = today;
        searchPoByDate.value = today;
        navigateTo('entry');

        try {
            await DB.getDB(); // Inicializa e abre o banco
            await refreshLocalData();
        } catch (error) {
            console.error("Erro na inicializa√ß√£o do IndexedDB:", error);
            loadingOverlay.innerHTML = "Erro ao iniciar o banco de dados offline.";
        }
        loadingOverlay.classList.add('hidden');
    }

    initialize();
</script>

</body>
</html>

