<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Rastreabilidade e Controle de Estoque</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Bibliotecas para exportação e gráficos -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .sidebar-icon {
            transition: all 0.2s ease-in-out;
        }
        .sidebar-icon:hover {
            transform: scale(1.1);
        }
        .active-nav {
            background-color: #4f46e5;
            color: white;
        }
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 50;
            inset: 0;
            align-items: center;
            justify-content: center;
            background-color: rgba(0, 0, 0, 0.5);
        }
        .form-input {
            transition: border-color 0.2s;
        }
        .form-input:focus {
            border-color: #4f46e5;
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.25);
        }
        .table-header-sortable {
            cursor: pointer;
        }
        .table-header-sortable:hover {
            background-color: #f0f4f8;
        }
        .insufficient-stock-row {
            background-color: #fee2e2; /* Red-100 */
        }
        .insufficient-stock-row:hover {
            background-color: #fecaca; /* Red-200 */
        }
        .searchable-container {
            position: relative;
        }
        .searchable-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #d1d5db;
            background-color: white;
            border-radius: 0 0 0.375rem 0.375rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .searchable-item {
            padding: 0.5rem 1rem;
            cursor: pointer;
        }
        .searchable-item:hover {
            background-color: #f3f4f6;
        }

        @keyframes fade-in-out {
            0% { opacity: 0; transform: translateY(-20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }
        .animate-fade-in-out {
            animation: fade-in-out 4s ease-in-out forwards;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="loading-overlay" class="fixed inset-0 z-[101] flex items-center justify-center bg-white">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-indigo-600"></div>
    </div>

    <div class="flex h-screen">
        <!-- Sidebar -->
        <aside class="w-20 bg-gray-800 text-white flex flex-col items-center py-4 space-y-6">
            <a href="#" id="nav-dashboard" class="sidebar-icon p-3 rounded-lg active-nav" title="Dashboard">
                <i class="fa-solid fa-chart-pie fa-lg"></i>
            </a>
            <nav class="flex flex-col items-center space-y-4">
                <a href="#" id="nav-entry" class="sidebar-icon p-3 rounded-lg" title="Entrada de Mercadorias">
                    <i class="fa-solid fa-dolly fa-lg"></i>
                </a>
                <a href="#" id="nav-inventory" class="sidebar-icon p-3 rounded-lg" title="Gerenciamento de Estoque">
                    <i class="fa-solid fa-warehouse fa-lg"></i>
                </a>
                <a href="#" id="nav-recipes" class="sidebar-icon p-3 rounded-lg" title="Receitas">
                    <i class="fa-solid fa-book-open fa-lg"></i>
                </a>
                <a href="#" id="nav-production" class="sidebar-icon p-3 rounded-lg" title="Ordens de Produção">
                    <i class="fa-solid fa-clipboard-list fa-lg"></i>
                </a>
                 <a href="#" id="nav-requisitions" class="sidebar-icon p-3 rounded-lg" title="Baixa por Requisição">
                    <i class="fa-solid fa-arrow-right-from-bracket fa-lg"></i>
                </a>
                <a href="#" id="nav-adjustments" class="sidebar-icon p-3 rounded-lg" title="Ajuste de Estoque">
                    <i class="fa-solid fa-sliders fa-lg"></i>
                </a>
                <a href="#" id="nav-consumption" class="sidebar-icon p-3 rounded-lg" title="Consumo Mensal">
                    <i class="fa-solid fa-calculator fa-lg"></i>
                </a>
                <a href="#" id="nav-residual" class="sidebar-icon p-3 rounded-lg" title="Estoque Residual">
                    <i class="fa-solid fa-recycle fa-lg"></i>
                </a>
            </nav>
            <div class="mt-auto">
                 <a href="#" id="nav-settings" class="sidebar-icon p-3 rounded-lg" title="Configurações">
                    <i class="fa-solid fa-cog fa-lg"></i>
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-6 md:p-8 overflow-y-auto">
            
            <!-- Tela da Dashboard -->
            <div id="screen-dashboard">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Visão Geral do Estoque</h1>
                
                <!-- Stat Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                    <div class="bg-white p-6 rounded-xl shadow flex items-center">
                        <div class="bg-blue-100 text-blue-600 p-4 rounded-full">
                            <i class="fa-solid fa-boxes-stacked fa-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-500">Itens Únicos</p>
                            <p id="stat-total-items" class="text-2xl font-bold">0</p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow flex items-center">
                        <div class="bg-green-100 text-green-600 p-4 rounded-full">
                            <i class="fa-solid fa-box fa-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-500">Quantidade Total</p>
                            <p id="stat-total-quantity" class="text-2xl font-bold">0</p>
                        </div>
                    </div>
                    <div id="card-low-stock" class="bg-white p-6 rounded-xl shadow flex items-center cursor-pointer hover:shadow-lg transition-shadow">
                         <div class="bg-yellow-100 text-yellow-600 p-4 rounded-full">
                            <i class="fa-solid fa-arrow-down-short-wide fa-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-500">Itens com Estoque Baixo</p>
                            <p id="stat-low-stock" class="text-2xl font-bold">0</p>
                        </div>
                    </div>
                    <div id="card-expiring-soon" class="bg-white p-6 rounded-xl shadow flex items-center cursor-pointer hover:shadow-lg transition-shadow">
                        <div class="bg-red-100 text-red-600 p-4 rounded-full">
                            <i class="fa-solid fa-calendar-times fa-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-500">Lotes Vencendo (30d)</p>
                            <p id="stat-expiring-soon" class="text-2xl font-bold">0</p>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Coluna Esquerda (Gráficos) -->
                    <div class="space-y-6">
                        <!-- Gráfico Quantidade Crítica -->
                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <h2 class="text-xl font-semibold text-gray-700 mb-4">Top 5 Itens Críticos (Quantidade)</h2>
                            <div class="h-80 flex items-center justify-center">
                                <canvas id="critical-quantity-chart"></canvas>
                            </div>
                        </div>
                        <!-- Gráfico Validade Crítica -->
                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <h2 class="text-xl font-semibold text-gray-700 mb-4">Top 5 Itens Críticos (Validade)</h2>
                            <div class="h-80 flex items-center justify-center">
                                <canvas id="critical-expiry-chart"></canvas>
                            </div>
                        </div>
                    </div>
                    <!-- Coluna Direita (Alertas e Entradas) -->
                    <div class="space-y-6">
                        <div class="bg-white p-6 rounded-xl shadow-lg">
                             <h2 class="text-xl font-semibold text-gray-700 mb-4 flex items-center"><i class="fa-solid fa-triangle-exclamation text-yellow-500 mr-3"></i>Alertas e Informações</h2>
                             <div id="alerts-container" class="space-y-4">
                                <!-- Alertas são renderizados aqui -->
                             </div>
                        </div>
                         <div class="bg-white p-6 rounded-xl shadow-lg">
                             <h2 class="text-xl font-semibold text-gray-700 mb-4">Últimas Entradas</h2>
                             <ul id="last-entries-list" class="divide-y divide-gray-200">
                                <!-- Preenchido por JS -->
                             </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tela de Registro de Entrada -->
            <div id="screen-entry" class="hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Registro de Entrada de Mercadorias</h1>
                <div class="bg-white p-8 rounded-xl shadow-lg max-w-2xl mx-auto">
                    <form id="entry-form">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="col-span-1 md:col-span-2">
                                <label for="product-name" class="block text-sm font-medium text-gray-700">Nome do Produto</label>
                                <input type="text" id="product-name" name="product-name" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none form-input">
                            </div>
                            <div>
                                <label for="product-code" class="block text-sm font-medium text-gray-700">Código</label>
                                <input type="text" id="product-code" name="product-code" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none form-input">
                            </div>
                            <div>
                                <label for="supplier" class="block text-sm font-medium text-gray-700">Fornecedor</label>
                                <input type="text" id="supplier" name="supplier" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none form-input">
                            </div>
                            <div>
                                <label for="quantity" class="block text-sm font-medium text-gray-700">Quantidade Recebida</label>
                                <input type="number" id="quantity" name="quantity" required min="0.01" step="0.01" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none form-input">
                            </div>
                             <div>
                                <label for="batch-code" class="block text-sm font-medium text-gray-700">Lote</label>
                                <input type="text" id="batch-code" name="batch-code" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none form-input">
                            </div>
                            <div>
                                <label for="mfg-date" class="block text-sm font-medium text-gray-700">Data de Fabricação</label>
                                <input type="date" id="mfg-date" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none form-input">
                            </div>
                            <div>
                                <label for="receipt-date" class="block text-sm font-medium text-gray-700">Data de Recebimento</label>
                                <input type="date" id="receipt-date" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none form-input">
                            </div>
                            <div>
                                <label for="expiry-date" class="block text-sm font-medium text-gray-700">Data de Validade</label>
                                <input type="date" id="expiry-date" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none form-input">
                            </div>
                        </div>
                        <div class="mt-8 flex justify-end">
                            <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105">
                                Registrar Entrada
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Tela de Gerenciamento de Estoque -->
            <div id="screen-inventory" class="hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Gerenciamento de Estoque</h1>
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                        <input type="text" id="search-inventory" placeholder="🔍 Buscar item..." class="w-full md:w-1/3 border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none form-input">
                        
                        <div class="w-full md:w-auto">
                            <select id="supplier-filter" class="form-input w-full">
                                <option value="">Todos os Fornecedores</option>
                            </select>
                        </div>

                        <button id="btn-export-excel" class="bg-white hover:bg-gray-100 text-gray-800 font-semibold py-2 px-4 border border-gray-300 rounded-lg shadow-sm">
                            <i class="fa-solid fa-file-excel text-green-600 mr-2"></i>Exportar para Excel
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 table-header-sortable" data-sort="name">Nome do Produto</th>
                                    <th scope="col" class="px-6 py-3 table-header-sortable" data-sort="code">Código</th>
                                    <th scope="col" class="px-6 py-3 table-header-sortable" data-sort="supplier">Fornecedor</th>
                                    <th scope="col" class="px-6 py-3 text-right table-header-sortable" data-sort="totalQuantity">Qtd. Total</th>
                                    <th scope="col" class="px-6 py-3 table-header-sortable" data-sort="expiry">Próx. Validade</th>
                                </tr>
                            </thead>
                            <tbody id="inventory-table-body">
                                <!-- Linhas de inventário serão inseridas aqui -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Tela de Receitas -->
            <div id="screen-recipes" class="hidden">
                 <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">Receitas</h1>
                    <button id="btn-new-recipe" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                        <i class="fa-solid fa-plus mr-2"></i>Nova Receita
                    </button>
                </div>
                <div id="recipes-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Cards de categoria de receita serão inseridos aqui -->
                </div>
            </div>
            
            <!-- Tela de Ordens de Produção -->
            <div id="screen-production" class="hidden">
                 <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">Ordens de Produção</h1>
                    <div>
                        <button id="btn-confirm-production" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 mr-2">
                            <i class="fa-solid fa-check-double mr-2"></i>Confirmar Selecionadas
                        </button>
                        <button id="btn-new-production-order" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                            <i class="fa-solid fa-plus mr-2"></i>Nova Ordem
                        </button>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm mb-6 flex items-center justify-between">
                    <div class="flex items-center">
                        <label for="search-po-by-date" class="text-sm font-medium text-gray-700 mr-2">Filtrar por data:</label>
                        <input type="date" id="search-po-by-date" class="form-input">
                    </div>
                    <button id="btn-export-pdf" class="bg-white hover:bg-gray-100 text-gray-800 font-semibold py-2 px-4 border border-gray-300 rounded-lg shadow-sm">
                        <i class="fa-solid fa-file-pdf text-red-600 mr-2"></i>Exportar Relatório (PDF)
                    </button>
                </div>
                <div id="production-orders-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Ordens de produção serão listadas aqui -->
                </div>
            </div>

            <!-- Tela de Consumo Mensal -->
            <div id="screen-consumption" class="hidden">
                 <h1 class="text-3xl font-bold text-gray-800 mb-6">Relatório de Consumo Mensal</h1>
                 <div class="bg-white p-6 rounded-xl shadow-lg">
                    <div class="flex items-center mb-4 space-x-4">
                        <select id="consumption-month-filter" class="form-input"></select>
                        <select id="consumption-year-filter" class="form-input"></select>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3">Produto</th>
                                    <th scope="col" class="px-6 py-3 text-right">Consumo Total no Mês</th>
                                </tr>
                            </thead>
                            <tbody id="consumption-table-body"></tbody>
                        </table>
                    </div>
                 </div>
            </div>

            <!-- Tela de Estoque Residual -->
            <div id="screen-residual" class="hidden">
                 <h1 class="text-3xl font-bold text-gray-800 mb-6">Estoque Residual</h1>
                 <div class="bg-white p-6 rounded-xl shadow-lg">
                    <p class="text-sm text-gray-600 mb-4">Esta tela mostra as sobras (positivo) ou faltas (negativo) de insumos acumuladas após a confirmação das ordens de produção.</p>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3">Produto</th>
                                    <th scope="col" class="px-6 py-3 text-right">Saldo Residual</th>
                                    <th scope="col" class="px-6 py-3 text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="residual-table-body"></tbody>
                        </table>
                    </div>
                 </div>
            </div>
            
             <!-- Tela de Baixa por Requisição -->
            <div id="screen-requisitions" class="hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Baixa por Requisição</h1>
                <div class="bg-white p-8 rounded-xl shadow-lg max-w-4xl mx-auto">
                    <form id="requisition-form">
                        <div class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="requisition-reason" class="block text-sm font-medium text-gray-700">Motivo/Destino da Requisição</label>
                                    <input type="text" id="requisition-reason" required class="mt-1 block w-full form-input" placeholder="Ex: Amostra para laboratório">
                                </div>
                                <div>
                                    <label for="requisition-responsible" class="block text-sm font-medium text-gray-700">Responsável</label>
                                    <input type="text" id="requisition-responsible" required class="mt-1 block w-full form-input" placeholder="Nome do responsável">
                                </div>
                            </div>
                            <h3 class="text-lg font-medium pt-4">Itens</h3>
                             
                            <div id="requisition-items-container" class="space-y-3">
                                <!-- Itens serão adicionados aqui -->
                            </div>
                            <button type="button" id="add-requisition-item-btn" class="text-indigo-600 hover:text-indigo-800 font-medium text-sm">
                                <i class="fa-solid fa-plus mr-1"></i>Adicionar Item
                            </button>
                        </div>
                        <div class="mt-8 flex justify-end">
                            <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-md">
                                Confirmar Baixa
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Tela de Ajuste de Estoque -->
            <div id="screen-adjustments" class="hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Ajuste de Estoque</h1>
                <div class="bg-white p-8 rounded-xl shadow-lg max-w-2xl mx-auto">
                    <form id="adjustment-form">
                        <div class="space-y-4">
                             <div>
                                <label class="block text-sm font-medium text-gray-700">Produto</label>
                                <div id="adjustment-searchable-container" class="searchable-container"></div>
                            </div>
                            <div>
                                <label for="adjustment-batch" class="block text-sm font-medium text-gray-700">Lote</label>
                                <select id="adjustment-batch" required class="mt-1 block w-full form-input"></select>
                            </div>
                            <div>
                                <label for="adjustment-new-quantity" class="block text-sm font-medium text-gray-700">Nova Quantidade do Lote</label>
                                <input type="number" id="adjustment-new-quantity" required min="0" step="0.01" class="mt-1 block w-full form-input">
                            </div>
                             <div>
                                <label for="adjustment-reason" class="block text-sm font-medium text-gray-700">Motivo do Ajuste</label>
                                <input type="text" id="adjustment-reason" required class="mt-1 block w-full form-input" placeholder="Ex: Contagem de inventário">
                            </div>
                             <div>
                                <label for="adjustment-responsible" class="block text-sm font-medium text-gray-700">Responsável pelo Ajuste</label>
                                <input type="text" id="adjustment-responsible" required class="mt-1 block w-full form-input" placeholder="Nome do responsável">
                            </div>
                        </div>
                        <div class="mt-8 flex justify-end">
                            <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-md">
                                Salvar Ajuste
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Tela de Configurações -->
            <div id="screen-settings" class="hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Configurações e Backup</h1>
                <div class="bg-white p-8 rounded-xl shadow-lg max-w-2xl mx-auto space-y-6">
                    <div>
                        <h2 class="text-xl font-semibold text-gray-700">Backup dos Dados</h2>
                        <p class="text-sm text-gray-500 mt-1">
                            Salve todos os seus dados em um arquivo para segurança ou para transferir para outro dispositivo.
                        </p>
                        <button id="btn-download-backup" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105">
                            <i class="fa-solid fa-download mr-2"></i>Baixar Backup (.json)
                        </button>
                    </div>
                    <div class="border-t pt-6">
                        <h2 class="text-xl font-semibold text-gray-700">Restaurar Backup</h2>
                        <p class="text-sm text-gray-500 mt-1">
                            Importe um arquivo de backup. <strong class="text-red-600">Atenção:</strong> Isso substituirá todos os dados existentes no aplicativo.
                        </p>
                        <button id="btn-upload-backup" class="mt-4 w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105">
                            <i class="fa-solid fa-upload mr-2"></i>Carregar Backup (.json)
                        </button>
                        <input type="file" id="backup-file-input" class="hidden" accept=".json">
                    </div>
                    <div class="border-t pt-6">
                        <h2 class="text-xl font-semibold text-red-700">Apagar Dados</h2>
                        <p class="text-sm text-gray-500 mt-1">
                           Esta ação é irreversível e apagará todos os dados do aplicativo.
                        </p>
                        <button id="btn-reset-database" class="mt-4 w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105">
                            <i class="fa-solid fa-trash-alt mr-2"></i>Apagar Todos os Dados
                        </button>
                    </div>
                </div>
            </div>

        </main>
    </div>
    
    <!-- Modal de Alerta de Shelf Life -->
    <div id="shelf-life-modal" class="modal">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100">
                    <i class="fa-solid fa-triangle-exclamation text-yellow-600 text-2xl"></i>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mt-4">Alerta de Shelf Life</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500">
                        O shelf life do produto é de <strong id="shelf-life-value"></strong>%, abaixo do mínimo de 75%.
                    </p>
                    <p class="text-sm text-gray-600 mt-2">
                        Para prosseguir, insira o nome do responsável que autorizou o recebimento.
                    </p>
                </div>
                <div class="mt-4">
                    <label for="authorizer-name" class="sr-only">Nome do Autorizador</label>
                    <input type="text" id="authorizer-name" placeholder="Nome do Responsável" class="w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none form-input" required>
                </div>
            </div>
            <div class="mt-6 flex justify-center space-x-4">
                <button id="cancel-receipt-btn" type="button" class="py-2 px-4 bg-gray-200 text-gray-800 font-semibold rounded-lg shadow-md hover:bg-gray-300">
                    Cancelar
                </button>
                <button id="confirm-receipt-btn" type="button" class="py-2 px-4 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700">
                    Confirmar Recebimento
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Detalhes e Edição do Item -->
    <div id="item-details-modal" class="modal p-4">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold" id="details-product-name">Nome do Produto</h2>
                <button id="close-details-modal" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            
            <!-- View Mode -->
            <div id="item-details-view">
                <div class="flex justify-end mb-4">
                    <button id="btn-edit-item" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md">
                        <i class="fa-solid fa-pencil mr-2"></i>Editar Item
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-sm">
                    <div><strong>Código:</strong> <span id="details-product-code"></span></div>
                    <div><strong>Fornecedor:</strong> <span id="details-supplier"></span></div>
                    <div><strong>Estoque Total:</strong> <span id="details-total-quantity"></span></div>
                    <div><strong>Consumo Médio Diário:</strong> <span id="details-avg-consumption"></span></div>
                    <div><strong>Estoque Mínimo:</strong> <span id="details-min-stock"></span></div>
                    <div><strong>Estoque Máximo:</strong> <span id="details-max-stock"></span></div>
                </div>
            </div>

            <!-- Edit Mode -->
            <div id="item-details-edit" class="hidden">
                 <form id="edit-item-form">
                    <input type="hidden" id="edit-item-id">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="col-span-1 md:col-span-2">
                            <label for="edit-product-name" class="block text-sm font-medium text-gray-700">Nome do Produto</label>
                            <input type="text" id="edit-product-name" required class="mt-1 block w-full form-input">
                        </div>
                        <div>
                            <label for="edit-product-code" class="block text-sm font-medium text-gray-700">Código</label>
                            <input type="text" id="edit-product-code" required class="mt-1 block w-full form-input">
                        </div>
                        <div>
                            <label for="edit-supplier" class="block text-sm font-medium text-gray-700">Fornecedor</label>
                            <input type="text" id="edit-supplier" required class="mt-1 block w-full form-input">
                        </div>
                        <div>
                            <label for="edit-min-stock" class="block text-sm font-medium text-gray-700">Estoque Mínimo (Opcional)</label>
                            <input type="number" id="edit-min-stock" step="0.01" class="mt-1 block w-full form-input" placeholder="Deixe em branco para auto-cálculo">
                        </div>
                        <div>
                            <label for="edit-max-stock" class="block text-sm font-medium text-gray-700">Estoque Máximo (Opcional)</label>
                            <input type="number" id="edit-max-stock" step="0.01" class="mt-1 block w-full form-input" placeholder="Deixe em branco para auto-cálculo">
                        </div>
                    </div>
                    <div class="mt-8 flex justify-end space-x-3">
                        <button type="button" id="btn-cancel-edit" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancelar</button>
                        <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Salvar Alterações</button>
                    </div>
                </form>
            </div>


            <h3 class="text-xl font-semibold mt-6 mb-2">Lotes Disponíveis</h3>
            <div class="overflow-x-auto border rounded-lg">
                <table class="w-full text-sm text-left">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2">Lote</th>
                            <th class="px-4 py-2">Quantidade</th>
                            <th class="px-4 py-2">Data de Validade</th>
                            <th class="px-4 py-2 text-center">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="details-batches-table"></tbody>
                </table>
            </div>
            
            <h3 class="text-xl font-semibold mt-6 mb-2">Histórico de Movimentação</h3>
            <div class="overflow-x-auto border rounded-lg max-h-60" id="details-history-container">
                <!-- Histórico agrupado por data -->
            </div>
        </div>
    </div>

     <!-- Modal de Edição de Lote -->
    <div id="edit-batch-modal" class="modal p-4">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Editar Lote</h2>
                <button id="close-edit-batch-modal" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <form id="edit-batch-form">
                <input type="hidden" id="edit-batch-id">
                <div class="space-y-4">
                    <div>
                        <label for="edit-batch-code" class="block text-sm font-medium text-gray-700">Código do Lote</label>
                        <input type="text" id="edit-batch-code" required class="mt-1 block w-full form-input">
                    </div>
                     <div>
                        <label for="edit-batch-quantity" class="block text-sm font-medium text-gray-700">Quantidade</label>
                        <input type="number" id="edit-batch-quantity" required min="0" step="0.01" class="mt-1 block w-full form-input">
                    </div>
                    <div>
                        <label for="edit-batch-expiry-date" class="block text-sm font-medium text-gray-700">Data de Validade</label>
                        <input type="date" id="edit-batch-expiry-date" class="mt-1 block w-full form-input">
                    </div>
                </div>
                <div class="mt-8 flex justify-end">
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg shadow-md">
                        Salvar Alterações
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Edição de Estoque Residual -->
    <div id="edit-residual-modal" class="modal p-4">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Editar Saldo Residual</h2>
                <button id="close-edit-residual-modal" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <form id="edit-residual-form">
                <input type="hidden" id="edit-residual-product-id">
                <div>
                    <p class="mb-2 text-sm">Produto: <strong id="edit-residual-product-name"></strong></p>
                    <label for="edit-residual-quantity" class="block text-sm font-medium text-gray-700">Nova Quantidade Residual</label>
                    <input type="number" id="edit-residual-quantity" required step="0.01" class="mt-1 block w-full form-input">
                </div>
                <div class="mt-8 flex justify-end">
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg shadow-md">
                        Salvar Alteração
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Receitas -->
    <div id="recipe-modal" class="modal p-4">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
             <div class="flex justify-between items-center mb-6">
                <h2 id="recipe-modal-title" class="text-2xl font-bold">Criar Nova Receita</h2>
                <button id="close-recipe-modal" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <form id="recipe-form">
                <input type="hidden" id="edit-recipe-id">
                <div class="space-y-4">
                     <div>
                        <label for="recipe-name" class="block text-sm font-medium text-gray-700">Nome da Receita</label>
                        <input type="text" id="recipe-name" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none form-input">
                    </div>
                     <div>
                        <label for="recipe-category" class="block text-sm font-medium text-gray-700">Linha de Produção</label>
                        <select id="recipe-category" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none form-input">
                            <option>Salgado</option>
                            <option>Pães congelados</option>
                            <option>Pães especiais</option>
                            <option>Pão de queijo</option>
                            <option>Confeitaria</option>
                        </select>
                    </div>
                    
                    <h3 class="text-lg font-medium pt-4">Ingredientes</h3>
                    <div id="ingredients-container" class="space-y-3">
                        <!-- Ingredientes serão adicionados dinamicamente aqui -->
                    </div>

                    <button type="button" id="add-ingredient-btn" class="text-indigo-600 hover:text-indigo-800 font-medium text-sm">
                        <i class="fa-solid fa-plus mr-1"></i>Adicionar Ingrediente
                    </button>
                </div>
                <div class="mt-8 flex justify-end">
                    <button id="save-recipe-btn" type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg shadow-md">
                        Salvar Receita
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal de Ordem de Produção -->
    <div id="production-order-modal" class="modal p-4">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-5xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 id="production-order-modal-title" class="text-2xl font-bold">Nova Ordem de Produção</h2>
                <button id="close-production-order-modal" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <form id="production-order-form">
                <input type="hidden" id="edit-po-id">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                     <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700">Selecione a Receita</label>
                        <div id="po-recipe-searchable-container" class="searchable-container"></div>
                    </div>
                    <div>
                        <label for="po-quantity" class="block text-sm font-medium text-gray-700">Qtd. de Receitas</label>
                        <input type="number" id="po-quantity" value="1" min="1" required class="mt-1 block w-full form-input">
                    </div>
                </div>
                 <div class="mt-4">
                    <label for="po-date" class="block text-sm font-medium text-gray-700">Data da Produção</label>
                    <input type="date" id="po-date" required class="mt-1 block w-full form-input">
                </div>
                <h3 class="text-lg font-medium pt-6 mb-2">Insumos Necessários</h3>
                <div class="overflow-x-auto border rounded-lg">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-2 py-2 text-left">Insumo</th>
                                <th class="px-2 py-2 text-left">Residual</th>
                                <th class="px-2 py-2 text-left">Qtd. Necessária</th>
                                <th class="px-2 py-2 text-left">Qtd. a Usar</th>
                                <th class="px-2 py-2 text-left">Lote de Consumo</th>
                                <th class="px-2 py-2 text-left">Manipulador</th>
                            </tr>
                        </thead>
                        <tbody id="po-ingredients-body"></tbody>
                    </table>
                </div>
                <div class="mt-8 flex justify-end">
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg shadow-md">
                        Criar Ordem de Produção
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Confirmação de Produção -->
    <div id="confirm-production-modal" class="modal p-4">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
             <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Confirmar Produção e Baixa de Estoque</h2>
                <button id="close-confirm-production-modal" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <p class="text-sm text-gray-600 mb-4">Resumo de todos os insumos para as ordens de produção selecionadas.</p>
             <div class="overflow-x-auto border rounded-lg">
                <table class="w-full text-sm">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left">Insumo</th>
                            <th class="px-4 py-2 text-left">Qtd. Requisitada</th>
                            <th class="px-4 py-2 text-left">Qtd. Entregue (editável)</th>
                        </tr>
                    </thead>
                    <tbody id="confirm-production-tbody"></tbody>
                </table>
             </div>
             <div class="mt-8 flex justify-end">
                <button id="btn-execute-stock-consumption" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md">
                    Confirmar e Dar Baixa no Estoque
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Confirmação de Upload -->
    <div id="confirm-upload-modal" class="modal">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                    <i class="fa-solid fa-triangle-exclamation text-red-600 text-2xl"></i>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mt-4">Confirmar Restauração</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500">
                        Você tem certeza que deseja restaurar o backup? <strong>Todos os dados atuais serão apagados e substituídos</strong> por completo. Essa ação não pode ser desfeita.
                    </p>
                </div>
            </div>
            <div class="mt-6 flex justify-center space-x-4">
                <button id="cancel-upload-btn" type="button" class="py-2 px-4 bg-gray-200 text-gray-800 font-semibold rounded-lg shadow-md hover:bg-gray-300">
                    Cancelar
                </button>
                <button id="confirm-upload-btn" type="button" class="py-2 px-4 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700">
                    Sim, Substituir Tudo
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação Genérica -->
    <div id="confirm-action-modal" class="modal">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                    <i class="fa-solid fa-triangle-exclamation text-red-600 text-2xl"></i>
                </div>
                <h3 id="confirm-title" class="text-lg leading-6 font-medium text-gray-900 mt-4">Confirmar Ação</h3>
                <div class="mt-2 px-7 py-3">
                    <p id="confirm-message" class="text-sm text-gray-500">
                        Você tem certeza? Essa ação não pode ser desfeita.
                    </p>
                </div>
            </div>
            <div class="mt-6 flex justify-center space-x-4">
                <button id="cancel-action-btn" type="button" class="py-2 px-4 bg-gray-200 text-gray-800 font-semibold rounded-lg shadow-md hover:bg-gray-300">
                    Cancelar
                </button>
                <button id="confirm-action-btn" type="button" class="py-2 px-4 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700">
                    Confirmar
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Informações da Dashboard -->
    <div id="info-list-modal" class="modal p-4">
         <div class="bg-white rounded-lg shadow-xl p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
             <div class="flex justify-between items-center mb-6">
                <h2 id="info-list-title" class="text-2xl font-bold">Detalhes do Alerta</h2>
                <button id="close-info-list-modal" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div id="info-list-content" class="overflow-x-auto">
                <!-- Conteúdo da lista será inserido aqui -->
            </div>
         </div>
    </div>


    <!-- Modal de Notificação -->
    <div id="notification-modal" class="fixed top-5 right-5 z-[100] hidden text-white py-2 px-5 rounded-lg shadow-lg">
        <p id="notification-message"></p>
    </div>

<script type="module">
    // --- MÓDULO DO BANCO DE DADOS OFFLINE (IndexedDB) ---
    const DB = (() => {
        let dbInstance;

        function init() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('estoqueDB', 4); // Versão incrementada para novo Object Store

                request.onerror = (event) => reject("Erro ao abrir o banco de dados.");

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('inventory')) {
                        const inventoryStore = db.createObjectStore('inventory', { keyPath: 'id', autoIncrement: true });
                        inventoryStore.createIndex('code', 'code', { unique: false });
                    }
                    if (!db.objectStoreNames.contains('batches')) {
                        const batchesStore = db.createObjectStore('batches', { keyPath: 'id', autoIncrement: true });
                        batchesStore.createIndex('productId', 'productId', { unique: false });
                    }
                    if (!db.objectStoreNames.contains('history')) {
                        db.createObjectStore('history', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains('recipes')) {
                        db.createObjectStore('recipes', { keyPath: 'id', autoIncrement: true });
                    }
                     if (!db.objectStoreNames.contains('productionOrders')) {
                        db.createObjectStore('productionOrders', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains('monthlyConsumption')) {
                         const consumptionStore = db.createObjectStore('monthlyConsumption', { keyPath: 'id', autoIncrement: true });
                         consumptionStore.createIndex('period', 'period', { unique: false });
                    }
                    if (!db.objectStoreNames.contains('residualStock')) {
                         db.createObjectStore('residualStock', { keyPath: 'productId' });
                    }
                };

                request.onsuccess = (event) => {
                    dbInstance = event.target.result;
                    resolve(dbInstance);
                };
            });
        }

        async function getDB() {
            if (!dbInstance) await init();
            return dbInstance;
        }

        async function add(storeName, data) {
            const db = await getDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.add(data);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function get(storeName, key) {
             const db = await getDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.get(key);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }
        
        async function getByIndex(storeName, indexName, value) {
            const db = await getDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readonly');
                const store = transaction.objectStore(storeName);
                const index = store.index(indexName);
                const request = index.get(value);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function getAll(storeName) {
            const db = await getDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function update(storeName, data) {
            const db = await getDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.put(data);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }
        
        async function remove(storeName, key) {
             const db = await getDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.delete(key);
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }
        
        async function clear(storeName) {
            const db = await getDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.clear();
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        return { add, get, getAll, update, getByIndex, getDB, clear, remove };
    })();

    // --- STATE MANAGEMENT ---
    let localInventory = [], localBatches = [], localHistory = [], localRecipes = [], localProductionOrders = [], localMonthlyConsumption = [], localResidualStock = [];
    let currentSort = { key: 'name', order: 'asc' };
    let tempEntryData = null;
    let backupFileContent = null; 
    let criticalQuantityChart = null;
    let criticalExpiryChart = null;

    // --- DOM ELEMENTS ---
    const loadingOverlay = document.getElementById('loading-overlay');
    const screens = { dashboard: document.getElementById('screen-dashboard'), entry: document.getElementById('screen-entry'), inventory: document.getElementById('screen-inventory'), recipes: document.getElementById('screen-recipes'), production: document.getElementById('screen-production'), requisitions: document.getElementById('screen-requisitions'), adjustments: document.getElementById('screen-adjustments'), consumption: document.getElementById('screen-consumption'), residual: document.getElementById('screen-residual'), settings: document.getElementById('screen-settings') };
    const navLinks = { dashboard: document.getElementById('nav-dashboard'), entry: document.getElementById('nav-entry'), inventory: document.getElementById('nav-inventory'), recipes: document.getElementById('nav-recipes'), production: document.getElementById('nav-production'), requisitions: document.getElementById('nav-requisitions'), adjustments: document.getElementById('nav-adjustments'), consumption: document.getElementById('nav-consumption'), residual: document.getElementById('nav-residual'), settings: document.getElementById('nav-settings') };
    const entryForm = document.getElementById('entry-form');
    const shelfLifeModal = document.getElementById('shelf-life-modal');
    const shelfLifeValue = document.getElementById('shelf-life-value');
    const authorizerNameInput = document.getElementById('authorizer-name');
    const cancelReceiptBtn = document.getElementById('cancel-receipt-btn');
    const confirmReceiptBtn = document.getElementById('confirm-receipt-btn');
    const inventoryTableBody = document.getElementById('inventory-table-body');
    const searchInput = document.getElementById('search-inventory');
    const btnExportExcel = document.getElementById('btn-export-excel');
    const detailsModal = document.getElementById('item-details-modal');
    const detailsBatchesTable = document.getElementById('details-batches-table');
    const closeDetailsModalBtn = document.getElementById('close-details-modal');
    const btnNewRecipe = document.getElementById('btn-new-recipe');
    const recipeModal = document.getElementById('recipe-modal');
    const recipeModalTitle = document.getElementById('recipe-modal-title');
    const saveRecipeBtn = document.getElementById('save-recipe-btn');
    const closeRecipeModalBtn = document.getElementById('close-recipe-modal');
    const recipeForm = document.getElementById('recipe-form');
    const addIngredientBtn = document.getElementById('add-ingredient-btn');
    const ingredientsContainer = document.getElementById('ingredients-container');
    const notificationModal = document.getElementById('notification-modal');
    const notificationMessage = document.getElementById('notification-message');
    const itemDetailsView = document.getElementById('item-details-view');
    const itemDetailsEdit = document.getElementById('item-details-edit');
    const btnEditItem = document.getElementById('btn-edit-item');
    const btnCancelEdit = document.getElementById('btn-cancel-edit');
    const editItemForm = document.getElementById('edit-item-form');
    const detailsHistoryContainer = document.getElementById('details-history-container');
    const recipesList = document.getElementById('recipes-list');
    const productionOrdersList = document.getElementById('production-orders-list');
    const btnNewProductionOrder = document.getElementById('btn-new-production-order');
    const productionOrderModal = document.getElementById('production-order-modal');
    const productionOrderModalTitle = document.getElementById('production-order-modal-title');
    const closeProductionOrderModalBtn = document.getElementById('close-production-order-modal');
    const productionOrderForm = document.getElementById('production-order-form');
    const poRecipeSearchableContainer = document.getElementById('po-recipe-searchable-container');
    const poIngredientsBody = document.getElementById('po-ingredients-body');
    const poQuantity = document.getElementById('po-quantity');
    const poDate = document.getElementById('po-date');
    const searchPoByDate = document.getElementById('search-po-by-date');
    const btnExportPdf = document.getElementById('btn-export-pdf');
    const btnConfirmProduction = document.getElementById('btn-confirm-production');
    const confirmProductionModal = document.getElementById('confirm-production-modal');
    const closeConfirmProductionModalBtn = document.getElementById('close-confirm-production-modal');
    const productionDateFilter = document.getElementById('production-date-filter');
    const confirmProductionTbody = document.getElementById('confirm-production-tbody');
    const btnExecuteStockConsumption = document.getElementById('btn-execute-stock-consumption');
    const btnDownloadBackup = document.getElementById('btn-download-backup');
    const btnUploadBackup = document.getElementById('btn-upload-backup');
    const backupFileInput = document.getElementById('backup-file-input');
    const confirmUploadModal = document.getElementById('confirm-upload-modal');
    const cancelUploadBtn = document.getElementById('cancel-upload-btn');
    const confirmUploadBtn = document.getElementById('confirm-upload-btn');
    const confirmActionModal = document.getElementById('confirm-action-modal');
    const editBatchModal = document.getElementById('edit-batch-modal');
    const closeEditBatchModal = document.getElementById('close-edit-batch-modal');
    const editBatchForm = document.getElementById('edit-batch-form');
    const adjustmentForm = document.getElementById('adjustment-form');
    const adjustmentSearchableContainer = document.getElementById('adjustment-searchable-container');
    const adjustmentBatchSelect = document.getElementById('adjustment-batch');
    const requisitionForm = document.getElementById('requisition-form');
    const requisitionItemsContainer = document.getElementById('requisition-items-container');
    const addRequisitionItemBtn = document.getElementById('add-requisition-item-btn');
    const consumptionMonthFilter = document.getElementById('consumption-month-filter');
    const consumptionYearFilter = document.getElementById('consumption-year-filter');
    const consumptionTableBody = document.getElementById('consumption-table-body');
    const residualTableBody = document.getElementById('residual-table-body');
    const editResidualModal = document.getElementById('edit-residual-modal');
    const closeEditResidualModal = document.getElementById('close-edit-residual-modal');
    const editResidualForm = document.getElementById('edit-residual-form');
    const btnResetDatabase = document.getElementById('btn-reset-database');
    const cardLowStock = document.getElementById('card-low-stock');
    const cardExpiringSoon = document.getElementById('card-expiring-soon');
    const infoListModal = document.getElementById('info-list-modal');
    const closeInfoListModalBtn = document.getElementById('close-info-list-modal');
    const supplierFilter = document.getElementById('supplier-filter');

    
    // --- FUNÇÕES AUXILIARES ---
    function showNotification(message, isError = false) {
        notificationMessage.textContent = message;
        notificationModal.classList.toggle('bg-green-500', !isError);
        notificationModal.classList.toggle('bg-red-500', isError);
        notificationModal.style.display = 'block';
        setTimeout(() => {
             notificationModal.style.display = 'none';
        }, 4000);
    }

    function showModal(modalElement) {
        modalElement.style.display = 'flex';
    }

    function hideModal(modalElement) {
        modalElement.style.display = 'none';
    }
    
    function showConfirmationModal(title, message, onConfirm) {
        document.getElementById('confirm-title').textContent = title;
        document.getElementById('confirm-message').innerHTML = message;
        showModal(confirmActionModal);

        const cancelBtn = document.getElementById('cancel-action-btn');
        const confirmBtn = document.getElementById('confirm-action-btn');

        const cleanup = () => {
            hideModal(confirmActionModal);
            confirmBtn.replaceWith(confirmBtn.cloneNode(true));
            cancelBtn.replaceWith(cancelBtn.cloneNode(true));
        };

        cancelBtn.addEventListener('click', cleanup, { once: true });
        confirmBtn.addEventListener('click', () => {
            onConfirm();
            cleanup();
        }, { once: true });
    }

    function createSearchableSelect(container, items, placeholder, onSelect) {
        container.innerHTML = `
            <input type="text" class="form-input w-full" placeholder="${placeholder}">
            <div class="searchable-dropdown hidden"></div>
        `;
        const input = container.querySelector('input');
        const dropdown = container.querySelector('.searchable-dropdown');

        input.addEventListener('input', () => {
            const searchTerm = input.value.toLowerCase();
            dropdown.innerHTML = '';
            if (searchTerm) {
                const filteredItems = items.filter(item => item.name.toLowerCase().includes(searchTerm));
                if (filteredItems.length > 0) {
                    filteredItems.forEach(item => {
                        const itemEl = document.createElement('div');
                        itemEl.className = 'searchable-item';
                        itemEl.textContent = item.name;
                        itemEl.dataset.id = item.id;
                        dropdown.appendChild(itemEl);
                    });
                    dropdown.classList.remove('hidden');
                } else {
                    dropdown.classList.add('hidden');
                }
            } else {
                dropdown.classList.add('hidden');
            }
        });

        dropdown.addEventListener('click', e => {
            if (e.target.classList.contains('searchable-item')) {
                const selectedId = parseInt(e.target.dataset.id);
                const selectedItem = items.find(item => item.id === selectedId);
                input.value = selectedItem.name;
                input.dataset.selectedId = selectedId;
                dropdown.classList.add('hidden');
                if (onSelect) onSelect(selectedItem);
            }
        });

        document.addEventListener('click', e => {
            if (!container.contains(e.target)) {
                dropdown.classList.add('hidden');
            }
        });
    }

    // --- NAVIGATION ---
    function navigateTo(screenName) {
        Object.values(screens).forEach(screen => screen.classList.add('hidden'));
        screens[screenName].classList.remove('hidden');
        Object.values(navLinks).forEach(link => link.classList.remove('active-nav'));
        navLinks[screenName].classList.add('active-nav');
        // Add logic to initialize screens with dynamic content
        if (screenName === 'adjustments') {
            initializeAdjustmentScreen();
        }
        if (screenName === 'requisitions') {
            initializeRequisitionScreen();
        }
    }
    Object.keys(navLinks).forEach(key => { navLinks[key].addEventListener('click', (e) => { e.preventDefault(); navigateTo(key); }); });

    // --- ENTRY SCREEN LOGIC ---
    function calculateShelfLife(mfg, receipt, expiry) {
        const mfgDate = new Date(mfg + 'T00:00:00');
        const receiptDate = new Date(receipt + 'T00:00:00');
        const expiryDate = new Date(expiry + 'T00:00:00');
        const totalLife = expiryDate.getTime() - mfgDate.getTime();
        const remainingLife = expiryDate.getTime() - receiptDate.getTime();
        if (totalLife <= 0) return 0;
        return ((remainingLife / totalLife) * 100).toFixed(1);
    }
    entryForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const formData = new FormData(entryForm);
        const data = {
            name: formData.get('product-name'), code: formData.get('product-code') || 'N/A', supplier: formData.get('supplier'),
            quantity: parseFloat(formData.get('quantity')), batchCode: formData.get('batch-code') || 'N/A',
            mfgDate: document.getElementById('mfg-date').value, receiptDate: document.getElementById('receipt-date').value,
            expiryDate: document.getElementById('expiry-date').value
        };
        let shelfLife = 100;
        if (data.mfgDate && data.receiptDate && data.expiryDate) { shelfLife = calculateShelfLife(data.mfgDate, data.receiptDate, data.expiryDate); }
        data.shelfLife = shelfLife;
        tempEntryData = data;
        if (shelfLife < 75 && data.mfgDate && data.expiryDate) {
            shelfLifeValue.textContent = shelfLife;
            showModal(shelfLifeModal);
        } else { saveEntry(); }
    });

    async function saveEntry(authorizedBy = null) {
        const data = tempEntryData;
        if (!data) return;
        try {
            let product = await DB.getByIndex('inventory', 'code', data.code);
            let productId;
            if (!product) {
                productId = await DB.add('inventory', { code: data.code, name: data.name, supplier: data.supplier, totalQuantity: data.quantity });
            } else {
                productId = product.id;
                product.totalQuantity += data.quantity;
                await DB.update('inventory', product);
            }
            await DB.add('batches', { productId, code: data.batchCode, quantity: data.quantity, mfgDate: data.mfgDate, receiptDate: data.receiptDate, expiryDate: data.expiryDate, shelfLife: data.shelfLife, authorizedBy });
            await DB.add('history', { productId, batchCode: data.batchCode, type: 'entrada', quantity: data.quantity, date: data.receiptDate });
            showNotification('Entrada registrada com sucesso!');
            entryForm.reset();
            closeShelfLifeModal();
            await refreshLocalData();
        } catch (error) {
            console.error("Erro ao salvar entrada: ", error);
            showNotification("Erro ao salvar entrada.", true);
        }
    }
    function closeShelfLifeModal() {
        hideModal(shelfLifeModal);
        authorizerNameInput.value = '';
        tempEntryData = null;
    }
    cancelReceiptBtn.addEventListener('click', closeShelfLifeModal);
    confirmReceiptBtn.addEventListener('click', () => {
        const authorizer = authorizerNameInput.value;
        if (!authorizer.trim()) {
            showNotification('Por favor, insira o nome do responsável.', true);
            return;
        }
        saveEntry(authorizer);
    });

    // --- INVENTORY SCREEN LOGIC ---
    function renderInventoryTable(specialFilter = null) {
        let filteredInventory = [...localInventory];
        let searchTerm = searchInput.value.toLowerCase();
        const selectedSupplier = supplierFilter.value;
        
        if (specialFilter) {
            searchInput.value = ''; // Clear search bar for special filters
            if (specialFilter === 'low-stock') {
                const lowStockItems = localInventory.filter(i => {
                    const metrics = calculateConsumptionMetrics(i.id);
                    const minStock = i.minStock !== null && i.minStock !== undefined ? i.minStock : metrics.minStock;
                    return i.totalQuantity < minStock && minStock > 0;
                });
                const lowStockIds = new Set(lowStockItems.map(i => i.id));
                filteredInventory = filteredInventory.filter(item => lowStockIds.has(item.id));
            } else if (specialFilter === 'expiring-soon') {
                const today = new Date();
                const thirtyDaysFromNow = new Date();
                thirtyDaysFromNow.setDate(today.getDate() + 30);
                const expiringBatches = localBatches.filter(b => b.quantity > 0 && b.expiryDate && new Date(b.expiryDate) <= thirtyDaysFromNow);
                const expiringProductIds = new Set(expiringBatches.map(b => b.productId));
                filteredInventory = filteredInventory.filter(item => expiringProductIds.has(item.id));
            }
        } else {
            if (searchTerm) {
                filteredInventory = filteredInventory.filter(item => 
                    item.name.toLowerCase().includes(searchTerm) ||
                    item.code.toLowerCase().includes(searchTerm) ||
                    item.supplier.toLowerCase().includes(searchTerm)
                );
            }
            if (selectedSupplier) {
                filteredInventory = filteredInventory.filter(item => item.supplier === selectedSupplier);
            }
        }

        filteredInventory.sort((a, b) => {
            let valA, valB;
            if (currentSort.key === 'expiry') {
                valA = getNextExpiry(a.id) || '9999-12-31';
                valB = getNextExpiry(b.id) || '9999-12-31';
            } else {
                valA = a[currentSort.key] || '';
                valB = b[currentSort.key] || '';
            }
             if (typeof valA === 'string') valA = valA.toLowerCase();
            if (typeof valB === 'string') valB = valB.toLowerCase();
            if (valA < valB) return currentSort.order === 'asc' ? -1 : 1;
            if (valA > valB) return currentSort.order === 'asc' ? 1 : -1;
            return 0;
        });

        document.querySelectorAll('.table-header-sortable i').forEach(icon => icon.remove());
        const activeHeader = document.querySelector(`.table-header-sortable[data-sort="${currentSort.key}"]`);
        if (activeHeader) {
            const icon = document.createElement('i');
            icon.className = `fa-solid ${currentSort.order === 'asc' ? 'fa-arrow-up' : 'fa-arrow-down'} ml-2`;
            activeHeader.appendChild(icon);
        }

        inventoryTableBody.innerHTML = '';
        if (filteredInventory.length === 0) {
            inventoryTableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4">Nenhum item encontrado.</td></tr>`;
            return;
        }
        filteredInventory.forEach(item => {
            const nextExpiry = getNextExpiry(item.id);
            const row = document.createElement('tr');
            row.className = 'bg-white border-b hover:bg-gray-50 cursor-pointer';
            row.addEventListener('click', () => showItemDetails(item.id));
            row.innerHTML = `
                <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${item.name}</td>
                <td class="px-6 py-4">${item.code}</td>
                <td class="px-6 py-4">${item.supplier}</td>
                <td class="px-6 py-4 text-right">${item.totalQuantity.toFixed(2)}</td>
                <td class="px-6 py-4">${nextExpiry ? new Date(nextExpiry + 'T00:00:00').toLocaleDateString('pt-BR') : 'N/A'}</td>
            `;
            inventoryTableBody.appendChild(row);
        });
    }
    function getNextExpiry(productId) {
         const productBatches = localBatches.filter(b => b.productId === productId && b.quantity > 0);
        if (productBatches.length === 0) return null;
        return productBatches.sort((a, b) => new Date(a.expiryDate) - new Date(b.expiryDate))[0].expiryDate;
    }
    document.querySelectorAll('.table-header-sortable').forEach(header => { 
        header.addEventListener('click', () => {
            const sortKey = header.dataset.sort;
            if (!sortKey) return;
            if (currentSort.key === sortKey) {
                currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.key = sortKey;
                currentSort.order = 'asc';
            }
            renderInventoryTable();
        });
    });
    searchInput.addEventListener('input', () => renderInventoryTable());
    supplierFilter.addEventListener('change', () => renderInventoryTable());

    function populateSupplierFilter() {
        const suppliers = [...new Set(localInventory.map(item => item.supplier))].sort();
        const currentVal = supplierFilter.value;
        supplierFilter.innerHTML = `<option value="">Todos os Fornecedores</option>`;
        suppliers.forEach(supplier => {
            const option = document.createElement('option');
            option.value = supplier;
            option.textContent = supplier;
            if (supplier === currentVal) {
                option.selected = true;
            }
            supplierFilter.appendChild(option);
        });
    }
    
    // --- ITEM DETAILS & EDIT MODAL ---
    function calculateConsumptionMetrics(productId) {
        const today = new Date();
        const currentPeriod = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
        const consumptionRecord = localMonthlyConsumption.find(c => c.period === currentPeriod && c.productId === productId);
        
        const monthlyConsumption = consumptionRecord ? consumptionRecord.totalConsumed : 0;
        const avgConsumption = monthlyConsumption / 22; // Dias úteis no mês

        const leadTime = 7; // Tempo de reposição em dias (exemplo)
        const replenishmentPeriod = 30; // Período de compra em dias (exemplo)

        const minStock = avgConsumption * leadTime;
        const maxStock = minStock + (avgConsumption * replenishmentPeriod);
        
        return { avgConsumption, minStock, maxStock };
    }

    function showItemDetails(productId) {
        const product = localInventory.find(p => p.id === productId);
        if (!product) return;
        
        document.getElementById('details-product-name').textContent = product.name;
        document.getElementById('details-product-code').textContent = product.code;
        document.getElementById('details-supplier').textContent = product.supplier;
        document.getElementById('details-total-quantity').textContent = product.totalQuantity.toFixed(2);
        
        const metrics = calculateConsumptionMetrics(productId);
        
        document.getElementById('details-avg-consumption').textContent = metrics.avgConsumption.toFixed(2);

        if (product.minStock !== null && product.minStock !== undefined) {
            document.getElementById('details-min-stock').innerHTML = `${product.minStock.toFixed(2)} <span class="text-xs text-gray-500">(sugestão: ${metrics.minStock.toFixed(2)})</span>`;
        } else {
            document.getElementById('details-min-stock').innerHTML = `${metrics.minStock.toFixed(2)} <span class="text-xs text-gray-500">(sugestão)</span>`;
        }
        
        if (product.maxStock !== null && product.maxStock !== undefined) {
             document.getElementById('details-max-stock').innerHTML = `${product.maxStock.toFixed(2)} <span class="text-xs text-gray-500">(sugestão: ${metrics.maxStock.toFixed(2)})</span>`;
        } else {
            document.getElementById('details-max-stock').innerHTML = `${metrics.maxStock.toFixed(2)} <span class="text-xs text-gray-500">(sugestão)</span>`;
        }
        
        document.getElementById('edit-item-id').value = product.id;
        document.getElementById('edit-product-name').value = product.name;
        document.getElementById('edit-product-code').value = product.code;
        document.getElementById('edit-supplier').value = product.supplier;
        document.getElementById('edit-min-stock').value = product.minStock;
        document.getElementById('edit-max-stock').value = product.maxStock;

        const batches = localBatches.filter(b => b.productId === productId && b.quantity > 0);
        const history = localHistory.filter(h => h.productId === productId).sort((a, b) => new Date(b.date) - new Date(a.date));

        detailsBatchesTable.innerHTML = batches.map(batch => `
            <tr class="border-b">
                <td class="px-4 py-2">${batch.code}</td>
                <td class="px-4 py-2">${batch.quantity.toFixed(2)}</td>
                <td class="px-4 py-2">${batch.expiryDate ? new Date(batch.expiryDate + 'T00:00:00').toLocaleDateString('pt-BR') : 'N/A'}</td>
                <td class="px-4 py-2 text-center">
                    <button class="edit-batch-btn text-blue-500 hover:text-blue-700 p-1" data-batch-id="${batch.id}" title="Editar Lote"><i class="fa-solid fa-pencil"></i></button>
                    <button class="delete-batch-btn text-red-500 hover:text-red-700 p-1" data-batch-id="${batch.id}" title="Excluir Lote"><i class="fa-solid fa-trash"></i></button>
                </td>
            </tr>`).join('');
        
        const groupedHistory = history.reduce((acc, entry) => {
            (acc[entry.date] = acc[entry.date] || []).push(entry);
            return acc;
        }, {});

        detailsHistoryContainer.innerHTML = Object.keys(groupedHistory).sort((a,b) => new Date(b) - new Date(a)).map(date => `
            <div class="pt-2">
                <h4 class="bg-gray-100 p-2 font-semibold text-sm sticky top-0">${new Date(date + 'T00:00:00').toLocaleDateString('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</h4>
                <table class="w-full text-sm text-left">
                    <tbody>
                        ${groupedHistory[date].map(entry => `
                        <tr class="border-b">
                            <td class="px-4 py-2 w-1/3">
                                <span class="font-medium ${entry.type === 'entrada' ? 'text-green-600' : 'text-red-600'}">${entry.type.charAt(0).toUpperCase() + entry.type.slice(1)}</span>
                                <span class="text-gray-500 text-xs block">${entry.reason || ''} ${entry.responsible ? `(Resp: ${entry.responsible})` : ''}</span>
                            </td>
                            <td class="px-4 py-2 w-1/3">${entry.quantity.toFixed(2)}</td>
                            <td class="px-4 py-2 w-1/3">${entry.batchCode}</td>
                        </tr>`).join('')}
                    </tbody>
                </table>
            </div>
        `).join('');

        itemDetailsView.classList.remove('hidden');
        itemDetailsEdit.classList.add('hidden');
        showModal(detailsModal);
    }
    closeDetailsModalBtn.addEventListener('click', () => { hideModal(detailsModal) });
    btnEditItem.addEventListener('click', () => { itemDetailsView.classList.add('hidden'); itemDetailsEdit.classList.remove('hidden'); });
    btnCancelEdit.addEventListener('click', () => { itemDetailsView.classList.remove('hidden'); itemDetailsEdit.classList.add('hidden'); });

    editItemForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const updatedData = {
            id: parseInt(document.getElementById('edit-item-id').value),
            name: document.getElementById('edit-product-name').value,
            code: document.getElementById('edit-product-code').value,
            supplier: document.getElementById('edit-supplier').value,
        };
        const minStock = parseFloat(document.getElementById('edit-min-stock').value);
        const maxStock = parseFloat(document.getElementById('edit-max-stock').value);
        updatedData.minStock = isNaN(minStock) ? null : minStock;
        updatedData.maxStock = isNaN(maxStock) ? null : maxStock;

        try {
            const item = await DB.get('inventory', updatedData.id);
            const fullItem = { ...item, ...updatedData };
            await DB.update('inventory', fullItem);
            showNotification("Item atualizado com sucesso!");
            itemDetailsView.classList.remove('hidden');
            itemDetailsEdit.classList.add('hidden');
            await refreshLocalData();
            showItemDetails(updatedData.id);
        } catch (error) {
            console.error("Erro ao atualizar o item:", error);
            showNotification("Erro ao atualizar o item.", true);
        }
    });
    
    // --- BATCH EDIT/DELETE ---
    detailsBatchesTable.addEventListener('click', e => {
        const editBtn = e.target.closest('.edit-batch-btn');
        if (editBtn) {
            handleEditBatch(parseInt(editBtn.dataset.batchId));
        }
        const deleteBtn = e.target.closest('.delete-batch-btn');
        if(deleteBtn) {
            handleDeleteBatch(parseInt(deleteBtn.dataset.batchId));
        }
    });

    async function handleEditBatch(batchId) {
        const batch = localBatches.find(b => b.id === batchId);
        if (!batch) return;
        document.getElementById('edit-batch-id').value = batch.id;
        document.getElementById('edit-batch-code').value = batch.code;
        document.getElementById('edit-batch-quantity').value = batch.quantity;
        document.getElementById('edit-batch-expiry-date').value = batch.expiryDate;
        showModal(editBatchModal);
    }

    closeEditBatchModal.addEventListener('click', () => hideModal(editBatchModal));
    
    editBatchForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const batchId = parseInt(document.getElementById('edit-batch-id').value);
        const newCode = document.getElementById('edit-batch-code').value;
        const newQuantity = parseFloat(document.getElementById('edit-batch-quantity').value);
        const newExpiryDate = document.getElementById('edit-batch-expiry-date').value;

        try {
            const batch = await DB.get('batches', batchId);
            const oldQuantity = batch.quantity;
            batch.code = newCode;
            batch.quantity = newQuantity;
            batch.expiryDate = newExpiryDate;

            if (batch.mfgDate && batch.receiptDate && newExpiryDate) {
                batch.shelfLife = calculateShelfLife(batch.mfgDate, batch.receiptDate, newExpiryDate);
            } else {
                batch.shelfLife = 100;
            }

            await DB.update('batches', batch);

            const quantityDifference = newQuantity - oldQuantity;
            const product = await DB.get('inventory', batch.productId);
            product.totalQuantity += quantityDifference;
            await DB.update('inventory', product);

            showNotification("Lote atualizado com sucesso!");
            hideModal(editBatchModal);
            await refreshLocalData();
            showItemDetails(batch.productId); // Refresh details view
        } catch (error) {
            showNotification("Erro ao atualizar o lote.", true);
            console.error(error);
        }
    });

    function handleDeleteBatch(batchId) {
        const batch = localBatches.find(b => b.id === batchId);
        if (!batch) return;

        showConfirmationModal("Excluir Lote", `Tem certeza que deseja excluir o lote <strong>${batch.code}</strong>? A quantidade (${batch.quantity.toFixed(2)}) será removida do estoque total.`, async () => {
            try {
                await DB.remove('batches', batchId);
                const product = await DB.get('inventory', batch.productId);
                product.totalQuantity -= batch.quantity;
                await DB.update('inventory', product);

                await DB.add('history', {
                    productId: batch.productId,
                    batchCode: batch.code,
                    type: 'exclusão',
                    quantity: batch.quantity,
                    date: new Date().toISOString().split('T')[0]
                });

                showNotification("Lote excluído com sucesso!");
                await refreshLocalData();
                showItemDetails(batch.productId);
            } catch(error) {
                showNotification("Erro ao excluir lote.", true);
                console.error(error);
            }
        });
    }


    // --- RECIPES SCREEN LOGIC ---
    function renderRecipes() {
        recipesList.innerHTML = '';
        if (localRecipes.length === 0) {
            recipesList.innerHTML = `<p class="text-gray-500 col-span-full">Nenhuma receita criada ainda.</p>`
            return;
        }
        const categories = [...new Set(localRecipes.map(r => r.category))].sort();
        categories.forEach(category => {
            const categoryDiv = document.createElement('div');
            categoryDiv.innerHTML = `<h2 class="text-xl font-semibold mb-3 text-gray-700">${category}</h2>`;
            const recipeCards = document.createElement('div');
            recipeCards.className = 'space-y-4';
            localRecipes.filter(r => r.category === category).forEach(recipe => {
                const card = document.createElement('div');
                card.className = 'relative bg-white p-4 rounded-lg shadow transition hover:shadow-md';
                let ingredientsHtml = recipe.ingredients.map(ing => {
                    const product = localInventory.find(p => p.id === ing.productId);
                    return `<li class="text-sm text-gray-600">${product ? product.name : 'Ingrediente desconhecido'}: ${ing.quantity}</li>`;
                }).join('');
                card.innerHTML = `
                    <div class="absolute top-2 right-2 flex space-x-2">
                        <button class="edit-recipe-btn text-blue-500 hover:text-blue-700" data-recipe-id="${recipe.id}" title="Editar"><i class="fa-solid fa-pencil"></i></button>
                        <button class="delete-recipe-btn text-red-500 hover:text-red-700" data-recipe-id="${recipe.id}" title="Excluir"><i class="fa-solid fa-trash"></i></button>
                    </div>
                    <h3 class="font-bold">${recipe.name}</h3>
                    <ul class="list-disc list-inside mt-2">${ingredientsHtml}</ul>
                `;
                recipeCards.appendChild(card);
            });
            categoryDiv.appendChild(recipeCards);
            recipesList.appendChild(categoryDiv);
        });
    }

    recipesList.addEventListener('click', (e) => {
        const editBtn = e.target.closest('.edit-recipe-btn');
        if (editBtn) {
            handleEditRecipe(parseInt(editBtn.dataset.recipeId));
        }
        const deleteBtn = e.target.closest('.delete-recipe-btn');
        if (deleteBtn) {
            handleDeleteRecipe(parseInt(deleteBtn.dataset.recipeId));
        }
    });
    
    function handleEditRecipe(recipeId) {
        const recipe = localRecipes.find(r => r.id === recipeId);
        if (!recipe) return;
        
        document.getElementById('edit-recipe-id').value = recipe.id;
        document.getElementById('recipe-name').value = recipe.name;
        document.getElementById('recipe-category').value = recipe.category;

        ingredientsContainer.innerHTML = '';
        recipe.ingredients.forEach(ing => {
            addIngredientRow(ing.productId, ing.quantity);
        });

        recipeModalTitle.textContent = "Editar Receita";
        saveRecipeBtn.textContent = "Salvar Alterações";
        showModal(recipeModal);
    }
    
    function handleDeleteRecipe(recipeId) {
         const recipe = localRecipes.find(r => r.id === recipeId);
         if(!recipe) return;

         showConfirmationModal(
            "Excluir Receita",
            `Tem certeza que deseja excluir a receita "<strong>${recipe.name}</strong>"?`,
            async () => {
                try {
                    await DB.remove('recipes', recipeId);
                    showNotification("Receita excluída com sucesso.");
                    await refreshLocalData();
                } catch(err) {
                    showNotification("Erro ao excluir a receita.", true);
                }
            }
        );
    }

    btnNewRecipe.addEventListener('click', () => {
        if(localInventory.length === 0) { showNotification("Adicione itens ao estoque antes de criar uma receita.", true); return; }
        recipeForm.reset();
        document.getElementById('edit-recipe-id').value = '';
        ingredientsContainer.innerHTML = '';
        addIngredientRow();
        recipeModalTitle.textContent = "Criar Nova Receita";
        saveRecipeBtn.textContent = "Salvar Receita";
        showModal(recipeModal);
    });

    closeRecipeModalBtn.addEventListener('click', () => hideModal(recipeModal));
    
    function addIngredientRow(selectedProductId = null, quantity = null) {
        const row = document.createElement('div');
        row.className = 'flex items-center space-x-2';
        row.innerHTML = `
            <div class="searchable-container flex-1"></div>
            <input type="number" placeholder="Qtd" value="${quantity || ''}" min="0.01" step="0.01" class="block w-1/3 form-input" required>
            <button type="button" class="text-red-500 hover:text-red-700 remove-ingredient-btn font-bold text-xl">&times;</button>
        `;
        ingredientsContainer.appendChild(row);

        const searchableContainer = row.querySelector('.searchable-container');
        createSearchableSelect(searchableContainer, localInventory, 'Buscar ingrediente...', null);

        if (selectedProductId) {
            const product = localInventory.find(p => p.id === selectedProductId);
            if (product) {
                const input = searchableContainer.querySelector('input');
                input.value = product.name;
                input.dataset.selectedId = product.id;
            }
        }
    }
    addIngredientBtn.addEventListener('click', () => addIngredientRow());
    ingredientsContainer.addEventListener('click', (e) => { if (e.target.classList.contains('remove-ingredient-btn')) e.target.parentElement.remove(); });
    
    recipeForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const recipeId = document.getElementById('edit-recipe-id').value;
        try {
            const ingredients = Array.from(ingredientsContainer.querySelectorAll('.flex')).map(row => {
                const input = row.querySelector('.searchable-container input');
                const productId = parseInt(input.dataset.selectedId);
                if (!productId) {
                    throw new Error("Produto inválido selecionado. Use a busca e clique no item desejado.");
                }
                return {
                    productId: productId,
                    quantity: parseFloat(row.querySelector('input[type="number"]').value)
                }
            });

            const recipeData = {
                name: document.getElementById('recipe-name').value, 
                category: document.getElementById('recipe-category').value,
                ingredients
            };
            
            if (recipeId) {
                recipeData.id = parseInt(recipeId);
                await DB.update('recipes', recipeData);
                showNotification("Receita atualizada com sucesso!");
            } else {
                await DB.add('recipes', recipeData);
                showNotification("Receita salva com sucesso!");
            }
            hideModal(recipeModal);
            await refreshLocalData();
        } catch(error) { console.error("Erro ao salvar receita: ", error); showNotification(error.message || "Erro ao salvar receita.", true); }
    });

    // --- PRODUCTION ORDERS LOGIC ---
    function renderProductionOrders() {
        productionOrdersList.innerHTML = '';
        const filterDate = searchPoByDate.value;
        
        let filteredOrders = localProductionOrders;
        if (filterDate) {
            filteredOrders = localProductionOrders.filter(po => po.date === filterDate);
        }

        if (filteredOrders.length === 0) {
            productionOrdersList.innerHTML = `<div class="bg-white p-6 rounded-lg shadow text-center text-gray-500 col-span-full">Nenhuma ordem de produção encontrada para a data selecionada.</div>`;
            return;
        }

        [...filteredOrders].sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(po => {
             try {
                const card = document.createElement('div');
                card.className = 'relative bg-white rounded-xl shadow-md overflow-hidden transform hover:scale-[1.02] transition-transform duration-300';
                
                const statusClass = po.status === 'pendente' ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800';
                const statusBorderClass = po.status === 'pendente' ? 'border-yellow-400' : 'border-green-400';

                const ingredientsHtml = po.ingredients.map(ing => {
                    const product = localInventory.find(p => p.id === ing.productId);
                    return `
                    <li class="flex justify-between items-center text-sm py-1">
                        <span class="text-gray-600"><i class="fa-solid fa-box-open mr-2 text-gray-400"></i>${product ? product.name : '...'}</span>
                        <span class="font-medium text-gray-800">${ing.adjustedQuantity.toFixed(2)}</span>
                    </li>`;
                }).join('');

                card.innerHTML = `
                    <div class="p-4 border-l-4 ${statusBorderClass}">
                         <div class="absolute top-3 left-3">
                            <input type="checkbox" class="po-select-checkbox h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" data-po-id="${po.id}" ${po.status !== 'pendente' ? 'disabled' : ''}>
                        </div>
                        <div class="flex justify-between items-start ml-8">
                            <div>
                                <h3 class="text-lg font-bold text-gray-800 pr-16">${po.recipeName} (${po.quantityProduced}x)</h3>
                                <p class="text-sm text-gray-500 mt-1">
                                    <i class="fa-solid fa-calendar-alt mr-1"></i>
                                    ${new Date(po.date + 'T00:00:00').toLocaleDateString('pt-BR')}
                                </p>
                            </div>
                            <div class="absolute top-3 right-3 text-right">
                                 <span class="block text-xs font-semibold px-3 py-1 rounded-full ${statusClass}">${po.status}</span>
                                 <div class="mt-2 flex space-x-2 justify-end">
                                    <button class="edit-po-btn text-blue-500 hover:text-blue-700 p-1" data-po-id="${po.id}" title="Editar Ordem"><i class="fa-solid fa-pencil"></i></button>
                                    <button class="delete-po-btn text-red-500 hover:text-red-700 p-1" data-po-id="${po.id}" title="Excluir Ordem"><i class="fa-solid fa-trash"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="p-4 bg-gray-50 border-t border-gray-200">
                        <p class="text-xs font-semibold text-gray-500 mb-2 uppercase tracking-wider">Insumos</p>
                        <ul class="space-y-1">${ingredientsHtml}</ul>
                    </div>
                `;
                productionOrdersList.appendChild(card);
            } catch (e) {
                console.error('Erro ao renderizar ordem de produção:', po, e);
            }
        });
    }

    productionOrdersList.addEventListener('click', (e) => {
        const editBtn = e.target.closest('.edit-po-btn');
        if (editBtn) {
            handleEditProductionOrder(parseInt(editBtn.dataset.poId));
        }
        const deleteBtn = e.target.closest('.delete-po-btn');
        if (deleteBtn) {
            handleDeleteProductionOrder(parseInt(deleteBtn.dataset.poId));
        }
    });

    function handleEditProductionOrder(poId) {
        const po = localProductionOrders.find(p => p.id === poId);
        if (!po) return;

        document.getElementById('edit-po-id').value = po.id;
        
        createSearchableSelect(poRecipeSearchableContainer, localRecipes, 'Buscar receita...', (recipe) => {
            if (recipe) {
                updatePOIngredients();
            }
        });
        const recipeSearchInput = poRecipeSearchableContainer.querySelector('input');
        recipeSearchInput.value = po.recipeName;
        recipeSearchInput.dataset.selectedId = po.recipeId;

        poQuantity.value = po.quantityProduced;
        poDate.value = po.date;
        
        updatePOIngredients(po.ingredients);

        productionOrderModalTitle.textContent = "Editar Ordem de Produção";
        productionOrderForm.querySelector('button[type="submit"]').textContent = "Salvar Alterações";
        
        showModal(productionOrderModal);
    }

    function handleDeleteProductionOrder(poId) {
        const po = localProductionOrders.find(p => p.id === poId);
        if (!po) return;

        showConfirmationModal(
            "Excluir Ordem de Produção",
            `Tem certeza que deseja excluir a ordem para "<strong>${po.recipeName}</strong>" do dia ${new Date(po.date + 'T00:00:00').toLocaleDateString('pt-BR')}?`,
            async () => {
                try {
                    await DB.remove('productionOrders', poId);
                    showNotification("Ordem de produção excluída com sucesso.");
                    await refreshLocalData();
                } catch (err) {
                    showNotification("Erro ao excluir a ordem de produção.", true);
                }
            }
        );
    }

    btnNewProductionOrder.addEventListener('click', () => {
        if (localRecipes.length === 0) {
            showNotification("Crie uma receita antes de gerar uma ordem.", true);
            return;
        }
        if(localInventory.length === 0) {
            showNotification("Adicione itens ao estoque antes de gerar uma ordem.", true);
            return;
        }
        productionOrderForm.reset();
        document.getElementById('edit-po-id').value = '';

        createSearchableSelect(poRecipeSearchableContainer, localRecipes, 'Buscar receita...', (recipe) => {
            if (recipe) {
                updatePOIngredients();
            }
        });
        const recipeSearchInput = poRecipeSearchableContainer.querySelector('input');
        recipeSearchInput.value = '';
        recipeSearchInput.dataset.selectedId = '';

        poQuantity.value = 1;
        poDate.value = new Date().toISOString().split('T')[0];
        updatePOIngredients();
        productionOrderModalTitle.textContent = "Nova Ordem de Produção";
        productionOrderForm.querySelector('button[type="submit"]').textContent = "Criar Ordem de Produção";
        showModal(productionOrderModal);
    });

    function updatePOIngredients(existingIngredients = null) {
        const recipeId = parseInt(poRecipeSearchableContainer.querySelector('input').dataset.selectedId);
        const recipe = localRecipes.find(r => r.id === recipeId);
        const recipeQuantity = parseInt(poQuantity.value, 10) || 1;
        
        if (!recipe) { poIngredientsBody.innerHTML = ''; return; }

        poIngredientsBody.innerHTML = recipe.ingredients.map((ing, index) => {
            const product = localInventory.find(p => p.id === ing.productId);
            if(!product) return '';
            
            const residual = localResidualStock.find(r => r.productId === product.id)?.quantity || 0;
            const neededQty = ing.quantity * recipeQuantity;
            const compensatedQty = neededQty - residual;
            const availableQty = product.totalQuantity;
            const isInsufficient = neededQty > availableQty;

            const existingIng = existingIngredients ? existingIngredients.find(ei => ei.productId === ing.productId) : null;

            const availableBatches = localBatches
                .filter(b => b.productId === ing.productId && b.quantity > 0)
                .sort((a,b) => new Date(a.expiryDate) - new Date(b.expiryDate));
            
            const batchOptions = availableBatches.map(b => 
                `<option value="${b.id}" data-code="${b.code}" ${existingIng && existingIng.batchId === b.id ? 'selected' : ''}>
                    ${b.code} (Qtd: ${b.quantity.toFixed(2)}, Val: ${b.expiryDate ? new Date(b.expiryDate+'T00:00:00').toLocaleDateString('pt-BR') : 'N/A'})
                </option>`
            ).join('');
            
            return `
            <tr data-product-id="${product.id}" data-original-qty="${ing.quantity}" class="${isInsufficient ? 'insufficient-stock-row' : ''}">
                <td class="px-2 py-2">${product.name}</td>
                <td class="px-2 py-2 text-sm ${residual > 0 ? 'text-green-600' : 'text-red-600'}">${residual.toFixed(2)}</td>
                <td class="px-2 py-2 font-medium">${neededQty.toFixed(2)}</td>
                <td class="px-2 py-2"><input type="number" value="${(existingIng ? existingIng.adjustedQuantity : compensatedQty).toFixed(2)}" min="0" step="0.01" class="w-24 form-input"></td>
                <td class="px-2 py-2"><select class="w-48 form-input text-xs">${batchOptions}</select></td>
                <td class="px-2 py-2"><input type="text" value="${existingIng ? existingIng.handler : ''}" placeholder="Nome" class="w-32 form-input"></td>
            </tr>`;
        }).join('');
    }
    
    poQuantity.addEventListener('input', () => updatePOIngredients());
    
    closeProductionOrderModalBtn.addEventListener('click', () => { hideModal(productionOrderModal) });

    productionOrderForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const poId = document.getElementById('edit-po-id').value;
        if (poIngredientsBody.querySelectorAll('.insufficient-stock-row').length > 0) { showNotification("Estoque insuficiente.", true); return; }
        
        const recipeId = parseInt(poRecipeSearchableContainer.querySelector('input').dataset.selectedId);
        if (!recipeId) {
            showNotification("Por favor, selecione uma receita válida.", true);
            return;
        }
        const recipe = localRecipes.find(r => r.id === recipeId);
        
        const ingredients = Array.from(poIngredientsBody.querySelectorAll('tr')).map(row => {
            const batchSelect = row.querySelector('select');
            const selectedOption = batchSelect.options[batchSelect.selectedIndex];
            return {
                productId: parseInt(row.dataset.productId), adjustedQuantity: parseFloat(row.querySelector('input[type="number"]').value),
                handler: row.querySelector('input[type="text"]').value || 'N/A',
                batchId: selectedOption ? parseInt(selectedOption.value) : null,
                batchCode: selectedOption ? selectedOption.dataset.code : 'N/A',
            }
        });
        if (ingredients.some(ing => !ing.batchId)) { showNotification("Lotes não disponíveis.", true); return; }
        const poData = {
            recipeId: recipe.id, recipeName: recipe.name, date: poDate.value,
            quantityProduced: parseInt(poQuantity.value, 10), status: 'pendente', ingredients
        };
        try {
            if (poId) {
                poData.id = parseInt(poId);
                const originalPo = localProductionOrders.find(p => p.id === poData.id);
                poData.status = originalPo.status; // Keep original status when editing
                await DB.update('productionOrders', poData);
                showNotification("Ordem de Produção atualizada!");
            } else {
                await DB.add('productionOrders', poData);
                showNotification("Ordem de Produção criada com sucesso!");
            }
            hideModal(productionOrderModal);
            await refreshLocalData();
        } catch(error) { console.error("Erro ao salvar Ordem de Produção:", error); showNotification("Erro ao salvar Ordem.", true); }
    });
    searchPoByDate.addEventListener('input', renderProductionOrders);
    
    btnConfirmProduction.addEventListener('click', () => {
        const selectedCheckboxes = document.querySelectorAll('.po-select-checkbox:checked');
        if (selectedCheckboxes.length === 0) {
            showNotification("Selecione pelo menos uma ordem de produção para confirmar.", true);
            return;
        }
        
        const selectedOrderIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.dataset.poId));
        const selectedOrders = localProductionOrders.filter(po => selectedOrderIds.includes(po.id));

        populateConfirmationModal(selectedOrders);
        showModal(confirmProductionModal);
    });

    function populateConfirmationModal(orders) {
        const aggregatedItems = {};
        orders.forEach(po => {
            const recipe = localRecipes.find(r => r.id === po.recipeId);
            po.ingredients.forEach(ing => {
                const recipeIng = recipe.ingredients.find(ri => ri.productId === ing.productId);
                const requestedQty = recipeIng.quantity * po.quantityProduced;

                if (aggregatedItems[ing.productId]) {
                    aggregatedItems[ing.productId].quantity += requestedQty;
                } else {
                    const product = localInventory.find(p => p.id === ing.productId);
                    aggregatedItems[ing.productId] = { 
                        productId: ing.productId,
                        name: product.name,
                        quantity: requestedQty 
                    };
                }
            });
        });
        
        confirmProductionTbody.innerHTML = Object.values(aggregatedItems).map(item => {
            return `<tr data-product-id="${item.productId}">
                <td class="px-4 py-2">${item.name}</td>
                <td class="px-4 py-2">${item.quantity.toFixed(2)}</td>
                <td class="px-4 py-2"><input type="number" value="${item.quantity.toFixed(2)}" class="w-32 form-input"></td>
            </tr>`;
        }).join('');
        confirmProductionTbody.dataset.orders = JSON.stringify(orders.map(po => po.id));
    }


    closeConfirmProductionModalBtn.addEventListener('click', () => { hideModal(confirmProductionModal) });


    // --- CONFIRM PRODUCTION & STOCK CONSUMPTION ---
    async function updateMonthlyConsumption(productId, consumedQuantity, date) {
        const period = date.substring(0, 7); // YYYY-MM
        let consumptionRecord = (await DB.getAll('monthlyConsumption')).find(c => c.period === period && c.productId === productId);

        if (consumptionRecord) {
            consumptionRecord.totalConsumed += consumedQuantity;
            await DB.update('monthlyConsumption', consumptionRecord);
        } else {
            await DB.add('monthlyConsumption', {
                period,
                productId,
                totalConsumed: consumedQuantity
            });
        }
    }
    
    async function updateResidualStock(productId, difference) {
        let residualRecord = await DB.get('residualStock', productId);
        if (residualRecord) {
            residualRecord.quantity += difference;
            await DB.update('residualStock', residualRecord);
        } else {
            await DB.add('residualStock', { productId, quantity: difference });
        }
    }

    btnExecuteStockConsumption.addEventListener('click', async () => {
        const orderIdsToUpdate = JSON.parse(confirmProductionTbody.dataset.orders || '[]');
        if (orderIdsToUpdate.length === 0) { showNotification("Nenhuma ordem para confirmar.", true); return; }
        try {
            loadingOverlay.classList.remove('hidden');
            const deliveredItems = Array.from(confirmProductionTbody.querySelectorAll('tr')).map(row => ({
                productId: parseInt(row.dataset.productId),
                requestedQty: parseFloat(row.cells[1].textContent),
                deliveredQty: parseFloat(row.querySelector('input').value)
            }));
            
            for (const item of deliveredItems) {
                let remainingToConsume = item.deliveredQty;
                if (remainingToConsume <= 0) continue;

                const productBatches = localBatches
                    .filter(b => b.productId === item.productId && b.quantity > 0)
                    .sort((a,b) => new Date(a.expiryDate) - new Date(b.expiryDate));

                for (const batchDoc of productBatches) {
                    const consumeFromThisBatch = Math.min(remainingToConsume, batchDoc.quantity);
                    batchDoc.quantity -= consumeFromThisBatch;
                    await DB.update('batches', batchDoc);
                    await DB.add('history', { productId: item.productId, batchCode: batchDoc.code, type: 'saída', quantity: consumeFromThisBatch, date: new Date().toISOString().split('T')[0] });
                    remainingToConsume -= consumeFromThisBatch;
                    if (remainingToConsume <= 0) break;
                }
                
                if (remainingToConsume > 0) throw new Error(`Estoque insuficiente para ${item.name}. Faltam ${remainingToConsume.toFixed(2)}.`);

                const product = await DB.get('inventory', item.productId);
                product.totalQuantity -= item.deliveredQty;
                await DB.update('inventory', product);
                await updateMonthlyConsumption(item.productId, item.deliveredQty, new Date().toISOString().split('T')[0]);
                
                // Update residual stock
                const difference = item.deliveredQty - item.requestedQty;
                await updateResidualStock(item.productId, difference);
            }
            
            const ordersToUpdate = localProductionOrders.filter(po => orderIdsToUpdate.includes(po.id));
            for(const order of ordersToUpdate) {
                const recipe = localRecipes.find(r => r.id === order.recipeId);
                const orderIngredients = order.ingredients;

                for (const ing of orderIngredients) {
                    const recipeIng = recipe.ingredients.find(ri => ri.productId === ing.productId);
                    const requestedQty = recipeIng.quantity * order.quantityProduced;
                    
                    const residual = localResidualStock.find(r => r.productId === ing.productId);
                    if (residual && residual.quantity > 0) {
                        const consumedFromResidual = Math.min(residual.quantity, requestedQty);
                        await updateResidualStock(ing.productId, -consumedFromResidual);
                    }
                }
                order.status = 'concluído';
                await DB.update('productionOrders', order);
            }

            showNotification("Baixa de estoque realizada com sucesso!");
            hideModal(confirmProductionModal);
            await refreshLocalData();
        } catch (error) {
            console.error("Erro ao dar baixa no estoque: ", error);
            showNotification(error.message || "Erro ao dar baixa no estoque.", true);
        } finally {
            loadingOverlay.classList.add('hidden');
        }
    });

    // --- BACKUP / RESTORE FUNCTIONS ---
    async function downloadBackup() {
        try {
            loadingOverlay.classList.remove('hidden');
            const backupData = {
                inventory: await DB.getAll('inventory'),
                batches: await DB.getAll('batches'),
                history: await DB.getAll('history'),
                recipes: await DB.getAll('recipes'),
                productionOrders: await DB.getAll('productionOrders'),
                monthlyConsumption: await DB.getAll('monthlyConsumption'),
                residualStock: await DB.getAll('residualStock'),
            };

            const jsonString = JSON.stringify(backupData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            const date = new Date().toISOString().split('T')[0];
            a.download = `backup_estoque_${date}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification("Backup baixado com sucesso!");

        } catch (error) {
            console.error("Erro ao criar backup:", error);
            showNotification("Falha ao criar o backup.", true);
        } finally {
            loadingOverlay.classList.add('hidden');
        }
    }
    btnDownloadBackup.addEventListener('click', downloadBackup);

    btnUploadBackup.addEventListener('click', () => {
        backupFileInput.click();
    });

    backupFileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                backupFileContent = JSON.parse(e.target.result);
                if (!backupFileContent.inventory || !backupFileContent.batches) {
                    throw new Error("Arquivo de backup inválido ou corrompido.");
                }
                showModal(confirmUploadModal);
            } catch (error) {
                console.error("Erro ao ler o arquivo de backup:", error);
                showNotification(error.message || "Falha ao ler o arquivo de backup.", true);
                backupFileContent = null;
            }
        };
        reader.onerror = () => {
             showNotification("Erro ao ler o arquivo.", true);
             backupFileContent = null;
        };
        reader.readAsText(file);
        
        backupFileInput.value = '';
    });

    cancelUploadBtn.addEventListener('click', () => {
        backupFileContent = null;
        hideModal(confirmUploadModal);
    });

    confirmUploadBtn.addEventListener('click', () => {
        hideModal(confirmUploadModal);
        if (backupFileContent) {
            importData(backupFileContent);
        }
    });
    
    async function importData(data) {
        try {
            loadingOverlay.classList.remove('hidden');
            const stores = ['inventory', 'batches', 'history', 'recipes', 'productionOrders', 'monthlyConsumption', 'residualStock'];
            
            for (const storeName of stores) {
                await DB.clear(storeName);
            }

            const idMaps = { inventory: {}, recipes: {} };

            if (data.inventory) {
                for (const item of data.inventory) {
                    const oldId = item.id;
                    delete item.id;
                    const newId = await DB.add('inventory', item);
                    idMaps.inventory[oldId] = newId;
                }
            }
            
             if (data.recipes) {
                for (const recipe of data.recipes) {
                    const oldId = recipe.id;
                    delete recipe.id;
                    if (recipe.ingredients) {
                        recipe.ingredients.forEach(ing => {
                            ing.productId = idMaps.inventory[ing.productId];
                        });
                    }
                    const newId = await DB.add('recipes', recipe);
                    idMaps.recipes[oldId] = newId;
                }
            }

            if (data.batches) {
                for (const batch of data.batches) {
                    delete batch.id;
                    batch.productId = idMaps.inventory[batch.productId];
                    if (batch.productId) {
                        await DB.add('batches', batch);
                    }
                }
            }

            if (data.history) {
                 for (const record of data.history) {
                    delete record.id;
                    record.productId = idMaps.inventory[record.productId];
                    if (record.productId) {
                        await DB.add('history', record);
                    }
                }
            }

            if (data.productionOrders) {
                for (const po of data.productionOrders) {
                    delete po.id;
                    po.recipeId = idMaps.recipes[po.recipeId];
                    if (po.ingredients) {
                        po.ingredients.forEach(ing => {
                           ing.productId = idMaps.inventory[ing.productId];
                        });
                    }
                    if (po.recipeId) {
                        await DB.add('productionOrders', po);
                    }
                }
            }
            if(data.monthlyConsumption) {
                for(const record of data.monthlyConsumption) {
                    delete record.id;
                    record.productId = idMaps.inventory[record.productId];
                    if (record.productId) {
                        await DB.add('monthlyConsumption', record);
                    }
                }
            }
            if(data.residualStock) {
                for(const record of data.residualStock) {
                    record.productId = idMaps.inventory[record.productId];
                     if (record.productId) {
                        await DB.add('residualStock', record);
                    }
                }
            }

            await refreshLocalData();
            showNotification("Backup restaurado com sucesso!");

        } catch (error) {
            console.error("Erro ao importar dados:", error);
            showNotification("Falha ao restaurar o backup. Verifique o arquivo.", true);
            const stores = ['inventory', 'batches', 'history', 'recipes', 'productionOrders', 'monthlyConsumption', 'residualStock'];
            for (const storeName of stores) { await DB.clear(storeName); }
            await refreshLocalData();

        } finally {
            loadingOverlay.classList.add('hidden');
            backupFileContent = null;
        }
    }


    // --- EXPORT FUNCTIONS ---
    function exportInventoryToExcel() {
        const dataToExport = localInventory.map(item => ({
            'Código': item.code,
            'Item': item.name,
            'Fornecedor': item.supplier,
            'Quantidade': item.totalQuantity.toFixed(2)
        }));
        const worksheet = XLSX.utils.json_to_sheet(dataToExport);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Estoque");
        XLSX.writeFile(workbook, "relatorio_estoque.xlsx");
        showNotification("Relatório de estoque exportado!");
    }
    btnExportExcel.addEventListener('click', exportInventoryToExcel);
    function exportOrdersToPDF() {
        const { jsPDF } = window.jspdf;
        const filterDate = searchPoByDate.value;
        if (!filterDate) {
            showNotification("Por favor, selecione uma data para gerar o relatório.", true);
            return;
        }

        const filteredOrders = localProductionOrders.filter(po => po.date === filterDate);
        if (filteredOrders.length === 0) {
            showNotification("Nenhuma ordem de produção para a data selecionada.", true);
            return;
        }

        const doc = new jsPDF();
        const formattedDate = new Date(filterDate + 'T00:00:00').toLocaleDateString('pt-BR');

        doc.setFontSize(18);
        doc.text(`Relatório de Ordens de Produção`, 14, 22);
        doc.setFontSize(11);
        doc.setTextColor(100);
        doc.text(`Data: ${formattedDate}`, 14, 30);

        let startY = 40;

        filteredOrders.forEach(order => {
            if (startY > 250) { // Page break
                doc.addPage();
                startY = 22;
            }
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text(`${order.recipeName} (${order.quantityProduced}x)`, 14, startY);
            startY += 7;

            const tableBody = order.ingredients.map(ing => {
                const product = localInventory.find(p => p.id === ing.productId);
                return [
                    product ? product.name : 'N/A',
                    ing.adjustedQuantity.toFixed(2),
                    ing.batchCode,
                    ing.handler
                ];
            });

            doc.autoTable({
                startY: startY,
                head: [['Insumo', 'Qtd. Usada', 'Lote', 'Manipulador']],
                body: tableBody,
                theme: 'striped',
                headStyles: { fillColor: [79, 70, 229] }
            });

            startY = doc.autoTable.previous.finalY + 15;
        });

        doc.save(`relatorio_producao_${filterDate}.pdf`);
        showNotification("Relatório PDF exportado!");
    }
    btnExportPdf.addEventListener('click', exportOrdersToPDF);


    // --- INICIALIZAÇÃO E SINCRONIZAÇÃO COM DADOS LOCAIS ---
    async function refreshLocalData() {
        try {
            localInventory = await DB.getAll('inventory');
            localBatches = await DB.getAll('batches');
            localHistory = await DB.getAll('history');
            localRecipes = await DB.getAll('recipes');
            localProductionOrders = await DB.getAll('productionOrders');
            localMonthlyConsumption = await DB.getAll('monthlyConsumption');
            localResidualStock = await DB.getAll('residualStock');
            
            renderInventoryTable();
            renderRecipes();
            renderProductionOrders();
            renderDashboard();
            renderConsumptionReport();
            renderResidualStock();
            populateSupplierFilter();
        } catch (error) {
            console.error("Erro ao carregar dados locais:", error);
            showNotification("Falha ao carregar dados do banco de dados local.", true);
        }
    }
    
    // --- DASHBOARD ---
    function renderDashboard() {
        const today = new Date();

        // --- STAT CARDS ---
        const lowStockItems = localInventory.filter(i => {
            const metrics = calculateConsumptionMetrics(i.id);
            const minStock = i.minStock !== null && i.minStock !== undefined ? i.minStock : metrics.minStock;
            return i.totalQuantity < minStock && minStock > 0;
        });
        const thirtyDaysFromNow = new Date();
        thirtyDaysFromNow.setDate(today.getDate() + 30);
        const expiringBatches = localBatches.filter(b => b.quantity > 0 && b.expiryDate && new Date(b.expiryDate) <= thirtyDaysFromNow);
        
        document.getElementById('stat-total-items').textContent = localInventory.length;
        document.getElementById('stat-total-quantity').textContent = localInventory.reduce((sum, item) => sum + item.totalQuantity, 0).toFixed(2);
        document.getElementById('stat-low-stock').textContent = lowStockItems.length;
        document.getElementById('stat-expiring-soon').textContent = expiringBatches.length;

        // --- GRÁFICOS ---
        renderCriticalQuantityChart(lowStockItems);
        renderCriticalExpiryChart(expiringBatches, today);
        
        // --- ÚLTIMAS ENTRADAS ---
        const lastEntries = [...localHistory].filter(h => h.type === 'entrada').sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0,5);
        const lastEntriesList = document.getElementById('last-entries-list');
        lastEntriesList.innerHTML = '';
        if (lastEntries.length > 0) {
            lastEntries.forEach(entry => {
                const product = localInventory.find(p => p.id === entry.productId);
                const li = document.createElement('li');
                li.className = 'py-3 flex justify-between items-center text-sm';
                li.innerHTML = `
                    <div>
                        <p class="font-medium text-gray-800">${product ? product.name : 'Produto desconhecido'}</p>
                        <p class="text-gray-500">Lote: ${entry.batchCode}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-semibold text-green-600">+${entry.quantity.toFixed(2)}</p>
                        <p class="text-gray-400">${new Date(entry.date + 'T00:00:00').toLocaleDateString('pt-BR')}</p>
                    </div>
                `;
                lastEntriesList.appendChild(li);
            });
        } else {
             lastEntriesList.innerHTML = `<p class="text-center text-gray-500 py-4">Nenhuma entrada registrada.</p>`;
        }
        
        // --- ALERTAS ---
        const lossRiskBatches = localBatches.filter(b => {
             const expiryDate = new Date(b.expiryDate);
             if (!b.expiryDate || expiryDate <= today || b.quantity <= 0) return false;
             
             const metrics = calculateConsumptionMetrics(b.productId);
             const consumptionRate = metrics.avgConsumption;
             if (consumptionRate <= 0) return false;

             const daysToExpire = (expiryDate.getTime() - today.getTime()) / (1000 * 60 * 60 * 24);
             const estimatedConsumption = daysToExpire * consumptionRate;
             
             return b.quantity > estimatedConsumption;
        });

        const sixtyDaysAgo = new Date();
        sixtyDaysAgo.setDate(today.getDate() - 60);
        const recentOuts = [...localHistory].filter(h => h.type === 'saída' && new Date(h.date) > sixtyDaysAgo);
        const recentOutProductIds = new Set(recentOuts.map(h => h.productId));
        const stagnantItems = localInventory.filter(i => i.totalQuantity > 0 && !recentOutProductIds.has(i.id));

        const alertsContainer = document.getElementById('alerts-container');
        alertsContainer.innerHTML = '';
        const createAlertHTML = (title, items, formatter) => {
            if (items.length > 0) {
                 return `<div><h3 class="font-semibold text-sm text-gray-600">${title} (${items.length})</h3>
                    <ul class="text-xs text-gray-500 mt-1 space-y-1">${items.map(formatter).join('')}</ul></div>`;
            }
            return '';
        }
        
        alertsContainer.innerHTML += createAlertHTML('Risco de Perda', lossRiskBatches, batch => {
            const product = localInventory.find(p => p.id === batch.productId);
            return `<li>- ${product.name} (L: ${batch.code})</li>`;
        });
        alertsContainer.innerHTML += createAlertHTML('Itens sem Saída (>60d)', stagnantItems, item => `<li>- ${item.name}</li>`);
        if(alertsContainer.innerHTML === '') {
            alertsContainer.innerHTML = `<p class="text-center text-gray-500 py-4">Nenhum alerta no momento.</p>`;
        }
    }

    function renderCriticalQuantityChart(lowStockItems) {
        const ctx = document.getElementById('critical-quantity-chart').getContext('2d');
        const top5 = lowStockItems.slice(0, 5);
        if (criticalQuantityChart) {
            criticalQuantityChart.destroy();
        }
        criticalQuantityChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: top5.map(item => item.name),
                datasets: [{
                    label: 'Qtd. Atual',
                    data: top5.map(item => item.totalQuantity),
                    backgroundColor: '#fca5a5',
                }, {
                    label: 'Estoque Mínimo',
                    data: top5.map(item => {
                        const metrics = calculateConsumptionMetrics(item.id);
                        return item.minStock !== null && item.minStock !== undefined ? item.minStock : metrics.minStock;
                    }),
                     backgroundColor: '#93c5fd',
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    }

    function renderCriticalExpiryChart(expiringBatches, today) {
        const ctx = document.getElementById('critical-expiry-chart').getContext('2d');
        const top5 = expiringBatches.sort((a,b) => new Date(a.expiryDate) - new Date(b.expiryDate)).slice(0, 5);

        if (criticalExpiryChart) {
            criticalExpiryChart.destroy();
        }
        criticalExpiryChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: top5.map(batch => {
                    const product = localInventory.find(p => p.id === batch.productId);
                    return `${product.name.substring(0,10)}... (${batch.code})`;
                }),
                datasets: [{
                    label: 'Dias para Vencer',
                    data: top5.map(batch => {
                        const diffTime = new Date(batch.expiryDate).getTime() - today.getTime();
                        return Math.max(0, Math.ceil(diffTime / (1000 * 60 * 60 * 24)));
                    }),
                    backgroundColor: '#fdba74',
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true, maintainAspectRatio: false,
                scales: {
                    x: { beginAtZero: true }
                }
            }
        });
    }
    
    cardLowStock.addEventListener('click', () => {
        navigateTo('inventory');
        renderInventoryTable('low-stock');
    });

    cardExpiringSoon.addEventListener('click', () => {
        navigateTo('inventory');
        renderInventoryTable('expiring-soon');
    });


    // --- AJUSTES E REQUISIÇÕES ---
    function initializeAdjustmentScreen() {
        createSearchableSelect(adjustmentSearchableContainer, localInventory, 'Buscar produto...', (product) => {
            const productId = product.id;
            const batches = localBatches.filter(b => b.productId === productId && b.quantity > 0);
            adjustmentBatchSelect.innerHTML = `<option value="">Selecione um lote...</option>` + batches.map(b => `<option value="${b.id}">${b.code} (Qtd: ${b.quantity.toFixed(2)})</option>`).join('');
        });
    }
    
    adjustmentForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const batchId = parseInt(adjustmentBatchSelect.value);
        const newQuantity = parseFloat(document.getElementById('adjustment-new-quantity').value);
        const reason = document.getElementById('adjustment-reason').value;
        const responsible = document.getElementById('adjustment-responsible').value;

        try {
            const batch = await DB.get('batches', batchId);
            const oldQuantity = batch.quantity;
            const difference = newQuantity - oldQuantity;

            batch.quantity = newQuantity;
            await DB.update('batches', batch);

            const product = await DB.get('inventory', batch.productId);
            product.totalQuantity += difference;
            await DB.update('inventory', product);
            
            await DB.add('history', {
                productId: product.id, batchCode: batch.code,
                type: 'ajuste', quantity: difference,
                date: new Date().toISOString().split('T')[0],
                reason, responsible
            });

            showNotification("Ajuste de estoque salvo com sucesso!");
            adjustmentForm.reset();
            initializeAdjustmentScreen();
            await refreshLocalData();

        } catch(error) {
            showNotification("Erro ao salvar ajuste.", true);
            console.error(error);
        }
    });

    function addRequisitionItemRow() {
        const row = document.createElement('div');
        row.className = 'requisition-item-row flex items-end space-x-2';
        row.innerHTML = `
            <div class="flex-1 searchable-container"></div>
            <div class="flex-1">
                <label class="block text-sm font-medium text-gray-700">Lote</label>
                <select class="requisition-batch w-full form-input"></select>
            </div>
            <div class="w-24">
                <label class="block text-sm font-medium text-gray-700">Qtd.</label>
                <input type="number" class="requisition-quantity w-full form-input" required min="0.01" step="0.01">
            </div>
            <button type="button" class="remove-requisition-item-btn text-red-500 hover:text-red-700 h-10">&times;</button>
        `;
        requisitionItemsContainer.appendChild(row);

        const searchableContainer = row.querySelector('.searchable-container');
        const batchSelect = row.querySelector('.requisition-batch');
        
        createSearchableSelect(searchableContainer, localInventory, 'Buscar produto...', (product) => {
            const productId = product.id;
            const batches = localBatches.filter(b => b.productId === productId && b.quantity > 0);
            batchSelect.innerHTML = batches.map(b => `<option value="${b.id}">${b.code} (Qtd: ${b.quantity.toFixed(2)})</option>`).join('');
        });
    }

    function initializeRequisitionScreen() {
        requisitionItemsContainer.innerHTML = '';
        addRequisitionItemRow();
    }
    
    addRequisitionItemBtn.addEventListener('click', addRequisitionItemRow);
    requisitionItemsContainer.addEventListener('click', (e) => {
        if (e.target.closest('.remove-requisition-item-btn')) {
            e.target.closest('.requisition-item-row').remove();
        }
    });
    
    requisitionForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const reason = document.getElementById('requisition-reason').value;
        const responsible = document.getElementById('requisition-responsible').value;
        const items = Array.from(document.querySelectorAll('.requisition-item-row')).map(row => ({
            batchId: parseInt(row.querySelector('.requisition-batch').value),
            quantity: parseFloat(row.querySelector('.requisition-quantity').value)
        }));

        if (items.some(item => isNaN(item.batchId) || isNaN(item.quantity))) {
            showNotification("Verifique os itens da requisição. Lote ou quantidade inválida.", true);
            return;
        }

        try {
             for(const item of items) {
                const batch = await DB.get('batches', item.batchId);
                if (item.quantity > batch.quantity) {
                    throw new Error(`Quantidade requisitada para o lote ${batch.code} é maior que o estoque.`);
                }
                const product = await DB.get('inventory', batch.productId);
                
                batch.quantity -= item.quantity;
                product.totalQuantity -= item.quantity;

                await DB.update('batches', batch);
                await DB.update('inventory', product);
                await DB.add('history', {
                    productId: product.id, batchCode: batch.code, type: 'requisição',
                    quantity: item.quantity, date: new Date().toISOString().split('T')[0], reason, responsible
                });
             }
             showNotification("Baixa por requisição realizada com sucesso!");
             requisitionForm.reset();
             initializeRequisitionScreen();
             await refreshLocalData();
        } catch(error) {
            showNotification(error.message || "Erro ao processar requisição.", true);
            console.error(error);
        }
    });
    
    // --- CONSUMPTION REPORT ---
    function populateConsumptionFilters() {
        const years = [...new Set(localMonthlyConsumption.map(c => c.period.substring(0, 4)))];
        const months = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
        const today = new Date();
        const currentYear = today.getFullYear();
        const currentMonth = today.getMonth();

        if (!years.includes(String(currentYear))) years.push(String(currentYear));
        years.sort((a,b) => b-a);
        
        const selectedYear = consumptionYearFilter.value || currentYear;
        const selectedMonth = consumptionMonthFilter.value || (currentMonth + 1);

        consumptionYearFilter.innerHTML = years.map(y => `<option value="${y}" ${y == selectedYear ? 'selected' : ''}>${y}</option>`).join('');
        consumptionMonthFilter.innerHTML = months.map((m, i) => `<option value="${i+1}" ${i+1 == selectedMonth ? 'selected' : ''}>${m}</option>`).join('');
    }

    function renderConsumptionReport() {
        populateConsumptionFilters();
        const year = consumptionYearFilter.value;
        const month = String(consumptionMonthFilter.value).padStart(2, '0');
        const period = `${year}-${month}`;

        const consumptionData = localMonthlyConsumption.filter(c => c.period === period);
        consumptionTableBody.innerHTML = '';
        if (consumptionData.length === 0) {
            consumptionTableBody.innerHTML = `<tr><td colspan="2" class="text-center py-4">Nenhum consumo registrado para este período.</td></tr>`;
            return;
        }

        consumptionData.forEach(item => {
            const product = localInventory.find(p => p.id === item.productId);
            if (product) {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b';
                row.innerHTML = `
                    <td class="px-6 py-4">${product.name}</td>
                    <td class="px-6 py-4 text-right">${item.totalConsumed.toFixed(2)}</td>
                `;
                consumptionTableBody.appendChild(row);
            }
        });
    }

    consumptionMonthFilter.addEventListener('change', renderConsumptionReport);
    consumptionYearFilter.addEventListener('change', renderConsumptionReport);

    // --- RESIDUAL STOCK ---
    function renderResidualStock() {
        residualTableBody.innerHTML = '';
        if(localResidualStock.length === 0) {
             residualTableBody.innerHTML = `<tr><td colspan="3" class="text-center py-4">Nenhum saldo residual.</td></tr>`;
            return;
        }

        localResidualStock.forEach(item => {
            const product = localInventory.find(p => p.id === item.productId);
            if (product && item.quantity !== 0) {
                 const row = document.createElement('tr');
                row.className = 'bg-white border-b';
                row.innerHTML = `
                    <td class="px-6 py-4">${product.name}</td>
                    <td class="px-6 py-4 text-right font-medium ${item.quantity > 0 ? 'text-green-600' : 'text-red-600'}">${item.quantity.toFixed(2)}</td>
                    <td class="px-6 py-4 text-center">
                        <button class="edit-residual-btn text-blue-500 hover:text-blue-700 p-1" data-product-id="${product.id}" title="Editar Saldo"><i class="fa-solid fa-pencil"></i></button>
                        <button class="delete-residual-btn text-red-500 hover:text-red-700 p-1" data-product-id="${product.id}" title="Zerar Saldo"><i class="fa-solid fa-trash"></i></button>
                    </td>
                `;
                residualTableBody.appendChild(row);
            }
        });
    }

    residualTableBody.addEventListener('click', e => {
        const editBtn = e.target.closest('.edit-residual-btn');
        if(editBtn) {
            const productId = parseInt(editBtn.dataset.productId);
            const product = localInventory.find(p => p.id === productId);
            const residual = localResidualStock.find(r => r.productId === productId);
            document.getElementById('edit-residual-product-id').value = productId;
            document.getElementById('edit-residual-product-name').textContent = product.name;
            document.getElementById('edit-residual-quantity').value = residual.quantity;
            showModal(editResidualModal);
        }

        const deleteBtn = e.target.closest('.delete-residual-btn');
        if(deleteBtn) {
            const productId = parseInt(deleteBtn.dataset.productId);
             const product = localInventory.find(p => p.id === productId);
            showConfirmationModal('Zerar Saldo Residual', `Tem certeza que deseja zerar o saldo residual para <strong>${product.name}</strong>?`, async () => {
                await updateResidualStock(productId, -localResidualStock.find(r => r.productId === productId).quantity);
                await refreshLocalData();
                showNotification('Saldo residual zerado.');
            });
        }
    });

    closeEditResidualModal.addEventListener('click', () => hideModal(editResidualModal));

    editResidualForm.addEventListener('submit', async e => {
        e.preventDefault();
        const productId = parseInt(document.getElementById('edit-residual-product-id').value);
        const newQuantity = parseFloat(document.getElementById('edit-residual-quantity').value);
        const residual = await DB.get('residualStock', productId);
        const difference = newQuantity - residual.quantity;
        await updateResidualStock(productId, difference);
        await refreshLocalData();
        hideModal(editResidualModal);
        showNotification('Saldo residual atualizado.');
    });

    // --- RESET DATABASE ---
    btnResetDatabase.addEventListener('click', () => {
        const password = prompt("Para apagar todos os dados, digite a senha:");
        if (password === '1q2w3e4r') {
            showConfirmationModal("Apagar TODOS os dados?", "Esta ação é irreversível e limpará completamente o banco de dados. Deseja continuar?", async () => {
                try {
                    loadingOverlay.classList.remove('hidden');
                    const stores = ['inventory', 'batches', 'history', 'recipes', 'productionOrders', 'monthlyConsumption', 'residualStock'];
                    for (const storeName of stores) {
                        await DB.clear(storeName);
                    }
                    await refreshLocalData();
                    showNotification("Banco de dados apagado com sucesso.");
                } catch(err) {
                    showNotification("Erro ao apagar o banco de dados.", true);
                } finally {
                    loadingOverlay.classList.add('hidden');
                }
            });
        } else if (password !== null) {
            showNotification("Senha incorreta.", true);
        }
    });


    async function initialize() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('receipt-date').value = today;
        searchPoByDate.value = today;
        navigateTo('dashboard');

        try {
            await DB.getDB(); // Inicializa e abre o banco
            await refreshLocalData();
        } catch (error) {
            console.error("Erro na inicialização do IndexedDB:", error);
            loadingOverlay.innerHTML = "Erro ao iniciar o banco de dados offline.";
        }
        loadingOverlay.classList.add('hidden');
    }

    initialize();
</script>

</body>
</html>

