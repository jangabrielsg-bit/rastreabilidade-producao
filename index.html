<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Rastreabilidade e Controle de Estoque</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Bibliotecas para exportação e gráficos -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .sidebar {
            transition: width 0.3s ease-in-out;
        }
        .sidebar-text {
            transition: opacity 0.3s ease-in-out;
        }
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 50;
            inset: 0;
            align-items: center;
            justify-content: center;
            background-color: rgba(0, 0, 0, 0.5);
        }
        .form-input {
            transition: border-color 0.2s;
        }
        .form-input:focus {
            border-color: #4f46e5;
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.25);
        }
        .table-header-sortable {
            cursor: pointer;
        }
        .table-header-sortable:hover {
            background-color: #f0f4f8;
        }
        .insufficient-stock-row {
            background-color: #fee2e2; /* Red-100 */
        }
        .insufficient-stock-row:hover {
            background-color: #fecaca; /* Red-200 */
        }
        .searchable-container {
            position: relative;
        }
        .searchable-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #d1d5db;
            background-color: white;
            border-radius: 0 0 0.375rem 0.375rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .searchable-item {
            padding: 0.5rem 1rem;
            cursor: pointer;
        }
        .searchable-item:hover {
            background-color: #f3f4f6;
        }

        @keyframes fade-in-out {
            0% { opacity: 0; transform: translateY(-20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }
        .animate-fade-in-out {
            animation: fade-in-out 4s ease-in-out forwards;
        }
        
        @keyframes flash-red-bg {
            0%, 100% { background-color: #f1f5f9; } /* bg-slate-100 */
            50% { background-color: #fee2e2; } /* bg-red-100 */
        }
        .flash-red {
            animation: flash-red-bg 0.8s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        .shake-alert {
            animation: shake 0.5s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="loading-overlay" class="fixed inset-0 z-[101] flex items-center justify-center bg-white">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-indigo-600"></div>
    </div>
    
    <!-- Low Stock Alert Bell -->
    <div id="low-stock-indicator" class="hidden fixed top-5 right-24 z-[100] cursor-pointer">
        <div class="relative">
            <i class="fa-solid fa-bell text-3xl text-red-600"></i>
            <span id="low-stock-count" class="absolute -top-2 -right-2 bg-red-700 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">0</span>
        </div>
    </div>


    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <aside class="w-20 bg-gray-800 text-white flex flex-col items-center py-4 space-y-6 sidebar hover:w-64 group">
            <a href="#" id="nav-dashboard" class="sidebar-icon p-3 rounded-lg active-nav flex items-center w-full" title="Dashboard">
                <i class="fa-solid fa-chart-pie fa-lg w-8 text-center"></i>
                <span class="ml-4 whitespace-nowrap opacity-0 group-hover:opacity-100 sidebar-text">Dashboard</span>
            </a>
            <nav class="flex-1 min-h-0 flex flex-col items-center space-y-4 w-full overflow-y-auto">
                <a href="#" id="nav-entry" class="sidebar-icon p-3 rounded-lg flex items-center w-full" title="Entrada de Mercadorias">
                    <i class="fa-solid fa-dolly fa-lg w-8 text-center"></i>
                    <span class="ml-4 whitespace-nowrap opacity-0 group-hover:opacity-100 sidebar-text">Entrada</span>
                </a>
                <a href="#" id="nav-inventory" class="sidebar-icon p-3 rounded-lg flex items-center w-full" title="Gerenciamento de Estoque">
                    <i class="fa-solid fa-warehouse fa-lg w-8 text-center"></i>
                     <span class="ml-4 whitespace-nowrap opacity-0 group-hover:opacity-100 sidebar-text">Estoque</span>
                </a>
                <a href="#" id="nav-recipes" class="sidebar-icon p-3 rounded-lg flex items-center w-full" title="Receitas">
                    <i class="fa-solid fa-book-open fa-lg w-8 text-center"></i>
                     <span class="ml-4 whitespace-nowrap opacity-0 group-hover:opacity-100 sidebar-text">Receitas</span>
                </a>
                <a href="#" id="nav-production" class="sidebar-icon p-3 rounded-lg flex items-center w-full" title="Ordens de Produção">
                    <i class="fa-solid fa-clipboard-list fa-lg w-8 text-center"></i>
                     <span class="ml-4 whitespace-nowrap opacity-0 group-hover:opacity-100 sidebar-text">Produção</span>
                </a>
                 <a href="#" id="nav-requisitions" class="sidebar-icon p-3 rounded-lg flex items-center w-full" title="Baixa por Requisição">
                    <i class="fa-solid fa-arrow-right-from-bracket fa-lg w-8 text-center"></i>
                     <span class="ml-4 whitespace-nowrap opacity-0 group-hover:opacity-100 sidebar-text">Requisição</span>
                </a>
                <a href="#" id="nav-adjustments" class="sidebar-icon p-3 rounded-lg flex items-center w-full" title="Ajuste de Estoque">
                    <i class="fa-solid fa-sliders fa-lg w-8 text-center"></i>
                     <span class="ml-4 whitespace-nowrap opacity-0 group-hover:opacity-100 sidebar-text">Ajuste</span>
                </a>
                <a href="#" id="nav-consumption" class="sidebar-icon p-3 rounded-lg flex items-center w-full" title="Consumo Mensal">
                    <i class="fa-solid fa-calculator fa-lg w-8 text-center"></i>
                     <span class="ml-4 whitespace-nowrap opacity-0 group-hover:opacity-100 sidebar-text">Consumo</span>
                </a>
                <a href="#" id="nav-residual" class="sidebar-icon p-3 rounded-lg flex items-center w-full" title="Estoque Residual">
                    <i class="fa-solid fa-recycle fa-lg w-8 text-center"></i>
                    <span class="ml-4 whitespace-nowrap opacity-0 group-hover:opacity-100 sidebar-text">Residual</span>
                </a>
                 <a href="#" id="nav-traceability" class="sidebar-icon p-3 rounded-lg flex items-center w-full" title="Rastreabilidade Inteligente">
                    <i class="fa-solid fa-magnifying-glass-chart fa-lg w-8 text-center"></i>
                    <span class="ml-4 whitespace-nowrap opacity-0 group-hover:opacity-100 sidebar-text">Rastreabilidade</span>
                </a>
            </nav>
            <div class="mt-auto w-full">
                 <a href="#" id="nav-settings" class="sidebar-icon p-3 rounded-lg flex items-center w-full" title="Configurações">
                    <i class="fa-solid fa-cog fa-lg w-8 text-center"></i>
                     <span class="ml-4 whitespace-nowrap opacity-0 group-hover:opacity-100 sidebar-text">Configurações</span>
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-6 md:p-8 overflow-y-auto">
            
            <!-- Tela da Dashboard -->
            <div id="screen-dashboard">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Visão Geral do Estoque</h1>
                
                <!-- Stat Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                    <div class="bg-white p-6 rounded-xl shadow flex items-center">
                        <div class="bg-blue-100 text-blue-600 p-4 rounded-full">
                            <i class="fa-solid fa-boxes-stacked fa-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-500">Itens Únicos</p>
                            <p id="stat-total-items" class="text-2xl font-bold">0</p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow flex items-center">
                        <div class="bg-green-100 text-green-600 p-4 rounded-full">
                            <i class="fa-solid fa-box fa-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-500">Quantidade Total</p>
                            <p id="stat-total-quantity" class="text-2xl font-bold">0</p>
                        </div>
                    </div>
                    <div id="card-low-stock" class="bg-white p-6 rounded-xl shadow flex items-center cursor-pointer hover:shadow-lg transition-shadow">
                         <div class="bg-yellow-100 text-yellow-600 p-4 rounded-full">
                            <i class="fa-solid fa-arrow-down-short-wide fa-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-500">Itens com Estoque Baixo</p>
                            <p id="stat-low-stock" class="text-2xl font-bold">0</p>
                        </div>
                    </div>
                    <div id="card-expiring-soon" class="bg-white p-6 rounded-xl shadow flex items-center cursor-pointer hover:shadow-lg transition-shadow">
                        <div class="bg-red-100 text-red-600 p-4 rounded-full">
                            <i class="fa-solid fa-calendar-times fa-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-500">Lotes Vencendo (30d)</p>
                            <p id="stat-expiring-soon" class="text-2xl font-bold">0</p>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Coluna Esquerda (Gráficos) -->
                    <div class="space-y-6">
                        <!-- Gráfico Saídas do dia -->
                        <div class="bg-white p-6 rounded-xl shadow-lg">
                             <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-semibold text-gray-700">Top 10 Saídas de Insumos (Hoje)</h2>
                                <button id="btn-export-daily-output" class="text-gray-500 hover:text-green-600" title="Exportar para Excel"><i class="fa-solid fa-file-excel fa-lg"></i></button>
                            </div>
                            <div class="h-80 flex items-center justify-center">
                                <canvas id="daily-output-chart"></canvas>
                            </div>
                        </div>
                        <!-- Gráfico Saídas Programadas -->
                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-semibold text-gray-700">Top 10 Saídas Programadas (48h)</h2>
                                 <button id="btn-export-scheduled-output" class="text-gray-500 hover:text-green-600" title="Exportar para Excel"><i class="fa-solid fa-file-excel fa-lg"></i></button>
                            </div>
                            <div class="h-80 flex items-center justify-center">
                                <canvas id="scheduled-output-chart"></canvas>
                            </div>
                        </div>
                    </div>
                    <!-- Coluna Direita (Alertas e Entradas) -->
                    <div class="space-y-6">
                        <div class="bg-white p-6 rounded-xl shadow-lg">
                             <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-semibold text-gray-700">Itens Vencendo (45d)</h2>
                                <button id="btn-export-expiring-45" class="text-gray-500 hover:text-green-600" title="Exportar para Excel"><i class="fa-solid fa-file-excel fa-lg"></i></button>
                            </div>
                             <div id="expiring-45-container" class="overflow-y-auto max-h-40"></div>
                        </div>
                         <div class="bg-white p-6 rounded-xl shadow-lg">
                              <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-semibold text-gray-700">Risco de Perda Potencial</h2>
                                <button id="btn-export-loss-risk" class="text-gray-500 hover:text-green-600" title="Exportar para Excel"><i class="fa-solid fa-file-excel fa-lg"></i></button>
                            </div>
                             <div id="loss-risk-container" class="overflow-y-auto max-h-40"></div>
                        </div>
                    </div>
                </div>

                <!-- Card da Curva ABC -->
                <div class="mt-6 bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">Curva ABC do Estoque (Baseado no Consumo Total)</h2>
                    <div class="h-80 flex items-center justify-center">
                        <canvas id="abc-curve-chart"></canvas>
                    </div>
               </div>
            </div>

            <!-- Tela de Registro de Entrada -->
            <div id="screen-entry" class="hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Registro de Entrada de Mercadorias</h1>
                <div class="bg-white p-8 rounded-xl shadow-lg max-w-2xl mx-auto">
                    <form id="entry-form">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="col-span-1 md:col-span-2">
                                <label for="product-name" class="block text-sm font-medium text-gray-700">Nome do Produto</label>
                                <input type="text" id="product-name" name="product-name" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none form-input">
                            </div>
                            <div>
                                <label for="product-code" class="block text-sm font-medium text-gray-700">Código</label>
                                <input type="text" id="product-code" name="product-code" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none form-input">
                            </div>
                            <div>
                                <label for="supplier" class="block text-sm font-medium text-gray-700">Fornecedor</label>
                                <input type="text" id="supplier" name="supplier" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none form-input">
                            </div>
                            <div>
                                <label for="quantity" class="block text-sm font-medium text-gray-700">Quantidade Recebida</label>
                                <input type="number" id="quantity" name="quantity" required min="0.01" step="0.01" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none form-input">
                            </div>
                             <div>
                                <label for="batch-code" class="block text-sm font-medium text-gray-700">Lote</label>
                                <input type="text" id="batch-code" name="batch-code" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none form-input">
                            </div>
                            <div>
                                <label for="mfg-date" class="block text-sm font-medium text-gray-700">Data de Fabricação</label>
                                <input type="date" id="mfg-date" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none form-input">
                            </div>
                            <div>
                                <label for="receipt-date" class="block text-sm font-medium text-gray-700">Data de Recebimento</label>
                                <input type="date" id="receipt-date" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none form-input">
                            </div>
                            <div>
                                <label for="expiry-date" class="block text-sm font-medium text-gray-700">Data de Validade</label>
                                <input type="date" id="expiry-date" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none form-input">
                            </div>
                        </div>
                        <div class="mt-8 flex justify-end">
                            <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105">
                                Registrar Entrada
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Tela de Gerenciamento de Estoque -->
            <div id="screen-inventory" class="hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Gerenciamento de Estoque</h1>
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                        <input type="text" id="search-inventory" placeholder="🔍 Buscar item..." class="w-full md:w-1/3 border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none form-input">
                        
                        <div class="w-full md:w-auto">
                            <select id="supplier-filter" class="form-input w-full">
                                <option value="">Todos os Fornecedores</option>
                            </select>
                        </div>

                        <button id="btn-export-excel" class="bg-white hover:bg-gray-100 text-gray-800 font-semibold py-2 px-4 border border-gray-300 rounded-lg shadow-sm flex items-center justify-center">
                            <i class="fa-solid fa-file-excel text-green-600 mr-2"></i>Exportar para Excel
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 table-header-sortable" data-sort="name">Nome do Produto</th>
                                    <th scope="col" class="px-6 py-3 table-header-sortable" data-sort="code">Código</th>
                                    <th scope="col" class="px-6 py-3 text-right table-header-sortable" data-sort="totalQuantity">Qtd. Física</th>
                                    <th scope="col" class="px-6 py-3 text-right table-header-sortable" data-sort="reserved">Qtd. Reservada</th>
                                    <th scope="col" class="px-6 py-3 text-right table-header-sortable" data-sort="available">Qtd. Disponível</th>
                                    <th scope="col" class="px-6 py-3 table-header-sortable" data-sort="expiry">Próx. Validade</th>
                                </tr>
                            </thead>
                            <tbody id="inventory-table-body">
                                <!-- Linhas de inventário serão inseridas aqui -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Tela de Receitas -->
            <div id="screen-recipes" class="hidden">
                <div class="flex justify-between items-center mb-6">
                   <h1 class="text-3xl font-bold text-gray-800">Receitas</h1>
                   <button id="btn-new-recipe" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                       <i class="fa-solid fa-plus mr-2"></i>Nova Receita
                   </button>
               </div>
               <div class="flex gap-8">
                   <!-- Coluna de Categorias -->
                   <div class="w-1/4">
                       <div class="bg-white p-4 rounded-xl shadow-lg">
                           <h2 class="text-lg font-semibold text-gray-700 mb-3 border-b pb-2">Linhas de Produção</h2>
                           <ul id="recipe-categories-list" class="space-y-2">
                               <!-- Categorias serão inseridas aqui -->
                           </ul>
                       </div>
                   </div>
                   <!-- Grid de Receitas -->
                   <div id="recipes-grid" class="w-3/4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-6 self-start">
                       <!-- Cards de receita serão inseridos aqui -->
                   </div>
               </div>
           </div>
            
            <!-- Tela de Ordens de Produção -->
            <div id="screen-production" class="hidden">
                 <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">Ordens de Produção</h1>
                    <div>
                        <button id="btn-confirm-production" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 mr-2">
                            <i class="fa-solid fa-check-double mr-2"></i>Confirmar Selecionadas
                        </button>
                        <button id="btn-new-production-order" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                            <i class="fa-solid fa-plus mr-2"></i>Nova Ordem
                        </button>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm mb-6 flex items-center justify-between flex-wrap gap-2">
                    <div class="flex items-center">
                        <label for="search-po-by-date" class="text-sm font-medium text-gray-700 mr-2">Filtrar por data:</label>
                        <input type="date" id="search-po-by-date" class="form-input">
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="btn-export-word" class="bg-white hover:bg-gray-100 text-gray-800 font-semibold py-2 px-4 border border-gray-300 rounded-lg shadow-sm">
                            <i class="fa-solid fa-file-word text-blue-600 mr-2"></i>Exportar para Word
                        </button>
                        <button id="btn-export-pdf" class="bg-white hover:bg-gray-100 text-gray-800 font-semibold py-2 px-4 border border-gray-300 rounded-lg shadow-sm">
                            <i class="fa-solid fa-file-pdf text-red-600 mr-2"></i>Exportar Relatório (PDF)
                        </button>
                    </div>
                </div>
                <div id="production-orders-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Ordens de produção serão listadas aqui -->
                </div>
            </div>

            <!-- Tela de Consumo Mensal -->
            <div id="screen-consumption" class="hidden">
                 <h1 class="text-3xl font-bold text-gray-800 mb-6">Relatório de Consumo Mensal</h1>
                 <div class="bg-white p-6 rounded-xl shadow-lg">
                    <div class="flex items-center mb-4 space-x-4">
                        <select id="consumption-month-filter" class="form-input"></select>
                        <select id="consumption-year-filter" class="form-input"></select>
                        <input type="text" id="search-consumption" placeholder="🔍 Buscar item..." class="form-input flex-grow">
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3">Produto</th>
                                    <th scope="col" class="px-6 py-3 text-right">Consumo Total no Mês</th>
                                </tr>
                            </thead>
                            <tbody id="consumption-table-body"></tbody>
                        </table>
                    </div>
                 </div>
            </div>

            <!-- Tela de Estoque Residual -->
            <div id="screen-residual" class="hidden">
                 <h1 class="text-3xl font-bold text-gray-800 mb-6">Estoque Residual</h1>
                 <div class="bg-white p-6 rounded-xl shadow-lg">
                    <p class="text-sm text-gray-600 mb-4">Esta tela mostra as sobras (positivo) ou faltas (negativo) de insumos acumuladas após a confirmação das ordens de produção.</p>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3">Produto</th>
                                    <th scope="col" class="px-6 py-3 text-right">Saldo Residual</th>
                                    <th scope="col" class="px-6 py-3 text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="residual-table-body"></tbody>
                        </table>
                    </div>
                 </div>
            </div>
            
             <!-- Tela de Baixa por Requisição -->
            <div id="screen-requisitions" class="hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Baixa por Requisição</h1>
                <div class="bg-white p-8 rounded-xl shadow-lg max-w-4xl mx-auto">
                    <form id="requisition-form">
                        <div class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="requisition-reason" class="block text-sm font-medium text-gray-700">Motivo/Destino da Requisição</label>
                                    <input type="text" id="requisition-reason" required class="mt-1 block w-full form-input" placeholder="Ex: Amostra para laboratório">
                                </div>
                                <div>
                                    <label for="requisition-responsible" class="block text-sm font-medium text-gray-700">Responsável</label>
                                    <input type="text" id="requisition-responsible" required class="mt-1 block w-full form-input" placeholder="Nome do responsável">
                                </div>
                            </div>
                            <h3 class="text-lg font-medium pt-4">Itens</h3>
                             
                            <div id="requisition-items-container" class="space-y-3">
                                <!-- Itens serão adicionados aqui -->
                            </div>
                            <button type="button" id="add-requisition-item-btn" class="text-indigo-600 hover:text-indigo-800 font-medium text-sm">
                                <i class="fa-solid fa-plus mr-1"></i>Adicionar Item
                            </button>
                        </div>
                        <div class="mt-8 flex justify-end">
                            <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-md">
                                Confirmar Baixa
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Tela de Ajuste de Estoque -->
            <div id="screen-adjustments" class="hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Ajuste de Estoque</h1>
                <div class="bg-white p-8 rounded-xl shadow-lg max-w-2xl mx-auto">
                    <form id="adjustment-form">
                        <div class="space-y-4">
                             <div>
                                <label class="block text-sm font-medium text-gray-700">Produto</label>
                                <div id="adjustment-searchable-container" class="searchable-container"></div>
                            </div>
                            <div>
                                <label for="adjustment-batch" class="block text-sm font-medium text-gray-700">Lote</label>
                                <select id="adjustment-batch" required class="mt-1 block w-full form-input"></select>
                            </div>
                            <div>
                                <label for="adjustment-new-quantity" class="block text-sm font-medium text-gray-700">Nova Quantidade do Lote</label>
                                <input type="number" id="adjustment-new-quantity" required min="0" step="0.01" class="mt-1 block w-full form-input">
                            </div>
                             <div>
                                <label for="adjustment-reason" class="block text-sm font-medium text-gray-700">Motivo do Ajuste</label>
                                <input type="text" id="adjustment-reason" required class="mt-1 block w-full form-input" placeholder="Ex: Contagem de inventário">
                            </div>
                             <div>
                                <label for="adjustment-responsible" class="block text-sm font-medium text-gray-700">Responsável pelo Ajuste</label>
                                <input type="text" id="adjustment-responsible" required class="mt-1 block w-full form-input" placeholder="Nome do responsável">
                            </div>
                        </div>
                        <div class="mt-8 flex justify-end">
                            <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-md">
                                Salvar Ajuste
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Tela de Rastreabilidade -->
             <div id="screen-traceability" class="hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Rastreabilidade Inteligente</h1>
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <div class="flex items-center space-x-4 mb-4">
                        <label class="flex items-center"><input type="radio" name="trace-type" value="lote" class="form-radio" checked> <span class="ml-2">Por Lote de Produto</span></label>
                        <label class="flex items-center"><input type="radio" name="trace-type" value="manipulador" class="form-radio"> <span class="ml-2">Por Manipulador</span></label>
                    </div>
                    <div id="trace-lote-fields">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div id="trace-product-searchable" class="searchable-container"></div>
                            <input type="text" id="trace-batch-code" class="form-input" placeholder="Digite o código do lote">
                        </div>
                    </div>
                    <div id="trace-manipulador-fields" class="hidden">
                        <input type="text" id="trace-handler-name" class="form-input" placeholder="Digite o nome do manipulador">
                    </div>
                    <button id="btn-trace" class="mt-4 bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg">Rastrear</button>
                    <div id="trace-results" class="mt-6"></div>
                </div>
             </div>

            <!-- Tela de Configurações -->
            <div id="screen-settings" class="hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Configurações e Backup</h1>
                <div class="bg-white p-8 rounded-xl shadow-lg max-w-2xl mx-auto space-y-6">
                    <div>
                        <h2 class="text-xl font-semibold text-gray-700">Backup dos Dados</h2>
                        <p class="text-sm text-gray-500 mt-1">
                            Salve todos os seus dados em um arquivo para segurança ou para transferir para outro dispositivo.
                        </p>
                        <button id="btn-download-backup" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105">
                            <i class="fa-solid fa-download mr-2"></i>Baixar Backup (.json)
                        </button>
                    </div>
                    <div class="border-t pt-6">
                        <h2 class="text-xl font-semibold text-gray-700">Restaurar Backup</h2>
                        <p class="text-sm text-gray-500 mt-1">
                            Importe um arquivo de backup. <strong class="text-red-600">Atenção:</strong> Isso substituirá todos os dados existentes no aplicativo.
                        </p>
                        <button id="btn-upload-backup" class="mt-4 w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105">
                            <i class="fa-solid fa-upload mr-2"></i>Carregar Backup (.json)
                        </button>
                        <input type="file" id="backup-file-input" class="hidden" accept=".json">
                    </div>
                    <div class="border-t pt-6">
                        <h2 class="text-xl font-semibold text-red-700">Apagar Dados</h2>
                        <p class="text-sm text-gray-500 mt-1">
                           Esta ação é irreversível e apagará todos os dados do aplicativo.
                        </p>
                        <button id="btn-reset-database" class="mt-4 w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105">
                            <i class="fa-solid fa-trash-alt mr-2"></i>Apagar Todos os Dados
                        </button>
                    </div>
                </div>
            </div>

        </main>
    </div>
    
    <!-- Modal de Alerta de Shelf Life -->
    <div id="shelf-life-modal" class="modal">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100">
                    <i class="fa-solid fa-triangle-exclamation text-yellow-600 text-2xl"></i>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mt-4">Alerta de Shelf Life</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500">
                        O shelf life do produto é de <strong id="shelf-life-value"></strong>%, abaixo do mínimo de 75%.
                    </p>
                    <p class="text-sm text-gray-600 mt-2">
                        Para prosseguir, insira o nome do responsável que autorizou o recebimento.
                    </p>
                </div>
                <div class="mt-4">
                    <label for="authorizer-name" class="sr-only">Nome do Autorizador</label>
                    <input type="text" id="authorizer-name" placeholder="Nome do Responsável" class="w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none form-input" required>
                </div>
            </div>
            <div class="mt-6 flex justify-center space-x-4">
                <button id="cancel-receipt-btn" type="button" class="py-2 px-4 bg-gray-200 text-gray-800 font-semibold rounded-lg shadow-md hover:bg-gray-300">
                    Cancelar
                </button>
                <button id="confirm-receipt-btn" type="button" class="py-2 px-4 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700">
                    Confirmar Recebimento
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Detalhes e Edição do Item -->
    <div id="item-details-modal" class="modal p-4">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold flex items-center">
                    <span id="details-product-name">Nome do Produto</span>
                    <button id="btn-edit-item" class="ml-4 text-gray-500 hover:text-blue-600" title="Editar Produto">
                        <i class="fa-solid fa-pencil"></i>
                    </button>
                </h2>
                <button id="close-details-modal" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            
            <!-- View Mode -->
            <div id="item-details-view">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-sm pt-4">
                    <div><strong>Código:</strong> <span id="details-product-code"></span></div>
                    <div><strong>Fornecedor:</strong> <span id="details-supplier"></span></div>
                    <div><strong>Estoque Total:</strong> <span id="details-total-quantity"></span></div>
                    <div><strong>Consumo Médio Diário:</strong> <span id="details-avg-consumption"></span></div>
                    <div><strong>Estoque Mínimo:</strong> <span id="details-min-stock"></span></div>
                    <div><strong>Estoque Máximo:</strong> <span id="details-max-stock"></span></div>
                </div>
            </div>

            <!-- Edit Mode -->
            <div id="item-details-edit" class="hidden">
                 <form id="edit-item-form">
                    <input type="hidden" id="edit-item-id">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="col-span-1 md:col-span-2">
                            <label for="edit-product-name" class="block text-sm font-medium text-gray-700">Nome do Produto</label>
                            <input type="text" id="edit-product-name" required class="mt-1 block w-full form-input">
                        </div>
                        <div>
                            <label for="edit-product-code" class="block text-sm font-medium text-gray-700">Código</label>
                            <input type="text" id="edit-product-code" required class="mt-1 block w-full form-input">
                        </div>
                        <div>
                            <label for="edit-supplier" class="block text-sm font-medium text-gray-700">Fornecedor</label>
                            <input type="text" id="edit-supplier" required class="mt-1 block w-full form-input">
                        </div>
                        <div>
                            <label for="edit-min-stock" class="block text-sm font-medium text-gray-700">Estoque Mínimo (Opcional)</label>
                            <input type="number" id="edit-min-stock" step="0.01" class="mt-1 block w-full form-input" placeholder="Deixe em branco para auto-cálculo">
                        </div>
                        <div>
                            <label for="edit-max-stock" class="block text-sm font-medium text-gray-700">Estoque Máximo (Opcional)</label>
                            <input type="number" id="edit-max-stock" step="0.01" class="mt-1 block w-full form-input" placeholder="Deixe em branco para auto-cálculo">
                        </div>
                    </div>
                    <div class="mt-8 flex justify-end space-x-3">
                        <button type="button" id="btn-cancel-edit" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancelar</button>
                        <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Salvar Alterações</button>
                    </div>
                </form>
            </div>


            <h3 class="text-xl font-semibold mt-6 mb-2">Lotes Disponíveis</h3>
            <div class="overflow-x-auto border rounded-lg">
                <table class="w-full text-sm text-left">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2">Lote</th>
                            <th class="px-4 py-2">Quantidade</th>
                            <th class="px-4 py-2">Data de Validade</th>
                             <th class="px-4 py-2">Shelf Life (%)</th>
                            <th class="px-4 py-2 text-center">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="details-batches-table"></tbody>
                </table>
            </div>
            
            <h3 class="text-xl font-semibold mt-6 mb-2">Histórico de Movimentação</h3>
            <div class="overflow-x-auto border rounded-lg max-h-60" id="details-history-container">
                <!-- Histórico agrupado por data -->
            </div>
        </div>
    </div>

     <!-- Modal de Edição de Lote -->
    <div id="edit-batch-modal" class="modal p-4">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Editar Lote</h2>
                <button id="close-edit-batch-modal" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <form id="edit-batch-form">
                <input type="hidden" id="edit-batch-id">
                <div class="space-y-4">
                    <div>
                        <label for="edit-batch-code" class="block text-sm font-medium text-gray-700">Código do Lote</label>
                        <input type="text" id="edit-batch-code" required class="mt-1 block w-full form-input">
                    </div>
                     <div>
                        <label for="edit-batch-quantity" class="block text-sm font-medium text-gray-700">Quantidade</label>
                        <input type="number" id="edit-batch-quantity" required min="0" step="0.01" class="mt-1 block w-full form-input">
                    </div>
                    <div>
                        <label for="edit-batch-expiry-date" class="block text-sm font-medium text-gray-700">Data de Validade</label>
                        <input type="date" id="edit-batch-expiry-date" class="mt-1 block w-full form-input">
                    </div>
                    <div>
                        <label for="edit-batch-mfg-date" class="block text-sm font-medium text-gray-700">Data de Fabricação (Opcional)</label>
                        <input type="date" id="edit-batch-mfg-date" class="mt-1 block w-full form-input">
                    </div>
                </div>
                <div class="mt-8 flex justify-end">
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg shadow-md">
                        Salvar Alterações
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Edição de Estoque Residual -->
    <div id="edit-residual-modal" class="modal p-4">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Editar Saldo Residual</h2>
                <button id="close-edit-residual-modal" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <form id="edit-residual-form">
                <input type="hidden" id="edit-residual-product-id">
                <div>
                    <p class="mb-2 text-sm">Produto: <strong id="edit-residual-product-name"></strong></p>
                    <label for="edit-residual-quantity" class="block text-sm font-medium text-gray-700">Nova Quantidade Residual</label>
                    <input type="number" id="edit-residual-quantity" required step="0.01" class="mt-1 block w-full form-input">
                </div>
                <div class="mt-8 flex justify-end">
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg shadow-md">
                        Salvar Alteração
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Receitas -->
    <div id="recipe-modal" class="modal p-4">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
             <div class="flex justify-between items-center mb-6">
                <h2 id="recipe-modal-title" class="text-2xl font-bold">Criar Nova Receita</h2>
                <button id="close-recipe-modal" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <form id="recipe-form">
                <input type="hidden" id="edit-recipe-id">
                <div class="space-y-4">
                     <div>
                        <label for="recipe-name" class="block text-sm font-medium text-gray-700">Nome da Receita</label>
                        <input type="text" id="recipe-name" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none form-input">
                    </div>
                     <div>
                        <label for="recipe-category" class="block text-sm font-medium text-gray-700">Linha de Produção</label>
                        <select id="recipe-category" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none form-input">
                            <option>Salgado</option>
                            <option>Pães congelados</option>
                            <option>Pães especiais</option>
                            <option>Pão de queijo</option>
                            <option>Confeitaria</option>
                        </select>
                    </div>
                    
                    <h3 class="text-lg font-medium pt-4">Ingredientes</h3>
                    <div id="ingredients-container" class="space-y-3">
                        <!-- Ingredientes serão adicionados dinamicamente aqui -->
                    </div>

                    <button type="button" id="add-ingredient-btn" class="text-indigo-600 hover:text-indigo-800 font-medium text-sm">
                        <i class="fa-solid fa-plus mr-1"></i>Adicionar Ingrediente
                    </button>
                </div>
                <div class="mt-8 flex justify-end">
                    <button id="save-recipe-btn" type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg shadow-md">
                        Salvar Receita
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal de Ordem de Produção -->
    <div id="production-order-modal" class="modal p-4">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-5xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 id="production-order-modal-title" class="text-2xl font-bold">Nova Ordem de Produção</h2>
                <button id="close-production-order-modal" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <form id="production-order-form">
                <input type="hidden" id="edit-po-id">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                     <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700">Selecione a Receita</label>
                        <div id="po-recipe-searchable-container" class="searchable-container"></div>
                    </div>
                    <div>
                        <label for="po-quantity" class="block text-sm font-medium text-gray-700">Qtd. de Receitas</label>
                        <input type="number" id="po-quantity" value="1" min="1" required class="mt-1 block w-full form-input">
                    </div>
                </div>
                 <div class="mt-4">
                    <label for="po-date" class="block text-sm font-medium text-gray-700">Data da Produção</label>
                    <input type="date" id="po-date" required class="mt-1 block w-full form-input">
                </div>
                <h3 class="text-lg font-medium pt-6 mb-2">Insumos Necessários</h3>
                <div class="overflow-x-auto border rounded-lg">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-2 py-2 text-left">Insumo</th>
                                <th class="px-2 py-2 text-left">Residual</th>
                                <th class="px-2 py-2 text-left">Qtd. Necessária</th>
                                <th class="px-2 py-2 text-left">Qtd. a Usar</th>
                                <th class="px-2 py-2 text-left">Plano de Consumo (Lotes)</th>
                                <th class="px-2 py-2 text-left">Manipulador</th>
                            </tr>
                        </thead>
                        <tbody id="po-ingredients-body"></tbody>
                    </table>
                </div>
                <div class="mt-8 flex justify-end">
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg shadow-md">
                        Criar Ordem de Produção
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Confirmação de Produção -->
    <div id="confirm-production-modal" class="modal p-4">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
             <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Confirmar Produção e Baixa de Estoque</h2>
                <button id="close-confirm-production-modal" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <p class="text-sm text-gray-600 mb-4">Resumo do plano de consumo para as ordens de produção selecionadas.</p>
             <div class="overflow-x-auto border rounded-lg">
                <table class="w-full text-sm">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left">Insumo</th>
                            <th class="px-4 py-2 text-right">Qtd. Total a Baixar</th>
                            <th class="px-4 py-2 text-left">Lotes de Consumo</th>
                        </tr>
                    </thead>
                    <tbody id="confirm-production-tbody"></tbody>
                </table>
             </div>
             <div class="mt-8 flex justify-end">
                <button id="btn-execute-stock-consumption" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md">
                    Confirmar e Dar Baixa no Estoque
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Confirmação de Upload -->
    <div id="confirm-upload-modal" class="modal">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                    <i class="fa-solid fa-triangle-exclamation text-red-600 text-2xl"></i>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mt-4">Confirmar Restauração</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500">
                        Você tem certeza que deseja restaurar o backup? <strong>Todos os dados atuais serão apagados e substituídos</strong> por completo. Essa ação não pode ser desfeita.
                    </p>
                </div>
            </div>
            <div class="mt-6 flex justify-center space-x-4">
                <button id="cancel-upload-btn" type="button" class="py-2 px-4 bg-gray-200 text-gray-800 font-semibold rounded-lg shadow-md hover:bg-gray-300">
                    Cancelar
                </button>
                <button id="confirm-upload-btn" type="button" class="py-2 px-4 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700">
                    Sim, Substituir Tudo
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação Genérica -->
    <div id="confirm-action-modal" class="modal">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                    <i class="fa-solid fa-triangle-exclamation text-red-600 text-2xl"></i>
                </div>
                <h3 id="confirm-title" class="text-lg leading-6 font-medium text-gray-900 mt-4">Confirmar Ação</h3>
                <div class="mt-2 px-7 py-3">
                    <p id="confirm-message" class="text-sm text-gray-500">
                        Você tem certeza? Essa ação não pode ser desfeita.
                    </p>
                </div>
            </div>
            <div class="mt-6 flex justify-center space-x-4">
                <button id="cancel-action-btn" type="button" class="py-2 px-4 bg-gray-200 text-gray-800 font-semibold rounded-lg shadow-md hover:bg-gray-300">
                    Cancelar
                </button>
                <button id="confirm-action-btn" type="button" class="py-2 px-4 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700">
                    Confirmar
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Informações da Dashboard -->
    <div id="info-list-modal" class="modal p-4">
         <div class="bg-white rounded-lg shadow-xl p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
             <div class="flex justify-between items-center mb-6">
                <h2 id="info-list-title" class="text-2xl font-bold">Detalhes do Alerta</h2>
                <button id="close-info-list-modal" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div id="info-list-content" class="overflow-x-auto">
                <!-- Conteúdo da lista será inserido aqui -->
            </div>
         </div>
    </div>

    <!-- Low Stock Alert Modal -->
    <div id="low-stock-alert-modal" class="modal p-4">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-lg w-full border-t-4 border-red-500">
             <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-red-600 flex items-center"><i class="fa-solid fa-triangle-exclamation mr-3"></i>Alerta de Estoque Baixo</h2>
                <button id="close-low-stock-alert-modal" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <p class="text-gray-600 mb-4">Os seguintes itens estão abaixo do estoque mínimo definido:</p>
            <div id="low-stock-alert-list" class="overflow-y-auto max-h-64 border rounded-lg">
                <!-- List will be populated by JS -->
            </div>
            <div class="mt-6 flex justify-end">
                 <button id="view-low-stock-items-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">
                    Ver Itens no Estoque
                </button>
            </div>
        </div>
    </div>


    <!-- Modal de Notificação -->
    <div id="notification-modal" class="fixed top-5 right-5 z-[100] hidden text-white py-2 px-5 rounded-lg shadow-lg">
        <p id="notification-message"></p>
    </div>

<script type="module">
    // --- MÓDULO DO BANCO DE DADOS OFFLINE (IndexedDB) ---
    const DB = (() => {
        let dbInstance;

        function init() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('estoqueDB', 4); // Versão incrementada para novo Object Store

                request.onerror = (event) => reject("Erro ao abrir o banco de dados.");

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('inventory')) {
                        const inventoryStore = db.createObjectStore('inventory', { keyPath: 'id', autoIncrement: true });
                        inventoryStore.createIndex('code', 'code', { unique: false });
                    }
                    if (!db.objectStoreNames.contains('batches')) {
                        const batchesStore = db.createObjectStore('batches', { keyPath: 'id', autoIncrement: true });
                        batchesStore.createIndex('productId', 'productId', { unique: false });
                    }
                    if (!db.objectStoreNames.contains('history')) {
                        db.createObjectStore('history', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains('recipes')) {
                        db.createObjectStore('recipes', { keyPath: 'id', autoIncrement: true });
                    }
                     if (!db.objectStoreNames.contains('productionOrders')) {
                        db.createObjectStore('productionOrders', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains('monthlyConsumption')) {
                         const consumptionStore = db.createObjectStore('monthlyConsumption', { keyPath: 'id', autoIncrement: true });
                         consumptionStore.createIndex('period', 'period', { unique: false });
                    }
                    if (!db.objectStoreNames.contains('residualStock')) {
                         db.createObjectStore('residualStock', { keyPath: 'productId' });
                    }
                };

                request.onsuccess = (event) => {
                    dbInstance = event.target.result;
                    resolve(dbInstance);
                };
            });
        }

        async function getDB() {
            if (!dbInstance) await init();
            return dbInstance;
        }

        async function add(storeName, data) {
            const db = await getDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.add(data);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function get(storeName, key) {
             const db = await getDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.get(key);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }
        
        async function getByIndex(storeName, indexName, value) {
            const db = await getDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readonly');
                const store = transaction.objectStore(storeName);
                const index = store.index(indexName);
                const request = index.get(value);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function getAll(storeName) {
            const db = await getDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function update(storeName, data) {
            const db = await getDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.put(data);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }
        
        async function remove(storeName, key) {
             const db = await getDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.delete(key);
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }
        
        async function clear(storeName) {
            const db = await getDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.clear();
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        return { add, get, getAll, update, getByIndex, getDB, clear, remove };
    })();

    // --- STATE MANAGEMENT ---
    let localInventory = [], localBatches = [], localHistory = [], localRecipes = [], localProductionOrders = [], localMonthlyConsumption = [], localResidualStock = [];
    let currentSort = { key: 'name', order: 'asc' };
    let tempEntryData = null;
    let backupFileContent = null; 
    let dailyOutputChart = null;
    let scheduledOutputChart = null;
    let abcCurveChart = null;
    let currentRecipeCategory = 'Todos'; // Default to show all
    let previouslyNotifiedLowStockIds = new Set();
    let hasFlashedScreen = false;

    // --- DOM ELEMENTS ---
    const loadingOverlay = document.getElementById('loading-overlay');
    const screens = { dashboard: document.getElementById('screen-dashboard'), entry: document.getElementById('screen-entry'), inventory: document.getElementById('screen-inventory'), recipes: document.getElementById('screen-recipes'), production: document.getElementById('screen-production'), requisitions: document.getElementById('screen-requisitions'), adjustments: document.getElementById('screen-adjustments'), consumption: document.getElementById('screen-consumption'), residual: document.getElementById('screen-residual'), traceability: document.getElementById('screen-traceability'), settings: document.getElementById('screen-settings') };
    const navLinks = { dashboard: document.getElementById('nav-dashboard'), entry: document.getElementById('nav-entry'), inventory: document.getElementById('nav-inventory'), recipes: document.getElementById('nav-recipes'), production: document.getElementById('nav-production'), requisitions: document.getElementById('nav-requisitions'), adjustments: document.getElementById('nav-adjustments'), consumption: document.getElementById('nav-consumption'), residual: document.getElementById('nav-residual'), traceability: document.getElementById('nav-traceability'), settings: document.getElementById('nav-settings') };
    const entryForm = document.getElementById('entry-form');
    const shelfLifeModal = document.getElementById('shelf-life-modal');
    const shelfLifeValue = document.getElementById('shelf-life-value');
    const authorizerNameInput = document.getElementById('authorizer-name');
    const cancelReceiptBtn = document.getElementById('cancel-receipt-btn');
    const confirmReceiptBtn = document.getElementById('confirm-receipt-btn');
    const inventoryTableBody = document.getElementById('inventory-table-body');
    const searchInput = document.getElementById('search-inventory');
    const btnExportExcel = document.getElementById('btn-export-excel');
    const detailsModal = document.getElementById('item-details-modal');
    const detailsBatchesTable = document.getElementById('details-batches-table');
    const closeDetailsModalBtn = document.getElementById('close-details-modal');
    const btnNewRecipe = document.getElementById('btn-new-recipe');
    const recipeModal = document.getElementById('recipe-modal');
    const recipeModalTitle = document.getElementById('recipe-modal-title');
    const saveRecipeBtn = document.getElementById('save-recipe-btn');
    const closeRecipeModalBtn = document.getElementById('close-recipe-modal');
    const recipeForm = document.getElementById('recipe-form');
    const addIngredientBtn = document.getElementById('add-ingredient-btn');
    const ingredientsContainer = document.getElementById('ingredients-container');
    const notificationModal = document.getElementById('notification-modal');
    const notificationMessage = document.getElementById('notification-message');
    const itemDetailsView = document.getElementById('item-details-view');
    const itemDetailsEdit = document.getElementById('item-details-edit');
    const btnEditItem = document.getElementById('btn-edit-item');
    const btnCancelEdit = document.getElementById('btn-cancel-edit');
    const editItemForm = document.getElementById('edit-item-form');
    const detailsHistoryContainer = document.getElementById('details-history-container');
    const recipesGrid = document.getElementById('recipes-grid');
    const recipeCategoriesList = document.getElementById('recipe-categories-list');
    const productionOrdersList = document.getElementById('production-orders-list');
    const btnNewProductionOrder = document.getElementById('btn-new-production-order');
    const productionOrderModal = document.getElementById('production-order-modal');
    const productionOrderModalTitle = document.getElementById('production-order-modal-title');
    const closeProductionOrderModalBtn = document.getElementById('close-production-order-modal');
    const productionOrderForm = document.getElementById('production-order-form');
    const poRecipeSearchableContainer = document.getElementById('po-recipe-searchable-container');
    const poIngredientsBody = document.getElementById('po-ingredients-body');
    const poQuantity = document.getElementById('po-quantity');
    const poDate = document.getElementById('po-date');
    const searchPoByDate = document.getElementById('search-po-by-date');
    const btnExportPdf = document.getElementById('btn-export-pdf');
    const btnExportWord = document.getElementById('btn-export-word');
    const btnConfirmProduction = document.getElementById('btn-confirm-production');
    const confirmProductionModal = document.getElementById('confirm-production-modal');
    const closeConfirmProductionModalBtn = document.getElementById('close-confirm-production-modal');
    const productionDateFilter = document.getElementById('production-date-filter');
    const confirmProductionTbody = document.getElementById('confirm-production-tbody');
    const btnExecuteStockConsumption = document.getElementById('btn-execute-stock-consumption');
    const btnDownloadBackup = document.getElementById('btn-download-backup');
    const btnUploadBackup = document.getElementById('btn-upload-backup');
    const backupFileInput = document.getElementById('backup-file-input');
    const confirmUploadModal = document.getElementById('confirm-upload-modal');
    const cancelUploadBtn = document.getElementById('cancel-upload-btn');
    const confirmUploadBtn = document.getElementById('confirm-upload-btn');
    const confirmActionModal = document.getElementById('confirm-action-modal');
    const editBatchModal = document.getElementById('edit-batch-modal');
    const closeEditBatchModal = document.getElementById('close-edit-batch-modal');
    const editBatchForm = document.getElementById('edit-batch-form');
    const adjustmentForm = document.getElementById('adjustment-form');
    const adjustmentSearchableContainer = document.getElementById('adjustment-searchable-container');
    const adjustmentBatchSelect = document.getElementById('adjustment-batch');
    const requisitionForm = document.getElementById('requisition-form');
    const requisitionItemsContainer = document.getElementById('requisition-items-container');
    const addRequisitionItemBtn = document.getElementById('add-requisition-item-btn');
    const consumptionMonthFilter = document.getElementById('consumption-month-filter');
    const consumptionYearFilter = document.getElementById('consumption-year-filter');
    const consumptionTableBody = document.getElementById('consumption-table-body');
    const residualTableBody = document.getElementById('residual-table-body');
    const editResidualModal = document.getElementById('edit-residual-modal');
    const closeEditResidualModal = document.getElementById('close-edit-residual-modal');
    const editResidualForm = document.getElementById('edit-residual-form');
    const btnResetDatabase = document.getElementById('btn-reset-database');
    const cardLowStock = document.getElementById('card-low-stock');
    const cardExpiringSoon = document.getElementById('card-expiring-soon');
    const infoListModal = document.getElementById('info-list-modal');
    const closeInfoListModalBtn = document.getElementById('close-info-list-modal');
    const supplierFilter = document.getElementById('supplier-filter');
    const btnExportDailyOutput = document.getElementById('btn-export-daily-output');
    const btnExportScheduledOutput = document.getElementById('btn-export-scheduled-output');
    const btnExportExpiring45 = document.getElementById('btn-export-expiring-45');
    const btnExportLossRisk = document.getElementById('btn-export-loss-risk');
    const traceProductSearchable = document.getElementById('trace-product-searchable');
    const traceBatchCodeInput = document.getElementById('trace-batch-code');
    const traceHandlerNameInput = document.getElementById('trace-handler-name');
    const btnTrace = document.getElementById('btn-trace');
    const traceResultsContainer = document.getElementById('trace-results');
    const traceTypeRadios = document.querySelectorAll('input[name="trace-type"]');
    const traceLoteFields = document.getElementById('trace-lote-fields');
    const traceManipuladorFields = document.getElementById('trace-manipulador-fields');
    const lowStockIndicator = document.getElementById('low-stock-indicator');
    const lowStockCount = document.getElementById('low-stock-count');
    const lowStockAlertModal = document.getElementById('low-stock-alert-modal');
    const closeLowStockAlertModal = document.getElementById('close-low-stock-alert-modal');
    const lowStockAlertList = document.getElementById('low-stock-alert-list');
    const viewLowStockItemsBtn = document.getElementById('view-low-stock-items-btn');
    
    // --- EVENT LISTENERS FOR NEW ELEMENTS ---
    lowStockIndicator.addEventListener('click', () => {
        showModal(lowStockAlertModal);
        lowStockIndicator.classList.remove('shake-alert');
    });

    closeLowStockAlertModal.addEventListener('click', () => {
        hideModal(lowStockAlertModal);
    });

    viewLowStockItemsBtn.addEventListener('click', () => {
        hideModal(lowStockAlertModal);
        navigateTo('inventory');
        renderInventoryTable('low-stock');
    });

    // --- FUNÇÕES AUXILIARES ---
    function showNotification(message, isError = false) {
        notificationMessage.textContent = message;
        notificationModal.classList.toggle('bg-green-500', !isError);
        notificationModal.classList.toggle('bg-red-500', isError);
        notificationModal.style.display = 'block';
        setTimeout(() => {
             notificationModal.style.display = 'none';
        }, 4000);
    }

    function showModal(modalElement) {
        modalElement.style.display = 'flex';
    }

    function hideModal(modalElement) {
        modalElement.style.display = 'none';
    }
    
    function showConfirmationModal(title, message, onConfirm) {
        document.getElementById('confirm-title').textContent = title;
        document.getElementById('confirm-message').innerHTML = message;
        showModal(confirmActionModal);

        const cancelBtn = document.getElementById('cancel-action-btn');
        const confirmBtn = document.getElementById('confirm-action-btn');

        const cleanup = () => {
            hideModal(confirmActionModal);
            confirmBtn.replaceWith(confirmBtn.cloneNode(true));
            cancelBtn.replaceWith(cancelBtn.cloneNode(true));
        };

        cancelBtn.addEventListener('click', cleanup, { once: true });
        confirmBtn.addEventListener('click', () => {
            onConfirm();
            cleanup();
        }, { once: true });
    }

    function createSearchableSelect(container, items, placeholder, onSelect) {
        container.innerHTML = `
            <input type="text" class="form-input w-full" placeholder="${placeholder}">
            <div class="searchable-dropdown hidden"></div>
        `;
        const input = container.querySelector('input');
        const dropdown = container.querySelector('.searchable-dropdown');

        input.addEventListener('input', () => {
            const searchTerm = input.value.toLowerCase();
            dropdown.innerHTML = '';
            if (searchTerm) {
                const filteredItems = items.filter(item => item.name.toLowerCase().includes(searchTerm));
                if (filteredItems.length > 0) {
                    filteredItems.forEach(item => {
                        const itemEl = document.createElement('div');
                        itemEl.className = 'searchable-item';
                        itemEl.textContent = item.name;
                        itemEl.dataset.id = item.id;
                        dropdown.appendChild(itemEl);
                    });
                    dropdown.classList.remove('hidden');
                } else {
                    dropdown.classList.add('hidden');
                }
            } else {
                dropdown.classList.add('hidden');
            }
        });

        dropdown.addEventListener('click', e => {
            if (e.target.classList.contains('searchable-item')) {
                const selectedId = parseInt(e.target.dataset.id);
                const selectedItem = items.find(item => item.id === selectedId);
                input.value = selectedItem.name;
                input.dataset.selectedId = selectedId;
                dropdown.classList.add('hidden');
                if (onSelect) onSelect(selectedItem);
            }
        });

        document.addEventListener('click', e => {
            if (!container.contains(e.target)) {
                dropdown.classList.add('hidden');
            }
        });
    }

    // --- NAVIGATION ---
    function navigateTo(screenName) {
        Object.values(screens).forEach(screen => screen.classList.add('hidden'));
        screens[screenName].classList.remove('hidden');
        Object.values(navLinks).forEach(link => link.classList.remove('active-nav'));
        navLinks[screenName].classList.add('active-nav');
        // Add logic to initialize screens with dynamic content
        if (screenName === 'adjustments') {
            initializeAdjustmentScreen();
        }
        if (screenName === 'requisitions') {
            initializeRequisitionScreen();
        }
        if (screenName === 'traceability') {
            initializeTraceabilityScreen();
        }
    }
    Object.keys(navLinks).forEach(key => { navLinks[key].addEventListener('click', (e) => { e.preventDefault(); navigateTo(key); }); });

    // --- ENTRY SCREEN LOGIC ---
    function calculateShelfLife(mfg, receipt, expiry) {
        const mfgDate = new Date(mfg + 'T00:00:00');
        const receiptDate = new Date(receipt + 'T00:00:00');
        const expiryDate = new Date(expiry + 'T00:00:00');
        const totalLife = expiryDate.getTime() - mfgDate.getTime();
        const remainingLife = expiryDate.getTime() - receiptDate.getTime();
        if (totalLife <= 0) return 0;
        return (remainingLife / totalLife) * 100;
    }
    entryForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const formData = new FormData(entryForm);
        const data = {
            name: formData.get('product-name'), code: formData.get('product-code') || 'N/A', supplier: formData.get('supplier'),
            quantity: parseFloat(formData.get('quantity')), batchCode: formData.get('batch-code') || 'N/A',
            mfgDate: document.getElementById('mfg-date').value, receiptDate: document.getElementById('receipt-date').value,
            expiryDate: document.getElementById('expiry-date').value
        };
        let shelfLife = null;
        if (data.mfgDate && data.receiptDate && data.expiryDate) { shelfLife = calculateShelfLife(data.mfgDate, data.receiptDate, data.expiryDate); }
        data.shelfLife = shelfLife;
        tempEntryData = data;
        if (shelfLife !== null && shelfLife < 75) {
            shelfLifeValue.textContent = shelfLife.toFixed(1);
            showModal(shelfLifeModal);
        } else { saveEntry(); }
    });

    async function saveEntry(authorizedBy = null) {
        const data = tempEntryData;
        if (!data) return;
        try {
            let product = await DB.getByIndex('inventory', 'code', data.code);
            let productId;
            if (!product) {
                productId = await DB.add('inventory', { code: data.code, name: data.name, supplier: data.supplier, totalQuantity: data.quantity });
            } else {
                productId = product.id;
                product.totalQuantity += data.quantity;
                await DB.update('inventory', product);
            }
            await DB.add('batches', { productId, code: data.batchCode, quantity: data.quantity, mfgDate: data.mfgDate, receiptDate: data.receiptDate, expiryDate: data.expiryDate, shelfLife: data.shelfLife, authorizedBy });
            await DB.add('history', { productId, batchCode: data.batchCode, type: 'entrada', quantity: data.quantity, date: data.receiptDate });
            showNotification('Entrada registrada com sucesso!');
            entryForm.reset();
            closeShelfLifeModal();
            await refreshLocalData();
        } catch (error) {
            console.error("Erro ao salvar entrada: ", error);
            showNotification("Erro ao salvar entrada.", true);
        }
    }
    function closeShelfLifeModal() {
        hideModal(shelfLifeModal);
        authorizerNameInput.value = '';
        tempEntryData = null;
    }
    cancelReceiptBtn.addEventListener('click', closeShelfLifeModal);
    confirmReceiptBtn.addEventListener('click', () => {
        const authorizer = authorizerNameInput.value;
        if (!authorizer.trim()) {
            showNotification('Por favor, insira o nome do responsável.', true);
            return;
        }
        saveEntry(authorizer);
    });

    // --- INVENTORY SCREEN LOGIC ---
    function calculateAllReservations() {
        const reservations = {}; // { productId: reservedQty }
        const pendingPOs = localProductionOrders.filter(p => p.status === 'pendente');
        
        pendingPOs.forEach(po => {
            if (!po.ingredients) return;
            po.ingredients.forEach(ing => {
                if (ing.consumptionPlan) {
                    ing.consumptionPlan.forEach(planItem => {
                        // This was the bug: it should be ing.productId, not planItem.productId
                        reservations[ing.productId] = (reservations[ing.productId] || 0) + planItem.quantity;
                    });
                }
            });
        });
        return reservations;
    }

    function renderInventoryTable(specialFilter = null) {
        const reservations = calculateAllReservations();
        let filteredInventory = [...localInventory];

        let searchTerm = searchInput.value.toLowerCase();
        const selectedSupplier = supplierFilter.value;
        
        if (specialFilter) {
            searchInput.value = ''; // Clear search bar for special filters
            if (specialFilter === 'low-stock') {
                const lowStockItems = localInventory.filter(i => {
                    const metrics = calculateConsumptionMetrics(i.id);
                    const minStock = i.minStock !== null && i.minStock !== undefined ? i.minStock : metrics.minStock;
                    return i.totalQuantity < minStock && minStock > 0;
                });
                const lowStockIds = new Set(lowStockItems.map(i => i.id));
                filteredInventory = filteredInventory.filter(item => lowStockIds.has(item.id));
            } else if (specialFilter === 'expiring-soon') {
                const today = new Date();
                const thirtyDaysFromNow = new Date();
                thirtyDaysFromNow.setDate(today.getDate() + 30);
                const expiringBatches = localBatches.filter(b => b.quantity > 0 && b.expiryDate && new Date(b.expiryDate) <= thirtyDaysFromNow);
                const expiringProductIds = new Set(expiringBatches.map(b => b.productId));
                filteredInventory = filteredInventory.filter(item => expiringProductIds.has(item.id));
            }
        } else {
            if (searchTerm) {
                filteredInventory = filteredInventory.filter(item => 
                    item.name.toLowerCase().includes(searchTerm) ||
                    (item.code && item.code.toLowerCase().includes(searchTerm)) ||
                    item.supplier.toLowerCase().includes(searchTerm)
                );
            }
            if (selectedSupplier) {
                filteredInventory = filteredInventory.filter(item => item.supplier === selectedSupplier);
            }
        }

        filteredInventory.sort((a, b) => {
            let valA, valB;
            if (currentSort.key === 'expiry') {
                valA = getNextExpiry(a.id) || '9999-12-31';
                valB = getNextExpiry(b.id) || '9999-12-31';
            } else if (currentSort.key === 'totalQuantity') {
                valA = a.totalQuantity;
                valB = b.totalQuantity;
            } else if (currentSort.key === 'reserved') {
                valA = reservations[a.id] || 0;
                valB = reservations[b.id] || 0;
            } else if (currentSort.key === 'available') {
                valA = a.totalQuantity - (reservations[a.id] || 0);
                valB = b.totalQuantity - (reservations[b.id] || 0);
            }
            else {
                valA = a[currentSort.key] || '';
                valB = b[currentSort.key] || '';
            }
             if (typeof valA === 'string') valA = valA.toLowerCase();
            if (typeof valB === 'string') valB = valB.toLowerCase();
            if (valA < valB) return currentSort.order === 'asc' ? -1 : 1;
            if (valA > valB) return currentSort.order === 'asc' ? 1 : -1;
            return 0;
        });

        document.querySelectorAll('.table-header-sortable i').forEach(icon => icon.remove());
        const activeHeader = document.querySelector(`.table-header-sortable[data-sort="${currentSort.key}"]`);
        if (activeHeader) {
            const icon = document.createElement('i');
            icon.className = `fa-solid ${currentSort.order === 'asc' ? 'fa-arrow-up' : 'fa-arrow-down'} ml-2`;
            activeHeader.appendChild(icon);
        }

        inventoryTableBody.innerHTML = '';
        if (filteredInventory.length === 0) {
            inventoryTableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4">Nenhum item encontrado.</td></tr>`;
            return;
        }
        filteredInventory.forEach(item => {
            const nextExpiry = getNextExpiry(item.id);
            const reservedQty = reservations[item.id] || 0;
            const availableQty = item.totalQuantity - reservedQty;
            const row = document.createElement('tr');
            row.className = 'bg-white border-b hover:bg-gray-50 cursor-pointer';
            row.addEventListener('click', () => showItemDetails(item.id));
            row.innerHTML = `
                <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${item.name}</td>
                <td class="px-6 py-4">${item.code}</td>
                <td class="px-6 py-4 text-right">${item.totalQuantity.toFixed(2)}</td>
                <td class="px-6 py-4 text-right text-blue-600">${reservedQty.toFixed(2)}</td>
                <td class="px-6 py-4 text-right font-bold ${availableQty <= 0 ? 'text-red-600' : 'text-green-600'}">${availableQty.toFixed(2)}</td>
                <td class="px-6 py-4">${nextExpiry ? new Date(nextExpiry + 'T00:00:00').toLocaleDateString('pt-BR') : 'N/A'}</td>
            `;
            inventoryTableBody.appendChild(row);
        });
    }
    function getNextExpiry(productId) {
         const productBatches = localBatches.filter(b => b.productId === productId && b.quantity > 0 && b.expiryDate);
        if (productBatches.length === 0) return null;
        return productBatches.sort((a, b) => new Date(a.expiryDate) - new Date(b.expiryDate))[0].expiryDate;
    }
    document.querySelectorAll('.table-header-sortable').forEach(header => { 
        header.addEventListener('click', () => {
            const sortKey = header.dataset.sort;
            if (!sortKey) return;
            if (currentSort.key === sortKey) {
                currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.key = sortKey;
                currentSort.order = 'asc';
            }
            renderInventoryTable();
        });
    });
    searchInput.addEventListener('input', () => renderInventoryTable());
    supplierFilter.addEventListener('change', () => renderInventoryTable());

    function populateSupplierFilter() {
        const suppliers = [...new Set(localInventory.map(item => item.supplier))].sort();
        const currentVal = supplierFilter.value;
        supplierFilter.innerHTML = `<option value="">Todos os Fornecedores</option>`;
        suppliers.forEach(supplier => {
            const option = document.createElement('option');
            option.value = supplier;
            option.textContent = supplier;
            if (supplier === currentVal) {
                option.selected = true;
            }
            supplierFilter.appendChild(option);
        });
    }
    
    // --- ITEM DETAILS & EDIT MODAL ---
    function calculateConsumptionMetrics(productId) {
        const today = new Date();
        const currentPeriod = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
        const consumptionRecord = localMonthlyConsumption.find(c => c.period === currentPeriod && c.productId === productId);
        
        const monthlyConsumption = consumptionRecord ? consumptionRecord.totalConsumed : 0;
        const avgConsumption = monthlyConsumption / 22; // Dias úteis no mês

        const leadTime = 7; // Tempo de reposição em dias (exemplo)
        const replenishmentPeriod = 30; // Período de compra em dias (exemplo)

        const minStock = avgConsumption * leadTime;
        const maxStock = minStock + (avgConsumption * replenishmentPeriod);
        
        return { avgConsumption, minStock, maxStock };
    }

    function showItemDetails(productId) {
        const product = localInventory.find(p => p.id === productId);
        if (!product) return;
        
        document.getElementById('details-product-name').textContent = product.name;
        document.getElementById('details-product-code').textContent = product.code;
        document.getElementById('details-supplier').textContent = product.supplier;
        document.getElementById('details-total-quantity').textContent = product.totalQuantity.toFixed(2);
        
        const metrics = calculateConsumptionMetrics(productId);
        
        document.getElementById('details-avg-consumption').textContent = metrics.avgConsumption.toFixed(2);

        if (product.minStock !== null && product.minStock !== undefined) {
            document.getElementById('details-min-stock').innerHTML = `${product.minStock.toFixed(2)} <span class="text-xs text-gray-500">(sugestão: ${metrics.minStock.toFixed(2)})</span>`;
        } else {
            document.getElementById('details-min-stock').innerHTML = `${metrics.minStock.toFixed(2)} <span class="text-xs text-gray-500">(sugestão)</span>`;
        }
        
        if (product.maxStock !== null && product.maxStock !== undefined) {
             document.getElementById('details-max-stock').innerHTML = `${product.maxStock.toFixed(2)} <span class="text-xs text-gray-500">(sugestão: ${metrics.maxStock.toFixed(2)})</span>`;
        } else {
            document.getElementById('details-max-stock').innerHTML = `${metrics.maxStock.toFixed(2)} <span class="text-xs text-gray-500">(sugestão)</span>`;
        }
        
        document.getElementById('edit-item-id').value = product.id;
        document.getElementById('edit-product-name').value = product.name;
        document.getElementById('edit-product-code').value = product.code;
        document.getElementById('edit-supplier').value = product.supplier;
        document.getElementById('edit-min-stock').value = product.minStock;
        document.getElementById('edit-max-stock').value = product.maxStock;

        const batches = localBatches.filter(b => b.productId === productId && b.quantity > 0);
        const history = localHistory.filter(h => h.productId === productId).sort((a, b) => new Date(b.date) - new Date(a.date));

        detailsBatchesTable.innerHTML = batches.map(batch => `
            <tr class="border-b">
                <td class="px-4 py-2">${batch.code}</td>
                <td class="px-4 py-2">${batch.quantity.toFixed(2)}</td>
                <td class="px-4 py-2">${batch.expiryDate ? new Date(batch.expiryDate + 'T00:00:00').toLocaleDateString('pt-BR') : 'N/A'}</td>
                <td class="px-4 py-2">${typeof batch.shelfLife === 'number' ? batch.shelfLife.toFixed(1) : (batch.shelfLife || 'N/A')}</td>
                <td class="px-4 py-2 text-center">
                    <button class="edit-batch-btn text-blue-500 hover:text-blue-700 p-1" data-batch-id="${batch.id}" title="Editar Lote"><i class="fa-solid fa-pencil"></i></button>
                    <button class="delete-batch-btn text-red-500 hover:text-red-700 p-1" data-batch-id="${batch.id}" title="Excluir Lote"><i class="fa-solid fa-trash"></i></button>
                </td>
            </tr>`).join('');
        
        const groupedHistory = history.reduce((acc, entry) => {
            (acc[entry.date] = acc[entry.date] || []).push(entry);
            return acc;
        }, {});

        detailsHistoryContainer.innerHTML = Object.keys(groupedHistory).sort((a,b) => new Date(b) - new Date(a)).map(date => `
            <div class="pt-2">
                <h4 class="bg-gray-100 p-2 font-semibold text-sm sticky top-0">${new Date(date + 'T00:00:00').toLocaleDateString('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</h4>
                <table class="w-full text-sm text-left">
                    <tbody>
                        ${groupedHistory[date].map(entry => `
                        <tr class="border-b">
                            <td class="px-4 py-2 w-1/3">
                                <span class="font-medium ${entry.type === 'entrada' ? 'text-green-600' : 'text-red-600'}">${entry.type.charAt(0).toUpperCase() + entry.type.slice(1)}</span>
                                <span class="text-gray-500 text-xs block">${entry.reason || ''} ${entry.responsible ? `(Resp: ${entry.responsible})` : ''}</span>
                            </td>
                            <td class="px-4 py-2 w-1/3">${entry.quantity.toFixed(2)}</td>
                            <td class="px-4 py-2 w-1/3">${entry.batchCode}</td>
                        </tr>`).join('')}
                    </tbody>
                </table>
            </div>
        `).join('');

        itemDetailsView.classList.remove('hidden');
        itemDetailsEdit.classList.add('hidden');
        showModal(detailsModal);
    }
    closeDetailsModalBtn.addEventListener('click', () => { hideModal(detailsModal) });
    btnEditItem.addEventListener('click', () => { itemDetailsView.classList.add('hidden'); itemDetailsEdit.classList.remove('hidden'); });
    btnCancelEdit.addEventListener('click', () => { itemDetailsView.classList.remove('hidden'); itemDetailsEdit.classList.add('hidden'); });

    editItemForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const updatedData = {
            id: parseInt(document.getElementById('edit-item-id').value),
            name: document.getElementById('edit-product-name').value,
            code: document.getElementById('edit-product-code').value,
            supplier: document.getElementById('edit-supplier').value,
        };
        const minStock = parseFloat(document.getElementById('edit-min-stock').value);
        const maxStock = parseFloat(document.getElementById('edit-max-stock').value);
        updatedData.minStock = isNaN(minStock) ? null : minStock;
        updatedData.maxStock = isNaN(maxStock) ? null : maxStock;

        try {
            const item = await DB.get('inventory', updatedData.id);
            const fullItem = { ...item, ...updatedData };
            await DB.update('inventory', fullItem);
            showNotification("Item atualizado com sucesso!");
            itemDetailsView.classList.remove('hidden');
            itemDetailsEdit.classList.add('hidden');
            await refreshLocalData();
            showItemDetails(updatedData.id);
        } catch (error) {
            console.error("Erro ao atualizar o item:", error);
            showNotification("Erro ao atualizar o item.", true);
        }
    });
    
    // --- BATCH EDIT/DELETE ---
    detailsBatchesTable.addEventListener('click', e => {
        const editBtn = e.target.closest('.edit-batch-btn');
        if (editBtn) {
            handleEditBatch(parseInt(editBtn.dataset.batchId));
        }
        const deleteBtn = e.target.closest('.delete-batch-btn');
        if(deleteBtn) {
            handleDeleteBatch(parseInt(deleteBtn.dataset.batchId));
        }
    });

    async function handleEditBatch(batchId) {
        const batch = localBatches.find(b => b.id === batchId);
        if (!batch) return;
        document.getElementById('edit-batch-id').value = batch.id;
        document.getElementById('edit-batch-code').value = batch.code;
        document.getElementById('edit-batch-quantity').value = batch.quantity;
        document.getElementById('edit-batch-expiry-date').value = batch.expiryDate;
        document.getElementById('edit-batch-mfg-date').value = batch.mfgDate;
        showModal(editBatchModal);
    }

    closeEditBatchModal.addEventListener('click', () => hideModal(editBatchModal));
    
    editBatchForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const batchId = parseInt(document.getElementById('edit-batch-id').value);
        const newCode = document.getElementById('edit-batch-code').value;
        const newQuantity = parseFloat(document.getElementById('edit-batch-quantity').value);
        const newExpiryDate = document.getElementById('edit-batch-expiry-date').value;
        const newMfgDate = document.getElementById('edit-batch-mfg-date').value;

        try {
            const batch = await DB.get('batches', batchId);
            const oldQuantity = batch.quantity;
            batch.code = newCode;
            batch.quantity = newQuantity;
            batch.expiryDate = newExpiryDate;
            batch.mfgDate = newMfgDate;

            if (batch.mfgDate && batch.receiptDate && newExpiryDate) {
                batch.shelfLife = calculateShelfLife(batch.mfgDate, batch.receiptDate, newExpiryDate);
            } else {
                batch.shelfLife = null;
            }

            await DB.update('batches', batch);

            const quantityDifference = newQuantity - oldQuantity;
            const product = await DB.get('inventory', batch.productId);
            product.totalQuantity += quantityDifference;
            await DB.update('inventory', product);

            showNotification("Lote atualizado com sucesso!");
            hideModal(editBatchModal);
            await refreshLocalData();
            showItemDetails(batch.productId); // Refresh details view
        } catch (error) {
            showNotification("Erro ao atualizar o lote.", true);
            console.error(error);
        }
    });

    function handleDeleteBatch(batchId) {
        const batch = localBatches.find(b => b.id === batchId);
        if (!batch) return;

        showConfirmationModal("Excluir Lote", `Tem certeza que deseja excluir o lote <strong>${batch.code}</strong>? A quantidade (${batch.quantity.toFixed(2)}) será removida do estoque total.`, async () => {
            try {
                await DB.remove('batches', batchId);
                const product = await DB.get('inventory', batch.productId);
                product.totalQuantity -= batch.quantity;
                await DB.update('inventory', product);

                await DB.add('history', {
                    productId: batch.productId,
                    batchCode: batch.code,
                    type: 'exclusão',
                    quantity: batch.quantity,
                    date: new Date().toISOString().split('T')[0]
                });

                showNotification("Lote excluído com sucesso!");
                await refreshLocalData();
                showItemDetails(batch.productId);
            } catch(error) {
                showNotification("Erro ao excluir lote.", true);
                console.error(error);
            }
        });
    }


    // --- RECIPES SCREEN LOGIC ---
    function renderRecipes() {
        // 1. Populate categories list
        const categories = ['Todos', ...new Set(localRecipes.map(r => r.category))].sort((a, b) => {
            if (a === 'Todos') return -1;
            if (b === 'Todos') return 1;
            return a.localeCompare(b);
        });

        recipeCategoriesList.innerHTML = categories.map(category => `
            <li>
                <a href="#" class="block p-2 rounded-md font-medium text-gray-600 hover:bg-indigo-50 hover:text-indigo-700 category-filter-btn ${category === currentRecipeCategory ? 'bg-indigo-100 text-indigo-800' : ''}" data-category="${category}">
                    ${category}
                </a>
            </li>
        `).join('');

        // 2. Filter recipes based on current category
        let filteredRecipes = localRecipes;
        if (currentRecipeCategory !== 'Todos') {
            filteredRecipes = localRecipes.filter(r => r.category === currentRecipeCategory);
        }

        // 3. Render recipe cards
        recipesGrid.innerHTML = '';
        if (filteredRecipes.length === 0) {
            recipesGrid.innerHTML = `<p class="text-gray-500 col-span-full text-center mt-8">Nenhuma receita encontrada para esta linha de produção.</p>`;
            return;
        }

        filteredRecipes.forEach(recipe => {
            const card = document.createElement('div');
            card.className = 'relative bg-white p-4 rounded-lg shadow transition hover:shadow-md flex flex-col'; // Added flex
            let ingredientsHtml = recipe.ingredients.map(ing => {
                const product = localInventory.find(p => p.id === ing.productId);
                return `<li class="text-sm text-gray-600">${product ? product.name : 'Ingrediente desconhecido'}: ${ing.quantity.toFixed(4)}</li>`;
            }).join('');

            card.innerHTML = `
                <div class="flex-grow">
                    <div class="absolute top-2 right-2 flex space-x-2">
                        <button class="edit-recipe-btn text-blue-500 hover:text-blue-700" data-recipe-id="${recipe.id}" title="Editar"><i class="fa-solid fa-pencil"></i></button>
                        <button class="delete-recipe-btn text-red-500 hover:text-red-700" data-recipe-id="${recipe.id}" title="Excluir"><i class="fa-solid fa-trash"></i></button>
                    </div>
                    <h3 class="font-bold pr-12">${recipe.name}</h3>
                    <ul class="list-disc list-inside mt-2">${ingredientsHtml}</ul>
                </div>
            `;
            recipesGrid.appendChild(card);
        });
    }

    recipeCategoriesList.addEventListener('click', (e) => {
        e.preventDefault();
        const filterBtn = e.target.closest('.category-filter-btn');
        if (filterBtn) {
            currentRecipeCategory = filterBtn.dataset.category;
            renderRecipes(); // Re-render with the new filter
        }
    });

    recipesGrid.addEventListener('click', (e) => {
        const editBtn = e.target.closest('.edit-recipe-btn');
        if (editBtn) {
            handleEditRecipe(parseInt(editBtn.dataset.recipeId));
        }
        const deleteBtn = e.target.closest('.delete-recipe-btn');
        if (deleteBtn) {
            handleDeleteRecipe(parseInt(deleteBtn.dataset.recipeId));
        }
    });
    
    function handleEditRecipe(recipeId) {
        const recipe = localRecipes.find(r => r.id === recipeId);
        if (!recipe) return;
        
        document.getElementById('edit-recipe-id').value = recipe.id;
        document.getElementById('recipe-name').value = recipe.name;
        document.getElementById('recipe-category').value = recipe.category;

        ingredientsContainer.innerHTML = '';
        recipe.ingredients.forEach(ing => {
            addIngredientRow(ing.productId, ing.quantity);
        });

        recipeModalTitle.textContent = "Editar Receita";
        saveRecipeBtn.textContent = "Salvar Alterações";
        showModal(recipeModal);
    }
    
    function handleDeleteRecipe(recipeId) {
         const recipe = localRecipes.find(r => r.id === recipeId);
         if(!recipe) return;

         showConfirmationModal(
            "Excluir Receita",
            `Tem certeza que deseja excluir a receita "<strong>${recipe.name}</strong>"?`,
            async () => {
                try {
                    await DB.remove('recipes', recipeId);
                    showNotification("Receita excluída com sucesso.");
                    await refreshLocalData();
                } catch(err) {
                    showNotification("Erro ao excluir a receita.", true);
                }
            }
        );
    }

    btnNewRecipe.addEventListener('click', () => {
        if(localInventory.length === 0) { showNotification("Adicione itens ao estoque antes de criar uma receita.", true); return; }
        recipeForm.reset();
        document.getElementById('edit-recipe-id').value = '';
        ingredientsContainer.innerHTML = '';
        addIngredientRow();
        recipeModalTitle.textContent = "Criar Nova Receita";
        saveRecipeBtn.textContent = "Salvar Receita";
        showModal(recipeModal);
    });

    closeRecipeModalBtn.addEventListener('click', () => hideModal(recipeModal));
    
    function addIngredientRow(selectedProductId = null, quantity = null) {
        const row = document.createElement('div');
        row.className = 'flex items-center space-x-2';
        row.innerHTML = `
            <div class="searchable-container flex-1"></div>
            <input type="number" placeholder="Qtd" value="${quantity || ''}" min="0.0001" step="0.0001" class="block w-1/3 form-input" required>
            <button type="button" class="text-red-500 hover:text-red-700 remove-ingredient-btn font-bold text-xl">&times;</button>
        `;
        ingredientsContainer.appendChild(row);

        const searchableContainer = row.querySelector('.searchable-container');
        createSearchableSelect(searchableContainer, localInventory, 'Buscar ingrediente...', null);

        if (selectedProductId) {
            const product = localInventory.find(p => p.id === selectedProductId);
            if (product) {
                const input = searchableContainer.querySelector('input');
                input.value = product.name;
                input.dataset.selectedId = product.id;
            }
        }
    }
    addIngredientBtn.addEventListener('click', () => addIngredientRow());
    ingredientsContainer.addEventListener('click', (e) => { if (e.target.classList.contains('remove-ingredient-btn')) e.target.parentElement.remove(); });
    
    recipeForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const recipeId = document.getElementById('edit-recipe-id').value;
        try {
            const ingredients = Array.from(ingredientsContainer.querySelectorAll('.flex')).map(row => {
                const input = row.querySelector('.searchable-container input');
                const productId = parseInt(input.dataset.selectedId);
                if (!productId) {
                    throw new Error("Produto inválido selecionado. Use a busca e clique no item desejado.");
                }
                return {
                    productId: productId,
                    quantity: parseFloat(row.querySelector('input[type="number"]').value)
                }
            });

            const recipeData = {
                name: document.getElementById('recipe-name').value, 
                category: document.getElementById('recipe-category').value,
                ingredients
            };
            
            if (recipeId) {
                recipeData.id = parseInt(recipeId);
                await DB.update('recipes', recipeData);
                showNotification("Receita atualizada com sucesso!");
            } else {
                await DB.add('recipes', recipeData);
                showNotification("Receita salva com sucesso!");
            }
            hideModal(recipeModal);
            await refreshLocalData();
        } catch(error) { console.error("Erro ao salvar receita: ", error); showNotification(error.message || "Erro ao salvar receita.", true); }
    });

    // --- PRODUCTION ORDERS LOGIC ---
    function renderProductionOrders() {
        productionOrdersList.innerHTML = '';
        const filterDate = searchPoByDate.value;
        
        let filteredOrders = localProductionOrders;
        if (filterDate) {
            filteredOrders = localProductionOrders.filter(po => po.date === filterDate);
        }

        if (filteredOrders.length === 0) {
            productionOrdersList.innerHTML = `<div class="bg-white p-6 rounded-lg shadow text-center text-gray-500 col-span-full">Nenhuma ordem de produção encontrada para a data selecionada.</div>`;
            return;
        }

        [...filteredOrders].sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(po => {
             try {
                const card = document.createElement('div');
                card.className = 'relative bg-white rounded-xl shadow-md overflow-hidden transform hover:scale-[1.02] transition-transform duration-300';
                
                const statusClass = po.status === 'pendente' ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800';
                const statusBorderClass = po.status === 'pendente' ? 'border-yellow-400' : 'border-green-400';

                const ingredientsHtml = po.ingredients.map(ing => {
                    const product = localInventory.find(p => p.id === ing.productId);
                    // Updated to show consumption plan
                    const consumptionPlanHtml = ing.consumptionPlan.map(p => `${p.batchCode} (${p.quantity.toFixed(2)})`).join(', ');
                    return `
                    <li class="flex justify-between items-center text-sm py-1">
                        <span class="text-gray-600 flex-1"><i class="fa-solid fa-box-open mr-2 text-gray-400"></i>${product ? product.name : '...'}</span>
                        <span class="font-medium text-gray-800 ml-2 text-right">${ing.adjustedQuantity.toFixed(2)}</span>
                    </li>
                    <li class="text-xs text-gray-500 pl-6 pb-1">↳ Lotes: ${consumptionPlanHtml}</li>
                    `;
                }).join('');

                card.innerHTML = `
                    <div class="p-4 border-l-4 ${statusBorderClass}">
                         <div class="absolute top-3 left-3">
                            <input type="checkbox" class="po-select-checkbox h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" data-po-id="${po.id}" ${po.status !== 'pendente' ? 'disabled' : ''}>
                        </div>
                        <div class="flex justify-between items-start ml-8">
                            <div>
                                <h3 class="text-lg font-bold text-gray-800 pr-16">${po.recipeName} (${po.quantityProduced}x)</h3>
                                <p class="text-sm text-gray-500 mt-1">
                                    <i class="fa-solid fa-calendar-alt mr-1"></i>
                                    ${new Date(po.date + 'T00:00:00').toLocaleDateString('pt-BR')}
                                </p>
                            </div>
                            <div class="absolute top-3 right-3 text-right">
                                 <span class="block text-xs font-semibold px-3 py-1 rounded-full ${statusClass}">${po.status}</span>
                                 <div class="mt-2 flex space-x-2 justify-end">
                                    <button class="edit-po-btn text-blue-500 hover:text-blue-700 p-1" data-po-id="${po.id}" title="Editar Ordem"><i class="fa-solid fa-pencil"></i></button>
                                    <button class="delete-po-btn text-red-500 hover:text-red-700 p-1" data-po-id="${po.id}" title="Excluir Ordem"><i class="fa-solid fa-trash"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="p-4 bg-gray-50 border-t border-gray-200">
                        <p class="text-xs font-semibold text-gray-500 mb-2 uppercase tracking-wider">Insumos</p>
                        <ul class="space-y-1">${ingredientsHtml}</ul>
                    </div>
                `;
                productionOrdersList.appendChild(card);
            } catch (e) {
                console.error('Erro ao renderizar ordem de produção:', po, e);
            }
        });
    }

    productionOrdersList.addEventListener('click', (e) => {
        const editBtn = e.target.closest('.edit-po-btn');
        if (editBtn) {
            handleEditProductionOrder(parseInt(editBtn.dataset.poId));
        }
        const deleteBtn = e.target.closest('.delete-po-btn');
        if (deleteBtn) {
            handleDeleteProductionOrder(parseInt(deleteBtn.dataset.poId));
        }
    });

    function handleEditProductionOrder(poId) {
        const po = localProductionOrders.find(p => p.id === poId);
        if (!po) return;

        document.getElementById('edit-po-id').value = po.id;
        
        createSearchableSelect(poRecipeSearchableContainer, localRecipes, 'Buscar receita...', (recipe) => {
            if (recipe) {
                updatePOIngredients();
            }
        });
        const recipeSearchInput = poRecipeSearchableContainer.querySelector('input');
        recipeSearchInput.value = po.recipeName;
        recipeSearchInput.dataset.selectedId = po.recipeId;

        poQuantity.value = po.quantityProduced;
        poDate.value = po.date;
        
        updatePOIngredients(po.ingredients);

        productionOrderModalTitle.textContent = "Editar Ordem de Produção";
        productionOrderForm.querySelector('button[type="submit"]').textContent = "Salvar Alterações";
        
        showModal(productionOrderModal);
    }

    function handleDeleteProductionOrder(poId) {
        const po = localProductionOrders.find(p => p.id === poId);
        if (!po) return;

        showConfirmationModal(
            "Excluir Ordem de Produção",
            `Tem certeza que deseja excluir a ordem para "<strong>${po.recipeName}</strong>" do dia ${new Date(po.date + 'T00:00:00').toLocaleDateString('pt-BR')}?`,
            async () => {
                try {
                    await DB.remove('productionOrders', poId);
                    showNotification("Ordem de produção excluída com sucesso.");
                    await refreshLocalData();
                } catch (err) {
                    showNotification("Erro ao excluir a ordem de produção.", true);
                }
            }
        );
    }

    btnNewProductionOrder.addEventListener('click', () => {
        if (localRecipes.length === 0) {
            showNotification("Crie uma receita antes de gerar uma ordem.", true);
            return;
        }
        if(localInventory.length === 0) {
            showNotification("Adicione itens ao estoque antes de gerar uma ordem.", true);
            return;
        }
        productionOrderForm.reset();
        document.getElementById('edit-po-id').value = '';

        createSearchableSelect(poRecipeSearchableContainer, localRecipes, 'Buscar receita...', (recipe) => {
            if (recipe) {
                updatePOIngredients();
            }
        });
        const recipeSearchInput = poRecipeSearchableContainer.querySelector('input');
        recipeSearchInput.value = '';
        recipeSearchInput.dataset.selectedId = '';

        poQuantity.value = 1;
        poDate.value = new Date().toISOString().split('T')[0];
        updatePOIngredients();
        productionOrderModalTitle.textContent = "Nova Ordem de Produção";
        productionOrderForm.querySelector('button[type="submit"]').textContent = "Criar Ordem de Produção";
        showModal(productionOrderModal);
    });
    
    function calculateConsumptionPlan(productId, quantityNeeded, poToExcludeId = null) {
        // 1. Calculate reserved stock from OTHER pending orders for THIS specific product
        const otherPendingPOs = localProductionOrders.filter(p => p.status === 'pendente' && p.id !== poToExcludeId);
        const reservedByBatch = {}; // { batchId: reservedQty }
        otherPendingPOs.forEach(po => {
            if (!po.ingredients) return;
            // Find the specific ingredient in the other order that matches the current productId
            const relevantIngredient = po.ingredients.find(ing => ing.productId === productId);
            if (relevantIngredient && relevantIngredient.consumptionPlan) {
                relevantIngredient.consumptionPlan.forEach(planItem => {
                    reservedByBatch[planItem.batchId] = (reservedByBatch[planItem.batchId] || 0) + planItem.quantity;
                });
            }
        });

        // 2. Determine the plan for the current ingredient
        const plan = [];
        let remainingNeeded = quantityNeeded;
        const availableBatches = localBatches
            .filter(b => b.productId === productId && b.quantity > 0)
            .sort((a, b) => new Date(a.expiryDate) - new Date(b.expiryDate));

        for (const batch of availableBatches) {
            if (remainingNeeded <= 0) break;
            const alreadyReserved = reservedByBatch[batch.id] || 0;
            const effectiveQty = batch.quantity - alreadyReserved;

            if (effectiveQty <= 0) continue;

            const takeFromThisBatch = Math.min(remainingNeeded, effectiveQty);
            plan.push({
                batchId: batch.id,
                batchCode: batch.code,
                quantity: takeFromThisBatch
            });
            remainingNeeded -= takeFromThisBatch;
        }

        return {
            plan,
            isSufficient: remainingNeeded <= 0.0001 // Allow for tiny floating point inaccuracies
        };
    }

    function updatePOIngredients(existingIngredients = null) {
        const recipeId = parseInt(poRecipeSearchableContainer.querySelector('input').dataset.selectedId);
        const recipe = localRecipes.find(r => r.id === recipeId);
        const recipeQuantity = parseInt(poQuantity.value, 10) || 1;
        const currentPoId = parseInt(document.getElementById('edit-po-id').value) || null;

        if (!recipe) {
            poIngredientsBody.innerHTML = '';
            return;
        }

        poIngredientsBody.innerHTML = recipe.ingredients.map((ing, index) => {
            const product = localInventory.find(p => p.id === ing.productId);
            if (!product) return '';

            const residual = localResidualStock.find(r => r.productId === product.id)?.quantity || 0;
            const neededQty = ing.quantity * recipeQuantity;
            const compensatedQty = Math.max(0, neededQty - residual);
            
            // Calculate consumption plan considering reservations
            const { plan, isSufficient } = calculateConsumptionPlan(product.id, compensatedQty, currentPoId);
            const planText = plan.length > 0 ? plan.map(p => `${p.batchCode} (${p.quantity.toFixed(2)})`).join(', ') : 'Sem estoque disponível';
            
            const existingIng = existingIngredients ? existingIngredients.find(ei => ei.productId === ing.productId) : null;
            
            return `
            <tr data-product-id="${product.id}" 
                data-original-qty="${ing.quantity}" 
                data-consumption-plan='${JSON.stringify(plan)}'
                class="${!isSufficient ? 'insufficient-stock-row' : ''}">
                <td class="px-2 py-2">${product.name}</td>
                <td class="px-2 py-2 text-sm ${residual >= 0 ? 'text-green-600' : 'text-red-600'}">${residual.toFixed(2)}</td>
                <td class="px-2 py-2 font-medium">${neededQty.toFixed(4)}</td>
                <td class="px-2 py-2"><input type="number" value="${(existingIng ? existingIng.adjustedQuantity : neededQty).toFixed(4)}" min="0" step="0.0001" class="w-24 form-input"></td>
                <td class="px-2 py-2 text-xs">${planText}</td>
                <td class="px-2 py-2"><input type="text" value="${existingIng ? existingIng.handler : ''}" placeholder="Nome" class="w-32 form-input"></td>
            </tr>`;
        }).join('');
    }
    
    poQuantity.addEventListener('input', () => updatePOIngredients());
    
    closeProductionOrderModalBtn.addEventListener('click', () => { hideModal(productionOrderModal) });
    
    productionOrderForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const poId = document.getElementById('edit-po-id').value;
        if (poIngredientsBody.querySelectorAll('.insufficient-stock-row').length > 0) {
            showNotification("Estoque insuficiente (considerando reservas) para um ou mais itens.", true);
            return;
        }
        
        const recipeId = parseInt(poRecipeSearchableContainer.querySelector('input').dataset.selectedId);
        if (!recipeId) {
            showNotification("Por favor, selecione uma receita válida.", true);
            return;
        }
        const recipe = localRecipes.find(r => r.id === recipeId);
        
        const ingredients = Array.from(poIngredientsBody.querySelectorAll('tr')).map(row => {
            return {
                productId: parseInt(row.dataset.productId),
                adjustedQuantity: parseFloat(row.querySelector('input[type="number"]').value),
                handler: row.querySelector('input[type="text"]').value || 'N/A',
                consumptionPlan: JSON.parse(row.dataset.consumptionPlan) // Save the calculated plan
            }
        });

        if (ingredients.some(ing => !ing.consumptionPlan || ing.consumptionPlan.length === 0)) {
            const hasStock = ingredients.every(ing => {
                const product = localInventory.find(p => p.id === ing.productId);
                return product.totalQuantity > 0;
            });
            if (hasStock) {
                 showNotification("Um ou mais itens não têm um plano de consumo. Verifique o estoque.", true);
                 return;
            }
        }
        const poData = {
            recipeId: recipe.id, recipeName: recipe.name, date: poDate.value,
            quantityProduced: parseInt(poQuantity.value, 10), status: 'pendente', ingredients
        };
        try {
            if (poId) {
                poData.id = parseInt(poId);
                const originalPo = localProductionOrders.find(p => p.id === poData.id);
                poData.status = originalPo.status; // Keep original status when editing
                await DB.update('productionOrders', poData);
                showNotification("Ordem de Produção atualizada!");
            } else {
                await DB.add('productionOrders', poData);
                showNotification("Ordem de Produção criada com sucesso!");
            }
            hideModal(productionOrderModal);
            await refreshLocalData();
        } catch(error) { console.error("Erro ao salvar Ordem de Produção:", error); showNotification("Erro ao salvar Ordem.", true); }
    });

    searchPoByDate.addEventListener('input', renderProductionOrders);
    
    btnConfirmProduction.addEventListener('click', () => {
        const selectedCheckboxes = document.querySelectorAll('.po-select-checkbox:checked');
        if (selectedCheckboxes.length === 0) {
            showNotification("Selecione pelo menos uma ordem de produção para confirmar.", true);
            return;
        }
        
        const selectedOrderIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.dataset.poId));
        const selectedOrders = localProductionOrders.filter(po => selectedOrderIds.includes(po.id));

        populateConfirmationModal(selectedOrders);
        showModal(confirmProductionModal);
    });

    function populateConfirmationModal(orders) {
        const aggregatedItems = {};
        
        orders.forEach(po => {
            if (!po.ingredients) return;
            po.ingredients.forEach(ing => {
                const product = localInventory.find(p => p.id === ing.productId);
                if (!product) return;

                if (!aggregatedItems[ing.productId]) {
                    aggregatedItems[ing.productId] = {
                        productId: ing.productId,
                        name: product.name,
                        totalAdjusted: 0,
                        plan: {} // { batchCode: totalQty }
                    };
                }
                
                aggregatedItems[ing.productId].totalAdjusted += ing.adjustedQuantity;
                
                if (ing.consumptionPlan) {
                    ing.consumptionPlan.forEach(p => {
                        aggregatedItems[ing.productId].plan[p.batchCode] = (aggregatedItems[ing.productId].plan[p.batchCode] || 0) + p.quantity;
                    });
                }
            });
        });
        
        confirmProductionTbody.innerHTML = Object.values(aggregatedItems).map(item => {
            const planDetails = Object.keys(item.plan).map(batchCode => `${batchCode} (${item.plan[batchCode].toFixed(2)})`).join(', ');
            return `<tr>
                <td class="px-4 py-2 font-medium">${item.name}</td>
                <td class="px-4 py-2 text-right">${item.totalAdjusted.toFixed(4)}</td>
                <td class="px-4 py-2 text-xs">${planDetails}</td>
            </tr>`;
        }).join('');

        confirmProductionTbody.dataset.orders = JSON.stringify(orders.map(po => po.id));
    }

    closeConfirmProductionModalBtn.addEventListener('click', () => { hideModal(confirmProductionModal) });

    btnExecuteStockConsumption.addEventListener('click', async () => {
        const orderIdsToConfirm = JSON.parse(confirmProductionTbody.dataset.orders || '[]');
        if (orderIdsToConfirm.length === 0) { 
            showNotification("Nenhuma ordem para confirmar.", true); 
            return; 
        }
        
        try {
            loadingOverlay.classList.remove('hidden');
            
            const ordersToConfirm = localProductionOrders.filter(po => orderIdsToConfirm.includes(po.id));

            for (const order of ordersToConfirm) {
                if (!order.ingredients) continue;
                
                let totalRecipeRequirement = {}; // To calculate residual
                
                for (const ingredient of order.ingredients) {
                    if (!ingredient.consumptionPlan || ingredient.consumptionPlan.length === 0) {
                        const product = localInventory.find(p => p.id === ingredient.productId) || {};
                        throw new Error(`Ordem para '${order.recipeName}' tem um plano de consumo inválido para o item '${product.name}'. Por favor, edite e salve a ordem novamente.`);
                    }
                    
                    // Calculate original requirement for residual calculation later
                    const recipe = localRecipes.find(r => r.id === order.recipeId);
                    const recipeIng = recipe.ingredients.find(ri => ri.productId === ingredient.productId);
                    const originalNeeded = recipeIng.quantity * order.quantityProduced;
                    totalRecipeRequirement[ingredient.productId] = (totalRecipeRequirement[ingredient.productId] || 0) + originalNeeded;

                    // Execute consumption based on the saved plan
                    for (const planItem of ingredient.consumptionPlan) {
                        const batch = await DB.get('batches', planItem.batchId);
                        if (!batch || batch.quantity < planItem.quantity) {
                            throw new Error(`Estoque insuficiente no lote ${batch.code} para confirmar a produção. Necessário: ${planItem.quantity.toFixed(2)}, disponível: ${batch ? batch.quantity.toFixed(2) : 0}.`);
                        }
                        
                        batch.quantity -= planItem.quantity;
                        await DB.update('batches', batch);

                        const product = await DB.get('inventory', ingredient.productId);
                        product.totalQuantity -= planItem.quantity;
                        await DB.update('inventory', product);
                        
                        await DB.add('history', { 
                            productId: ingredient.productId, 
                            batchCode: batch.code, 
                            type: 'saída', 
                            quantity: planItem.quantity, 
                            date: new Date().toISOString().split('T')[0],
                            reason: `Produção: ${order.recipeName}`
                        });
                    }
                    await updateMonthlyConsumption(ingredient.productId, ingredient.adjustedQuantity, order.date);
                }
                
                // Update residual stock for this order
                for(const ingredient of order.ingredients) {
                    const originalNeeded = totalRecipeRequirement[ingredient.productId] || 0;
                    const actualUsed = ingredient.adjustedQuantity;
                    const difference = originalNeeded - actualUsed; // Positive if sobra, negative if falta
                    await updateResidualStock(ingredient.productId, difference);
                }

                // Mark order as completed
                order.status = 'concluído';
                await DB.update('productionOrders', order);
            }

            showNotification("Baixa de estoque realizada com sucesso!");
            hideModal(confirmProductionModal);
            await refreshLocalData();

        } catch (error) {
            console.error("Erro ao dar baixa no estoque: ", error);
            showNotification(error.message || "Erro ao dar baixa no estoque.", true);
            await refreshLocalData(); 
        } finally {
            loadingOverlay.classList.add('hidden');
        }
    });

    // --- BACKUP / RESTORE FUNCTIONS ---
    async function downloadBackup() {
        try {
            loadingOverlay.classList.remove('hidden');
            const backupData = {
                inventory: await DB.getAll('inventory'),
                batches: await DB.getAll('batches'),
                history: await DB.getAll('history'),
                recipes: await DB.getAll('recipes'),
                productionOrders: await DB.getAll('productionOrders'),
                monthlyConsumption: await DB.getAll('monthlyConsumption'),
                residualStock: await DB.getAll('residualStock'),
            };

            const jsonString = JSON.stringify(backupData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            const date = new Date().toISOString().split('T')[0];
            a.download = `backup_estoque_${date}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification("Backup baixado com sucesso!");

        } catch (error) {
            console.error("Erro ao criar backup:", error);
            showNotification("Falha ao criar o backup.", true);
        } finally {
            loadingOverlay.classList.add('hidden');
        }
    }
    btnDownloadBackup.addEventListener('click', downloadBackup);

    btnUploadBackup.addEventListener('click', () => {
        backupFileInput.click();
    });

    backupFileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                backupFileContent = JSON.parse(e.target.result);
                if (!backupFileContent.inventory || !backupFileContent.batches) {
                    throw new Error("Arquivo de backup inválido ou corrompido.");
                }
                showModal(confirmUploadModal);
            } catch (error) {
                console.error("Erro ao ler o arquivo de backup:", error);
                showNotification(error.message || "Falha ao ler o arquivo de backup.", true);
                backupFileContent = null;
            }
        };
        reader.onerror = () => {
             showNotification("Erro ao ler o arquivo.", true);
             backupFileContent = null;
        };
        reader.readAsText(file);
        
        backupFileInput.value = '';
    });

    cancelUploadBtn.addEventListener('click', () => {
        backupFileContent = null;
        hideModal(confirmUploadModal);
    });

    confirmUploadBtn.addEventListener('click', () => {
        hideModal(confirmUploadModal);
        if (backupFileContent) {
            importData(backupFileContent);
        }
    });
    
    async function importData(data) {
        try {
            loadingOverlay.classList.remove('hidden');
            const stores = ['inventory', 'batches', 'history', 'recipes', 'productionOrders', 'monthlyConsumption', 'residualStock'];
            
            for (const storeName of stores) {
                await DB.clear(storeName);
            }

            const idMaps = { inventory: {}, recipes: {} };

            if (data.inventory) {
                for (const item of data.inventory) {
                    const oldId = item.id;
                    delete item.id;
                    const newId = await DB.add('inventory', item);
                    idMaps.inventory[oldId] = newId;
                }
            }
            
             if (data.recipes) {
                for (const recipe of data.recipes) {
                    const oldId = recipe.id;
                    delete recipe.id;
                    if (recipe.ingredients) {
                        recipe.ingredients.forEach(ing => {
                            ing.productId = idMaps.inventory[ing.productId];
                        });
                    }
                    const newId = await DB.add('recipes', recipe);
                    idMaps.recipes[oldId] = newId;
                }
            }

            if (data.batches) {
                for (const batch of data.batches) {
                    delete batch.id;
                    batch.productId = idMaps.inventory[batch.productId];
                    if (batch.productId) {
                        await DB.add('batches', batch);
                    }
                }
            }

            if (data.history) {
                 for (const record of data.history) {
                    delete record.id;
                    record.productId = idMaps.inventory[record.productId];
                    if (record.productId) {
                        await DB.add('history', record);
                    }
                }
            }

            if (data.productionOrders) {
                for (const po of data.productionOrders) {
                    delete po.id;
                    po.recipeId = idMaps.recipes[po.recipeId];
                    if (po.ingredients) {
                        po.ingredients.forEach(ing => {
                           ing.productId = idMaps.inventory[ing.productId];
                        });
                    }
                    if (po.recipeId) {
                        await DB.add('productionOrders', po);
                    }
                }
            }
            if(data.monthlyConsumption) {
                for(const record of data.monthlyConsumption) {
                    delete record.id;
                    record.productId = idMaps.inventory[record.productId];
                    if (record.productId) {
                        await DB.add('monthlyConsumption', record);
                    }
                }
            }
            if(data.residualStock) {
                for(const record of data.residualStock) {
                    record.productId = idMaps.inventory[record.productId];
                     if (record.productId) {
                        await DB.add('residualStock', record);
                    }
                }
            }

            await refreshLocalData();
            showNotification("Backup restaurado com sucesso!");

        } catch (error) {
            console.error("Erro ao importar dados:", error);
            showNotification("Falha ao restaurar o backup. Verifique o arquivo.", true);
            const stores = ['inventory', 'batches', 'history', 'recipes', 'productionOrders', 'monthlyConsumption', 'residualStock'];
            for (const storeName of stores) { await DB.clear(storeName); }
            await refreshLocalData();

        } finally {
            loadingOverlay.classList.add('hidden');
            backupFileContent = null;
        }
    }


    // --- EXPORT FUNCTIONS ---
    function exportInventoryToExcel() {
        const button = document.getElementById('btn-export-excel');
        const originalHtml = button.innerHTML;
        button.disabled = true;
        button.innerHTML = `<span class="animate-spin h-5 w-5 mr-3" role="status" aria-hidden="true"><i class="fa-solid fa-spinner"></i></span> Exportando...`;

        setTimeout(() => {
            try {
                const reservations = calculateAllReservations();
                const dataToExport = [];
                
                localInventory.forEach(item => {
                    const reservedQty = reservations[item.id] || 0;
                    const availableQty = item.totalQuantity - reservedQty;
                    const itemBatches = localBatches.filter(b => b.productId === item.id && b.quantity > 0);
                    
                    if (itemBatches.length > 0) {
                        itemBatches.forEach(batch => {
                            dataToExport.push({
                                'Nome do Produto': item.name, 'Código': item.code, 'Fornecedor': item.supplier,
                                'Estoque Mínimo': item.minStock, 'Estoque Máximo': item.maxStock,
                                'Quantidade Física': item.totalQuantity,
                                'Quantidade Reservada': reservedQty,
                                'Quantidade Disponível': availableQty,
                                'Lote': batch.code, 'Quantidade do Lote': batch.quantity,
                                'Data de Validade': batch.expiryDate ? new Date(batch.expiryDate + 'T00:00:00').toLocaleDateString('pt-BR') : 'N/A',
                                'Data de Fabricação': batch.mfgDate ? new Date(batch.mfgDate + 'T00:00:00').toLocaleDateString('pt-BR') : 'N/A',
                                'Data de Recebimento': batch.receiptDate ? new Date(batch.receiptDate + 'T00:00:00').toLocaleDateString('pt-BR') : 'N/A'
                            });
                        });
                    } else {
                        dataToExport.push({
                            'Nome do Produto': item.name, 'Código': item.code, 'Fornecedor': item.supplier,
                            'Estoque Mínimo': item.minStock, 'Estoque Máximo': item.maxStock,
                            'Quantidade Física': item.totalQuantity,
                            'Quantidade Reservada': reservedQty,
                            'Quantidade Disponível': availableQty,
                            'Lote': 'N/A', 'Quantidade do Lote': 0,
                            'Data de Validade': 'N/A', 'Data de Fabricação': 'N/A', 'Data de Recebimento': 'N/A'
                        });
                    }
                });

                if (dataToExport.length === 0) {
                    showNotification("Nenhum dado de estoque para exportar.", true);
                    return;
                }

                const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Estoque Detalhado");

                worksheet['!cols'] = [ { wch: 40 }, { wch: 15 }, { wch: 25 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 20 }, { wch: 20 }, { wch: 20 }, { wch: 20 }, { wch: 20 }, { wch: 20 }, { wch: 20 } ];

                XLSX.writeFile(workbook, `Relatorio_Estoque_Detalhado_${new Date().toISOString().split('T')[0]}.xlsx`);
                showNotification("Relatório de estoque exportado com sucesso!");

            } catch (error) {
                console.error("Erro ao exportar para Excel:", error);
                showNotification("Ocorreu um erro ao exportar o relatório.", true);
            } finally {
                button.disabled = false;
                button.innerHTML = originalHtml;
            }
        }, 50);
    }


    function exportChartDataToExcel(data, fileName) {
        const dataToExport = data.map(item => {
            const product = localInventory.find(p => p.id === item.productId);
            return {
                'Produto': product ? product.name : 'N/A',
                'Quantidade': item.total.toFixed(4)
            }
        });
        const worksheet = XLSX.utils.json_to_sheet(dataToExport);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Dados");
        XLSX.writeFile(workbook, fileName);
        showNotification("Dados exportados!");
    }

    btnExportExpiring45.addEventListener('click', () => {
         const today = new Date();
         const fortyFiveDaysFromNow = new Date();
         fortyFiveDaysFromNow.setDate(today.getDate() + 45);
         const expiring45Batches = localBatches.filter(b => b.quantity > 0 && b.expiryDate && new Date(b.expiryDate) <= fortyFiveDaysFromNow);
         const dataToExport = expiring45Batches.map(batch => {
            const product = localInventory.find(p => p.id === batch.productId);
            return {
                'Produto': product.name,
                'Lote': batch.code,
                'Quantidade': batch.quantity,
                'Data de Validade': new Date(batch.expiryDate + 'T00:00:00').toLocaleDateString('pt-BR')
            }
         });
         const worksheet = XLSX.utils.json_to_sheet(dataToExport);
         const workbook = XLSX.utils.book_new();
         XLSX.utils.book_append_sheet(workbook, worksheet, "Vencendo_em_45_dias");
         XLSX.writeFile(workbook, "relatorio_vencendo_45_dias.xlsx");
         showNotification("Relatório exportado!");
    });

    btnExportLossRisk.addEventListener('click', () => {
        const today = new Date();
        const lossRiskBatches = localBatches.filter(b => {
             const expiryDate = new Date(b.expiryDate);
             if (!b.expiryDate || expiryDate <= today || b.quantity <= 0) return false;
             
             const metrics = calculateConsumptionMetrics(b.productId);
             const consumptionRate = metrics.avgConsumption;
             if (consumptionRate <= 0) return false;

             const daysToExpire = (expiryDate.getTime() - today.getTime()) / (1000 * 3600 * 24);
             const estimatedConsumption = daysToExpire * consumptionRate;
             
             return b.quantity > estimatedConsumption;
        });
         const dataToExport = lossRiskBatches.map(batch => {
            const product = localInventory.find(p => p.id === batch.productId);
            return {
                'Produto': product.name,
                'Lote': batch.code,
                'Quantidade': batch.quantity,
                'Data de Validade': new Date(batch.expiryDate + 'T00:00:00').toLocaleDateString('pt-BR')
            }
         });
         const worksheet = XLSX.utils.json_to_sheet(dataToExport);
         const workbook = XLSX.utils.book_new();
         XLSX.utils.book_append_sheet(workbook, worksheet, "Risco_de_Perda");
         XLSX.writeFile(workbook, "relatorio_risco_de_perda.xlsx");
         showNotification("Relatório exportado!");
    });
    
    btnExportWord.addEventListener('click', exportProductionOrdersToWord);

    async function exportProductionOrdersToWord() {
        const filterDate = searchPoByDate.value;
        if (!filterDate) {
            showNotification("Por favor, selecione uma data para exportar.", true);
            return;
        }

        let filteredOrders = localProductionOrders.filter(po => po.date === filterDate);

        if (filteredOrders.length === 0) {
            showNotification("Nenhuma ordem de produção para exportar na data selecionada.", true);
            return;
        }

        // Group orders by production line (recipe category)
        const groupedByLine = {};
        for (const order of filteredOrders) {
            const recipe = localRecipes.find(r => r.id === order.recipeId);
            if (recipe) {
                const category = recipe.category || 'Sem Categoria';
                if (!groupedByLine[category]) {
                    groupedByLine[category] = [];
                }
                groupedByLine[category].push(order);
            }
        }

        let htmlContent = `
            <!DOCTYPE html>
            <html>
            <head>
            <meta charset='UTF-8'>
            <style>
                body { font-family: Arial, sans-serif; font-size: 11pt; margin: 40px; }
                h1 { font-size: 18pt; color: #333; text-align: center; }
                h2 { font-size: 16pt; color: #444; border-bottom: 2px solid #ccc; padding-bottom: 5px; margin-top: 30px;}
                h3 { font-size: 14pt; color: #555; }
                table { border-collapse: collapse; width: 100%; margin-top: 10px; font-size: 10pt; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                th { background-color: #f2f2f2; font-weight: bold; }
                .order-container { margin-bottom: 25px; page-break-inside: avoid; }
            </style>
            </head>
            <body>
        `;

        const formattedDate = new Date(filterDate + 'T00:00:00').toLocaleDateString('pt-BR');
        htmlContent += `<h1>Ordens de Produção - ${formattedDate}</h1>`;

        const productionLines = Object.keys(groupedByLine).sort();

        for (const line of productionLines) {
            htmlContent += `<h2>Linha de Produção: ${line}</h2>`;
            const ordersInLine = groupedByLine[line];

            for (const order of ordersInLine) {
                htmlContent += `<div class="order-container">`;
                htmlContent += `<h3>Receita: ${order.recipeName} (Quantidade: ${order.quantityProduced})</h3>`;
                
                htmlContent += `
                    <table>
                        <thead>
                            <tr>
                                <th>Insumo</th>
                                <th>Lote de Consumo</th>
                                <th>Quantidade a Usar</th>
                                <th>Manipulador</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                for (const ing of order.ingredients) {
                    const product = localInventory.find(p => p.id === ing.productId);
                    const consumptionPlanHtml = ing.consumptionPlan.map(p => `${p.batchCode} (${p.quantity.toFixed(2)})`).join(', ');
                    htmlContent += `
                        <tr>
                            <td>${product ? product.name : 'Insumo não encontrado'}</td>
                            <td>${consumptionPlanHtml}</td>
                            <td>${ing.adjustedQuantity.toFixed(4)}</td>
                            <td>${ing.handler}</td>
                        </tr>
                    `;
                }

                htmlContent += `</tbody></table></div>`;
            }
        }

        htmlContent += `</body></html>`;

        try {
            // Note: FileSaver.js must be loaded for 'saveAs' to be defined.
            const blob = new Blob([htmlContent], { type: "application/msword;charset=utf-8" });
            saveAs(blob, `Ordens_de_Producao_${filterDate}.doc`);
            showNotification("Arquivo Word gerado com sucesso!");
        } catch (error) {
            console.error("Erro ao gerar arquivo Word:", error);
            showNotification("Erro ao gerar arquivo Word. Verifique se a biblioteca FileSaver.js está carregada.", true);
        }
    }

    // --- LOW STOCK ALERT LOGIC ---
    function updateLowStockAlerts() {
        const lowStockItems = localInventory.filter(i => {
            const metrics = calculateConsumptionMetrics(i.id);
            const minStock = i.minStock !== null && i.minStock !== undefined ? i.minStock : metrics.minStock;
            // Only alert if a minimum stock is defined (greater than 0)
            return minStock > 0 && i.totalQuantity < minStock;
        });

        if (lowStockItems.length === 0) {
            lowStockIndicator.classList.add('hidden');
            previouslyNotifiedLowStockIds.clear();
            return;
        }

        // Always show the indicator if there are low stock items
        lowStockCount.textContent = lowStockItems.length;
        lowStockIndicator.classList.remove('hidden');

        // Populate the modal list
        lowStockAlertList.innerHTML = `
            <table class="w-full text-sm">
                <thead class="bg-gray-50 sticky top-0">
                    <tr>
                        <th class="px-4 py-2 text-left">Produto</th>
                        <th class="px-4 py-2 text-right">Atual</th>
                        <th class="px-4 py-2 text-right">Mínimo</th>
                    </tr>
                </thead>
                <tbody>
                    ${lowStockItems.map(item => {
                        const metrics = calculateConsumptionMetrics(item.id);
                        const minStock = item.minStock !== null && item.minStock !== undefined ? item.minStock : metrics.minStock;
                        return `
                        <tr class="border-b">
                            <td class="px-4 py-2">${item.name}</td>
                            <td class="px-4 py-2 text-right font-bold text-red-600">${item.totalQuantity.toFixed(2)}</td>
                            <td class="px-4 py-2 text-right">${minStock.toFixed(2)}</td>
                        </tr>
                        `
                    }).join('')}
                </tbody>
            </table>
        `;

        const currentLowStockIds = new Set(lowStockItems.map(item => item.id));
        const hasNewItems = [...currentLowStockIds].some(id => !previouslyNotifiedLowStockIds.has(id));
        
        if (hasNewItems) {
            // Flash the screen on the very first new notification of the session
            if (!hasFlashedScreen) {
                document.body.classList.add('flash-red');
                hasFlashedScreen = true; // Prevents re-flashing
                setTimeout(() => document.body.classList.remove('flash-red'), 800);
            }

            // Always shake the bell and show the modal for new items
            lowStockIndicator.classList.add('shake-alert');
            showModal(lowStockAlertModal);
            
            // Update the set of notified items
            previouslyNotifiedLowStockIds = currentLowStockIds;
        }
    }


    // --- INICIALIZAÇÃO E SINCRONIZAÇÃO COM DADOS LOCAIS ---
    async function refreshLocalData() {
        try {
            localInventory = await DB.getAll('inventory');
            localBatches = await DB.getAll('batches');
            localHistory = await DB.getAll('history');
            localRecipes = await DB.getAll('recipes');
            localProductionOrders = await DB.getAll('productionOrders');
            localMonthlyConsumption = await DB.getAll('monthlyConsumption');
            localResidualStock = await DB.getAll('residualStock');
            
            renderInventoryTable();
            renderRecipes();
            renderProductionOrders();
            renderDashboard();
            renderConsumptionReport();
            renderResidualStock();
            populateSupplierFilter();
            
            // Check for low stock after all data is refreshed
            updateLowStockAlerts();
        } catch (error) {
            console.error("Erro ao carregar dados locais:", error);
            showNotification("Falha ao carregar dados do banco de dados local.", true);
        }
    }
    
    // --- DASHBOARD ---
    function renderDashboard() {
        const today = new Date();
        const todayStr = today.toISOString().split('T')[0];
        const tomorrow = new Date();
        tomorrow.setDate(today.getDate() + 1);
        const tomorrowStr = tomorrow.toISOString().split('T')[0];


        // --- STAT CARDS ---
        const lowStockItems = localInventory.filter(i => {
            const metrics = calculateConsumptionMetrics(i.id);
            const minStock = i.minStock !== null && i.minStock !== undefined ? i.minStock : metrics.minStock;
            return i.totalQuantity < minStock && minStock > 0;
        });
        const thirtyDaysFromNow = new Date();
        thirtyDaysFromNow.setDate(today.getDate() + 30);
        const expiringBatches = localBatches.filter(b => b.quantity > 0 && b.expiryDate && new Date(b.expiryDate) <= thirtyDaysFromNow);
        
        document.getElementById('stat-total-items').textContent = localInventory.length;
        document.getElementById('stat-total-quantity').textContent = localInventory.reduce((sum, item) => sum + item.totalQuantity, 0).toFixed(2);
        document.getElementById('stat-low-stock').textContent = lowStockItems.length;
        document.getElementById('stat-expiring-soon').textContent = expiringBatches.length;

        // --- GRÁFICOS ---
        const dailyOutputs = localHistory.filter(h => h.date === todayStr && (h.type === 'saída' || h.type === 'requisição'));
        dailyOutputChart = renderDashboardChart('daily-output-chart', dailyOutputChart, 'Top 10 Saídas de Hoje', dailyOutputs, false, 'btn-export-daily-output');
        
        const scheduledOutputs = localProductionOrders.filter(po => (po.date === todayStr || po.date === tomorrowStr) && po.status === 'pendente');
        scheduledOutputChart = renderDashboardChart('scheduled-output-chart', scheduledOutputChart, 'Top 10 Saídas Programadas (48h)', scheduledOutputs, true, 'btn-export-scheduled-output');

        // --- ÚLTIMAS ENTRADAS ---
        const lastEntriesList = document.getElementById('last-entries-list');
        if (lastEntriesList) {
            const lastEntries = [...localHistory].filter(h => h.type === 'entrada').sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0,5);
            lastEntriesList.innerHTML = '';
            if (lastEntries.length > 0) {
                lastEntries.forEach(entry => {
                    const product = localInventory.find(p => p.id === entry.productId);
                    const li = document.createElement('li');
                    li.className = 'py-3 flex justify-between items-center text-sm';
                    li.innerHTML = `
                        <div>
                            <p class="font-medium text-gray-800">${product ? product.name : 'Produto desconhecido'}</p>
                            <p class="text-gray-500">Lote: ${entry.batchCode}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-semibold text-green-600">+${entry.quantity.toFixed(2)}</p>
                            <p class="text-gray-400">${new Date(entry.date + 'T00:00:00').toLocaleDateString('pt-BR')}</p>
                        </div>
                    `;
                    lastEntriesList.appendChild(li);
                });
            } else {
                 lastEntriesList.innerHTML = `<p class="text-center text-gray-500 py-4">Nenhuma entrada registrada.</p>`;
            }
        }
        
        
        // --- ALERTAS ---
        const lossRiskBatches = localBatches.filter(b => {
             const expiryDate = new Date(b.expiryDate);
             if (!b.expiryDate || expiryDate <= today || b.quantity <= 0) return false;
             
             const metrics = calculateConsumptionMetrics(b.productId);
             const consumptionRate = metrics.avgConsumption;
             if (consumptionRate <= 0) return false;

             const daysToExpire = (expiryDate.getTime() - today.getTime()) / (1000 * 3600 * 24);
             const estimatedConsumption = daysToExpire * consumptionRate;
             
             return b.quantity > estimatedConsumption;
        });

        const sixtyDaysAgo = new Date();
        sixtyDaysAgo.setDate(today.getDate() - 60);
        const recentOuts = [...localHistory].filter(h => h.type === 'saída' && new Date(h.date) > sixtyDaysAgo);
        const recentOutProductIds = new Set(recentOuts.map(h => h.productId));
        const stagnantItems = localInventory.filter(i => i.totalQuantity > 0 && !recentOutProductIds.has(i.id));
        
        const fortyFiveDaysFromNow = new Date();
        fortyFiveDaysFromNow.setDate(today.getDate() + 45);
        const expiring45Batches = localBatches.filter(b => b.quantity > 0 && b.expiryDate && new Date(b.expiryDate) <= fortyFiveDaysFromNow);

        renderAlertTable('expiring-45-container', expiring45Batches, (batch) => {
            const product = localInventory.find(p => p.id === batch.productId);
            return `<tr>
                        <td class="py-1 pr-2 text-xs">${product.name} (${batch.code})</td>
                        <td class="py-1 px-2 text-xs text-right">${batch.quantity.toFixed(2)}</td>
                        <td class="py-1 pl-2 text-xs text-right">${new Date(batch.expiryDate + 'T00:00:00').toLocaleDateString('pt-BR')}</td>
                    </tr>`;
        }, ['Produto (Lote)', 'Qtd', 'Validade']);
        
        renderAlertTable('loss-risk-container', lossRiskBatches, (batch) => {
            const product = localInventory.find(p => p.id === batch.productId);
            return `<tr>
                        <td class="py-1 pr-2 text-xs">${product.name} (${batch.code})</td>
                        <td class="py-1 pl-2 text-xs text-right">${new Date(batch.expiryDate + 'T00:00:00').toLocaleDateString('pt-BR')}</td>
                    </tr>`;
        }, ['Produto (Lote)', 'Validade']);

        calculateAndRenderAbcCurve();
    }

    function renderAlertTable(containerId, items, formatter, headers) {
        const container = document.getElementById(containerId);
        if (!container) return;
        if (items.length > 0) {
            container.innerHTML = `
                <table class="w-full text-left">
                    <thead class="text-xs text-gray-500"><tr>${headers.map(h => `<th class="pb-2 font-semibold ${h !== 'Produto (Lote)' ? 'text-right' : ''}">${h}</th>`).join('')}</tr></thead>
                    <tbody class="divide-y divide-gray-200">${items.map(formatter).join('')}</tbody>
                </table>`;
        } else {
            container.innerHTML = `<p class="text-center text-sm text-gray-400 py-4">Nenhum item para exibir.</p>`;
        }
    }


    function renderDashboardChart(canvasId, chartInstance, title, data, isScheduled = false, exportBtnId) {
        const ctx = document.getElementById(canvasId);
        if (!ctx) return null;
        
        if (Chart.getChart(ctx)) {
            Chart.getChart(ctx).destroy();
        }
        
        const consumption = {};
        if (isScheduled) {
             data.forEach(po => {
                if(!po.ingredients) return;
                po.ingredients.forEach(ing => {
                    consumption[ing.productId] = (consumption[ing.productId] || 0) + ing.adjustedQuantity;
                })
             });
        } else { // History
            data.forEach(h => {
                consumption[h.productId] = (consumption[h.productId] || 0) + h.quantity;
            });
        }
        
        const sortedData = Object.keys(consumption)
            .map(productId => ({ productId: parseInt(productId), total: consumption[productId] }))
            .sort((a,b) => b.total - a.total)
            .slice(0, 10);

        const newChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: sortedData.map(item => {
                    const product = localInventory.find(p => p.id === item.productId);
                    return product ? product.name.substring(0, 15) : 'N/A';
                }),
                datasets: [{
                    label: 'Quantidade',
                    data: sortedData.map(item => item.total),
                    backgroundColor: '#818cf8',
                }]
            },
             options: {
                indexAxis: 'y',
                responsive: true, maintainAspectRatio: false,
                scales: { x: { beginAtZero: true } },
                plugins: { legend: { display: false } }
            }
        });

        const exportBtn = document.getElementById(exportBtnId);
        if (exportBtn) {
            exportBtn.onclick = () => exportChartDataToExcel(sortedData, `${title.replace(/\s/g, '_')}.xlsx`);
        }

        return newChartInstance;
    }

    
    cardLowStock.addEventListener('click', () => {
        const lowStockItems = localInventory.filter(i => {
            const metrics = calculateConsumptionMetrics(i.id);
            const minStock = i.minStock !== null && i.minStock !== undefined ? i.minStock : metrics.minStock;
            return i.totalQuantity < minStock && minStock > 0;
        });
        document.getElementById('info-list-title').textContent = 'Itens com Estoque Baixo';
        let content = `<table class="w-full text-sm">
                        <thead><tr class="border-b"><th class="py-2 text-left">Produto</th><th class="py-2 text-right">Qtd. Atual</th><th class="py-2 text-right">Mínimo</th></tr></thead>
                        <tbody>`;
        content += lowStockItems.map(item => {
            const metrics = calculateConsumptionMetrics(item.id);
            const minStock = item.minStock !== null && item.minStock !== undefined ? item.minStock : metrics.minStock;
            return `<tr><td class="py-2">${item.name}</td><td class="py-2 text-right">${item.totalQuantity.toFixed(2)}</td><td class="py-2 text-right">${minStock.toFixed(2)}</td></tr>`
        }).join('');
        content += `</tbody></table>`;
        document.getElementById('info-list-content').innerHTML = content;
        showModal(infoListModal);
    });

    cardExpiringSoon.addEventListener('click', () => {
        const today = new Date();
        const thirtyDaysFromNow = new Date();
        thirtyDaysFromNow.setDate(today.getDate() + 30);
        const expiringBatches = localBatches.filter(b => b.quantity > 0 && b.expiryDate && new Date(b.expiryDate) <= thirtyDaysFromNow);

        document.getElementById('info-list-title').textContent = 'Lotes Vencendo nos Próximos 30 Dias';
        let content = `<table class="w-full text-sm">
                        <thead><tr class="border-b"><th class="py-2 text-left">Produto</th><th class="py-2 text-left">Lote</th><th class="py-2 text-right">Validade</th></tr></thead>
                        <tbody>`;
        content += expiringBatches.map(batch => {
            const product = localInventory.find(p => p.id === batch.productId);
            return `<tr><td class="py-2">${product.name}</td><td class="py-2">${batch.code}</td><td class="py-2 text-right">${new Date(batch.expiryDate + 'T00:00:00').toLocaleDateString('pt-BR')}</td></tr>`
        }).join('');
        content += `</tbody></table>`;
        document.getElementById('info-list-content').innerHTML = content;
        showModal(infoListModal);
    });

    closeInfoListModalBtn.addEventListener('click', () => hideModal(infoListModal));


    // --- AJUSTES E REQUISIÇÕES ---
    function initializeAdjustmentScreen() {
        createSearchableSelect(adjustmentSearchableContainer, localInventory, 'Buscar produto...', (product) => {
            const productId = product.id;
            const batches = localBatches.filter(b => b.productId === productId && b.quantity > 0);
            adjustmentBatchSelect.innerHTML = `<option value="">Selecione um lote...</option>` + batches.map(b => `<option value="${b.id}">${b.code} (Qtd: ${b.quantity.toFixed(2)})</option>`).join('');
        });
    }
    
    adjustmentForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const batchId = parseInt(adjustmentBatchSelect.value);
        const newQuantity = parseFloat(document.getElementById('adjustment-new-quantity').value);
        const reason = document.getElementById('adjustment-reason').value;
        const responsible = document.getElementById('adjustment-responsible').value;

        try {
            const batch = await DB.get('batches', batchId);
            const oldQuantity = batch.quantity;
            const difference = newQuantity - oldQuantity;

            batch.quantity = newQuantity;
            await DB.update('batches', batch);

            const product = await DB.get('inventory', batch.productId);
            product.totalQuantity += difference;
            await DB.update('inventory', product);
            
            await DB.add('history', {
                productId: product.id, batchCode: batch.code,
                type: 'ajuste', quantity: difference,
                date: new Date().toISOString().split('T')[0],
                reason, responsible
            });

            showNotification("Ajuste de estoque salvo com sucesso!");
            adjustmentForm.reset();
            initializeAdjustmentScreen();
            await refreshLocalData();

        } catch(error) {
            showNotification("Erro ao salvar ajuste.", true);
            console.error(error);
        }
    });

    function addRequisitionItemRow() {
        const row = document.createElement('div');
        row.className = 'requisition-item-row flex items-end space-x-2';
        row.innerHTML = `
            <div class="flex-1 searchable-container"></div>
            <div class="flex-1">
                <label class="block text-sm font-medium text-gray-700">Lote</label>
                <select class="requisition-batch w-full form-input"></select>
            </div>
            <div class="w-24">
                <label class="block text-sm font-medium text-gray-700">Qtd.</label>
                <input type="number" class="requisition-quantity w-full form-input" required min="0.0001" step="0.0001">
            </div>
            <button type="button" class="remove-requisition-item-btn text-red-500 hover:text-red-700 h-10">&times;</button>
        `;
        requisitionItemsContainer.appendChild(row);

        const searchableContainer = row.querySelector('.searchable-container');
        const batchSelect = row.querySelector('.requisition-batch');
        
        createSearchableSelect(searchableContainer, localInventory, 'Buscar produto...', (product) => {
            const productId = product.id;
            const batches = localBatches.filter(b => b.productId === productId && b.quantity > 0);
            batchSelect.innerHTML = batches.map(b => `<option value="${b.id}">${b.code} (Qtd: ${b.quantity.toFixed(2)})</option>`).join('');
        });
    }

    function initializeRequisitionScreen() {
        requisitionItemsContainer.innerHTML = '';
        addRequisitionItemRow();
    }
    
    addRequisitionItemBtn.addEventListener('click', addRequisitionItemRow);
    requisitionItemsContainer.addEventListener('click', (e) => {
        if (e.target.closest('.remove-requisition-item-btn')) {
            e.target.closest('.requisition-item-row').remove();
        }
    });
    
    requisitionForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const reason = document.getElementById('requisition-reason').value;
        const responsible = document.getElementById('requisition-responsible').value;
        const items = Array.from(document.querySelectorAll('.requisition-item-row')).map(row => ({
            batchId: parseInt(row.querySelector('.requisition-batch').value),
            quantity: parseFloat(row.querySelector('.requisition-quantity').value)
        }));

        if (items.some(item => isNaN(item.batchId) || isNaN(item.quantity))) {
            showNotification("Verifique os itens da requisição. Lote ou quantidade inválida.", true);
            return;
        }

        try {
             for(const item of items) {
                const batch = await DB.get('batches', item.batchId);
                if (item.quantity > batch.quantity) {
                    throw new Error(`Quantidade requisitada para o lote ${batch.code} é maior que o estoque.`);
                }
                const product = await DB.get('inventory', batch.productId);
                
                batch.quantity -= item.quantity;
                product.totalQuantity -= item.quantity;

                await DB.update('batches', batch);
                await DB.update('inventory', product);
                await DB.add('history', {
                    productId: product.id, batchCode: batch.code, type: 'requisição',
                    quantity: item.quantity, date: new Date().toISOString().split('T')[0], reason, responsible
                });
             }
             showNotification("Baixa por requisição realizada com sucesso!");
             requisitionForm.reset();
             initializeRequisitionScreen();
             await refreshLocalData();
        } catch(error) {
            showNotification(error.message || "Erro ao processar requisição.", true);
            console.error(error);
        }
    });
    
    // --- CONSUMPTION REPORT ---
    function populateConsumptionFilters() {
        const years = [...new Set(localMonthlyConsumption.map(c => c.period.substring(0, 4)))];
        const months = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
        const today = new Date();
        const currentYear = today.getFullYear();
        const currentMonth = today.getMonth();

        if (!years.includes(String(currentYear))) years.push(String(currentYear));
        years.sort((a,b) => b-a);
        
        const selectedYear = consumptionYearFilter.value || currentYear;
        const selectedMonth = consumptionMonthFilter.value || (currentMonth + 1);

        consumptionYearFilter.innerHTML = years.map(y => `<option value="${y}" ${y == selectedYear ? 'selected' : ''}>${y}</option>`).join('');
        consumptionMonthFilter.innerHTML = months.map((m, i) => `<option value="${i+1}" ${i+1 == selectedMonth ? 'selected' : ''}>${m}</option>`).join('');
    }

    function renderConsumptionReport() {
        populateConsumptionFilters();
        const year = consumptionYearFilter.value;
        const month = String(consumptionMonthFilter.value).padStart(2, '0');
        const period = `${year}-${month}`;
        const searchTerm = document.getElementById('search-consumption').value.toLowerCase();

        let consumptionData = localMonthlyConsumption.filter(c => c.period === period);

        if (searchTerm) {
            consumptionData = consumptionData.filter(item => {
                const product = localInventory.find(p => p.id === item.productId);
                return product && product.name.toLowerCase().includes(searchTerm);
            });
        }

        consumptionTableBody.innerHTML = '';
        if (consumptionData.length === 0) {
            consumptionTableBody.innerHTML = `<tr><td colspan="2" class="text-center py-4">Nenhum consumo encontrado para este período/filtro.</td></tr>`;
            return;
        }

        consumptionData.forEach(item => {
            const product = localInventory.find(p => p.id === item.productId);
            if (product) {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b';
                row.innerHTML = `
                    <td class="px-6 py-4">${product.name}</td>
                    <td class="px-6 py-4 text-right">${item.totalConsumed.toFixed(2)}</td>
                `;
                consumptionTableBody.appendChild(row);
            }
        });
    }

    consumptionMonthFilter.addEventListener('change', renderConsumptionReport);
    consumptionYearFilter.addEventListener('change', renderConsumptionReport);
    document.getElementById('search-consumption').addEventListener('input', renderConsumptionReport);

    // --- RESIDUAL STOCK ---
    function renderResidualStock() {
        residualTableBody.innerHTML = '';
        if(localResidualStock.length === 0) {
             residualTableBody.innerHTML = `<tr><td colspan="3" class="text-center py-4">Nenhum saldo residual.</td></tr>`;
            return;
        }

        localResidualStock.forEach(item => {
            const product = localInventory.find(p => p.id === item.productId);
            if (product && item.quantity !== 0) {
                 const row = document.createElement('tr');
                row.className = 'bg-white border-b';
                row.innerHTML = `
                    <td class="px-6 py-4">${product.name}</td>
                    <td class="px-6 py-4 text-right font-medium ${item.quantity > 0 ? 'text-green-600' : 'text-red-600'}">${item.quantity.toFixed(2)}</td>
                    <td class="px-6 py-4 text-center">
                        <button class="edit-residual-btn text-blue-500 hover:text-blue-700 p-1" data-product-id="${product.id}" title="Editar Saldo"><i class="fa-solid fa-pencil"></i></button>
                        <button class="delete-residual-btn text-red-500 hover:text-red-700 p-1" data-product-id="${product.id}" title="Zerar Saldo"><i class="fa-solid fa-trash"></i></button>
                    </td>
                `;
                residualTableBody.appendChild(row);
            }
        });
    }

    residualTableBody.addEventListener('click', e => {
        const editBtn = e.target.closest('.edit-residual-btn');
        if(editBtn) {
            const productId = parseInt(editBtn.dataset.productId);
            const product = localInventory.find(p => p.id === productId);
            const residual = localResidualStock.find(r => r.productId === productId);
            document.getElementById('edit-residual-product-id').value = productId;
            document.getElementById('edit-residual-product-name').textContent = product.name;
            document.getElementById('edit-residual-quantity').value = residual.quantity;
            showModal(editResidualModal);
        }

        const deleteBtn = e.target.closest('.delete-residual-btn');
        if(deleteBtn) {
            const productId = parseInt(deleteBtn.dataset.productId);
             const product = localInventory.find(p => p.id === productId);
            showConfirmationModal('Zerar Saldo Residual', `Tem certeza que deseja zerar o saldo residual para <strong>${product.name}</strong>?`, async () => {
                const residual = localResidualStock.find(r => r.productId === productId);
                if (residual) {
                    await updateResidualStock(productId, -residual.quantity);
                    await refreshLocalData();
                    showNotification('Saldo residual zerado.');
                }
            });
        }
    });

    closeEditResidualModal.addEventListener('click', () => hideModal(editResidualModal));

    editResidualForm.addEventListener('submit', async e => {
        e.preventDefault();
        const productId = parseInt(document.getElementById('edit-residual-product-id').value);
        const newQuantity = parseFloat(document.getElementById('edit-residual-quantity').value);
        const residual = await DB.get('residualStock', productId);
        const difference = newQuantity - (residual ? residual.quantity : 0);
        await updateResidualStock(productId, difference);
        await refreshLocalData();
        hideModal(editResidualModal);
        showNotification('Saldo residual atualizado.');
    });
    
    // --- CÓDIGO CORRIGIDO/ADICIONADO PARA RASTREABILIDADE ---
    function initializeTraceabilityScreen() {
        createSearchableSelect(traceProductSearchable, localInventory, 'Buscar produto...', null);
    }

    traceTypeRadios.forEach(radio => {
        radio.addEventListener('change', () => {
            if (radio.value === 'lote') {
                traceLoteFields.classList.remove('hidden');
                traceManipuladorFields.classList.add('hidden');
            } else {
                traceLoteFields.classList.add('hidden');
                traceManipuladorFields.classList.remove('hidden');
            }
        });
    });

    btnTrace.addEventListener('click', () => {
        const traceType = document.querySelector('input[name="trace-type"]:checked').value;
        traceResultsContainer.innerHTML = '<div class="text-center py-4"><div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-indigo-600 mx-auto"></div><p class="mt-2 text-gray-600">Buscando...</p></div>';

        // Usamos um setTimeout para garantir que o spinner de loading apareça na tela antes de iniciar a busca pesada
        setTimeout(() => {
            let resultsHtml = '';

            if (traceType === 'lote') {
                const productId = parseInt(traceProductSearchable.querySelector('input').dataset.selectedId);
                const batchCode = traceBatchCodeInput.value.trim();

                if (!productId || !batchCode) {
                    traceResultsContainer.innerHTML = '<p class="text-red-500 p-4 text-center">Por favor, selecione um produto e insira um código de lote.</p>';
                    return;
                }

                const product = localInventory.find(p => p.id === productId);
                resultsHtml += `<h3 class="text-xl font-semibold mb-4">Rastreamento para: ${product.name} - Lote ${batchCode}</h3>`;

                // 1. Encontrar a origem do lote
                const entryRecord = localHistory.find(h => h.productId === productId && h.batchCode === batchCode && h.type === 'entrada');
                if (entryRecord) {
                    resultsHtml += `
                        <div class="mb-4 p-4 border rounded-lg bg-gray-50">
                            <h4 class="font-bold text-lg text-green-700">Origem do Lote</h4>
                            <p><strong>Data de Recebimento:</strong> ${new Date(entryRecord.date + 'T00:00:00').toLocaleDateString('pt-BR')}</p>
                            <p><strong>Fornecedor:</strong> ${product.supplier}</p>
                            <p><strong>Quantidade Recebida:</strong> ${entryRecord.quantity.toFixed(2)}</p>
                        </div>
                    `;
                } else {
                     resultsHtml += `<div class="mb-4 p-4 border-l-4 border-yellow-400 bg-yellow-50"><p class="text-yellow-700">Nenhum registro de entrada encontrado para este lote.</p></div>`;
                }

                // 2. Encontrar o uso em produção
                const productionUsages = localProductionOrders.filter(po =>
                    po.ingredients.some(ing => {
                        // Check inside the consumption plan
                        return ing.productId === productId && ing.consumptionPlan && ing.consumptionPlan.some(p => p.batchCode === batchCode)
                    })
                );

                if (productionUsages.length > 0) {
                    resultsHtml += `<h4 class="font-bold text-lg text-blue-700 mt-6 mb-2">Uso em Produção</h4>`;
                    resultsHtml += '<ul class="space-y-3">';
                    productionUsages.forEach(po => {
                        const usedIngredient = po.ingredients.find(ing => ing.productId === productId);
                        // Find the specific quantity used from this batch code
                        const usageFromBatch = usedIngredient.consumptionPlan.find(p => p.batchCode === batchCode);
                        if (usageFromBatch) {
                             resultsHtml += `
                                <li class="p-3 border rounded-md shadow-sm">
                                    Produziu <strong>${po.recipeName}</strong> em <strong>${new Date(po.date + 'T00:00:00').toLocaleDateString('pt-BR')}</strong>.
                                    <div class="text-sm text-gray-600 mt-1">
                                        <span>Quantidade Usada deste Lote: ${usageFromBatch.quantity.toFixed(2)}</span> |
                                        <span>Manipulador: ${usedIngredient.handler}</span>
                                    </div>
                                </li>
                            `;
                        }
                    });
                    resultsHtml += '</ul>';
                }

                // 3. Encontrar outras movimentações (ajustes, requisições, etc.)
                const otherMovements = localHistory.filter(h => h.productId === productId && h.batchCode === batchCode && h.type !== 'entrada' && h.type !== 'saída');
                if(otherMovements.length > 0) {
                    resultsHtml += `<h4 class="font-bold text-lg text-purple-700 mt-6 mb-2">Outras Movimentações</h4>`;
                    resultsHtml += '<ul class="space-y-3">';
                     otherMovements.forEach(m => {
                         resultsHtml += `
                            <li class="p-3 border rounded-md shadow-sm">
                                <strong>${m.type.charAt(0).toUpperCase() + m.type.slice(1)}</strong> em <strong>${new Date(m.date + 'T00:00:00').toLocaleDateString('pt-BR')}</strong>.
                                <div class="text-sm text-gray-600 mt-1">
                                    <span>Quantidade: ${m.quantity.toFixed(2)}</span>
                                    ${m.reason ? `<span> | Motivo: ${m.reason}</span>` : ''}
                                    ${m.responsible ? `<span> | Responsável: ${m.responsible}</span>` : ''}
                                </div>
                            </li>
                         `;
                     });
                     resultsHtml += '</ul>';
                }
                
                if (!entryRecord && productionUsages.length === 0 && otherMovements.length === 0) {
                     resultsHtml += `<p class="text-center text-gray-500 mt-4">Nenhuma movimentação encontrada para este lote.</p>`;
                }

            } else if (traceType === 'manipulador') {
                const handlerName = traceHandlerNameInput.value.trim().toLowerCase();
                if (!handlerName) {
                    traceResultsContainer.innerHTML = '<p class="text-red-500 p-4 text-center">Por favor, insira o nome do manipulador.</p>';
                    return;
                }

                resultsHtml += `<h3 class="text-xl font-semibold mb-4">Rastreamento para Manipulador: ${traceHandlerNameInput.value.trim()}</h3>`;

                const handledProductions = localProductionOrders.filter(po =>
                    po.ingredients.some(ing => ing.handler && ing.handler.toLowerCase().includes(handlerName))
                );

                if (handledProductions.length > 0) {
                    resultsHtml += '<ul class="space-y-4">';
                    handledProductions.forEach(po => {
                         const handledIngredients = po.ingredients.filter(ing => ing.handler && ing.handler.toLowerCase().includes(handlerName));
                         resultsHtml += `
                            <li class="p-4 border rounded-lg bg-gray-50 shadow-sm">
                                <p class="font-bold">Produção de <strong>${po.recipeName}</strong> em <strong>${new Date(po.date + 'T00:00:00').toLocaleDateString('pt-BR')}</strong></p>
                                <p class="text-sm mt-2 font-semibold">Insumos manipulados:</p>
                                <ul class="list-disc list-inside text-sm text-gray-700 pl-4">
                                    ${handledIngredients.map(ing => {
                                        const product = localInventory.find(p => p.id === ing.productId);
                                        const consumptionPlanHtml = ing.consumptionPlan.map(p => `${p.batchCode} (${p.quantity.toFixed(2)})`).join(', ');
                                        return `<li>${product.name} (Lotes: ${consumptionPlanHtml}, Qtd Total: ${ing.adjustedQuantity.toFixed(2)})</li>`;
                                    }).join('')}
                                </ul>
                            </li>
                         `;
                    });
                    resultsHtml += '</ul>';
                } else {
                    resultsHtml += `<p class="text-center text-gray-500 mt-4">Nenhuma produção encontrada para este manipulador.</p>`;
                }
            }
            
            traceResultsContainer.innerHTML = resultsHtml;

        }, 200);
    });

    // --- ABC CURVE ---
    function calculateAndRenderAbcCurve() {
        const consumptionData = localMonthlyConsumption.reduce((acc, current) => {
            if (acc[current.productId]) {
                acc[current.productId] += current.totalConsumed;
            } else {
                acc[current.productId] = current.totalConsumed;
            }
            return acc;
        }, {});

        const totalConsumption = Object.values(consumptionData).reduce((sum, qty) => sum + qty, 0);
        
        const canvas = document.getElementById('abc-curve-chart');
        const ctx = canvas.getContext('2d');
        if (abcCurveChart) {
            abcCurveChart.destroy();
        }

        if (totalConsumption === 0) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.textAlign = 'center';
            ctx.fillStyle = '#6b7280';
            ctx.font = "16px 'Inter', sans-serif";
            ctx.fillText('Dados de consumo insuficientes para gerar a curva ABC.', canvas.width / 2, canvas.height / 2);
            return;
        }

        const sortedItems = Object.keys(consumptionData)
            .map(productId => ({
                productId: parseInt(productId),
                consumedQty: consumptionData[productId],
                percentage: (consumptionData[productId] / totalConsumption) * 100,
            }))
            .sort((a, b) => b.consumedQty - a.consumedQty);

        let cumulativePercentage = 0;
        const classifiedItems = { A: 0, B: 0, C: 0 };
        
        sortedItems.forEach(item => {
            cumulativePercentage += item.percentage;
            if (cumulativePercentage <= 80) {
                classifiedItems.A++;
            } else if (cumulativePercentage <= 95) { // 80 + 15
                classifiedItems.B++;
            } else {
                classifiedItems.C++;
            }
        });

        abcCurveChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: [
                    `Classe A (${classifiedItems.A} itens)`,
                    `Classe B (${classifiedItems.B} itens)`,
                    `Classe C (${classifiedItems.C} itens)`
                ],
                datasets: [{
                    label: 'Número de Itens por Classe',
                    data: [classifiedItems.A, classifiedItems.B, classifiedItems.C],
                    backgroundColor: [
                        '#4f46e5', // Indigo-600
                        '#10b981', // Emerald-500
                        '#f59e0b'  // Amber-500
                    ],
                    borderColor: '#ffffff',
                    borderWidth: 2,
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                const totalItems = classifiedItems.A + classifiedItems.B + classifiedItems.C;
                                const value = context.raw;
                                const percentage = totalItems > 0 ? (value / totalItems * 100).toFixed(1) : 0;
                                label += `${percentage}% do total de itens`;
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }

    // --- RESET DATABASE ---
    btnResetDatabase.addEventListener('click', () => {
        showConfirmationModal("Apagar TODOS os dados?", "Esta ação é irreversível e limpará completamente o banco de dados. Deseja continuar?", async () => {
            try {
                loadingOverlay.classList.remove('hidden');
                const stores = ['inventory', 'batches', 'history', 'recipes', 'productionOrders', 'monthlyConsumption', 'residualStock'];
                for (const storeName of stores) {
                    await DB.clear(storeName);
                }
                await refreshLocalData();
                showNotification("Banco de dados apagado com sucesso.");
            } catch(err) {
                showNotification("Erro ao apagar o banco de dados.", true);
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        });
    });


    async function initialize() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('receipt-date').value = today;
        searchPoByDate.value = today;
        navigateTo('dashboard');

        btnExportExcel.addEventListener('click', exportInventoryToExcel);

        try {
            await DB.getDB(); // Inicializa e abre o banco
            await refreshLocalData();
        } catch (error) {
            console.error("Erro na inicialização do IndexedDB:", error);
            loadingOverlay.innerHTML = "Erro ao iniciar o banco de dados offline.";
        }
        loadingOverlay.classList.add('hidden');
    }

    initialize();
</script>

</body>
</html>

